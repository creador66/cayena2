<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IAEgo - Sistema POS Moderno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4a6cfa;
      --primary-dark: #3a5ae0;
      --secondary: #ff7043;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --dark: #2c3e50;
      --light: #f8f9fa;
      --gray: #e0e0e0;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Roboto', sans-serif;
    }
    
    body, html {
      height: 100%;
      background: linear-gradient(135deg, #f5f7fb, #eef2ff);
      color: #333;
      overflow: hidden;
    }
    
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: var(--shadow);
      z-index: 100;
      color: white;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      gap: 12px;
    }
    
    .header-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .header-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
    }
    
    #mesaBar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      z-index: 99;
    }
    
    .mesa-btn {
      flex: none;
      margin-right: 12px;
      padding: 0 18px;
      height: 40px;
      line-height: 40px;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: white;
      color: var(--dark);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    .mesa-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .mesa-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .mesa-btn.ocupada {
      background: #fff3e0;
      border-color: #ffb74d;
      color: #e65100;
    }
    
    .mesa-btn.ocupada.selected {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }
    
    .mesa-count {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 0 8px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .container {
      display: flex;
      position: absolute;
      top: 124px;
      bottom: 76px;
      left: 0;
      right: 0;
    }
    
    .sidebar {
      width: 65%;
      background: white;
      overflow-y: auto;
      border-right: 1px solid var(--gray);
      padding: 16px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.03);
    }
    
    .category-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .thumb-list {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    
    .thumb-list li {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid #f0f0f0;
    }
    
    .thumb-list li:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .thumb-list img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: #f0f0f0;
    }
    
    .product-info {
      padding: 12px;
    }
    
    .product-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-price {
      font-weight: 600;
      color: var(--primary);
      margin-top: 4px;
    }
    
    .main {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: var(--border-radius);
      margin: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .details {
      text-align: center;
      width: 100%;
    }
    
    .details h2 {
      font-size: 1.8rem;
      margin-bottom: 12px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    #categoryMenu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 76px;
      background: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      overflow-x: auto;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 98;
    }
    
    .category-btn {
      flex: none;
      margin-right: 12px;
      padding: 0 20px;
      height: 44px;
      line-height: 44px;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius);
      background: white;
      color: #555;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      font-weight: 500;
    }
    
    .category-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .subcuenta {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .btnCobro {
      display: flex;
      gap: 8px;
    }
    
    .boton-icono {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .boton-icono:hover {
      transform: scale(1.1);
    }
    
    .boton-icono.success {
      background: var(--success);
      color: white;
    }
    
    .boton-icono.warning {
      background: var(--warning);
      color: white;
    }
    
    .boton-icono.danger {
      background: var(--danger);
      color: white;
    }
    
    .boton-icono.info {
      background: var(--primary);
      color: white;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: 0.3s;
      z-index: 1000;
    }
    
    .modal.active {
      visibility: visible;
      opacity: 1;
    }
    
    .modal .panel {
      background: white;
      border-radius: var(--border-radius);
      padding: 28px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(120%);
      transition: transform 0.3s;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background: var(--danger);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .thumb-list {
        grid-template-columns: repeat(2, 1fr);
      }
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 40%;
      }
      .main {
        width: 100%;
        height: 60%;
      }
    }
    
    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #777;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Payment form styling */
    .payment-form {
      display: grid;
      gap: 15px;
    }
    
    .payment-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .payment-form input,
    .payment-form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .payment-total {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin: 15px 0;
      color: var(--primary);
    }
    
    /* Product counter */
    .product-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .counter-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 1.2rem;
      transition: var(--transition);
    }
    
    .counter-btn:hover {
      background: #e9e9e9;
    }
    
    .counter-value {
      font-size: 1.2rem;
      font-weight: 500;
      min-width: 30px;
      text-align: center;
    }
    
    /* Totals section */
    .totals-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px dashed #e0e0e0;
    }
    
    .totals-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .total-label {
      font-weight: 600;
    }
    
    .total-value {
      font-weight: 700;
      color: var(--primary);
    }
    
    .grand-total {
      font-size: 1.4rem;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid var(--primary);
    }
    
    /* Animation for price updates */
    @keyframes highlight {
      0% { background-color: #fff9c4; }
      100% { background-color: transparent; }
    }
    
    .price-update {
      animation: highlight 1s ease;
    }
    
    /* Mesa view styles */
    .mesa-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary);
    }
    
    .cuenta-card {
      background: #f9f9ff;
      border-radius: var(--border-radius);
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: var(--shadow);
    }
    
    .cuenta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .cuenta-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--primary-dark);
    }
    
    .product-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .product-name {
      flex: 2;
    }
    
    .product-qty {
      flex: 1;
      text-align: center;
    }
    
    .product-price {
      flex: 1;
      text-align: right;
    }
    
    .cuenta-total {
      font-weight: 700;
      text-align: right;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    
    .cuenta-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
    }
    
    .mesa-total {
      background: var(--primary);
      color: white;
      padding: 15px;
      border-radius: var(--border-radius);
      font-size: 1.3rem;
      font-weight: 700;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-cash-register"></i><span> IAEgo POS</span></div>
    <div class="header-controls">
      <button onclick="crearMesa()" class="header-btn"><i class="fas fa-plus"></i> Nueva Mesa</button>
      <button onclick="verHistorial()" class="header-btn"><i class="fas fa-history"></i> Historial</button>
      <button onclick="refrescarProductos()" class="header-btn"><i class="fas fa-sync"></i> Actualizar</button>
    </div>
  </header>

  <div id="mesaBar"></div>

  <div class="container">
    <aside class="sidebar">
      <div class="category-title"><i class="fas fa-utensils"></i> Productos Disponibles</div>
      <ul class="thumb-list" id="thumbList"></ul>
    </aside>
    
    <section class="main" id="mesaView">
      <div class="mesa-header">
        <h2><i class="fas fa-table"></i> <span id="currentMesaName">Seleccione una mesa</span></h2>
        <button onclick="cerrarMesaView()" class="btn-secondary"><i class="fas fa-times"></i> Cerrar</button>
      </div>
      
      <div id="cuentasContainer" class="empty-state">
        <i class="fas fa-receipt"></i>
        <h3>No hay cuentas abiertas</h3>
        <p>Seleccione una mesa para ver sus cuentas</p>
      </div>
    </section>
  </div>

  <div id="categoryMenu"></div>

  <!-- Modal de cobro -->
  <div class="modal" id="modal-cobrar">
    <div class="panel" id="payPanel"></div>
  </div>

  <!-- Modal de historial -->
  <div class="modal" id="modal-history">
    <div class="panel">
      <h3><i class="fas fa-history"></i> Historial Ventas</h3>
      <ul id="history-list"></ul>
      <div class="actions">
        <button onclick="cerrarHistorial()" class="btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-info-circle"></i><span id="notification-text"></span>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
    const CONFIG = {
      STORAGE_KEYS: { 
        ALMACEN: 'almacen6525', 
        MESAS: 'mesas',
        PRODUCTS: 'products',
        SALES: 'salesHistory'
      },
      FACTORES: { mg: 0.001, g:1, kg:1000, ml:1, l:1000, pz:1 },
      MARGEN: 2
    };
    
    // Estado global
    const state = {
      products: [],
      mesas: [],
      salesHistory: [],
      currentMesaId: null,
      currentProd: -1,
      currentQty: 1,
      currentCategory: 'Todas',
      debugMode: false
    };

    // --- Utilidades ---
    function logDebug(message) {
      if (state.debugMode) {
        console.log(`[DEBUG] ${message}`);
      }
    }
    
    function loadJSON(key) {
      try { 
        const d = localStorage.getItem(key); 
        return d ? JSON.parse(d) : []; 
      } catch(e) {
        return []; 
      }
    }
    
    function saveJSON(key,val) {
      try { 
        localStorage.setItem(key, JSON.stringify(val)); 
        return true; 
      } catch(e) {
        return false; 
      }
    }
    
    function showNot(msg,err=false) {
      const n = document.getElementById('notification');
      const t = document.getElementById('notification-text');
      t.textContent = msg;
      n.className = err ? 'notification error show' : 'notification show';
      setTimeout(()=> n.className = 'notification',3000);
    }
    
    // Función clave: encontrar índice por ID de mesa
    function findMesaIndexById(id) {
      return state.mesas.findIndex(m => m.id === id);
    }

    // --- Costos ---
    function calcularCosto(ingredientes,alm) {
      const f = CONFIG.FACTORES; 
      let total=0;
      ingredientes.forEach(item=>{
        const p = alm.find(x=>String(x.codigo)===String(item.codigo));
        if(!p) return;
        const ua = f[p.unidadDeMedida.trim().toLowerCase()];
        const ui = f[item.unidad.trim().toLowerCase()];
        if(ua && ui){
          const base = ua*parseFloat(p.cantidad);
          const precioU = p.precio/base;
          total += precioU * (ui*item.cantidad);
        }
      });
      return +total.toFixed(2);
    }
    
    function aplicarMargen(c) { 
      return +(c*CONFIG.MARGEN).toFixed(2); 
    }

    // --- Fetch remoto ---
    async function fetchRec() {
      try {
        const fd = new FormData(); 
        fd.append('op','obtenerCocina');
        const r = await fetch(API_URL,{method:'POST',body:fd});
        const j = await r.json();
        if(j.status === 'success') {
          return j.data;
        }
        throw new Error(j.message || 'Error desconocido');
      } catch(e) {
        showNot('Error al obtener recetas', true);
        return []; 
      }
    }
    
    async function saveSale(sale) {
      try {
        const fd = new FormData();
        fd.append('op','guardarVentas');
        fd.append('venta',JSON.stringify(sale));
        fd.append('metodoPago',sale.metodoPago);
        const r = await fetch(API_URL,{method:'POST',body:fd});
        const j = await r.json();
        if(j.status === 'success') {
          return true;
        }
        throw new Error(j.message || 'Error al guardar venta');
      } catch(e) {
        showNot('Error al guardar venta', true);
        return false; 
      }
    }

    // --- Render dinámico ---
    function setupCats() {
      const cats = ['Todas'];
      state.products.forEach(p=>{
        if(p.categoria && !cats.includes(p.categoria)) cats.push(p.categoria);
      });
      window.categoriesJson = cats.map(c=>({name:c,filter:c==='Todas'?null:c}));
    }
    
    function renderCats() {
      const m = document.getElementById('categoryMenu');
      m.innerHTML = '';
      window.categoriesJson.forEach(c=>{
        m.innerHTML += `<button onclick="filtrarCat('${c.name}')" class="category-btn${c.name===state.currentCategory?' active':''}">${c.name}</button>`;
      });
    }
    
    function renderThumbnails() {
      const l = document.getElementById('thumbList');
      l.innerHTML = '';
      const list = state.currentCategory==='Todas'? state.products: state.products.filter(p=>p.categoria===state.currentCategory);
      
      if(!list.length){
        l.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><h3>No hay productos</h3></div>`;
        return;
      }
      
      list.forEach((p,i)=>{
        l.innerHTML += `
          <li onclick="selectProd(${i})">
            <img src="${p.imagen}" alt="${p.nombre}" >
            <div class="product-info">
              <div class="product-name">${p.nombre}</div>
              <div class="product-price">$${p.precio.toFixed(2)}</div>
            </div>
          </li>`;
      });
    }
    
    function renderMesas() {
      const bar = document.getElementById('mesaBar');
      bar.innerHTML = '';
      state.mesas.forEach(m=>{
        const cnt = m.cuentas.flatMap(c=>c.pedidos.map(x=>x.cantidad)).reduce((a,b)=>a+b,0);
        bar.innerHTML += `
          <button onclick="abrirMesa(${m.id})" class="mesa-btn${m.id===state.currentMesaId?' selected':''}${cnt>0?' ocupada':''}">
            ${m.name} (${cnt} pz)
          </button>`;
      });
    }
    
    // Función clave: renderizar vista de mesa en el panel principal
    function renderMesaView(mesaId) {
      const index = findMesaIndexById(mesaId);
      if (index === -1) return;
      
      const mesa = state.mesas[index];
      document.getElementById('currentMesaName').textContent = mesa.name;
      
      const container = document.getElementById('cuentasContainer');
      container.innerHTML = '';
      
      if(!mesa.cuentas.length){
        container.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><h3>No hay cuentas</h3></div>`;
        return;
      }
      
      let mesaTotal = 0;
      
      mesa.cuentas.forEach((cuenta, ci)=>{
        const cuentaTotal = cuenta.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        mesaTotal += cuentaTotal;
        
        const cuentaHTML = `
          <div class="cuenta-card">
            <div class="cuenta-header">
              <div class="cuenta-title">${cuenta.nombre}</div>
              <div class="cuenta-total">Total: $${cuentaTotal.toFixed(2)}</div>
            </div>
            
            <div class="cuenta-content">
              ${cuenta.pedidos.length ? '' : '<div class="empty-state small">No hay productos en esta cuenta</div>'}
              ${cuenta.pedidos.map((p, pi) => `
                <div class="product-item">
                  <div class="product-name">${p.nombre}</div>
                  <div class="product-qty">${p.cantidad} x $${p.precio.toFixed(2)}</div>
                  <div class="product-price">$${(p.precio * p.cantidad).toFixed(2)}</div>
                </div>
              `).join('')}
            </div>
            
            <div class="cuenta-actions">
              <button onclick="addToCuenta(${index}, ${ci})" class="boton-icono info"><i class="fas fa-plus"></i></button>
              <button onclick="openPay(${index}, ${ci})" class="boton-icono success"><i class="fas fa-cash-register"></i></button>
              <button onclick="eliminarCuenta(${index}, ${ci})" class="boton-icono danger"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        
        container.innerHTML += cuentaHTML;
      });
      
      // Añadir total de mesa
      container.innerHTML += `
        <div class="mesa-total">
          Total Mesa: $${mesaTotal.toFixed(2)}
        </div>
        <div class="actions" style="margin-top:15px">
          <button onclick="nuevaCuenta()" class="btn-add"><i class="fas fa-plus"></i> Nueva Cuenta</button>
          <button onclick="cobrarTodo(${index})" class="btn-add"><i class="fas fa-money-bill-wave"></i> Cobrar Todo</button>
        </div>
      `;
    }
    
    // Función para cerrar la vista de mesa
    function cerrarMesaView() {
      state.currentMesaId = null;
      document.getElementById('currentMesaName').textContent = 'Seleccione una mesa';
      document.getElementById('cuentasContainer').innerHTML = `
        <div class="empty-state">
          <i class="fas fa-receipt"></i>
          <h3>No hay cuentas abiertas</h3>
          <p>Seleccione una mesa para ver sus cuentas</p>
        </div>
      `;
      renderMesas();
    }

    // --- Funciones UI ---
    function filtrarCat(cat) {
      state.currentCategory = cat; 
      renderCats(); 
      renderThumbnails();
    }
    
    function selectProd(i) {
      state.currentProd = i; 
      const p = state.products[i];
      state.currentQty = 1; 
      showNot(`Producto seleccionado: ${p.nombre}`);
    }
    
    function cambiarCantidad(d) {
      state.currentQty = Math.max(1, state.currentQty + d);
    }
    
    // Función clave: abrir mesa en la vista principal
    function abrirMesa(id) {
      state.currentMesaId = id;
      renderMesas();
      renderMesaView(id);
    }
    
    function addToCuenta(mi, ci) {
      if(state.currentProd < 0) {
        showNot('Selecciona un producto', true);
        return;
      }
      
      const p = state.products[state.currentProd];
      const cuenta = state.mesas[mi].cuentas[ci];
      
      const ex = cuenta.pedidos.find(x=>x.codigo===p.codigo);
      
      if(ex) {
        ex.cantidad += state.currentQty;
      } else {
        cuenta.pedidos.push({
          codigo: p.codigo,
          nombre: p.nombre,
          precio: p.precio,
          cantidad: state.currentQty
        });
      }
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      showNot(`${state.currentQty}× ${p.nombre} añadido a ${cuenta.nombre}`);
      renderMesaView(state.mesas[mi].id);
      state.currentQty = 1;
    }
    
    function crearMesa() {
      const next = state.mesas.length ? Math.max(...state.mesas.map(m=>m.id)) + 1 : 1;
      state.mesas.push({
        id: next,
        name: `Mesa ${next}`,
        cuentas: [{nombre:'Cuenta 1', pedidos:[]}]
      });
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      renderMesas(); 
      abrirMesa(next);
      showNot(`Mesa ${next} creada`);
    }
    
    function verHistorial() {
      const ul = document.getElementById('history-list'); 
      ul.innerHTML = '';
      
      if(!state.salesHistory.length){
        ul.innerHTML = `<div class="empty-state"><i class="fas fa-history"></i><h3>No hay historial</h3></div>`;
      } else {
        state.salesHistory.forEach(s => {
          ul.innerHTML += `
            <li class="subcuenta">
              <div>${s.mesa} - ${s.cuenta} <small>${new Date(s.fecha).toLocaleString()}</small></div>
              <div>$${s.total.toFixed(2)} - ${s.metodoPago}</div>
            </li>`;
        });
      }
      
      document.getElementById('modal-history').classList.add('active');
    }
    
    function cerrarHistorial() { 
      document.getElementById('modal-history').classList.remove('active');
    }
    
    async function refrescarProductos() {
      const rec = await fetchRec();
      if(!rec.length) return;
      
      const alm = loadJSON(CONFIG.STORAGE_KEYS.ALMACEN);
      state.products = rec.map(r => ({
        codigo: r.codigo,
        nombre: r.nombre,
        descripcion: r.descripcion || '',
        categoria: r.categoria || '',
        imagen: r.imagen || 'https://via.placeholder.com/300x200?text=No+img',
        precio: aplicarMargen(calcularCosto(r.ingredientes, alm)),
        ingredientes: r.ingredientes
      }));
      
      saveJSON(CONFIG.STORAGE_KEYS.PRODUCTS, state.products);
      setupCats(); 
      renderCats(); 
      renderThumbnails();
      
      if(state.products.length) selectProd(0);
      showNot('Productos actualizados');
    }
    
    function nuevaCuenta() {
      if (state.currentMesaId === null) {
        showNot('Selecciona una mesa primero', true);
        return;
      }
      
      const index = findMesaIndexById(state.currentMesaId);
      if (index === -1) return;
      
      const m = state.mesas[index];
      const num = m.cuentas.length + 1;
      m.cuentas.push({nombre: `Cuenta ${num}`, pedidos: []});
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      renderMesaView(state.currentMesaId);
      showNot(`Cuenta ${num} creada`);
    }
    
    function eliminarCuenta(mi, ci) {
      state.mesas[mi].cuentas.splice(ci, 1);
      
      // Si no quedan cuentas, eliminar la mesa
      if (state.mesas[mi].cuentas.length === 0) {
        eliminarMesa(mi);
        return;
      }
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      renderMesaView(state.mesas[mi].id);
      showNot('Cuenta eliminada');
    }
    
    function eliminarMesa(index) {
      state.mesas.splice(index, 1);
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      cerrarMesaView();
      renderMesas();
      showNot('Mesa eliminada');
    }
    
    function cobrarTodo(mi) { 
      openPay(mi, 'all'); 
    }
    
    function openPay(mi, ci) {
      let items = [], total = 0, title = '';
      
      if(ci === 'all'){
        title = 'Cobrar Mesa Completa';
        state.mesas[mi].cuentas.forEach(c => {
          items = items.concat(c.pedidos);
          total += c.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        });
      } else {
        const c = state.mesas[mi].cuentas[ci];
        title = `Cobrar ${c.nombre}`;
        items = c.pedidos.slice();
        total = items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      }
      
      total = +total.toFixed(2);
      
      let html = `<h3><i class="fas fa-cash-register"></i> ${title}</h3><ul class="payment-list">`;
      
      if(!items.length) {
        html += '<li class="empty-state">No hay productos</li>';
      } else {
        items.forEach(i => {
          html += `
            <li class="subcuenta">
              <div>${i.nombre} × ${i.cantidad}</div>
              <div>$${(i.precio * i.cantidad).toFixed(2)}</div>
            </li>`;
        });
      }
      
      html += `</ul>
        <div class="payment-total">Total: $${total.toFixed(2)}</div>
        <div class="payment-form">
          <label>Método de Pago:</label>
          <select id="payMethod">
            <option>Efectivo</option>
            <option>Tarjeta Crédito</option>
            <option>Tarjeta Débito</option>
            <option>Transferencia</option>
          </select>
          <label>Monto Recibido:</label>
          <input type="number" min="0" step="0.01" value="${total}" 
                 oninput="actualizarCambio(this.value, ${total})" 
                 id="receivedAmount"/>
          <div id="payChange">Cambio: $0.00</div>
        </div>
        <div class="actions">
          <button onclick="confirmPay(${mi}, '${ci}')" class="btn-add">Confirmar Pago</button>
          <button onclick="closePay()" class="btn-secondary">Cancelar</button>
        </div>`;
      
      document.getElementById('payPanel').innerHTML = html;
      document.getElementById('modal-cobrar').classList.add('active');
    }
    
    function actualizarCambio(recibido, total) {
      const recibidoNum = parseFloat(recibido) || 0;
      const cambio = recibidoNum - total;
      const cambioTexto = cambio >= 0 ? `$${cambio.toFixed(2)}` : `-$${Math.abs(cambio).toFixed(2)}`;
      
      document.getElementById('payChange').textContent = `Cambio: ${cambioTexto}`;
      document.getElementById('payChange').style.color = cambio >= 0 ? 'var(--success)' : 'var(--danger)';
    }
    
    function closePay() { 
      document.getElementById('modal-cobrar').classList.remove('active');
    }
    
    async function confirmPay(mi, ci) {
      const metodo = document.getElementById('payMethod').value;
      const recibido = parseFloat(document.getElementById('receivedAmount').value) || 0;
      
      let items = [], total = 0, mesaName = '', cuentaName = '';
      const mesaId = state.mesas[mi].id;
      
      if(ci === 'all'){
        const m = state.mesas[mi]; 
        mesaName = m.name; 
        cuentaName = 'Mesa Completa';
        
        m.cuentas.forEach(c => {
          items = items.concat(c.pedidos.map(i => ({
            codigo: String(i.codigo),
            producto: i.nombre,
            cantidad: i.cantidad,
            total: +(i.precio * i.cantidad).toFixed(2)
          })));
          
          total += c.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        });
      } else {
        const m = state.mesas[mi];
        const c = m.cuentas[ci];
        mesaName = m.name; 
        cuentaName = c.nombre;
        
        items = c.pedidos.map(i => ({
          codigo: String(i.codigo),
          producto: i.nombre,
          cantidad: i.cantidad,
          total: +(i.precio * i.cantidad).toFixed(2)
        }));
        
        total = items.reduce((sum, item) => sum + item.total, 0);
      }
      
      if(recibido < total) {
        showNot('Monto insuficiente', true);
        return;
      }
      
      const sale = {
        fecha: new Date().toISOString(),
        metodoPago: metodo,
        items,
        mesa: mesaName,
        cuenta: cuentaName,
        total
      };
      
      if(await saveSale(sale)){
        // Limpiar pedidos después de cobrar
        if(ci === 'all') {
          // Eliminar toda la mesa después de cobrar
          eliminarMesa(mi);
        } else {
          // Eliminar solo la cuenta cobrada
          state.mesas[mi].cuentas.splice(ci, 1);
          
          // Si no quedan cuentas, eliminar la mesa
          if (state.mesas[mi].cuentas.length === 0) {
            eliminarMesa(mi);
          } else {
            saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
            renderMesaView(mesaId);
          }
        }
        
        // Actualizar historial
        state.salesHistory.push(sale);
        saveJSON(CONFIG.STORAGE_KEYS.SALES, state.salesHistory);
        
        showNot(`Pago de $${sale.total.toFixed(2)} registrado`);
        closePay();
      } else {
        showNot('Error al registrar pago', true);
      }
    }

    // --- Inicio ---
    (async() => {
      // Cargar datos iniciales
      state.mesas = loadJSON(CONFIG.STORAGE_KEYS.MESAS);
      state.salesHistory = loadJSON(CONFIG.STORAGE_KEYS.SALES) || [];
      state.products = loadJSON(CONFIG.STORAGE_KEYS.PRODUCTS) || [];
      
      // Si no hay mesas, crear una por defecto
      if(!state.mesas.length) {
        crearMesa();
      } else {
        // Seleccionar la primera mesa al inicio
        if (state.mesas.length > 0) {
          abrirMesa(state.mesas[0].id);
        }
      }
      
      // Configurar UI
      setupCats(); 
      renderCats(); 
      renderThumbnails(); 
      renderMesas();
      
      // Seleccionar primer producto si existe
      if(state.products.length) selectProd(0);
    })();
  </script>
</body>
</html>
