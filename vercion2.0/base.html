<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>IAEgo - Sistema POS Moderno</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #4a6cfa;
      --primary-dark: #3a5ae0;
      --secondary: #ff7043;
      --success: #4caf50;
      --warning: #ff9800;
      --danger: #f44336;
      --dark: #2c3e50;
      --light: #f8f9fa;
      --gray: #e0e0e0;
      --border-radius: 12px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-hover: 0 6px 16px rgba(0,0,0,0.12);
      --transition: all 0.3s ease;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Roboto', sans-serif;
    }
    
    body, html {
      height: 100%;
      background: linear-gradient(135deg, #f5f7fb, #eef2ff);
      color: #333;
      overflow: hidden;
    }
    
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      box-shadow: var(--shadow);
      z-index: 100;
      color: white;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
      font-weight: 600;
    }
    
    .header-controls {
      display: flex;
      gap: 12px;
    }
    
    .header-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: var(--transition);
      font-weight: 500;
    }
    
    .header-btn:hover {
      background: rgba(255,255,255,0.25);
      transform: translateY(-2px);
    }
    
    #mesaBar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      height: 60px;
      background: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      overflow-x: auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      z-index: 99;
    }
    
    .mesa-btn {
      flex: none;
      margin-right: 12px;
      padding: 0 18px;
      height: 40px;
      line-height: 40px;
      border-radius: 8px;
      border: 1px solid var(--gray);
      background: white;
      color: var(--dark);
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    .mesa-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
    }
    
    .mesa-btn.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .mesa-btn.ocupada {
      background: #fff3e0;
      border-color: #ffb74d;
      color: #e65100;
    }
    
    .mesa-btn.ocupada.selected {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }
    
    .mesa-count {
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      padding: 0 8px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    
    .container {
      display: flex;
      position: absolute;
      top: 124px;
      bottom: 76px;
      left: 0;
      right: 0;
    }
    
    .sidebar {
      width: 65%;
      background: white;
      overflow-y: auto;
      border-right: 1px solid var(--gray);
      padding: 16px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.03);
    }
    
    .category-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 16px;
      color: var(--primary-dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .thumb-list {
      list-style: none;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
    }
    
    .thumb-list li {
      background: white;
      border-radius: var(--border-radius);
      overflow: hidden;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      border: 1px solid #f0f0f0;
    }
    
    .thumb-list li:hover {
      transform: translateY(-4px);
      box-shadow: var(--shadow-hover);
    }
    
    .thumb-list img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: #f0f0f0;
    }
    
    .product-info {
      padding: 12px;
    }
    
    .product-name {
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .product-price {
      font-weight: 600;
      color: var(--primary);
      margin-top: 4px;
    }
    
    .main {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: white;
      border-radius: var(--border-radius);
      margin: 16px;
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .main img {
      max-width: 70%;
      max-height: 300px;
      object-fit: contain;
      border-radius: var(--border-radius);
      margin-bottom: 24px;
      background: #f9f9f9;
      padding: 20px;
    }
    
    .details {
      text-align: center;
      width: 100%;
    }
    
    .details h2 {
      font-size: 2rem;
      margin-bottom: 12px;
    }
    
    .details .price {
      font-size: 1.8rem;
      color: var(--primary);
      margin-bottom: 24px;
      font-weight: 700;
    }
    
    .details .desc {
      font-size: 1.1rem;
      color: #555;
      line-height: 1.6;
      max-width: 600px;
      margin: 0 auto 20px;
    }
    
    #categoryMenu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 76px;
      background: white;
      display: flex;
      align-items: center;
      padding: 0 20px;
      overflow-x: auto;
      box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
      z-index: 98;
    }
    
    .category-btn {
      flex: none;
      margin-right: 12px;
      padding: 0 20px;
      height: 44px;
      line-height: 44px;
      border: 1px solid var(--gray);
      border-radius: var(--border-radius);
      background: white;
      color: #555;
      cursor: pointer;
      box-shadow: var(--shadow);
      transition: var(--transition);
      font-weight: 500;
    }
    
    .category-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    #checkoutPanel {
      position: fixed;
      bottom: 86px;
      right: 24px;
      background: white;
      padding: 24px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-hover);
      min-width: 320px;
      max-height: 70vh;
      overflow-y: auto;
      display: none;
      z-index: 101;
      border: 1px solid #e0e0e0;
    }
    
    #checkoutHeader {
      margin-bottom: 20px;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .panel-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn-add {
      background: var(--primary);
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }
    
    .btn-add:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: white;
      color: var(--primary);
      border: 1px solid var(--primary);
      padding: 12px 18px;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: var(--transition);
    }
    
    .btn-secondary:hover {
      background: #f0f5ff;
    }
    
    .subcuenta {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .btnCobro {
      display: flex;
      gap: 8px;
    }
    
    .boton-icono {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .boton-icono:hover {
      transform: scale(1.1);
    }
    
    .boton-icono.success {
      background: var(--success);
      color: white;
    }
    
    .boton-icono.warning {
      background: var(--warning);
      color: white;
    }
    
    .boton-icono.danger {
      background: var(--danger);
      color: white;
    }
    
    .boton-icono.info {
      background: var(--primary);
      color: white;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: 0.3s;
      z-index: 1000;
    }
    
    .modal.active {
      visibility: visible;
      opacity: 1;
    }
    
    .modal .panel {
      background: white;
      border-radius: var(--border-radius);
      padding: 28px;
      max-width: 500px;
      width: 90%;
      max-height: 80%;
      overflow-y: auto;
      animation: fadeIn 0.3s ease;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(120%);
      transition: transform 0.3s;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification.error {
      background: var(--danger);
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .thumb-list {
        grid-template-columns: repeat(2, 1fr);
      }
      .container {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        height: 40%;
      }
      .main {
        width: 100%;
        height: 60%;
      }
    }
    
    /* Empty state styles */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #777;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }
    
    /* Payment form styling */
    .payment-form {
      display: grid;
      gap: 15px;
    }
    
    .payment-form label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .payment-form input,
    .payment-form select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
    }
    
    .payment-total {
      font-size: 1.5rem;
      font-weight: 700;
      text-align: center;
      margin: 15px 0;
      color: var(--primary);
    }
    
    /* Product counter */
    .product-counter {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }
    
    .counter-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #ddd;
      background: #f9f9f9;
      cursor: pointer;
      font-size: 1.2rem;
      transition: var(--transition);
    }
    
    .counter-btn:hover {
      background: #e9e9e9;
    }
    
    .counter-value {
      font-size: 1.2rem;
      font-weight: 500;
      min-width: 30px;
      text-align: center;
    }
    
    /* Totals section */
    .totals-section {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 2px dashed #e0e0e0;
    }
    
    .totals-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .total-label {
      font-weight: 600;
    }
    
    .total-value {
      font-weight: 700;
      color: var(--primary);
    }
    
    .grand-total {
      font-size: 1.4rem;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid var(--primary);
    }
    
    /* Animation for price updates */
    @keyframes highlight {
      0% { background-color: #fff9c4; }
      100% { background-color: transparent; }
    }
    
    .price-update {
      animation: highlight 1s ease;
    }
    
    /* Debug console */
    .debug-console {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      max-width: 300px;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo"><i class="fas fa-cash-register"></i><span> IAEgo POS</span></div>
    <div class="header-controls">
      <button onclick="crearMesa()" class="header-btn"><i class="fas fa-plus"></i> Nueva Mesa</button>
      <button onclick="verHistorial()" class="header-btn"><i class="fas fa-history"></i> Historial</button>
      <button onclick="refrescarProductos()" class="header-btn"><i class="fas fa-sync"></i> Actualizar</button>
      <button onclick="toggleDebug()" class="header-btn"><i class="fas fa-bug"></i> Debug</button>
    </div>
  </header>

  <div id="mesaBar"></div>

  <div class="container">
    <aside class="sidebar">
      <div class="category-title"><i class="fas fa-utensils"></i> Productos Disponibles</div>
      <ul class="thumb-list" id="thumbList"></ul>
    </aside>
    <section class="main">
      <img id="mainImage" src="https://via.placeholder.com/400x300?text=Selecciona+un+producto" alt="Producto" />
      <div class="details">
        <h2 id="productName">Selecciona un producto</h2>
        <div class="price" id="productPrice"></div>
        <p class="desc" id="productDesc">Selecciona un producto de la lista para ver sus detalles.</p>
        <div class="product-counter">
          <button onclick="cambiarCantidad(-1)" class="counter-btn">-</button>
          <div class="counter-value" id="quantityDisplay">1</div>
          <button onclick="cambiarCantidad(1)" class="counter-btn">+</button>
        </div>
        <button onclick="añadirAlPedido()" class="btn-add">
          <i class="fas fa-cart-plus"></i> Añadir al Pedido
        </button>
      </div>
    </section>
  </div>

  <div id="categoryMenu"></div>

  <div id="checkoutPanel">
    <div id="checkoutHeader">
      <div class="panel-title"><i class="fas fa-receipt"></i> <span id="mesaNumber"></span></div>
      <button class="boton-icono info" onclick="cerrarPanel()"><i class="fas fa-times"></i></button>
    </div>
    <div id="accountsList"></div>
    <div class="totals-section">
      <div class="totals-row">
        <span class="total-label">Total Mesa:</span>
        <span class="total-value" id="mesaTotal">$0.00</span>
      </div>
      <div class="totals-row grand-total">
        <span class="total-label">Total General:</span>
        <span class="total-value" id="grandTotal">$0.00</span>
      </div>
    </div>
    <div class="actions">
      <button onclick="nuevaCuenta()" class="btn-add"><i class="fas fa-plus"></i> Nueva Cuenta</button>
      <button onclick="cobrarTodo()" class="btn-add"><i class="fas fa-money-bill-wave"></i> Cobrar Todo</button>
      <button onclick="cerrarPanel()" class="btn-secondary"><i class="fas fa-times"></i> Cerrar</button>
    </div>
  </div>

  <!-- Modales -->
  <div class="modal" id="modal-edit">
    <div class="panel">
      <h3><i class="fas fa-edit"></i> Editar Pedidos</h3>
      <ul id="edit-list"></ul>
      <div class="actions">
        <button onclick="cancelarEdicion()" class="btn-secondary">Cancelar</button>
        <button onclick="guardarEdicion()" class="btn-add">Guardar</button>
      </div>
    </div>
  </div>

  <div class="modal" id="modal-cobrar">
    <div class="panel" id="payPanel"></div>
  </div>

  <div class="modal" id="modal-history">
    <div class="panel">
      <h3><i class="fas fa-history"></i> Historial Ventas</h3>
      <ul id="history-list"></ul>
      <div class="actions">
        <button onclick="cerrarHistorial()" class="btn-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <div class="notification" id="notification">
    <i class="fas fa-info-circle"></i><span id="notification-text"></span>
  </div>
  
  <div id="debugConsole" class="debug-console">Debug Console</div>

  <script>
    // Configuración mejorada con mensajes de depuración
    const API_URL = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
    const CONFIG = {
      STORAGE_KEYS: { 
        ALMACEN: 'almacen6525', 
        COSTEADAS: 'recetasCosteadas',
        MESAS: 'mesas',
        PRODUCTS: 'products',
        SALES: 'salesHistory'
      },
      FACTORES: { mg: 0.001, g:1, kg:1000, ml:1, l:1000, pz:1 },
      CATEGORIAS: { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] },
      MARGEN: 2
    };
    
    // Estado global con mejor manejo de errores
    const state = {
      products: [],
      mesas: [],
      salesHistory: [],
      currentMesa: null,
      currentProd: -1,
      currentQty: 1,
      currentCategory: 'Todas',
      editList: [],
      inspectAcc: null,
      inspectSub: null,
      debugMode: false
    };

    // --- Utilidades mejoradas ---
    function logDebug(message) {
      if (state.debugMode) {
        console.log(`[DEBUG] ${message}`);
        const consoleElement = document.getElementById('debugConsole');
        consoleElement.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
        consoleElement.scrollTop = consoleElement.scrollHeight;
      }
    }
    
    function loadJSON(key) {
      try { 
        const d = localStorage.getItem(key); 
        logDebug(`Cargando ${key}: ${d ? 'Éxito' : 'Vacío'}`);
        return d ? JSON.parse(d) : []; 
      } catch(e) {
        logDebug(`Error al cargar ${key}: ${e.message}`);
        return []; 
      }
    }
    
    function saveJSON(key,val) {
      try { 
        localStorage.setItem(key, JSON.stringify(val)); 
        logDebug(`Guardado en ${key}`);
        return true; 
      } catch(e) {
        logDebug(`Error al guardar en ${key}: ${e.message}`);
        return false; 
      }
    }
    
    function showNot(msg,err=false) {
      logDebug(`Notificación: ${msg} ${err ? '(error)' : ''}`);
      const n = document.getElementById('notification');
      const t = document.getElementById('notification-text');
      t.textContent = msg;
      n.className = err ? 'notification error show' : 'notification show';
      setTimeout(()=> n.className = 'notification',3000);
    }
    
    function toggleDebug() {
      state.debugMode = !state.debugMode;
      const consoleElement = document.getElementById('debugConsole');
      consoleElement.style.display = state.debugMode ? 'block' : 'none';
      showNot(`Modo debug ${state.debugMode ? 'activado' : 'desactivado'}`);
    }
    
    // Función clave para resolver el problema: encontrar índice por ID de mesa
    function findMesaIndexById(id) {
      const index = state.mesas.findIndex(m => m.id === id);
      if (index === -1) {
        logDebug(`Mesa con ID ${id} no encontrada`);
        showNot(`Error: Mesa ${id} no encontrada`, true);
      }
      return index;
    }

    // --- Costos ---
    function calcularCosto(ingredientes,alm) {
      const f = CONFIG.FACTORES; 
      let total=0;
      ingredientes.forEach(item=>{
        const p = alm.find(x=>String(x.codigo)===String(item.codigo));
        if(!p) return;
        const ua = f[p.unidadDeMedida.trim().toLowerCase()];
        const ui = f[item.unidad.trim().toLowerCase()];
        if(ua && ui){
          const base = ua*parseFloat(p.cantidad);
          const precioU = p.precio/base;
          total += precioU * (ui*item.cantidad);
        }
      });
      return +total.toFixed(2);
    }
    
    function aplicarMargen(c) { 
      return +(c*CONFIG.MARGEN).toFixed(2); 
    }

    // --- Fetch remoto con manejo de errores ---
    async function fetchAlm() {
      try {
        const fd = new FormData(); 
        fd.append('op','obtenerAlmacen');
        const r = await fetch(API_URL,{method:'POST',body:fd});
        const j = await r.json();
        if(j.status === 'success') {
          logDebug('Almacén obtenido con éxito');
          return j.data;
        }
        throw new Error(j.message || 'Error desconocido');
      } catch(e) {
        logDebug(`Error al obtener almacén: ${e.message}`);
        showNot('Error al obtener almacén', true);
        return []; 
      }
    }
    
    async function fetchRec() {
      try {
        const fd = new FormData(); 
        fd.append('op','obtenerCocina');
        const r = await fetch(API_URL,{method:'POST',body:fd});
        const j = await r.json();
        if(j.status === 'success') {
          logDebug('Recetas obtenidas con éxito');
          return j.data;
        }
        throw new Error(j.message || 'Error desconocido');
      } catch(e) {
        logDebug(`Error al obtener recetas: ${e.message}`);
        showNot('Error al obtener recetas', true);
        return []; 
      }
    }
    
    async function saveSale(sale) {
      try {
        const fd = new FormData();
        fd.append('op','guardarVentas');
        fd.append('venta',JSON.stringify(sale));
        fd.append('metodoPago',sale.metodoPago);
        const r = await fetch(API_URL,{method:'POST',body:fd});
        const j = await r.json();
        if(j.status === 'success') {
          logDebug('Venta guardada con éxito');
          return true;
        }
        throw new Error(j.message || 'Error al guardar venta');
      } catch(e) {
        logDebug(`Error al guardar venta: ${e.message}`);
        showNot('Error al guardar venta', true);
        return false; 
      }
    }

    // --- Render dinámico mejorado ---
    function setupCats() {
      const cats = ['Todas'];
      state.products.forEach(p=>{
        if(p.categoria && !cats.includes(p.categoria)) cats.push(p.categoria);
      });
      window.categoriesJson = cats.map(c=>({name:c,filter:c==='Todas'?null:c}));
    }
    
    function renderCats() {
      const m = document.getElementById('categoryMenu');
      m.innerHTML = '';
      window.categoriesJson.forEach(c=>{
        m.innerHTML += `<button onclick="filtrarCat('${c.name}')" class="category-btn${c.name===state.currentCategory?' active':''}">${c.name}</button>`;
      });
    }
    
    function renderThumbnails() {
      const l = document.getElementById('thumbList');
      l.innerHTML = '';
      const list = state.currentCategory==='Todas'? state.products: state.products.filter(p=>p.categoria===state.currentCategory);
      
      if(!list.length){
        l.innerHTML = `<div class="empty-state"><i class="fas fa-box-open"></i><h3>No hay productos</h3></div>`;
        return;
      }
      
      list.forEach((p,i)=>{
        l.innerHTML += `
          <li onclick="selectProd(${i})">
            <img src="${p.imagen}" alt="${p.nombre}" >
            <div class="product-info">
              <div class="product-name">${p.nombre}</div>
              <div class="product-price">$${p.precio.toFixed(2)}</div>
            </div>
          </li>`;
      });
    }
    
    function renderMesas() {
      const bar = document.getElementById('mesaBar');
      bar.innerHTML = '';
      state.mesas.forEach(m=>{
        const cnt = m.cuentas.flatMap(c=>c.pedidos.map(x=>x.cantidad)).reduce((a,b)=>a+b,0);
        bar.innerHTML += `
          <button onclick="abrirMesa(${m.id})" class="mesa-btn${m.id===state.currentMesa?' selected':''}${cnt>0?' ocupada':''}">
            ${m.name} (${cnt} pz)
          </button>`;
      });
    }
    
    function updateTotals() {
      if (state.inspectAcc === null) return;
      
      const mesa = state.mesas[state.inspectAcc];
      if (!mesa) return;
      
      // Calcular total para toda la mesa
      const mesaTotal = mesa.cuentas.reduce((acc, cuenta) => {
        return acc + cuenta.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      }, 0);
      
      document.getElementById('mesaTotal').textContent = `$${mesaTotal.toFixed(2)}`;
      document.getElementById('grandTotal').textContent = `$${mesaTotal.toFixed(2)}`;
      
      // Aplicar animación de actualización
      document.getElementById('mesaTotal').classList.add('price-update');
      document.getElementById('grandTotal').classList.add('price-update');
      setTimeout(() => {
        document.getElementById('mesaTotal').classList.remove('price-update');
        document.getElementById('grandTotal').classList.remove('price-update');
      }, 1000);
    }

    // --- Funciones UI mejoradas ---
    function filtrarCat(cat) {
      state.currentCategory = cat; 
      renderCats(); 
      renderThumbnails();
      logDebug(`Categoría filtrada: ${cat}`);
    }
    
    function selectProd(i) {
      state.currentProd = i; 
      const p = state.products[i];
      document.getElementById('mainImage').src = p.imagen;
      document.getElementById('productName').textContent = p.nombre;
      document.getElementById('productPrice').textContent = `$${p.precio.toFixed(2)}`;
      document.getElementById('productDesc').textContent = p.descripcion || '';
      state.currentQty = 1; 
      document.getElementById('quantityDisplay').textContent = 1;
      logDebug(`Producto seleccionado: ${p.nombre}`);
    }
    
    function cambiarCantidad(d) {
      state.currentQty = Math.max(1, state.currentQty + d);
      document.getElementById('quantityDisplay').textContent = state.currentQty;
      logDebug(`Cantidad cambiada a: ${state.currentQty}`);
    }
    
    function añadirAlPedido() {
      if(state.inspectAcc === null || state.inspectSub === null) {
        showNot('Abre una cuenta primero', true);
        logDebug('Intento de añadir sin cuenta abierta');
        return;
      }
      addToSub(state.inspectAcc, state.inspectSub);
    }
    
    // Función clave: ahora usa índices de array en lugar de IDs
    function abrirMesa(id) {
      const index = findMesaIndexById(id);
      if (index === -1) return;
      
      state.currentMesa = id;
      state.inspectAcc = index;
      renderMesas();
      openAccounts(index);
      logDebug(`Mesa abierta: ${id} (índice: ${index})`);
    }
    
    function addToSub(mi, ci) {
      if(state.currentProd < 0) {
        showNot('Selecciona un producto', true);
        logDebug('Intento de añadir sin producto seleccionado');
        return;
      }
      
      // Verificar que tenemos índices válidos
      if (mi === null || mi === undefined || ci === null || ci === undefined) {
        showNot('Error: Mesa no seleccionada', true);
        logDebug(`Índices inválidos: mi=${mi}, ci=${ci}`);
        return;
      }
      
      if (!state.mesas[mi]) {
        showNot(`Error: Mesa en índice ${mi} no encontrada`, true);
        logDebug(`Mesa en índice ${mi} no encontrada`);
        return;
      }
      
      const sub = state.mesas[mi].cuentas[ci];
      const p = state.products[state.currentProd];
      
      const ex = sub.pedidos.find(x=>x.codigo===p.codigo);
      
      if(ex) {
        ex.cantidad += state.currentQty;
        logDebug(`Producto existente actualizado: ${p.nombre} +${state.currentQty}`);
      } else {
        sub.pedidos.push({
          codigo: p.codigo,
          nombre: p.nombre,
          precio: p.precio,
          cantidad: state.currentQty
        });
        logDebug(`Nuevo producto añadido: ${p.nombre} x${state.currentQty}`);
      }
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      showNot(`${state.currentQty}× ${p.nombre} añadido`);
      openAccounts(mi);
      state.currentQty = 1; 
      document.getElementById('quantityDisplay').textContent = 1;
      updateTotals();
    }
    
    function openAccounts(mi) {
      state.inspectAcc = mi; 
      state.inspectSub = null;
      
      const m = state.mesas[mi];
      if(!m) {
        showNot(`Error: Mesa en índice ${mi} no encontrada`, true);
        logDebug(`Mesa en índice ${mi} no encontrada en openAccounts`);
        return;
      }
      
      const totalCount = m.cuentas.flatMap(c => c.pedidos.map(x => x.cantidad)).reduce((a,b) => a+b, 0);
      document.getElementById('mesaNumber').textContent = `${m.name} (${totalCount} pz)`;
      
      const list = document.getElementById('accountsList'); 
      list.innerHTML = '';
      
      if(!m.cuentas.length){
        list.innerHTML = `<div class="empty-state"><i class="fas fa-receipt"></i><h3>No hay cuentas</h3></div>`;
      } else {
        m.cuentas.forEach((c,i)=>{
          const cnt = c.pedidos.reduce((a,x) => a + x.cantidad, 0);
          const val = c.pedidos.reduce((a,x) => a + (x.precio * x.cantidad), 0);
          list.innerHTML += `
            <div class="subcuenta">
              <div>${c.nombre} - ${cnt} pz ($${val.toFixed(2)})</div>
              <div class="btnCobro">
                <button class="boton-icono info" onclick="addToSub(${mi},${i})"><i class="fas fa-plus"></i></button>
                <button class="boton-icono warning" onclick="abrirEdicion(${mi},${i})"><i class="fas fa-pen-to-square"></i></button>
                <button class="boton-icono success" onclick="openPay(${mi},${i})"><i class="fas fa-cash-register"></i></button>
              </div>
            </div>`;
        });
      }
      
      document.getElementById('checkoutPanel').style.display = 'block';
      updateTotals();
    }

    function crearMesa() {
      const next = state.mesas.length ? Math.max(...state.mesas.map(m=>m.id)) + 1 : 1;
      state.mesas.push({
        id: next,
        name: `Mesa ${next}`,
        cuentas: [{nombre:'Cuenta 1', pedidos:[]}]
      });
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      renderMesas(); 
      
      // Abrir la nueva mesa por su ID
      abrirMesa(next);
      
      showNot(`Mesa ${next} creada`);
      logDebug(`Nueva mesa creada: ${next}`);
    }
    
    function verHistorial() {
      const ul = document.getElementById('history-list'); 
      ul.innerHTML = '';
      
      if(!state.salesHistory.length){
        ul.innerHTML = `<div class="empty-state"><i class="fas fa-history"></i><h3>No hay historial</h3></div>`;
      } else {
        state.salesHistory.forEach(s => {
          ul.innerHTML += `
            <li class="subcuenta">
              <div>${s.mesa} - ${s.cuenta} <small>${new Date(s.fecha).toLocaleString()}</small></div>
              <div>$${s.total.toFixed(2)} - ${s.metodoPago}</div>
            </li>`;
        });
      }
      
      document.getElementById('modal-history').classList.add('active');
      logDebug('Historial de ventas abierto');
    }
    
    function cerrarHistorial() { 
      document.getElementById('modal-history').classList.remove('active');
      logDebug('Historial de ventas cerrado');
    }
    
    async function refrescarProductos() {
      const rec = await fetchRec();
      if(!rec.length) return;
      
      const alm = loadJSON(CONFIG.STORAGE_KEYS.ALMACEN);
      state.products = rec.map(r => ({
        codigo: r.codigo,
        nombre: r.nombre,
        descripcion: r.descripcion || '',
        categoria: r.categoria || '',
        imagen: r.imagen || 'https://via.placeholder.com/300x200?text=No+img',
        precio: aplicarMargen(calcularCosto(r.ingredientes, alm)),
        ingredientes: r.ingredientes
      }));
      
      saveJSON(CONFIG.STORAGE_KEYS.PRODUCTS, state.products);
      setupCats(); 
      renderCats(); 
      renderThumbnails();
      
      if(state.products.length) selectProd(0);
      showNot('Productos actualizados');
      logDebug('Productos actualizados');
    }
    
    function nuevaCuenta() {
      if (state.inspectAcc === null) {
        showNot('Selecciona una mesa primero', true);
        return;
      }
      
      const m = state.mesas[state.inspectAcc];
      const num = m.cuentas.length + 1;
      m.cuentas.push({nombre: `Cuenta ${num}`, pedidos: []});
      
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      openAccounts(state.inspectAcc);
      showNot(`Cuenta ${num} creada`);
      logDebug(`Nueva cuenta creada: ${num}`);
    }
    
    function cobrarTodo() { 
      if (state.inspectAcc === null) {
        showNot('Selecciona una mesa primero', true);
        return;
      }
      openPay(state.inspectAcc, 'all'); 
      logDebug('Iniciando cobro de toda la mesa');
    }
    
    function cerrarPanel() { 
      document.getElementById('checkoutPanel').style.display = 'none';
      state.inspectAcc = null;
      state.inspectSub = null;
      logDebug('Panel de cobro cerrado');
    }
    
    function openPay(mi,ci) {
      state.inspectAcc = mi; 
      state.inspectSub = ci;
      
      let items = [], total = 0, title = '';
      
      if(ci === 'all'){
        title = 'Cobrar Mesa Completa';
        state.mesas[mi].cuentas.forEach(c => {
          items = items.concat(c.pedidos);
          total += c.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        });
      } else {
        const c = state.mesas[mi].cuentas[ci];
        title = `Cobrar ${c.nombre}`;
        items = c.pedidos.slice();
        total = items.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
      }
      
      total = +total.toFixed(2);
      
      let html = `<h3><i class="fas fa-cash-register"></i> ${title}</h3><ul class="payment-list">`;
      
      if(!items.length) {
        html += '<li class="empty-state">No hay productos</li>';
      } else {
        items.forEach(i => {
          html += `
            <li class="subcuenta">
              <div>${i.nombre} × ${i.cantidad}</div>
              <div>$${(i.precio * i.cantidad).toFixed(2)}</div>
            </li>`;
        });
      }
      
      html += `</ul>
        <div class="payment-total">Total: $${total.toFixed(2)}</div>
        <div class="payment-form">
          <label>Método de Pago:</label>
          <select id="payMethod">
            <option>Efectivo</option>
            <option>Tarjeta Crédito</option>
            <option>Tarjeta Débito</option>
            <option>Transferencia</option>
          </select>
          <label>Monto Recibido:</label>
          <input type="number" min="0" step="0.01" value="${total}" 
                 oninput="actualizarCambio(this.value, ${total})" 
                 id="receivedAmount"/>
          <div id="payChange">Cambio: $0.00</div>
        </div>
        <div class="actions">
          <button onclick="confirmPay()" class="btn-add">Confirmar Pago</button>
          <button onclick="closePay()" class="btn-secondary">Cancelar</button>
        </div>`;
      
      document.getElementById('payPanel').innerHTML = html;
      document.getElementById('modal-cobrar').classList.add('active');
      logDebug(`Panel de pago abierto para: ${title}`);
    }
    
    function actualizarCambio(recibido, total) {
      const recibidoNum = parseFloat(recibido) || 0;
      const cambio = recibidoNum - total;
      const cambioTexto = cambio >= 0 ? `$${cambio.toFixed(2)}` : `-$${Math.abs(cambio).toFixed(2)}`;
      
      document.getElementById('payChange').textContent = `Cambio: ${cambioTexto}`;
      document.getElementById('payChange').style.color = cambio >= 0 ? 'var(--success)' : 'var(--danger)';
      logDebug(`Cambio calculado: ${cambioTexto}`);
    }
    
    function closePay() { 
      document.getElementById('modal-cobrar').classList.remove('active');
      logDebug('Panel de pago cerrado');
    }
    
    async function confirmPay() {
      const metodo = document.getElementById('payMethod').value;
      const recibido = parseFloat(document.getElementById('receivedAmount').value) || 0;
      
      let items = [], total = 0, mesaName = '', cuentaName = '';
      
      if(state.inspectSub === 'all'){
        const m = state.mesas[state.inspectAcc]; 
        mesaName = m.name; 
        cuentaName = 'Mesa Completa';
        
        m.cuentas.forEach(c => {
          items = items.concat(c.pedidos.map(i => ({
            codigo: String(i.codigo),
            producto: i.nombre,
            cantidad: i.cantidad,
            total: +(i.precio * i.cantidad).toFixed(2)
          })));
          
          total += c.pedidos.reduce((sum, item) => sum + (item.precio * item.cantidad), 0);
        });
      } else {
        const m = state.mesas[state.inspectAcc];
        const c = m.cuentas[state.inspectSub];
        mesaName = m.name; 
        cuentaName = c.nombre;
        
        items = c.pedidos.map(i => ({
          codigo: String(i.codigo),
          producto: i.nombre,
          cantidad: i.cantidad,
          total: +(i.precio * i.cantidad).toFixed(2)
        }));
        
        total = items.reduce((sum, item) => sum + item.total, 0);
      }
      
      if(recibido < total) {
        showNot('Monto insuficiente', true);
        logDebug('Monto recibido insuficiente para completar el pago');
        return;
      }
      
      const sale = {
        fecha: new Date().toISOString(),
        metodoPago: metodo,
        items,
        mesa: mesaName,
        cuenta: cuentaName,
        total
      };
      
      if(await saveSale(sale)){
        // Limpiar pedidos después de cobrar
        if(state.inspectSub === 'all') {
          state.mesas[state.inspectAcc].cuentas.forEach(c => c.pedidos = []);
        } else {
          state.mesas[state.inspectAcc].cuentas[state.inspectSub].pedidos = [];
        }
        
        // Eliminar cuentas vacías
        state.mesas[state.inspectAcc].cuentas = state.mesas[state.inspectAcc].cuentas.filter(c => c.pedidos.length > 0);
        
        // Si no hay cuentas, crear una nueva vacía
        if(state.mesas[state.inspectAcc].cuentas.length === 0) {
          state.mesas[state.inspectAcc].cuentas.push({nombre:'Cuenta 1', pedidos:[]});
        }
        
        // Actualizar historial y guardar
        state.salesHistory.push(sale);
        saveJSON(CONFIG.STORAGE_KEYS.SALES, state.salesHistory);
        saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
        
        showNot(`Pago de $${sale.total.toFixed(2)} registrado`);
        logDebug(`Pago registrado: $${sale.total.toFixed(2)}`);
        
        // Actualizar UI
        renderMesas(); 
        closePay(); 
        openAccounts(state.inspectAcc);
      } else {
        showNot('Error al registrar pago', true);
      }
    }
    
    function abrirEdicion(mi,ci) {
      state.inspectAcc = mi; 
      state.inspectSub = ci;
      state.editList = JSON.parse(JSON.stringify(state.mesas[mi].cuentas[ci].pedidos));
      renderEdit();
      document.getElementById('modal-edit').classList.add('active');
      logDebug(`Editando cuenta: Mesa ${mi}, Cuenta ${ci}`);
    }
    
    function renderEdit() {
      const ul = document.getElementById('edit-list'); 
      ul.innerHTML = '';
      
      if(!state.editList.length){
        ul.innerHTML = `<li class="empty-state">No hay productos</li>`;
      } else {
        state.editList.forEach((x,i) => {
          ul.innerHTML += `
            <li class="subcuenta">
              <div>${x.nombre} × ${x.cantidad} = $${(x.precio * x.cantidad).toFixed(2)}</div>
              <button class="boton-icono danger" onclick="removerItem(${i})"><i class="fas fa-trash"></i></button>
            </li>`;
        });
      }
    }
    
    function removerItem(i) { 
      state.editList.splice(i, 1); 
      renderEdit();
      logDebug('Ítem eliminado de la edición');
    }
    
    function cancelarEdicion() { 
      document.getElementById('modal-edit').classList.remove('active');
      logDebug('Edición cancelada');
    }
    
    function guardarEdicion() {
      state.mesas[state.inspectAcc].cuentas[state.inspectSub].pedidos = state.editList;
      saveJSON(CONFIG.STORAGE_KEYS.MESAS, state.mesas);
      document.getElementById('modal-edit').classList.remove('active');
      openAccounts(state.inspectAcc);
      showNot('Pedido actualizado');
      logDebug('Cambios guardados en el pedido');
    }

    // --- Inicio mejorado ---
    (async() => {
      // Cargar datos iniciales
      state.mesas = loadJSON(CONFIG.STORAGE_KEYS.MESAS);
      state.salesHistory = loadJSON(CONFIG.STORAGE_KEYS.SALES) || [];
      state.products = loadJSON(CONFIG.STORAGE_KEYS.PRODUCTS) || [];
      
      // Si no hay mesas, crear una por defecto
      if(!state.mesas.length) {
        crearMesa();
      } else {
        // Seleccionar la primera mesa al inicio
        if (state.mesas.length > 0) {
          abrirMesa(state.mesas[0].id);
        }
      }
      
      // Configurar UI
      setupCats(); 
      renderCats(); 
      renderThumbnails(); 
      renderMesas();
      
      // Seleccionar primer producto si existe
      if(state.products.length) selectProd(0);
      
      logDebug('Sistema inicializado correctamente');
    })();
  </script>
</body>
</html>
