<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestor Cocina — Preparación (CRUD)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg:#f6f7fb; --panel:#fff; --accent:#4a4e69; --muted:#6c757d;
      --radius:10px; --border:#e6e9ef; --shadow:0 6px 20px rgba(0,0,0,0.06);
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Roboto,"Helvetica Neue",sans-serif}
    body{margin:0;background:var(--bg);color:#111}
    .wrap{max-width:980px;margin:24px auto;padding:20px}
    header{display:flex;gap:12px;align-items:center}
    header h1{font-size:1.15rem;color:var(--accent);margin:0}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{background:var(--panel);border:1px solid var(--border);padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:14px;margin-top:16px}
    .panel{background:var(--panel);border-radius:var(--radius);padding:12px;border:1px solid var(--border);box-shadow:var(--shadow)}
    .list-item{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:8px;border:1px solid transparent;cursor:pointer}
    .list-item:hover{border-color:#eee;background:#fbfbff}
    .list-meta{flex:1}
    .list-title{font-weight:700}
    .small{font-size:0.85rem;color:var(--muted);margin-top:4px}
    .controls{display:flex;gap:6px}
    input,textarea,select{width:100%;padding:8px;border:1px solid var(--border);border-radius:8px;background:#fff}
    label{font-weight:600;font-size:0.88rem;margin-top:8px;display:block}
    form .row{display:flex;gap:8px}
    .row .col{flex:1}
    .footer-actions{display:flex;gap:8px;align-items:center;margin-top:10px}
    .notice{position:fixed;right:18px;bottom:18px;padding:12px 16px;border-radius:10px;background:#fff;border:1px solid var(--border);box-shadow:var(--shadow);display:none}
    .notice.ok{border-left:4px solid #28a745}
    .notice.err{border-left:4px solid #dc3545}
    .ingredientes .row { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
    .ingredientes .row input { flex:1; }
    .ingredientes .row button { flex:0; padding:6px 10px; }
    .card { display:flex; flex-direction:column; border-radius:8px; overflow:hidden; border:1px solid var(--border); background:#fff; }
    .card img { width:100%; height:220px; object-fit:cover; }
    .card h3 { margin:8px; font-size:1.1rem; }
    .card .actions { margin-top:auto; display:flex; gap:6px; padding:8px; }
    .cards { display:block; } 
    @media (max-width:860px){ .layout{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1><i class="fas fa-utensils"></i> Gestión Cocina — Preparación</h1>
      <div class="top-actions">
        <button class="btn" id="btn-refresh"><i class="fas fa-sync"></i> Actualizar</button>
        <button class="btn primary" id="btn-new"><i class="fas fa-plus"></i> Nueva receta</button>
      </div>
    </header>

    <div class="layout">
      <!-- Lista -->
      <div class="panel" aria-labelledby="lista-cocina">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
          <input id="q" placeholder="Buscar por nombre, código o categoría" style="flex:1;padding:8px;border:1px solid var(--border);border-radius:8px"/>
          <select id="filter-cat" style="width:160px;padding:8px;border:1px solid var(--border);border-radius:8px">
            <option value="">Todas</option>
          </select>
        </div>

        <div id="lista" style="display:grid;gap:8px;max-height:68vh;overflow:auto"></div>
      </div>

      <!-- Formulario (la selección SOLO rellena este formulario) -->
      <div class="panel" aria-labelledby="form-cocina">
        <form id="form-cocina">
          <label for="codigo">Código *</label>
          <input id="codigo" name="codigo" required />

          <label for="nombre">Nombre *</label>
          <input id="nombre" name="nombre" required />

          <label for="imagen">URL Imagen</label>
          <input id="imagen" name="imagen" placeholder="https://..." />
          <img id="preview-imagen" src="" alt="Vista previa" style="width:100%;max-height:180px;object-fit:cover;margin-top:8px;display:none"/>

          <label for="categoria">Categoría</label>
          <input id="categoria" name="categoria" placeholder="Ej: Entradas, Principal" />

          <label for="preparacion">Preparación</label>
          <textarea id="preparacion" name="preparacion" rows="5" placeholder="Describe la preparación (pasos, tiempos, notas)"></textarea>

          <h3 style="margin-top:12px">Ingredientes</h3>
          <div id="ing-list" class="ingredientes"></div>
          <div style="margin-top:8px"><button type="button" id="add-ing">+ Agregar ingrediente</button></div>

          <div class="footer-actions">
            <button type="submit" class="btn primary" id="btn-save">Guardar</button>
            <button type="button" class="btn" id="btn-clear">Limpiar</button>
            <button type="button" class="btn" id="btn-delete" style="margin-left:auto;display:none"><i class="fas fa-trash"></i> Eliminar</button>
          </div>
        </form>

        <!-- Nota: la vista grande se dejó vacía a propósito -->
        <div id="vista-grande" style="margin-top:18px;">
          <div id="recetas-cards" class="cards"></div>
        </div>
      </div>
    </div>

    <div id="notice" class="notice"></div>
  </div>

  <script>
    // URL de tu Google Apps Script (reemplaza si hace falta)
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';

    // Estado local
    let recetas = [];
    let selectedCodigo = null; // receta seleccionada (aún la guardamos por si la necesitas)

    // único contenedor de tarjetas (se mantiene pero lo dejamos vacío)
    const cardsContainer = (function(){
      let el = document.getElementById('recetas-cards');
      if (!el) {
        const parent = document.getElementById('vista-grande') || document.body;
        el = document.createElement('div');
        el.id = 'recetas-cards';
        el.className = 'cards';
        parent.appendChild(el);
      }
      return el;
    })();

    // Helper: POST FormData con op
    async function apiFetch(op, payload = {}) {
      const fd = new FormData();
      fd.append('op', op);
      Object.entries(payload || {}).forEach(([k, v]) => fd.append(k, v === undefined || v === null ? '' : v.toString()));
      const res = await fetch(GAS_URL, { method: 'POST', body: fd });
      const js = await res.json();
      if (js.status === 'error') throw new Error(js.message || 'Error servidor');
      return js.data !== undefined ? js.data : js;
    }

    // Notificaciones
    function notice(msg, ok = true) {
      const el = document.getElementById('notice');
      el.textContent = msg;
      el.className = 'notice ' + (ok ? 'ok' : 'err');
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    // Preview imagen
    document.getElementById('imagen').addEventListener('input', function(){
      const url = this.value.trim();
      const img = document.getElementById('preview-imagen');
      if (url) { img.src = url; img.style.display = 'block'; } else { img.style.display = 'none'; }
    });

    // Ingredientes: filas con campos libres (codigo, nombre, cantidad, unidad)
    function addIngrediente(obj = {}) {
      const container = document.getElementById('ing-list');
      const div = document.createElement('div');
      div.className = 'row';
      div.innerHTML = `
        <input type="text" name="ing_codigo" placeholder="Código (opcional)" value="${escapeHtml(obj.codigo||'')}" />
        <input type="text" name="ing_nombre" placeholder="Nombre ingrediente" value="${escapeHtml(obj.nombre||'')}" />
        <input type="text" name="ing_cantidad" placeholder="Cantidad" value="${escapeHtml(obj.cantidad||'')}" style="width:100px" />
        <input type="text" name="ing_unidad" placeholder="Unidad (g, ml, pz...)" value="${escapeHtml(obj.unidad||'')}" style="width:90px" />
        <button type="button" aria-label="Eliminar ingrediente">✕</button>
      `;
      div.querySelector('button').onclick = () => div.remove();
      container.appendChild(div);
    }

    document.getElementById('add-ing').onclick = () => addIngrediente();

    // Guardar receta (insert/update)
    document.getElementById('form-cocina').onsubmit = async function(e) {
      e.preventDefault();
      const codigo = document.getElementById('codigo').value.trim();
      const nombre = document.getElementById('nombre').value.trim();
      if (!codigo || !nombre) { notice('Código y nombre obligatorios', false); return; }

      const imagen = document.getElementById('imagen').value.trim();
      const categoria = document.getElementById('categoria').value.trim();
      const preparacion = document.getElementById('preparacion').value.trim();

      // recoger ingredientes
      const rows = Array.from(document.querySelectorAll('#ing-list .row'));
      const ingredientes = rows.map(r => ({
        codigo: r.querySelector('input[name="ing_codigo"]').value.trim(),
        nombre: r.querySelector('input[name="ing_nombre"]').value.trim(),
        cantidad: r.querySelector('input[name="ing_cantidad"]').value.trim(),
        unidad: r.querySelector('input[name="ing_unidad"]').value.trim()
      })).filter(i => i.nombre || i.codigo);

      // payload al GAS
      try {
        await apiFetch('guardarCocina', {
          codigo,
          nombre,
          ingredientes: JSON.stringify(ingredientes),
          imagen,
          categoria,
          preparacion
        });
        notice('Receta guardada', true);
        selectedCodigo = codigo; // mantener selección por si la necesitas
        resetForm();
        await loadRecetas();
      } catch (err) {
        notice('Error al guardar: ' + err.message, false);
      }
    };

    // Cargar recetas
    async function loadRecetas() {
      try {
        const data = await apiFetch('obtenerCocina');
        recetas = Array.isArray(data) ? data : [];
        if (selectedCodigo && !recetas.find(r => String(r.codigo) === String(selectedCodigo))) selectedCodigo = null;
        renderLista();
        // dejamos el contenedor grande vacío (el formulario es la vista principal)
        cardsContainer.innerHTML = '';
        setupCategorias();
      } catch (err) {
        recetas = [];
        renderLista();
        cardsContainer.innerHTML = '';
        notice('Error al cargar recetas: ' + err.message, false);
      }
    }

    // === NUEVA FUNCIÓN: poblar filtro de categorías ===
    function setupCategorias() {
      const sel = document.getElementById('filter-cat');
      if (!sel) return;
      const uniq = [...new Set(recetas.map(r => (r.categoria||'').toString().trim()).filter(Boolean))].sort();
      sel.innerHTML = '<option value="">Todas</option>' + uniq.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    }
    // ===================================================

    // Render lista lateral
    function renderLista() {
      const q = (document.getElementById('q')?.value || '').toLowerCase().trim();
      const cat = document.getElementById('filter-cat')?.value || '';
      const cont = document.getElementById('lista');
      if(!cont) return;
      const items = recetas.filter(r => {
        if (cat && (r.categoria||'') !== cat) return false;
        if (!q) return true;
        return (r.nombre||'').toLowerCase().includes(q) || (r.codigo||'').toString().toLowerCase().includes(q) || (r.categoria||'').toLowerCase().includes(q);
      }).sort((a,b) => (a.nombre||'').localeCompare(b.nombre||''));
      if (!items.length) { cont.innerHTML = '<div class="small" style="padding:12px;color:var(--muted)">Sin recetas</div>'; return; }
      cont.innerHTML = items.map(r => `
        <div class="list-item" data-codigo="${escapeAttr(r.codigo)}" onclick="verReceta('${escapeAttr(r.codigo)}')">
          <div class="list-meta">
            <div class="list-title">${escapeHtml(r.nombre||'')}</div>
            <div class="small">Código: ${escapeHtml(r.codigo||'')} · Cat: ${escapeHtml(r.categoria||'-')}</div>
            <div class="small" style="margin-top:6px">${(r.preparacion||'').toString().slice(0,120)}${(r.preparacion||'').length>120?'...':''}</div>
          </div>
          <div class="controls" onclick="event.stopPropagation()">
            <button class="btn" onclick="verReceta('${escapeAttr(r.codigo)}')"><i class="fas fa-eye"></i></button>
            <button class="btn" onclick="editarReceta('${escapeAttr(r.codigo)}')"><i class="fas fa-edit"></i></button>
          </div>
        </div>
      `).join('');
    }

    // Ver receta: SOLO rellena el formulario (no mostramos nada en la vista grande)
    window.verReceta = function(codigo) {
      const rc = recetas.find(r => String(r.codigo) === String(codigo));
      if (!rc) return notice('Receta no encontrada', false);
      selectedCodigo = codigo;
      populateForm(rc);
      document.getElementById('btn-delete').style.display = 'inline-block';
      document.getElementById('btn-save').textContent = 'Actualizar';
    };

    // Editar receta: rellena el formulario para editar
    window.editarReceta = function(codigo) {
      const rc = recetas.find(r => String(r.codigo) === String(codigo));
      if (!rc) return notice('Receta no encontrada', false);
      selectedCodigo = codigo;
      populateForm(rc);
      document.getElementById('codigo').readOnly = true;
      document.getElementById('btn-delete').style.display = 'inline-block';
      document.getElementById('btn-save').textContent = 'Actualizar';
    };

    function populateForm(rc) {
      document.getElementById('codigo').value = rc.codigo || '';
      document.getElementById('nombre').value = rc.nombre || '';
      document.getElementById('imagen').value = rc.imagen || '';
      const img = document.getElementById('preview-imagen');
      if (rc.imagen) { img.src = rc.imagen; img.style.display = 'block'; } else img.style.display = 'none';
      document.getElementById('categoria').value = rc.categoria || '';
      document.getElementById('preparacion').value = rc.preparacion || '';
      // ingredientes
      const list = document.getElementById('ing-list');
      list.innerHTML = '';
      (rc.ingredientes || []).forEach(i => {
        addIngrediente({
          codigo: i.codigo || i.id || '',
          nombre: i.nombre || i.producto || '',
          cantidad: i.cantidad || i.qty || '',
          unidad: i.unidad || ''
        });
      });
    }

    // Limpiar / nuevo
    document.getElementById('btn-new').onclick = function(){
      resetForm();
      document.getElementById('codigo').focus();
    };
    document.getElementById('btn-clear').onclick = resetForm;

    function resetForm() {
      const f = document.getElementById('form-cocina');
      f.reset();
      document.getElementById('preview-imagen').style.display = 'none';
      document.getElementById('ing-list').innerHTML = '';
      document.getElementById('codigo').readOnly = false;
      document.getElementById('btn-delete').style.display = 'none';
      document.getElementById('btn-save').textContent = 'Guardar';
      selectedCodigo = null;
      // dejamos la vista grande vacía
      cardsContainer.innerHTML = '';
    }

    // Eliminar receta
    async function eliminarReceta(codigo) {
      if (!confirm('¿Eliminar receta ' + codigo + '?')) return;
      try {
        await apiFetch('eliminarCocina', { codigo });
        notice('Receta eliminada', true);
        if (String(selectedCodigo) === String(codigo)) selectedCodigo = null;
        resetForm();
        await loadRecetas();
      } catch (err) {
        notice('Error al eliminar: ' + err.message, false);
      }
    }

    // Botón eliminar del formulario
    document.getElementById('btn-delete').onclick = function(){
      const codigo = document.getElementById('codigo').value.trim();
      if (!codigo) return notice('Código requerido', false);
      eliminarReceta(codigo);
    };

    // Buscar / filtros
    document.getElementById('q').addEventListener('input', renderLista);
    document.getElementById('filter-cat').addEventListener('change', () => { renderLista(); });

    // Refresh
    document.getElementById('btn-refresh').onclick = loadRecetas;

    // Inicializar
    (async function init(){
      await loadRecetas();
    })();

    // utilidades de escape simples
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
    function escapeAttr(s){ return (s||'').toString().replaceAll("'", "\\'").replaceAll('"','\\"'); }
  </script>
</body>
</html>
