<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <title>Sistema de Gesti√≥n Mejorado</title>
  <style>
    *{ 
      margin: auto;
      border: none;
      box-sizing: border-box; margin: 0; padding: 0; 
    }
  
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 1rem;
      padding-bottom: calc(60px + 1rem);
    }
  
    /* NAVEGACI√ìN */
    nav.top-nav {
      display: flex;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    nav.top-nav button {
      flex: 1;
      padding: .75rem 0;
      border: none;
      background: #3f51b5;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    nav.top-nav button:not(.active) { 
      opacity: .6;
      background: #5c6bc0;
    }
    nav.top-nav button:hover {
      background: #303f9f;
      opacity: 1;
    }
    .section { display: none; }
    .section.active { display: block; }
  
    /* GRID DE TARJETAS */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 15px;
    }

    /* TARJETA */
    .card {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.05);
      overflow: hidden;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }

    /* Cabecera */
    .card-header {
      background: #3f51b5;
      color: white;
      padding: 0.9rem 1.2rem;
      font-size: 0.9rem;
      font-weight: bold;
      border-bottom: 1px solid #ddd;
    }
    
    .seccion1 {
      padding: 15px;
    }
    
    .seccion1 p {
      font-size: 0.9rem;
      margin: 5px 0;
    }
    
    .div2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      margin-bottom: 10px;
      gap: 8px;
      border-bottom: 1px solid #f0f0f0;
      padding-bottom: 10px;
    }
    
    .div2 input, .div2 select {
      width: 100%;
      font-size: 1rem;
      text-align: center;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    .mutinput {
      text-align: center;
      text-align-last: center;
      -moz-text-align-last: center;
      width: 100%;
      font-size: 1rem;
      background: none;
      color: #3f51b5;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    .div3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .div3 input, .div3 select {
      text-align: center;
      font-size: 1rem;
      width: 100%;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    input {
      text-align: center;
      font-size: 1rem;
      width: 100%;
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    .name2 {
      color: #e91e63;
      font-weight: bold;
    }
    
    /* BOT√ìN AGREGAR */
    .btn-add {
      display: block;
      width: 100%;
      padding: 1rem 0;
      margin-bottom: 1.2rem;
      background: #3f51b5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .btn-add:hover { 
      background: #303f9f;
      opacity: 1; 
    }
    
    /* FORMULARIO VENTAS */
    .form-panel {
      background: #fff;
      border-radius: 10px;
      padding: 1.2rem;
      margin-bottom: 1.2rem;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }
    
    .item-row {
      margin-bottom: 0.8rem;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      align-items: center;
    }
    
    .item-row button { 
      flex: 0 0 auto; 
      padding: .5rem .8rem; 
    }
    
    /* TICKETS VENTAS */
    #tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1rem;
    }
    
    .ticket-card {
      background: #fff;
      border-radius: 10px;
      padding: 1.2rem;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
      display: flex;
      flex-direction: column;
      transition: all 0.3s ease;
    }
    
    .ticket-card:hover {
      box-shadow: 0 6px 12px rgba(0,0,0,0.1);
    }
    
    .ticket-header { 
      font-weight: bold; 
      margin-bottom: .6rem;
      color: #3f51b5;
    }
    
    .ticket-method,
    .ticket-footer { margin: .6rem 0; }
    
    .ticket-item { 
      margin-left: 1.2rem; 
      font-size: 0.95rem;
      padding: 3px 0;
    }
    
    /* FOOTER RESUMEN */
    footer.payment-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 70px;
      background: #3f51b5;
      color: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -4px 8px rgba(0,0,0,0.15);
      font-size: 1rem;
      z-index: 100;
    }
    
    footer.payment-summary div span {
      display: block;
      font-weight: bold;
      margin-top: .3rem;
      font-size: 1.1rem;
    }
    
    /* PANEL DE ESTAD√çSTICAS */
    .top-stats {
      position: sticky;
      top: 1rem;
      z-index: 90;      
      display: flex;
      justify-content: space-around;
      background: #fff;
      padding: .8rem 0;
      margin-bottom: 1.2rem;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.05);
    }
    
    .top-stats div {
      text-align: center;
      font-size: 0.95rem;
      padding: 0 10px;
    }
    
    .top-stats i {
      margin-bottom: .3rem;
      display: block;
      font-size: 1.4rem;
      color: #3f51b5;
    }
    
    .top-stats strong {
      display: block;
      margin-top: .3rem;
      font-size: 1.2rem;
      color: #e91e63;
    }
    
    /* BACKDROP */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    
    /* CONTENEDOR MODAL */
    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* CABECERA */
    .modal-header {
      padding: 1.2rem;
      border-bottom: 1px solid #e0e0e0;
      font-size: 1.2rem;
      font-weight: bold;
      color: #3f51b5;
      background: #f5f7ff;
    }
    
    /* CUERPO */
    .modal-body {
      padding: 1.5rem;
      font-size: 1rem;
      color: #555;
      line-height: 1.6;
    }
    
    /* PIE */
    .modal-footer {
      padding: 1rem;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 0.8rem;
      background: #f9f9f9;
    }
    
    /* BOTONES EN PIE DE MODAL */
    .modal-footer button {
      padding: 0.7rem 1.3rem;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .modal-footer button:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }
    
    /* BOT√ìN DE CONFIRMACI√ìN */
    .modal-footer .btn-primary {
      background: #3f51b5;
      color: #fff;
    }
    
    /* BOT√ìN DE CANCELAR / PELIGRO */
    .modal-footer .btn-danger {
      background: #f44336;
      color: #fff;
    }
    
    .btnNormal {
      padding: 8px 12px;
      border-radius: 8px;
      background: #3f51b5;
      color: #fff;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .btnNormal:hover {
      background: #303f9f;
      transform: translateY(-2px);
    }
    
    .btnNormal.delete {
      background: #f44336;
    }
    
    .btnNormal.delete:hover {
      background: #d32f2f;
    }
    
    .hidden { display: none; }
    
    .dividirEn2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    
    .validation-error {
      border: 2px solid #f44336 !important;
      background-color: #ffebee;
    }
    
    .validation-message {
      color: #f44336;
      font-size: 0.85rem;
      margin-top: 5px;
      display: block;
    }
    
    .status-low {
      color: #f44336;
      font-weight: bold;
    }
    
    .status-medium {
      color: #ff9800;
      font-weight: bold;
    }
    
    .status-good {
      color: #4caf50;
      font-weight: bold;
    }
    
    .status-excess {
      color: #2196f3;
      font-weight: bold;
    }
    
    h2 {
      color: #3f51b5;
      margin-bottom: 1.2rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e0e0e0;
    }
    
    h3 {
      color: #5c6bc0;
      margin: 1rem 0;
    }
    
    .ingredient-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .ingredient-row input, .ingredient-row select {
      padding: 8px;
      border: 1px solid #e0e0e0;
      border-radius: 5px;
    }
    
    .ingredient-actions {
      display: flex;
      justify-content: center;
    }
    
    .stock-alert {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 10px;
      margin: 10px 0;
      border-radius: 0 5px 5px 0;
      font-size: 0.9rem;
    }
    
    .product-in-use {
      background-color: #fff8e1;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .product-in-use ul {
      margin: 5px 0 0 20px;
    }
    
    .product-in-use li {
      margin-bottom: 3px;
    }
    
    .inactive-product {
      opacity: 0.6;
      text-decoration: line-through;
    }
  </style>
</head>
<body>

  <!-- MODAL REUTILIZABLE -->
  <div id="modal-backdrop" class="modal-backdrop" style="display:none;">
    <div class="modal">
      <div id="modal-header" class="modal-header"></div>
      <div id="modal-body" class="modal-body"></div>
      <div id="modal-footer" class="modal-footer"></div>
    </div>
  </div>

  <!-- ESTAD√çSTICAS -->
  <div class="top-stats">
    <div><i class="fa-solid fa-warehouse"></i> Inventario<br><strong id="stat-inventory">0.00</strong></div>
    <div><i class="fa-solid fa-cart-shopping"></i> Compras<br><strong id="stat-purchases">0.00</strong></div>
    <div><i class="fa-solid fa-truck-moving"></i> Reposici√≥n<br><strong id="stat-restock">0.00</strong></div>
  </div>

  <!-- NAVEGACI√ìN -->
  <nav class="top-nav">
    <button data-sec="stock" class="active" onclick="cambiarSeccion('stock')">Stock</button>
    <button data-sec="compras" onclick="cambiarSeccion('compras')">Compras</button>
    <button data-sec="ventas" onclick="cambiarSeccion('ventas')">Ventas</button>
    <button data-sec="recetas" onclick="cambiarSeccion('recetas')">Recetas</button>
  </nav>

  <!-- STOCK -->
  <section id="stock" class="section active">
    <h2>Stock de Productos</h2>
    <button class="btn-add" onclick="addNewProducto()">‚ûï Nuevo Producto</button>
    <div id="stock-grid" class="card-grid"></div>
  </section>

  <!-- COMPRAS -->
  <section id="compras" class="section">
    <h2>Historial de Compras</h2>
    <div id="compras-grid" class="card-grid"></div>
  </section>

  <!-- VENTAS -->
  <section id="ventas" class="section">
    <h2>Gesti√≥n de Ventas</h2>
    <div class="form-panel">
      <h3 id="form-title">Nueva Venta</h3>
      <input type="hidden" id="form-id">
      
      <div class="div2">
        <input class="mutinput" type="date" id="form-fecha">
        <select class="mutinput" id="form-pago">
          <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
        </select>
      </div>
      
      <div id="items-container"></div>
      <button id="btn-add-item" class="btn-add" onclick="agregarItemVenta()">+ Agregar producto</button>

      <div class="div2">
        <button id="btn-save" class="btn-add" onclick="guardarVenta()">
          <i class="fa-solid fa-floppy-disk"></i> Guardar
        </button>
        <button id="btn-cancel" class="btn-add" onclick="resetForm()">Cancelar</button>
      </div>
    </div>
    <div id="tickets-grid" class="card-grid"></div>
  </section>

  <!-- RECETAS -->
  <section id="recetas" class="section">
    <h2>CRUD Recetas</h2>
    <div class="form-panel">
      <h3 id="form-receta-title">Nueva Receta</h3>
      <input type="hidden" id="form-receta-id">
      <div class="item-row dividirEn2">
        <div>
          <input id="receta-codigo" type="text" placeholder="Ej: R001">
          <span class="validation-message" id="codigo-error"></span>
        </div>
        <div>
          <input id="receta-nombre" type="text" placeholder="Nombre receta">
          <span class="validation-message" id="nombre-error"></span>
        </div>
      </div>
      <div class="item-row dividirEn2">
        <label>
          <select class="mutinput" id="receta-categoria" onclick="toggleNuevaCategoria()" onchange="toggleNuevaCategoria()"></select>
        </label>
        <label class="hidden" id="wrapper-receta-categoria-nueva">
          <input class="mutinput" id="receta-categoria-nueva" type="text" placeholder="Nueva categor√≠a">
          <span class="validation-message" id="categoria-error"></span>
        </label>
        <input id="receta-imagen" type="text" placeholder="http://...">
      </div>
      <h3>Ingredientes</h3>
      <div id="ingredientes-container"></div>
      <button id="agregar-ingrediente" class="btn-add" onclick="agregarFila()">+ Agregar ingrediente</button>
      <div class="div2">
        <button id="guardar-receta" class="btn-add" onclick="guardarReceta()">
          <i class="fa-solid fa-floppy-disk"></i> Guardar
        </button>
        <button class="btn-add" id="limpiar-form" onclick="limpiarForm()">
          Limpiar
        </button>
      </div>
      <div id="receta-validation-errors" class="validation-message"></div>
    </div>
    
    <div id="lista-recetas" class="card-grid"></div>
  </section>

  <footer class="payment-summary">
    <div>Efectivo<br><span id="sum-efectivo">0.00</span></div>
    <div>Transferencia<br><span id="sum-transferencia">0.00</span></div>
    <div>Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
    <div>Total<br><span id="sum-total">0.00</span></div>
  </footer>

<script>
  // CONSTANTES
  const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
  const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
  const MARGEN     = 2;
  const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };

  // ESTADO GLOBAL
  let almacenData = [], comprasData = [], ventData = [], cocData = [];
  let recetas = [], recetasData = [], categorias = [], productInfo = {}, editMode = false;

  // MODAL REUTILIZABLE
  const modal = {
    backdrop: document.getElementById('modal-backdrop'),
    header:   document.getElementById('modal-header'),
    body:     document.getElementById('modal-body'),
    footer:   document.getElementById('modal-footer'),
    show: ({ title = '', message = '', confirm = false }) => new Promise(res => {
      modal.header.textContent = title;
      modal.body.innerHTML   = message;
      modal.footer.innerHTML   = '';
      const btnOk = Object.assign(document.createElement('button'), { textContent: 'OK', className: 'btn-primary' });
      btnOk.onclick = () => (modal.backdrop.style.display = 'none', res(true));
      modal.footer.append(btnOk);
      if (confirm) {
        const btnCancel = Object.assign(document.createElement('button'), { textContent: 'Cancelar', className: 'btn-danger' });
        btnCancel.onclick = () => (modal.backdrop.style.display = 'none', res(false));
        modal.footer.append(btnCancel);
      }
      modal.backdrop.style.display = 'flex';
    })
  };
  const showAlert   = msg => modal.show({ title: '¬°Atenci√≥n!', message: msg });
  const showConfirm = msg => modal.show({ title: 'Confirma', message: msg, confirm: true });

  // UTILIDADES DE FETCH
  const callApi = params => {
    const url = new URL(API_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
    return fetch(url).then(r => r.json());
  };
  async function postOpNotify(op, params = {}, successTitle = '√âxito') {
    try {
      const data = await postOp(op, params);
      const msg = typeof data === 'string' ? data : data?.message ?? JSON.stringify(data);
      await modal.show({ title: successTitle, message: msg });
      return data;
    } catch (err) {
      const errMsg = err?.message ?? String(err);
      await modal.show({ title: 'Error', message: errMsg });
      throw err;
    }
  }
  const postOp = async (op, params = {}) => {
    const fd = new FormData(); fd.append('op', op);
    Object.entries(params).forEach(([k,v]) => fd.append(k,v));
    const res = await fetch(API_URL, { method: 'POST', body: fd });
    const json = await res.json();
    if (json.status === 'success') return json.data;
    else throw new Error(json.message);
  };

  // UTILIDADES DE UNIDAD
  const categoriaDe = u =>
    ['mg','g','kg'].includes(u) ? 'peso'
  : ['ml','l'].includes(u)    ? 'volumen'
  :                             'conteo';

  const humanizeComposite = (b, c) =>
    c === 'peso'
      ? ((kg => (kg ? kg+'kg ' : '') + ((b%1000)? (b%1000)+'g' : '') || '0g')(Math.trunc(b/1000)))
    : c === 'volumen'
      ? ((l => (l ? l+'l ' : '') + ((b%1000)? (b%1000)+'ml' : '') || '0ml')(Math.trunc(b/1000)))
    : `${b.toFixed(0)}pz`;

  // PRODUCT INFO
  function buildProductInfo() {
    productInfo = {};
    almacenData.forEach(it => {
      const uni = it.unidadDeMedida.trim().toLowerCase();
      const cat = categoriaDe(uni);
      const base = parseFloat(it.cantidad)*FACTORES[uni] || 1;
      productInfo[it.codigo] = {
        priceBase: parseFloat(it.precio)/base || 0,
        categoria:  cat,
        opcionesUnidad: CATEGORIAS[cat],
        name: it.name,
        active: it.active !== false // Por defecto activo
      };
    });
  }

  // RENDER STOCK
  function renderStockTable() {
    const grid = document.getElementById('stock-grid'); grid.innerHTML = '';
    const compMap = {}, usedMap = {};
    comprasData.forEach(c => compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo)===String(it.codigo));
      rec && rec.ingredientes.forEach(ing =>
        usedMap[ing.codigo] = (usedMap[ing.codigo]||0) + ing.cantidad*FACTORES[ing.unidad]*it.cantidad
      );
    }));
    almacenData.forEach(it => {
      const info    = productInfo[it.codigo];
      const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
      const bought  = compMap[it.codigo]||0;
      const used    = usedMap[it.codigo]||0;
      const remain  = bought - used;
      const pct     = recBase ? remain/recBase*100 : 0;
      const estado  = pct <= 30 ? 'status-low' 
                    : pct <= 50 ? 'status-medium'
                    : pct <=90 ? 'status-good'
                    :             'status-excess';
      const estadoText = pct <= 30 ? 'üî¥ Bajo'
                    : pct <= 50 ? 'üü† Medio'
                    : pct <=90 ? 'üü¢ Bueno'
                    :             'üîµ Excedente';
      const delta   = recBase - remain;
      const accion  = delta>0
        ? `Ordenar ${humanizeComposite(delta,info.categoria)}`
        : `Sobrante ${humanizeComposite(-delta,info.categoria)}`;
      const totalB = (info.priceBase*bought).toFixed(2);
      const totalU = (info.priceBase*used).toFixed(2);
      const totalR = (info.priceBase*remain).toFixed(2);
      
      // Verificar si el producto est√° en uso
      const enUso = buscarRecetasConProducto(it.codigo).length > 0;

      const card = document.createElement('div'); 
      card.className = 'card';
      if (!info.active) card.classList.add('inactive-product');
      
      card.innerHTML = `
        <div class="card-header">#${it.codigo} ${info.active ? '' : '(Inactivo)'}</div>
        <div class="seccion1">
          ${enUso ? `<div class="product-in-use">
            <strong>Este producto est√° en uso en recetas</strong>
          </div>` : ''}
          
          <label><input class="name2" type="text" id="name-${it.codigo}" value="${it.name||''}"></label>
          <label class="div2">Precio:<input type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></label>
          <label class="div2">Cant.inicial:<input type="number" id="cant-${it.codigo}" value="${it.cantidad||0}"></label>
          <label class="div2">Unidad:<select class="mutinput" id="unidad-${it.codigo}">
            ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`).join('')}
          </select></label>
          <label class="div2">Stock.rec.:<input type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}"></label>
          <label class="div2">Proveedor:<input type="text" id="prov-${it.codigo}" value="${it.proveedor||''}"></label>
          <hr>
          <p>Comprado: ${humanizeComposite(bought,info.categoria)} = $${totalB}</p>
          <p>Usado: ${humanizeComposite(used,info.categoria)} = $${totalU}</p>
          <p>Restante: ${humanizeComposite(remain,info.categoria)} = $${totalR}</p>
          <p>Estado: <span class="${estado}">${estadoText}</span></p>
          <p>Acci√≥n: ${accion}</p>
          <label class="div3">
            <strong>Comprar:</strong>
            <input type="number" id="buyqty-${it.codigo}" value="1" min="0" step="0.1">
            <select class="mutinput" id="buyunit-${it.codigo}">
              ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
            </select>
          </label>
          <div class="div3">
            <button class="btnNormal" onclick="buyProduct('${it.codigo}')"><i class="fa-solid fa-cart-shopping"></i></button>
            <button class="btnNormal" onclick="saveAlmacen('${it.codigo}')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button class="btnNormal delete" onclick="deleteAlmacen('${it.codigo}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      grid.append(card);
    });
  }

  // RENDER COMPRAS
  function renderComprasTable() {
    const grid = document.getElementById('compras-grid'); grid.innerHTML = '';
    comprasData.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach(c => {
      const prod = almacenData.find(x=>x.codigo==c.idProducto);
      if (!prod) return;
      const info  = productInfo[c.idProducto];
      const total = (info.priceBase * c.cantidad * FACTORES[c.unidad]).toFixed(2);
      const card = document.createElement('div'); card.className = 'card';
      card.innerHTML = `
        <div class="card-header">Compra #${c.idCompra}</div>
        <div class="seccion1">
          <label class="div2">Fecha:<input class="mutinput" type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}" onclick="recalcCompra('${c.idCompra}','${c.idProducto}')" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')"></label>
          <label class="div2"><p class="name2">${prod.name}</p></label>
          <label class="div2">Cantidad:<input type="number" id="qty-${c.idCompra}" value="${c.cantidad}" onclick="recalcCompra('${c.idCompra}','${c.idProducto}')" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')" min="0" step="0.1"></label>
          <label class="div2">Unidad:<select class="mutinput" id="unit-${c.idCompra}" onclick="recalcCompra('${c.idCompra}','${c.idProducto}')" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')">
            ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`).join('')}
          </select></label>
          <label class="div2">Total:$<span id="total-${c.idCompra}">${total}</span></label>
          <div class="div2">
            <button class="btnNormal" onclick="saveCompra('${c.idCompra}','${c.idProducto}')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button class="btnNormal delete" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </div>
      `;
      grid.append(card);
      recalcCompra(c.idCompra, c.idProducto);
    });
  }

  // ACCIONES STOCK/COMPRAS
  async function addNewProducto() {
    almacenData.push({ 
      codigo: Date.now(), 
      name:'', 
      precio:0, 
      cantidad:0, 
      unidadDeMedida:'pz', 
      stockRecomendado:0, 
      proveedor:'',
      active: true
    });
    buildProductInfo(); renderStockTable();
  }
  
  async function saveAlmacen(codigo) {
    const name = document.getElementById(`name-${codigo}`).value.trim();
    if (!name) {
      document.getElementById(`name-${codigo}`).classList.add('validation-error');
      return showAlert('El nombre del producto es obligatorio');
    }
    
    await postOpNotify('guardarAlmacen', {
      codigo,
      name,
      precio: document.getElementById(`precio-${codigo}`).value,
      cantidad: document.getElementById(`cant-${codigo}`).value,
      unidadDeMedida: document.getElementById(`unidad-${codigo}`).value,
      stockRecomendado: document.getElementById(`rec-${codigo}`).value,
      proveedor: document.getElementById(`prov-${codigo}`).value
    }, 'Almac√©n actualizado');
    await loadData();
  }
  
  // Buscar recetas que usan un producto
  function buscarRecetasConProducto(codigoProducto) {
    return cocData.filter(receta => 
      receta.ingredientes.some(ing => ing.codigo == codigoProducto && parseFloat(ing.cantidad) > 0)
    ).map(receta => receta.nombre);
  }
  
  async function deleteAlmacen(codigo) {
    // Buscar recetas que usan este producto
    const recetasQueLoUsan = buscarRecetasConProducto(codigo);
    
    if (recetasQueLoUsan.length > 0) {
      const message = `
        <div class="product-in-use">
          <p><strong>¬°Advertencia!</strong> Este producto est√° siendo usado en las siguientes recetas:</p>
          <ul>
            ${recetasQueLoUsan.map(r => `<li>${r}</li>`).join('')}
          </ul>
          <p>Si contin√∫a, el producto se marcar√° como inactivo y en las recetas su cantidad se establecer√° a 0.</p>
        </div>
        <p>¬øDesea continuar con la eliminaci√≥n?</p>
      `;
      
      const ok = await showConfirm(message);
      if (!ok) return;
      
      // Actualizar las recetas: poner a 0 la cantidad de este ingrediente
      for (const receta of cocData) {
        // Si la receta contiene el ingrediente
        if (receta.ingredientes.some(ing => ing.codigo == codigo)) {
          // Actualizar cada ingrediente que coincida
          receta.ingredientes = receta.ingredientes.map(ing => {
            if (ing.codigo == codigo) {
              return { ...ing, cantidad: 0 };
            }
            return ing;
          });
          // Guardar la receta actualizada
          await postOp('guardarCocina', {
            codigo: receta.codigo,
            nombre: receta.nombre,
            categoria: receta.categoria,
            imagen: receta.imagen || '',
            ingredientes: JSON.stringify(receta.ingredientes)
          });
        }
      }
      
      // Marcar el producto como inactivo en lugar de eliminarlo
      const producto = almacenData.find(p => p.codigo == codigo);
      if (producto) {
        producto.active = false;
        await postOpNotify('guardarAlmacen', {
          codigo,
          name: producto.name,
          precio: producto.precio,
          cantidad: producto.cantidad,
          unidadDeMedida: producto.unidadDeMedida,
          stockRecomendado: producto.stockRecomendado,
          proveedor: producto.proveedor,
          active: false
        }, 'Producto marcado como inactivo');
      }
    } else {
      // Si no est√° en uso, eliminarlo completamente
      const ok = await showConfirm(`¬øEliminar producto ${codigo}?`);
      if (!ok) return;
      await postOpNotify('eliminarAlmacen',{codigo},'Producto eliminado');
    }
    
    await loadData();
  }
  
  async function buyProduct(id) {
    const info = productInfo[id];
    const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value) || 0;
    if (qty <= 0) {
      document.getElementById(`buyqty-${id}`).classList.add('validation-error');
      return showAlert('La cantidad debe ser mayor que cero');
    }
    const uni   = document.getElementById(`buyunit-${id}`).value;
    const total = (info.priceBase * qty * FACTORES[uni]).toFixed(0);
    const fecha = new Date().toISOString().slice(0,10);
    await postOpNotify('guardarCompras',{ 
      idProducto: id,
      fecha,
      name: almacenData.find(x => x.codigo == id).name,
      precio: total,
      cantidad: qty,
      unidad: uni
    },'Compra registrada');
    await loadData();
  }

  function recalcCompra(idC,idP) {
    const info = productInfo[idP];
    const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
    const uni  = document.getElementById(`unit-${idC}`).value;
    document.getElementById(`total-${idC}`).textContent = (info.priceBase*qty*FACTORES[uni]).toFixed(2);
  }
  
  async function saveCompra(idC,idP) {
    const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
    if (qty<=0) {
      document.getElementById(`qty-${idC}`).classList.add('validation-error');
      return showAlert('La cantidad debe ser mayor que cero');
    }
    const uni   = document.getElementById(`unit-${idC}`).value;
    const fecha = document.getElementById(`date-${idC}`).value;
    await postOpNotify('guardarCompras',{
      idCompra:idC, idProducto:idP, fecha, cantidad:qty, unidad:uni,
      name:almacenData.find(x=>x.codigo==idP).name,
      precio:(productInfo[idP].priceBase*qty*FACTORES[uni]).toFixed(0)
    }, 'Compra guardada');
    await loadData();
  }
  
  async function deleteCompra(idC,idP) {
    const ok = await showConfirm(`¬øEliminar compra ${idC}?`);
    if (!ok) return;
    await postOpNotify('eliminarCompras',{idCompra:idC,idProducto:idP},'Compra eliminada');
    await loadData();
  }

  // NAVEGACI√ìN
  function cambiarSeccion(sec) {
    document.querySelectorAll('nav.top-nav button').forEach(b=>b.classList.remove('active'));
    document.querySelector(`nav.top-nav button[data-sec="${sec}"]`).classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(sec).classList.add('active');
  }

  // VENTAS
  function crearItemRow(cod = '', cant = '', tot = '') {
    const row = document.createElement('div'); row.className = 'item-row';
    row.innerHTML = `
      <select class="mutinput" onchange="recalcRow(this)" onclick="recalcRow(this)">
        ${recetas.map(r => `<option value="${r.codigo}" ${r.codigo===cod?'selected':''}>${r.nombre}</option>`).join('')}
      </select>
      <input type="number" min="1" value="${cant}" placeholder="Cantidad" onclick="recalcRow(this)" oninput="recalcRow(this)">
      <input type="number" value="${tot}" placeholder="Total" readonly>
      <button class="btnNormal delete" type="button" onclick="this.parentNode.remove()">‚àí</button>
    `;
    return row;
  }
  
  function recalcRow(el) {
    const row = el.closest('.item-row');
    const sel    = row.children[0];
    const inpCant= row.children[1];
    const inpTot = row.children[2];
    const rec = recetas.find(x => x.codigo === sel.value) || { precio: 0 };
    inpTot.value = (Number(rec.precio) * Number(inpCant.value || 0)).toFixed(2);
  }
  
  function agregarItemVenta() {
    document.getElementById('items-container').append(crearItemRow());
  }
  
  function renderTicketCard(v) {
    const fechaStr = new Date(v.fecha).toLocaleDateString();
    const itemsHtml = v.venta.map(it => `<div class="ticket-item">${it.producto} x${it.cantidad} = $${it.total}</div>`).join('');
    const total = v.venta.reduce((sum,i) => sum + Number(i.total), 0).toFixed(2);
    const card = document.createElement('div'); card.className = 'ticket-card';
    card.innerHTML = `
      <div class="card-header">${fechaStr}</div>
      <div class="seccion1">
        <div class="div2">
          <strong>Pago:</strong> ${v.metodoPago}
        </div>
        <div class="div2">
          ${itemsHtml}
        </div>
        <div class="div2">
          <strong>Total:</strong> <span class="ticket-total">${total}</span>
        </div>
        <div class="div2">
          <button class="btnNormal" onclick='startEdit(${JSON.stringify(v)})'>Editar</button>
          <button class="btnNormal delete" onclick="eliminarVenta('${v.id}')">
            <i class="fa-solid fa-trash"></i>
          </button>
        </div>
      </div>
    `;
    return card;
  }
  
  async function cargarVentas() {
    await fetchRecetas();
    const res = await callApi({op:'obtenerVentas'});
    ventData = res.status==='success'?res.data:ventData;
    const grid = document.getElementById('tickets-grid'); grid.innerHTML='';
    ventData.forEach(v=>grid.append(renderTicketCard(v)));
    actualizarResumen(ventData);
  }
  
  function startEdit(v) {
    document.getElementById('form-id').value      = v.id;
    document.getElementById('form-title').textContent = 'Editar Venta';
    document.getElementById('form-fecha').value   = new Date(v.fecha).toISOString().slice(0,10);
    document.getElementById('form-pago').value    = v.metodoPago;
    const cont = document.getElementById('items-container'); cont.innerHTML = '';
    v.venta.forEach(itm => cont.append(crearItemRow(itm.codigo, itm.cantidad, itm.total)));
  }
  
  function resetForm() {
    document.getElementById('form-id').value = '';
    document.getElementById('form-title').textContent = 'Nueva Venta';
    document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
    document.getElementById('form-pago').value = 'Efectivo';
    document.getElementById('items-container').innerHTML = '';
  }
  
  // VALIDAR STOCK ANTES DE VENTA
  function validarStockVenta(ventaItems) {
    const availableStock = {};
    const totalRequired = {};
    
    // Calcular stock disponible
    comprasData.forEach(c => {
      const base = c.cantidad * FACTORES[c.unidad];
      availableStock[c.idProducto] = (availableStock[c.idProducto] || 0) + base;
    });
    
    ventData.forEach(v => {
      v.venta.forEach(item => {
        const recipe = cocData.find(r => r.codigo === item.codigo);
        if (recipe) {
          recipe.ingredientes.forEach(ing => {
            // Solo considerar productos activos
            const producto = almacenData.find(p => p.codigo == ing.codigo);
            if (producto && producto.active !== false) {
              const baseUsed = ing.cantidad * FACTORES[ing.unidad] * item.cantidad;
              availableStock[ing.codigo] = (availableStock[ing.codigo] || 0) - baseUsed;
            }
          });
        }
      });
    });
    
    // Calcular requerimientos para la nueva venta
    for (const item of ventaItems) {
      const recipe = cocData.find(r => r.codigo === item.codigo);
      if (!recipe) continue;
      
      for (const ing of recipe.ingredientes) {
        // Saltar ingredientes con productos inactivos o cantidad 0
        const producto = almacenData.find(p => p.codigo == ing.codigo);
        if (!producto || producto.active === false || parseFloat(ing.cantidad) === 0) continue;
        
        const unit = ing.unidad.trim().toLowerCase();
        if (!(unit in FACTORES)) {
          return { valido: false, mensaje: `Unidad no reconocida: ${ing.unidad} en la receta ${recipe.codigo}` };
        }
        const baseRequired = ing.cantidad * FACTORES[unit] * item.cantidad;
        totalRequired[ing.codigo] = (totalRequired[ing.codigo] || 0) + baseRequired;
      }
    }
    
    // Verificar disponibilidad
    for (const [codigo, baseReq] of Object.entries(totalRequired)) {
      const available = availableStock[codigo] || 0;
      if (baseReq > available) {
        const product = almacenData.find(p => p.codigo == codigo) || { name: `Producto ${codigo}` };
        let cat = 'conteo';
        if (product) {
          cat = productInfo[product.codigo].categoria;
        }
        const reqHuman = humanizeComposite(baseReq, cat);
        const avaHuman = humanizeComposite(available, cat);
        return { 
          valido: false, 
          mensaje: `No hay suficiente stock de ${product.name}. Requerido: ${reqHuman}, Disponible: ${avaHuman}`
        };
      }
    }
    
    return { valido: true };
  }
  
  async function guardarVenta() {
    const fecha = document.getElementById('form-fecha').value;
    const rows = document.querySelectorAll('#items-container .item-row');
    
    if (!fecha) {
      document.getElementById('form-fecha').classList.add('validation-error');
      return await showAlert('Selecciona fecha');
    }
    
    if (!rows.length) {
      return await showAlert('Agrega al menos un producto');
    }
    
    const ventaItems = Array.from(rows).map(r => {
      const [sel, ic, it] = r.children;
      const rec = recetas.find(x => x.codigo === sel.value) || { nombre: '', precio: 0 };
      return { codigo: sel.value, producto: rec.nombre, cantidad: Number(ic.value) || 0, total: Number(it.value) || 0 };
    });
    
    // Validar stock antes de guardar
    const validacionStock = validarStockVenta(ventaItems);
    if (!validacionStock.valido) {
      return await showAlert(validacionStock.mensaje);
    }
    
    const payload = {
      id: document.getElementById('form-id').value,
      fecha,
      metodoPago: document.getElementById('form-pago').value,
      venta: ventaItems,
      items: ventaItems
    };
    
    await postOpNotify('guardarVentas', { venta: JSON.stringify(payload) }, 'Venta guardada');
    resetForm();
    await loadData();
  }
  
  async function eliminarVenta(id) {
    const ok = await showConfirm('¬øEliminar venta?');
    if (!ok) return;
    await postOpNotify('eliminarVentas',{id},'Venta eliminada');
    await loadData();
  }

  // RES√öMENES
  function actualizarResumen(vs) {
    let e=0,t=0,ta=0;
    vs.forEach(v=>v.venta.forEach(i=>{
      const s=parseFloat(i.total)||0;
      if (v.metodoPago==='Efectivo') e+=s;
      else if (v.metodoPago==='Transferencia') t+=s;
      else ta+=s;
    }));
    document.getElementById('sum-efectivo').textContent     = e.toFixed(2);
    document.getElementById('sum-transferencia').textContent = t.toFixed(2);
    document.getElementById('sum-tarjeta').textContent      = ta.toFixed(2);
    document.getElementById('sum-total').textContent        = (e+t+ta).toFixed(2);
  }
  
  function updateTopStats() {
    let totalInv=0, totalCompras=0, totalRestock=0;
    const compMap={}, usedMap={};
    comprasData.forEach(c=>{
      compMap[c.idProducto]=(compMap[c.idProducto]||0)+c.cantidad*FACTORES[c.unidad];
      totalCompras+=productInfo[c.idProducto].priceBase*c.cantidad*FACTORES[c.unidad];
    });
    ventData.forEach(v=>v.venta.forEach(it=>{
      const rec=cocData.find(r=>String(r.codigo)===String(it.codigo));
      rec && rec.ingredientes.forEach(ing=>{
        // Solo considerar productos activos
        const producto = almacenData.find(p => p.codigo == ing.codigo);
        if (producto && producto.active !== false && parseFloat(ing.cantidad) > 0) {
          usedMap[ing.codigo]=(usedMap[ing.codigo]||0)+ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
        }
      });
    }));
    almacenData.forEach(it=>{
      // Solo considerar productos activos
      if (it.active === false) return;
      
      const info=productInfo[it.codigo];
      const bought=compMap[it.codigo]||0;
      const used=usedMap[it.codigo]||0;
      const remain=bought-used;
      totalInv+=remain*info.priceBase;
      const recBase=(parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
      const delta=recBase-remain;
      if (delta>0) totalRestock+=delta*info.priceBase;
    });
    document.getElementById('stat-inventory').textContent = totalInv.toFixed(2);
    document.getElementById('stat-purchases').textContent = totalCompras.toFixed(2);
    document.getElementById('stat-restock').textContent   = totalRestock.toFixed(2);
  }

  // RECETAS
  async function fetchRecetas() {
    const cocR = await callApi({ op: 'obtenerCocina' });
    if (cocR.status === 'success') {
      cocData = cocR.data.map(r => ({
        ...r,
        ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
      }));
    }
    recetas = cocData.map(r => {
      const costo = r.ingredientes.reduce((sum, ing) => {
        // Saltar ingredientes con cantidad 0
        if (parseFloat(ing.cantidad) === 0) return sum;
        
        const p = almacenData.find(
          x => String(x.codigo) === String(ing.codigo)
        );
        // Solo considerar productos activos
        if (!p || p.active === false) return sum;
        
        const basePrice =
          p.precio /
          (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad);
        return (
          sum +
          basePrice * (FACTORES[ing.unidad.trim().toLowerCase()] * ing.cantidad)
        );
      }, 0);
      return {
        codigo: r.codigo,
        nombre: r.nombre,
        precio: (costo * MARGEN).toFixed(2)
      };
    });
  }

  async function cargarRecetas() {
    await fetchRecetas();
    recetasData = cocData;
    categorias = [...new Set(recetasData.map(r => r.categoria))];

    const sel = document.getElementById('receta-categoria');
    sel.innerHTML = [
      '<option value="">-- Selecciona categor√≠a --</option>',
      ...categorias.sort().map(c => `<option value="${c}">${c}</option>`),
      '<option value="__nueva__">+ Nueva categor√≠a</option>'
    ].join('');

    mostrarRecetas();
  }

  function toggleNuevaCategoria() {
    document
      .getElementById('wrapper-receta-categoria-nueva')
      .classList.toggle(
        'hidden',
        document.getElementById('receta-categoria').value !== '__nueva__'
      );
  }

  function mostrarRecetas() {
    const cont = document.getElementById('lista-recetas');
    cont.innerHTML = recetasData
      .map(r => {
        function costoIngrediente(i) {
          // Si la cantidad es 0, costo 0
          if (parseFloat(i.cantidad) === 0) return 0;
          
          const p = almacenData.find(x => String(x.codigo) === String(i.codigo));
          // Si el producto no existe o est√° inactivo, costo 0
          if (!p || p.active === false) return 0;
          
          const unidadInv = p.unidadDeMedida.trim().toLowerCase();
          const unidadRec = i.unidad.trim().toLowerCase();
          const precioPorUnidadMinima =
            p.precio / (FACTORES[unidadInv] * p.cantidad);
          return precioPorUnidadMinima * (FACTORES[unidadRec] * i.cantidad);
        }

        const ingredientesHtml = r.ingredientes
          .map(i => {
            const c = costoIngrediente(i).toFixed(2);
            const p = almacenData.find(x => String(x.codigo) === String(i.codigo));
            
            if (parseFloat(i.cantidad) === 0) {
              return `<p class="stock-alert">${i.codigo}: ${i.cantidad}${i.unidad} (eliminado) ‚Üí $0.00</p>`;
            } else if (!p || p.active === false) {
              return `<p class="stock-alert">${i.codigo}: ${i.cantidad}${i.unidad} (producto inactivo) ‚Üí $0.00</p>`;
            } else {
              return `<p>${i.codigo}: ${i.cantidad}${i.unidad} ‚Üí $${c}</p>`;
            }
          })
          .join('');

        const totalCosto = r.ingredientes
          .reduce((sum, i) => sum + costoIngrediente(i), 0)
          .toFixed(2);

        return `
        <div class="card">
          <div class="card-header">${r.codigo} ‚Äì ${r.nombre}</div>
          <div class="seccion1">
            <div class="div2"><strong>Categor√≠a:</strong> ${r.categoria}</div>
            ${r.imagen ? `<div class="div2"><img src="${r.imagen}" style="max-width:100%"></div>` : ''}
            <div class="div2">${ingredientesHtml}</div>
            <p><strong>Costo total:</strong> $${totalCosto}</p>
            <div class="div2">
              <button class="btnNormal" onclick='cargarEnForm(${JSON.stringify(r)})'>Editar</button>
              <button class="btnNormal delete" onclick="eliminarReceta('${r.codigo}')">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </div>`;
      })
      .join('');
  }

  function cargarEnForm(r) {
    editMode = true;
    document.getElementById('receta-codigo').value = r.codigo;
    document.getElementById('receta-codigo').disabled = true;
    document.getElementById('receta-nombre').value = r.nombre;

    const selCat = document.getElementById('receta-categoria');
    if (categorias.includes(r.categoria)) {
      selCat.value = r.categoria;
      document
        .getElementById('wrapper-receta-categoria-nueva')
        .classList.add('hidden');
    } else {
      selCat.value = '__nueva__';
      document
        .getElementById('wrapper-receta-categoria-nueva')
        .classList.remove('hidden');
      document.getElementById('receta-categoria-nueva').value = r.categoria;
    }

    document.getElementById('receta-imagen').value = r.imagen || '';

    const cont = document.getElementById('ingredientes-container');
    cont.innerHTML = '';
    r.ingredientes.forEach(i => agregarFila(i));
  }
  
  // VALIDAR RECETA ANTES DE GUARDAR
  function validarReceta(receta) {
    const errores = [];
    
    if (!receta.codigo.trim()) {
      document.getElementById('receta-codigo').classList.add('validation-error');
      document.getElementById('codigo-error').textContent = 'C√≥digo requerido';
      errores.push('El c√≥digo de la receta es obligatorio');
    }
    
    if (!receta.nombre.trim()) {
      document.getElementById('receta-nombre').classList.add('validation-error');
      document.getElementById('nombre-error').textContent = 'Nombre requerido';
      errores.push('El nombre de la receta es obligatorio');
    }
    
    if (!receta.categoria.trim()) {
      document.getElementById('receta-categoria').classList.add('validation-error');
      document.getElementById('categoria-error').textContent = 'Categor√≠a requerida';
      errores.push('La categor√≠a de la receta es obligatoria');
    }
    
    // Validar ingredientes
    const cont = document.getElementById('ingredientes-container');
    const filas = cont.querySelectorAll('.item-row');
    
    if (filas.length === 0) {
      errores.push('Debe agregar al menos un ingrediente');
    }
    
    filas.forEach((fila, index) => {
      const selP = fila.querySelector('select');
      const inpC = fila.querySelector('input[type="number"]');
      const selU = fila.querySelector('select:last-child');
      
      if (!selP.value) {
        selP.classList.add('validation-error');
        errores.push(`Ingrediente ${index+1}: Seleccione un producto`);
      }
      
      if (!inpC.value || parseFloat(inpC.value) <= 0) {
        inpC.classList.add('validation-error');
        errores.push(`Ingrediente ${index+1}: Cantidad debe ser mayor que cero`);
      }
      
      if (!selU.value) {
        selU.classList.add('validation-error');
        errores.push(`Ingrediente ${index+1}: Seleccione una unidad`);
      }
    });
    
    return errores;
  }

  async function guardarReceta() {
    const cod = document.getElementById('receta-codigo').value.trim();
    const nom = document.getElementById('receta-nombre').value.trim();
    
    let cat = document.getElementById('receta-categoria').value;
    if (cat === '__nueva__') {
      cat = document.getElementById('receta-categoria-nueva').value.trim();
    }
    
    const ingredientes = Array.from(
      document
        .getElementById('ingredientes-container')
        .querySelectorAll('.item-row')
    ).map(row => {
      const [selP, inpC, selU] = row.children;
      return {
        codigo: selP.value,
        cantidad: Number(inpC.value) || 0,
        unidad: selU.value
      };
    });
    
    const receta = {
      codigo: cod,
      nombre: nom,
      categoria: cat,
      imagen: document.getElementById('receta-imagen').value.trim(),
      ingredientes: ingredientes
    };
    
    // Validar receta
    const errores = validarReceta(receta);
    if (errores.length > 0) {
      const errorContainer = document.getElementById('receta-validation-errors');
      errorContainer.innerHTML = errores.map(e => `<div>${e}</div>`).join('');
      return;
    }
    
    await postOpNotify(
      'guardarCocina',
      {
        codigo: cod,
        nombre: nom,
        categoria: cat,
        imagen: document.getElementById('receta-imagen').value.trim(),
        ingredientes: JSON.stringify(ingredientes)
      },
      'Receta guardada'
    );

    await cargarRecetas();
    limpiarForm();
  }

  async function eliminarReceta(codigo) {
    const ok = await showConfirm(`¬øEliminar receta ${codigo}?`);
    if (!ok) return;
    await postOpNotify('eliminarCocina', { codigo }, 'Receta eliminada');
    await cargarRecetas();
  }

  let filaCounter = 0;

  function agregarFila(item = {}) {
    const cont = document.getElementById('ingredientes-container');
    const id = ++filaCounter;

    const primerP = item.codigo
      ? almacenData.find(p => String(p.codigo) === String(item.codigo))
      : almacenData[0];
    const unidadDef = primerP ? primerP.unidadDeMedida.trim().toLowerCase() : 'pz';
    const unidad0   = item.unidad || unidadDef;
    const cat0      = categoriaDe(unidad0);

    const opcionesProductos = almacenData
      .map(p => {
        const sel  = String(p.codigo) === String(item.codigo) ? ' selected' : '';
        const inactiveClass = p.active === false ? 'inactive-product' : '';
        return `<option value="${p.codigo}" data-unit="${p.unidadDeMedida.trim().toLowerCase()}"${sel} class="${inactiveClass}">
          ${p.name} (${p.cantidad}${p.unidadDeMedida}) ${p.active === false ? '(Inactivo)' : ''}
        </option>`;
      })
      .join('');

    const opcionesUnidades = CATEGORIAS[cat0]
      .map(u => {
        const sel = u === unidad0 ? ' selected' : '';
        return `<option value="${u}"${sel}>${u}</option>`;
      })
      .join('');

    const rowHTML = `
      <div class="item-row" id="fila-${id}">
        <select class="mutinput" id="sel-producto-${id}">
          <option value="">-- Seleccione producto --</option>
          ${opcionesProductos}
        </select>
        <input
          type="number"
          min="0.1"
          step="0.1"
          value="${item.cantidad || 1}"
          placeholder="Cantidad"
          id="inp-cantidad-${id}"
        >
        <select class="mutinput" id="sel-unidad-${id}">
          ${opcionesUnidades}
        </select>
        <button class="btnNormal delete" type="button" id="btn-remove-${id}">‚àí</button>
      </div>
    `;
    cont.insertAdjacentHTML('beforeend', rowHTML);

    const selP = document.getElementById(`sel-producto-${id}`);
    let   selU = document.getElementById(`sel-unidad-${id}`);
    const btn  = document.getElementById(`btn-remove-${id}`);

    selP.addEventListener('change', () => {
      const selectedOption = selP.selectedOptions[0];
      if (!selectedOption || !selectedOption.dataset.unit) return;
      
      const nuevaUnit = selectedOption.dataset.unit;
      const nuevaCat  = categoriaDe(nuevaUnit);
      const opciones  = CATEGORIAS[nuevaCat]
        .map(u => `<option value="${u}">${u}</option>`)
        .join('');
      
      selU.innerHTML = opciones;
    });

    btn.addEventListener('click', () => {
      document.getElementById(`fila-${id}`).remove();
    });
  }

  function limpiarForm() {
    editMode = false;
    ['receta-codigo', 'receta-nombre', 'receta-imagen', 'receta-categoria', 'receta-categoria-nueva'].forEach(
      id => {
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('validation-error');
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
      }
    );
    document.getElementById('codigo-error').textContent = '';
    document.getElementById('nombre-error').textContent = '';
    document.getElementById('categoria-error').textContent = '';
    document.getElementById('receta-codigo').disabled = false;
    document.getElementById('ingredientes-container').innerHTML = '';
    document.getElementById('wrapper-receta-categoria-nueva').classList.add('hidden');
    document.getElementById('receta-validation-errors').innerHTML = '';
  }

  // CARGA GENERAL
  async function loadData() {
    const [alm, comp, vent, coc] = await Promise.all([
      callApi({op:'obtenerAlmacen'}),
      callApi({op:'obtenerCompras'}),
      callApi({op:'obtenerVentas'}),
      callApi({op:'obtenerCocina'})
    ]);
    almacenData = alm.data; 
    comprasData = comp.data; 
    ventData = vent.data;
    if (coc.status === 'success') {
      cocData = coc.data.map(r => ({
        ...r,
        ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
      }));
    }
    buildProductInfo();
    renderStockTable();
    renderComprasTable();
    await cargarVentas();
    await cargarRecetas();
    updateTopStats();
  }

  window.onload = async () => {
    resetForm();
    document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
    await loadData();
    
    // Limpiar clases de error al cambiar valores
    document.querySelectorAll('input, select').forEach(el => {
      el.addEventListener('input', () => {
        el.classList.remove('validation-error');
        if (el.id === 'receta-codigo') document.getElementById('codigo-error').textContent = '';
        if (el.id === 'receta-nombre') document.getElementById('nombre-error').textContent = '';
      });
    });
  };
</script>
</body>
</html>
