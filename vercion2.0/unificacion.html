<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <title>StockFlow Pro</title>
  <style>
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5d4ec9;
      --primary-light: #e9e7ff;
      --secondary: #00cec9;
      --secondary-light: #e0f7f6;
      --danger: #ff7675;
      --danger-light: #ffeded;
      --success: #00b894;
      --success-light: #e6f8f5;
      --warning: #fdcb6e;
      --warning-light: #fff8e9;
      --dark: #2d3436;
      --light: #f8fafc;
      --gray: #dfe6e9;
      --gray-light: #f1f5f9;
      --border: #e2e8f0;
      --card-shadow: 0 4px 12px rgba(0,0,0,0.06);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --radius: 12px;
      --header-height: 70px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
  
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--light);
      color: var(--dark);
      padding: 0;
      padding-bottom: 120px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    /* HEADER */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 0 20px;
      height: var(--header-height);
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    
    .app-header h1 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .app-header .stats {
      display: flex;
      gap: 20px;
      font-size: 0.8rem;
    }
    
    .stat-item {
      text-align: center;
      padding: 8px 12px;
      border-radius: var(--radius);
      background: var(--primary-light);
      min-width: 80px;
    }
    
    .stat-item i {
      font-size: 0.9rem;
      margin-bottom: 3px;
    }
    
    .stat-item strong {
      display: block;
      font-size: 1.1rem;
      margin-top: 2px;
      color: var(--primary);
    }
    
    /* NAVEGACI√ìN INFERIOR */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      display: flex;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      z-index: 100;
      height: 70px;
      border-top: 1px solid var(--border);
    }
    
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #777;
      border: none;
      background: transparent;
      transition: var(--transition);
      padding: 8px 0;
      position: relative;
    }
    
    .nav-btn i {
      font-size: 1.3rem;
      margin-bottom: 3px;
      transition: var(--transition);
    }
    
    .nav-btn.active {
      color: var(--primary);
      background: rgba(108, 92, 231, 0.05);
    }
    
    .nav-btn.active i {
      transform: translateY(-3px);
    }
    
    .nav-badge {
      position: absolute;
      top: 8px;
      right: 20px;
      background: var(--danger);
      color: white;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      font-size: 0.6rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* RESUMEN VENTAS */
    .sales-summary {
      position: fixed;
      bottom: 70px;
      left: 0;
      width: 100%;
      background: var(--dark);
      color: white;
      display: flex;
      padding: 8px 0;
      z-index: 99;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    .summary-item {
      flex: 1;
      text-align: center;
      padding: 5px;
      position: relative;
    }
    
    .summary-item:not(:last-child)::after {
      content: '';
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 60%;
      width: 1px;
      background: rgba(255,255,255,0.2);
    }
    
    .summary-item.total {
      font-weight: bold;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .summary-item span {
      display: block;
      font-size: 1.1rem;
      font-weight: 600;
      margin-top: 3px;
    }
    
    /* SECCIONES */
    .section {
      display: none;
      padding: 20px;
      animation: fadeIn 0.4s ease;
    }
    
    .section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title {
      font-size: 1.3rem;
      margin-bottom: 20px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    
    /* TARJETAS */
    .card {
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      margin-bottom: 20px;
      transition: var(--transition);
      border: 1px solid var(--border);
    }
    
    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.08);
    }
    
    .card-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .card-row {
      display: flex;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray-light);
    }
    
    .card-row:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .card-label {
      flex: 1;
      color: #777;
      font-weight: 500;
    }
    
    .card-value {
      flex: 1;
      text-align: right;
      font-weight: 500;
      color: var(--dark);
    }
    
    .card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    
    /* FORMULARIOS */
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.9rem;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      background: white;
      transition: var(--transition);
    }
    
    .form-input:focus, .form-select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .form-row > * {
      flex: 1;
    }
    
    /* BOTONES */
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 14px;
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      width: 100%;
      gap: 8px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-secondary:hover {
      background: #00b8b5;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #ff5e5d;
    }
    
    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-outline:hover {
      background: var(--primary-light);
    }
    
    .btn-icon {
      padding: 10px;
      width: auto;
      border-radius: 50%;
    }
    
    /* MODAL */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .modal-backdrop.show {
      opacity: 1;
      pointer-events: all;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
      overflow: hidden;
      transform: translateY(20px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .modal-backdrop.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }
    
    .modal-header {
      padding: 15px 20px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .modal-body {
      padding: 20px;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .modal-footer {
      padding: 15px 20px;
      display: flex;
      gap: 10px;
      background: var(--gray-light);
      border-top: 1px solid var(--border);
    }
    
    /* LISTAS */
    .list {
      margin-bottom: 15px;
    }
    
    .list-item {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid var(--border);
      transition: var(--transition);
      cursor: pointer;
    }
    
    .list-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.08);
    }
    
    .list-title {
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .list-subtitle {
      font-size: 0.85rem;
      color: #777;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    /* ESTADOS */
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .status-low {
      background: rgba(255, 118, 117, 0.15);
      color: var(--danger);
    }
    
    .status-medium {
      background: rgba(253, 203, 110, 0.15);
      color: #e17055;
    }
    
    .status-good {
      background: rgba(0, 184, 148, 0.15);
      color: var(--success);
    }
    
    .status-excess {
      background: rgba(108, 92, 231, 0.15);
      color: var(--primary);
    }
    
    .status-reposicion {
      background: rgba(45, 52, 54, 0.15);
      color: var(--dark);
    }
    
    /* UTILIDADES */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mb-15 {
      margin-bottom: 15px;
    }
    
    .mt-15 {
      margin-top: 15px;
    }
    
    .flex {
      display: flex;
    }
    
    .gap-10 {
      gap: 10px;
    }
    
    /* ANIMACIONES */
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c2c2c2;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }
    
    /* DASHBOARD */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .dashboard-card {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .dashboard-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: var(--primary);
    }
    
    .dashboard-card-title {
      font-size: 0.9rem;
      color: #777;
      margin-bottom: 10px;
    }
    
    .dashboard-card-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 5px;
    }
    
    .dashboard-card-subtitle {
      font-size: 0.85rem;
      color: #777;
    }
    
    /* FILTROS */
    .filters {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .filter-item {
      flex: 1;
      min-width: 200px;
    }
    
    /* CHARTS */
    .chart-container {
      background: white;
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border);
      margin-bottom: 20px;
    }
    
    .chart-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* LOADER */
    .loader {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid rgba(108, 92, 231, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* SEARCH */
    .search-container {
      position: relative;
      margin-bottom: 20px;
    }
    
    .search-input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      background: white;
      transition: var(--transition);
    }
    
    .search-input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
    }
    
    .search-icon {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #777;
    }
    
    /* EMPTY STATE */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      border: 1px dashed var(--border);
    }
    
    .empty-state i {
      font-size: 3rem;
      color: var(--gray);
      margin-bottom: 15px;
    }
    
    .empty-state h3 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--dark);
    }
    
    .empty-state p {
      color: #777;
      margin-bottom: 20px;
    }
    
    /* PRODUCT GRID */
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .product-card {
      background: white;
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border);
      transition: var(--transition);
      cursor: pointer;
    }
    
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .product-image {
      height: 150px;
      background: var(--gray-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--gray);
      font-size: 3rem;
    }
    
    .product-body {
      padding: 15px;
    }
    
    .product-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .product-subtitle {
      font-size: 0.85rem;
      color: #777;
      margin-bottom: 10px;
    }
    
    .product-price {
      font-weight: 700;
      color: var(--primary);
      font-size: 1.1rem;
    }
    
    /* NOTIFICATIONS */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: var(--radius);
      padding: 15px 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      border-left: 4px solid var(--success);
      transform: translateX(110%);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 350px;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-title {
      font-weight: 600;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .notification-content {
      font-size: 0.9rem;
      color: #777;
    }
    
    .notification-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: transparent;
      border: none;
      color: #777;
      cursor: pointer;
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .app-header .stats {
        gap: 10px;
      }
      
      .stat-item {
        min-width: 70px;
        padding: 6px 8px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <h1><i class="fas fa-boxes"></i> StockFlow Pro</h1>
    <div class="stats">
      <div class="stat-item">
        <i class="fas fa-warehouse"></i> Inv<br><strong id="stat-inventory">0.00</strong>
      </div>
      <div class="stat-item">
        <i class="fas fa-shopping-cart"></i> Com<br><strong id="stat-purchases">0.00</strong>
      </div>
      <div class="stat-item">
        <i class="fas fa-truck-loading"></i> Rep<br><strong id="stat-restock">0.00</strong>
      </div>
    </div>
  </header>

  <!-- NOTIFICATION -->
  <div class="notification" id="notification">
    <button class="notification-close" onclick="hideNotification()"><i class="fas fa-times"></i></button>
    <div class="notification-title" id="notification-title">Operaci√≥n exitosa</div>
    <div class="notification-content" id="notification-content">Los cambios se han guardado correctamente</div>
  </div>

  <!-- RESUMEN VENTAS -->
  <div class="sales-summary">
    <div class="summary-item">Efectivo<br><span id="sum-efectivo">0.00</span></div>
    <div class="summary-item">Transferencia<br><span id="sum-transferencia">0.00</span></div>
    <div class="summary-item">Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
    <div class="summary-item total">Total<br><span id="sum-total">0.00</span></div>
  </div>

  <!-- SECCIONES -->
  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <h2 class="section-title"><i class="fas fa-chart-line"></i> Panel de Control</h2>
      
      <div class="dashboard-grid">
        <div class="dashboard-card">
          <div class="dashboard-card-title">Valor Total del Inventario</div>
          <div class="dashboard-card-value">$<span id="dashboard-inventory">0.00</span></div>
          <div class="dashboard-card-subtitle">√öltimo mes: <span id="dashboard-inventory-change">+0.0%</span></div>
        </div>
        
        <div class="dashboard-card">
          <div class="dashboard-card-title">Ventas del Mes</div>
          <div class="dashboard-card-value">$<span id="dashboard-sales">0.00</span></div>
          <div class="dashboard-card-subtitle">vs mes anterior: <span id="dashboard-sales-change">+0.0%</span></div>
        </div>
        
        <div class="dashboard-card">
          <div class="dashboard-card-title">Productos con Stock Bajo</div>
          <div class="dashboard-card-value"><span id="dashboard-low-stock">0</span></div>
          <div class="dashboard-card-subtitle">Necesitan reposici√≥n inmediata</div>
        </div>
        
        <div class="dashboard-card">
          <div class="dashboard-card-title">Recetas Populares</div>
          <div class="dashboard-card-value"><span id="dashboard-top-recipe">-</span></div>
          <div class="dashboard-card-subtitle">M√°s vendida este mes</div>
        </div>
      </div>
      
      <div class="filters">
        <div class="filter-item">
          <label class="form-label">Rango de Fechas</label>
          <select class="form-select" id="dashboard-range">
            <option value="7">√öltimos 7 d√≠as</option>
            <option value="30" selected>√öltimos 30 d√≠as</option>
            <option value="90">√öltimos 90 d√≠as</option>
            <option value="custom">Personalizado</option>
          </select>
        </div>
        
        <div class="filter-item" id="custom-dates" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Desde</label>
              <input type="date" class="form-input" id="dashboard-from">
            </div>
            <div class="form-group">
              <label class="form-label">Hasta</label>
              <input type="date" class="form-input" id="dashboard-to">
            </div>
          </div>
        </div>
      </div>
      
      <div class="chart-container">
        <div class="chart-title"><i class="fas fa-chart-bar"></i> Ventas por D√≠a</div>
        <canvas id="sales-chart"></canvas>
      </div>
      
      <div class="chart-container">
        <div class="chart-title"><i class="fas fa-chart-pie"></i> M√©todos de Pago</div>
        <canvas id="payment-chart"></canvas>
      </div>
    </section>

    <!-- STOCK -->
    <section id="stock" class="section">
      <h2 class="section-title"><i class="fas fa-box-open"></i> Stock de Productos</h2>
      
      <div class="filters">
        <div class="filter-item">
          <label class="form-label">Buscar Producto</label>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="stock-search" placeholder="Buscar por nombre o c√≥digo...">
          </div>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Categor√≠a</label>
          <select class="form-select" id="stock-category">
            <option value="">Todas las categor√≠as</option>
            <option value="peso">Peso (kg/g)</option>
            <option value="volumen">Volumen (l/ml)</option>
            <option value="conteo">Conteo (pz)</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Estado</label>
          <select class="form-select" id="stock-status">
            <option value="">Todos</option>
            <option value="low">Stock Bajo</option>
            <option value="medium">Stock Medio</option>
            <option value="good">Stock Bueno</option>
            <option value="excess">Excedente</option>
            <option value="inactive">Inactivos</option>
          </select>
        </div>
      </div>
      
      <div class="flex gap-10 mb-15">
        <button class="btn btn-primary" onclick="addNewProducto()">
          <i class="fas fa-plus"></i> Nuevo Producto
        </button>
        
        <button class="btn btn-outline" onclick="exportStock()">
          <i class="fas fa-file-export"></i> Exportar
        </button>
      </div>
      
      <div id="stock-grid" class="product-grid"></div>
      
      <div id="stock-empty" class="empty-state" style="display: none;">
        <i class="fas fa-box-open"></i>
        <h3>No se encontraron productos</h3>
        <p>Intenta cambiar los filtros o agregar un nuevo producto</p>
        <button class="btn btn-primary" onclick="addNewProducto()">
          <i class="fas fa-plus"></i> Agregar Producto
        </button>
      </div>
    </section>

    <!-- COMPRAS -->
    <section id="compras" class="section">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Historial de Compras</h2>
      
      <div class="filters">
        <div class="filter-item">
          <label class="form-label">Buscar</label>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="purchase-search" placeholder="Buscar compra...">
          </div>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Proveedor</label>
          <select class="form-select" id="purchase-supplier">
            <option value="">Todos los proveedores</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Rango de Fechas</label>
          <div class="form-row">
            <div class="form-group">
              <input type="date" class="form-input" id="purchase-from">
            </div>
            <div class="form-group">
              <input type="date" class="form-input" id="purchase-to">
            </div>
          </div>
        </div>
      </div>
      
      <div id="compras-list" class="list"></div>
      
      <div id="purchase-empty" class="empty-state" style="display: none;">
        <i class="fas fa-shopping-cart"></i>
        <h3>No se encontraron compras</h3>
        <p>Intenta cambiar los filtros o registrar una nueva compra</p>
      </div>
    </section>

    <!-- VENTAS -->
    <section id="ventas" class="section">
      <h2 class="section-title"><i class="fas fa-cash-register"></i> Gesti√≥n de Ventas</h2>
      
      <div class="card mb-15">
        <div class="card-header">Nueva Venta</div>
        <div class="card-body">
          <input type="hidden" id="form-id">
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Fecha</label>
              <input class="form-input" type="date" id="form-fecha">
            </div>
            <div class="form-group">
              <label class="form-label">M√©todo de Pago</label>
              <select class="form-select" id="form-pago">
                <option>Efectivo</option>
                <option>Transferencia</option>
                <option>Tarjeta</option>
              </select>
            </div>
          </div>
          
          <div id="items-container" class="mb-15"></div>
          
          <div class="form-row">
            <div class="card-value" style="flex: 2; text-align: right; font-weight: 700; font-size: 1.2rem;">
              Total: $<span id="sale-total">0.00</span>
            </div>
            <button class="btn btn-outline" style="flex: 1;" onclick="agregarItemVenta()">
              <i class="fas fa-plus"></i> Agregar producto
            </button>
          </div>
          
          <div class="form-row">
            <button class="btn btn-primary" onclick="guardarVenta()">
              <i class="fas fa-save"></i> Guardar Venta
            </button>
            <button class="btn btn-outline" onclick="resetForm()">
              <i class="fas fa-times"></i> Cancelar
            </button>
          </div>
        </div>
      </div>
      
      <h3 class="section-title"><i class="fas fa-receipt"></i> Historial de Ventas</h3>
      
      <div class="filters">
        <div class="filter-item">
          <label class="form-label">Buscar</label>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="sale-search" placeholder="Buscar venta...">
          </div>
        </div>
        
        <div class="filter-item">
          <label class="form-label">M√©todo de Pago</label>
          <select class="form-select" id="sale-payment">
            <option value="">Todos</option>
            <option value="Efectivo">Efectivo</option>
            <option value="Transferencia">Transferencia</option>
            <option value="Tarjeta">Tarjeta</option>
          </select>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Rango de Fechas</label>
          <div class="form-row">
            <div class="form-group">
              <input type="date" class="form-input" id="sale-from">
            </div>
            <div class="form-group">
              <input type="date" class="form-input" id="sale-to">
            </div>
          </div>
        </div>
      </div>
      
      <div id="tickets-list" class="list"></div>
      
      <div id="sale-empty" class="empty-state" style="display: none;">
        <i class="fas fa-receipt"></i>
        <h3>No se encontraron ventas</h3>
        <p>Intenta cambiar los filtros o registrar una nueva venta</p>
      </div>
    </section>

    <!-- RECETAS -->
    <section id="recetas" class="section">
      <h2 class="section-title"><i class="fas fa-utensils"></i> Gesti√≥n de Recetas</h2>
      
      <div class="card mb-15">
        <div class="card-header">Nueva Receta</div>
        <div class="card-body">
          <input type="hidden" id="form-receta-id">
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">C√≥digo</label>
              <input class="form-input" id="receta-codigo" type="text" placeholder="Ej: R001">
            </div>
            <div class="form-group">
              <label class="form-label">Nombre</label>
              <input class="form-input" id="receta-nombre" type="text" placeholder="Nombre receta">
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categor√≠a</label>
              <input class="form-input" id="receta-categoria" type="text" placeholder="Nueva categor√≠a">
            </div>
            <div class="form-group">
              <label class="form-label">Imagen (URL)</label>
              <input class="form-input" id="receta-imagen" type="text" placeholder="http://...">
            </div>
          </div>
          
          <h3 class="section-title"><i class="fas fa-carrot"></i> Ingredientes</h3>
          <div id="ingredientes-container" class="mb-15"></div>
          
          <button class="btn btn-outline mb-15" onclick="agregarFila()">
            <i class="fas fa-plus"></i> Agregar ingrediente
          </button>
          
          <div class="form-row">
            <button class="btn btn-primary" onclick="guardarReceta()">
              <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-outline" onclick="limpiarForm()">
              <i class="fas fa-broom"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <h3 class="section-title"><i class="fas fa-book"></i> Recetas</h3>
      
      <div class="filters">
        <div class="filter-item">
          <label class="form-label">Buscar Receta</label>
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="search-input" id="recipe-search" placeholder="Buscar receta...">
          </div>
        </div>
        
        <div class="filter-item">
          <label class="form-label">Categor√≠a</label>
          <input class="form-input" id="recipe-category" type="text" placeholder="Filtrar por categor√≠a">
        </div>
        
        <div class="filter-item">
          <label class="form-label">Ordenar por</label>
          <select class="form-select" id="recipe-sort">
            <option value="name">Nombre</option>
            <option value="popularity">Popularidad</option>
            <option value="cost">Costo</option>
            <option value="price">Precio</option>
          </select>
        </div>
      </div>
      
      <div id="recetas-list" class="product-grid"></div>
      
      <div id="recipe-empty" class="empty-state" style="display: none;">
        <i class="fas fa-utensils"></i>
        <h3>No se encontraron recetas</h3>
        <p>Intenta cambiar los filtros o crear una nueva receta</p>
        <button class="btn btn-primary" onclick="limpiarForm()">
          <i class="fas fa-plus"></i> Crear Receta
        </button>
      </div>
    </section>
  </main>

  <!-- NAVEGACI√ìN INFERIOR -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-sec="dashboard" onclick="cambiarSeccion('dashboard')">
      <i class="fas fa-chart-line"></i> Dashboard
    </button>
    <button class="nav-btn" data-sec="stock" onclick="cambiarSeccion('stock')">
      <i class="fas fa-boxes"></i> Stock
    </button>
    <button class="nav-btn" data-sec="compras" onclick="cambiarSeccion('compras')">
      <i class="fas fa-shopping-cart"></i> Compras
      <span class="nav-badge" id="purchase-badge" style="display: none;">0</span>
    </button>
    <button class="nav-btn" data-sec="ventas" onclick="cambiarSeccion('ventas')">
      <i class="fas fa-cash-register"></i> Ventas
    </button>
    <button class="nav-btn" data-sec="recetas" onclick="cambiarSeccion('recetas')">
      <i class="fas fa-utensils"></i> Recetas
    </button>
  </nav>

  <!-- MODAL REUTILIZABLE -->
  <div id="modal-backdrop" class="modal-backdrop">
    <div class="modal-content">
      <div id="modal-header" class="modal-header"></div>
      <div id="modal-body" class="modal-body"></div>
      <div id="modal-footer" class="modal-footer"></div>
    </div>
  </div>

  <!-- CHARTS LIBRARY -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
<script>
  // CONSTANTES
  const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
  const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
  const MARGEN     = 2;
  const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };

  // ESTADO GLOBAL
  let almacenData = [], comprasData = [], ventData = [], cocData = [];
  let recetas = [], recetasData = [], productInfo = {}, editMode = false;
  let salesChart, paymentChart;

  // NOTIFICACIONES
  function showNotification(title, content, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationTitle = document.getElementById('notification-title');
    const notificationContent = document.getElementById('notification-content');
    
    notificationTitle.textContent = title;
    notificationContent.textContent = content;
    
    // Reset classes
    notification.className = 'notification';
    
    // Add type class
    if (type === 'success') {
      notification.style.borderLeftColor = 'var(--success)';
    } else if (type === 'error') {
      notification.style.borderLeftColor = 'var(--danger)';
    } else if (type === 'warning') {
      notification.style.borderLeftColor = 'var(--warning)';
    }
    
    notification.classList.add('show');
    
    // Auto hide after 3 seconds
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }
  
  function hideNotification() {
    document.getElementById('notification').classList.remove('show');
  }

  // MODAL REUTILIZABLE
  const modal = {
    backdrop: document.getElementById('modal-backdrop'),
    header:   document.getElementById('modal-header'),
    body:     document.getElementById('modal-body'),
    footer:   document.getElementById('modal-footer'),
    show: ({ title = '', message = '', confirm = false }) => new Promise(res => {
      modal.header.textContent = title;
      modal.body.innerHTML   = message;
      modal.footer.innerHTML   = '';
      const btnOk = document.createElement('button');
      btnOk.className = 'btn btn-primary';
      btnOk.textContent = 'OK';
      btnOk.onclick = () => (modal.backdrop.classList.remove('show'), res(true));
      modal.footer.append(btnOk);
      if (confirm) {
        const btnCancel = document.createElement('button');
        btnCancel.className = 'btn btn-outline';
        btnCancel.textContent = 'Cancelar';
        btnCancel.onclick = () => (modal.backdrop.classList.remove('show'), res(false));
        modal.footer.append(btnCancel);
      }
      modal.backdrop.classList.add('show');
    })
  };
  
  const showAlert   = msg => modal.show({ title: '¬°Atenci√≥n!', message: msg });
  const showConfirm = msg => modal.show({ title: 'Confirma', message: msg, confirm: true });

  // UTILIDADES DE FETCH
  const callApi = params => {
    const url = new URL(API_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
    return fetch(url).then(r => r.json());
  };
  
  async function postOpNotify(op, params = {}, successTitle = '√âxito') {
    try {
      const data = await postOp(op, params);
      const msg = typeof data === 'string' ? data : data?.message ?? JSON.stringify(data);
      await modal.show({ title: successTitle, message: msg });
      return data;
    } catch (err) {
      const errMsg = err?.message ?? String(err);
      await modal.show({ title: 'Error', message: errMsg });
      throw err;
    }
  }
  
  const postOp = async (op, params = {}) => {
    const fd = new FormData(); fd.append('op', op);
    Object.entries(params).forEach(([k,v]) => fd.append(k,v));
    const res = await fetch(API_URL, { method: 'POST', body: fd });
    const json = await res.json();
    if (json.status === 'success') return json.data;
    else throw new Error(json.message);
  };

  // UTILIDADES DE UNIDAD
  const categoriaDe = u =>
    ['mg','g','kg'].includes(u) ? 'peso'
  : ['ml','l'].includes(u)    ? 'volumen'
  :                             'conteo';

  const humanizeComposite = (b, c) =>
    c === 'peso'
      ? ((kg => (kg ? kg+'kg ' : '') + ((b%1000)? (b%1000)+'g' : '') || '0g')(Math.trunc(b/1000)))
    : c === 'volumen'
      ? ((l => (l ? l+'l ' : '') + ((b%1000)? (b%1000)+'ml' : '') || '0ml')(Math.trunc(b/1000)))
    : `${b.toFixed(0)}pz`;

  // PRODUCT INFO
  function buildProductInfo() {
    productInfo = {};
    almacenData.forEach(it => {
      const uni = it.unidadDeMedida.trim().toLowerCase();
      const cat = categoriaDe(uni);
      const base = parseFloat(it.cantidad)*FACTORES[uni] || 1;
      productInfo[it.codigo] = {
        priceBase: parseFloat(it.precio)/base || 0,
        categoria:  cat,
        opcionesUnidad: CATEGORIAS[cat],
        name: it.name,
        active: it.active !== false,
        proveedor: it.proveedor || 'Sin proveedor'
      };
    });
  }

  // RENDER STOCK
  function renderStockTable() {
    const grid = document.getElementById('stock-grid'); 
    const emptyState = document.getElementById('stock-empty');
    grid.innerHTML = '';
    
    const searchTerm = document.getElementById('stock-search').value.toLowerCase();
    const categoryFilter = document.getElementById('stock-category').value;
    const statusFilter = document.getElementById('stock-status').value;
    
    const compMap = {}, usedMap = {};
    
    comprasData.forEach(c => compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo)===String(it.codigo));
      rec && rec.ingredientes.forEach(ing =>
        usedMap[ing.codigo] = (usedMap[ing.codigo]||0) + ing.cantidad*FACTORES[ing.unidad]*it.cantidad
      );
    }));
    
    let hasItems = false;
    
    almacenData.forEach(it => {
      const info    = productInfo[it.codigo] || {};
      const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
      const bought  = compMap[it.codigo]||0;
      const used    = usedMap[it.codigo]||0;
      const remain  = bought - used;
      const pct     = recBase ? remain/recBase*100 : 0;
      const estado  = pct <= 30 ? 'status-low' 
                    : pct <= 50 ? 'status-medium'
                    : pct <=90 ? 'status-good'
                    :             'status-excess';
      const estadoText = pct <= 30 ? 'üî¥ Bajo'
                    : pct <= 50 ? 'üü† Medio'
                    : pct <=90 ? 'üü¢ Bueno'
                    :             'üîµ Excedente';
      const delta   = recBase - remain;
      const accion  = delta>0
        ? `Ordenar ${humanizeComposite(delta,info.categoria)}`
        : `Sobrante ${humanizeComposite(-delta,info.categoria)}`;
      
      // Calcular valor de reposici√≥n
      const valorReposicion = (delta * info.priceBase).toFixed(2);
      
      // Verificar si el producto est√° en uso
      const enUso = buscarRecetasConProducto(it.codigo).length > 0;
      
      // Filtrar por b√∫squeda
      const matchesSearch = it.name.toLowerCase().includes(searchTerm) || 
                           String(it.codigo).includes(searchTerm);
      
      // Filtrar por categor√≠a
      const matchesCategory = categoryFilter ? info.categoria === categoryFilter : true;
      
      // Filtrar por estado
      let matchesStatus = true;
      if (statusFilter === 'low' && pct > 30) matchesStatus = false;
      if (statusFilter === 'medium' && (pct <= 30 || pct > 50)) matchesStatus = false;
      if (statusFilter === 'good' && (pct <= 50 || pct > 90)) matchesStatus = false;
      if (statusFilter === 'excess' && pct <= 90) matchesStatus = false;
      if (statusFilter === 'inactive' && info.active) matchesStatus = false;
      
      if (!matchesSearch || !matchesCategory || !matchesStatus) return;
      
      hasItems = true;
      
      const item = document.createElement('div');
      item.className = 'product-card';
      item.innerHTML = `
        <div class="product-image">
          <i class="fas fa-box"></i>
        </div>
        <div class="product-body">
          <div class="product-title">${it.name} ${!info.active ? '<span class="status-badge status-low">Inactivo</span>' : ''}</div>
          <div class="product-subtitle">#${it.codigo} | ${it.unidadDeMedida}</div>
          <div class="product-subtitle">${humanizeComposite(remain,info.categoria)} disponibles</div>
          <div class="product-subtitle"><span class="status-badge ${estado}">${estadoText}</span></div>
          <div class="product-price">$${parseFloat(it.precio).toFixed(2)}</div>
        </div>
      `;
      
      item.addEventListener('click', () => {
        const card = document.createElement('div');
        card.className = 'card fade-in';
        card.innerHTML = `
          <div class="card-header">${it.name} ${!info.active ? '(Inactivo)' : ''}</div>
          <div class="card-body">
            <div class="card-row">
              <div class="card-label">C√≥digo</div>
              <div class="card-value">#${it.codigo}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Precio</div>
              <div class="card-value">
                <input class="form-input" type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Cantidad inicial</div>
              <div class="card-value">
                <input class="form-input" type="number" id="cant-${it.codigo}" value="${it.cantidad||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Unidad</div>
              <div class="card-value">
                <select class="form-select" id="unidad-${it.codigo}">
                  ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Stock recomendado</div>
              <div class="card-value">
                <input class="form-input" type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Proveedor</div>
              <div class="card-value">
                <input class="form-input" type="text" id="prov-${it.codigo}" value="${it.proveedor||''}">
              </div>
            </div>
            ${enUso ? `
            <div class="card-row">
              <div class="card-label">En uso en</div>
              <div class="card-value">
                <div class="status-badge status-medium">${buscarRecetasConProducto(it.codigo).length} recetas</div>
              </div>
            </div>` : ''}
            <div class="card-row">
              <div class="card-label">Comprado</div>
              <div class="card-value">${humanizeComposite(bought,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Usado</div>
              <div class="card-value">${humanizeComposite(used,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Restante</div>
              <div class="card-value">${humanizeComposite(remain,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Estado</div>
              <div class="card-value"><span class="status-badge ${estado}">${estadoText}</span></div>
            </div>
            <div class="card-row">
              <div class="card-label">Valor inventario</div>
              <div class="card-value">$${(remain * info.priceBase).toFixed(2)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Reposici√≥n necesaria</div>
              <div class="card-value">${accion}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Valor reposici√≥n</div>
              <div class="card-value">$${valorReposicion}</div>
            </div>
            <div class="form-row mt-15">
              <div class="form-group">
                <label class="form-label">Comprar cantidad</label>
                <input class="form-input" type="number" id="buyqty-${it.codigo}" value="1" min="0" step="0.1">
              </div>
              <div class="form-group">
                <label class="form-label">Unidad</label>
                <select class="form-select" id="buyunit-${it.codigo}">
                  ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-icon btn-primary" onclick="buyProduct('${it.codigo}')">
                <i class="fas fa-cart-plus"></i>
              </button>
              <button class="btn btn-icon btn-primary" onclick="saveAlmacen('${it.codigo}')">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-icon btn-danger" onclick="deleteAlmacen('${it.codigo}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        
        modal.show({
          title: 'Detalle de Producto',
          message: card.innerHTML
        });
      });
      
      grid.appendChild(item);
    });
    
    emptyState.style.display = hasItems ? 'none' : 'block';
  }

  // Buscar recetas que usan un producto
  function buscarRecetasConProducto(codigoProducto) {
    return cocData.filter(receta => 
      receta.ingredientes.some(ing => ing.codigo == codigoProducto && parseFloat(ing.cantidad) > 0)
    ).map(receta => receta.nombre);
  }
  
  // ACCIONES STOCK/COMPRAS
  async function addNewProducto() {
    almacenData.push({ 
      codigo: Date.now(), 
      name:'Nuevo Producto', 
      precio:0, 
      cantidad:0, 
      unidadDeMedida:'pz', 
      stockRecomendado:0, 
      proveedor:'',
      active: true
    });
    buildProductInfo(); 
    renderStockTable();
    showNotification('Producto creado', 'Puedes editar los detalles del nuevo producto', 'success');
  }
  
  async function saveAlmacen(codigo) {
    const name = document.getElementById(`name-${codigo}`)?.value.trim() || 'Nuevo Producto';
    
    await postOpNotify('guardarAlmacen', {
      codigo,
      name,
      precio: document.getElementById(`precio-${codigo}`).value,
      cantidad: document.getElementById(`cant-${codigo}`).value,
      unidadDeMedida: document.getElementById(`unidad-${codigo}`).value,
      stockRecomendado: document.getElementById(`rec-${codigo}`).value,
      proveedor: document.getElementById(`prov-${codigo}`).value
    }, 'Almac√©n actualizado');
    await loadData();
    showNotification('Producto actualizado', 'Los cambios se han guardado correctamente', 'success');
  }
  
  async function deleteAlmacen(codigo) {
    // Buscar recetas que usan este producto
    const recetasQueLoUsan = buscarRecetasConProducto(codigo);
    
    if (recetasQueLoUsan.length > 0) {
      const message = `
        <div class="card">
          <div class="card-header">¬°Advertencia!</div>
          <div class="card-body">
            <p>Este producto est√° siendo usado en las siguientes recetas:</p>
            <ul style="padding-left: 20px; margin: 10px 0;">
              ${recetasQueLoUsan.map(r => `<li>${r}</li>`).join('')}
            </ul>
            <p>Si contin√∫a, el producto se marcar√° como inactivo y en las recetas su cantidad se establecer√° a 0.</p>
          </div>
        </div>
        <p>¬øDesea continuar con la eliminaci√≥n?</p>
      `;
      
      const ok = await showConfirm(message);
      if (!ok) return;
      
      // Actualizar las recetas: poner a 0 la cantidad de este ingrediente
      for (const receta of cocData) {
        if (receta.ingredientes.some(ing => ing.codigo == codigo)) {
          receta.ingredientes = receta.ingredientes.map(ing => {
            if (ing.codigo == codigo) {
              return { ...ing, cantidad: 0 };
            }
            return ing;
          });
          await postOp('guardarCocina', {
            codigo: receta.codigo,
            nombre: receta.nombre,
            categoria: receta.categoria,
            imagen: receta.imagen || '',
            ingredientes: JSON.stringify(receta.ingredientes)
          });
        }
      }
      
      // Marcar el producto como inactivo
      const producto = almacenData.find(p => p.codigo == codigo);
      if (producto) {
        producto.active = false;
        await postOpNotify('guardarAlmacen', {
          codigo,
          name: producto.name,
          precio: producto.precio,
          cantidad: producto.cantidad,
          unidadDeMedida: producto.unidadDeMedida,
          stockRecomendado: producto.stockRecomendado,
          proveedor: producto.proveedor,
          active: false
        }, 'Producto marcado como inactivo');
      }
    } else {
      const ok = await showConfirm(`¬øEliminar producto ${codigo}?`);
      if (!ok) return;
      await postOpNotify('eliminarAlmacen',{codigo},'Producto eliminado');
    }
    
    await loadData();
    showNotification('Producto eliminado', 'El producto ha sido eliminado del inventario', 'success');
  }
  
  async function buyProduct(id) {
    const info = productInfo[id];
    const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value) || 0;
    if (qty <= 0) {
      return showAlert('La cantidad debe ser mayor que cero');
    }
    const uni   = document.getElementById(`buyunit-${id}`).value;
    const total = (info.priceBase * qty * FACTORES[uni]).toFixed(0);
    const fecha = new Date().toISOString().slice(0,10);
    await postOpNotify('guardarCompras',{ 
      idProducto: id,
      fecha,
      name: almacenData.find(x => x.codigo == id).name,
      precio: total,
      cantidad: qty,
      unidad: uni
    },'Compra registrada');
    await loadData();
    showNotification('Compra registrada', 'El producto ha sido a√±adido al inventario', 'success');
  }

  // RENDER COMPRAS
  function renderComprasTable() {
    const list = document.getElementById('compras-list'); 
    const emptyState = document.getElementById('purchase-empty');
    list.innerHTML = '';
    
    const searchTerm = document.getElementById('purchase-search').value.toLowerCase();
    const supplierFilter = document.getElementById('purchase-supplier').value;
    const fromDate = document.getElementById('purchase-from').value;
    const toDate = document.getElementById('purchase-to').value;
    
    let hasItems = false;
    
    comprasData.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach(c => {
      const prod = almacenData.find(x=>x.codigo==c.idProducto);
      if (!prod) return;
      const info  = productInfo[c.idProducto] || {};
      const total = (info.priceBase * c.cantidad * FACTORES[c.unidad]).toFixed(2);
      
      // Filtrar por b√∫squeda
      const matchesSearch = prod.name.toLowerCase().includes(searchTerm) || 
                           String(c.idCompra).includes(searchTerm);
      
      // Filtrar por proveedor
      const matchesSupplier = supplierFilter ? prod.proveedor === supplierFilter : true;
      
      // Filtrar por fecha
      const compDate = new Date(c.fecha);
      const matchesDate = (!fromDate || compDate >= new Date(fromDate)) && 
                         (!toDate || compDate <= new Date(toDate));
      
      if (!matchesSearch || !matchesSupplier || !matchesDate) return;
      
      hasItems = true;
      
      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <div>
          <div class="list-title">${prod.name}</div>
          <div class="list-subtitle">Compra #${c.idCompra}</div>
          <div class="list-subtitle">${new Date(c.fecha).toLocaleDateString()}</div>
        </div>
        <div>
          <div class="list-title">${c.cantidad}${c.unidad}</div>
          <div class="list-subtitle">$${total}</div>
        </div>
      `;
      
      item.addEventListener('click', () => {
        const card = document.createElement('div');
        card.className = 'card fade-in';
        card.innerHTML = `
          <div class="card-header">Detalle de Compra #${c.idCompra}</div>
          <div class="card-body">
            <div class="card-row">
              <div class="card-label">Producto</div>
              <div class="card-value">${prod.name}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Fecha</div>
              <div class="card-value">
                <input class="form-input" type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Cantidad</div>
              <div class="card-value">
                <input class="form-input" type="number" id="qty-${c.idCompra}" value="${c.cantidad}" min="0" step="0.1">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Unidad</div>
              <div class="card-value">
                <select class="form-select" id="unit-${c.idCompra}">
                  ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Total</div>
              <div class="card-value">$${total}</div>
            </div>
            <div class="card-actions">
              <button class="btn btn-icon btn-primary" onclick="saveCompra('${c.idCompra}','${c.idProducto}')">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-icon btn-danger" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        
        modal.show({
          title: 'Editar Compra',
          message: card.innerHTML
        });
      });
      
      list.appendChild(item);
    });
    
    emptyState.style.display = hasItems ? 'none' : 'block';
  }
  
  async function saveCompra(idC,idP) {
    const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
    if (qty<=0) {
      return showAlert('La cantidad debe ser mayor que cero');
    }
    const uni   = document.getElementById(`unit-${idC}`).value;
    const fecha = document.getElementById(`date-${idC}`).value;
    await postOpNotify('guardarCompras',{
      idCompra:idC, idProducto:idP, fecha, cantidad:qty, unidad:uni,
      name:almacenData.find(x=>x.codigo==idP).name,
      precio:(productInfo[idP].priceBase*qty*FACTORES[uni]).toFixed(0)
    }, 'Compra guardada');
    await loadData();
    showNotification('Compra actualizada', 'Los cambios se han guardado correctamente', 'success');
  }
  
  async function deleteCompra(idC,idP) {
    const ok = await showConfirm(`¬øEliminar compra ${idC}?`);
    if (!ok) return;
    await postOpNotify('eliminarCompras',{idCompra:idC,idProducto:idP},'Compra eliminada');
    await loadData();
    showNotification('Compra eliminada', 'La compra ha sido eliminada del historial', 'success');
  }

  // NAVEGACI√ìN
  function cambiarSeccion(sec) {
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`.nav-btn[data-sec="${sec}"]`).classList.add('active');
    document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
    document.getElementById(sec).classList.add('active');
    window.scrollTo(0, 0);
    
    // Actualizar datos espec√≠ficos de la secci√≥n
    if (sec === 'dashboard') {
      updateDashboard();
    }
  }

  // VENTAS
  function crearItemRow(cod = '', cant = '', tot = '') {
    const row = document.createElement('div'); 
    row.className = 'form-row';
    row.innerHTML = `
      <select class="form-select" onchange="recalcRow(this)" style="flex: 2;">
        ${recetas.map(r => `<option value="${r.codigo}" ${r.codigo===cod?'selected':''}>${r.nombre}</option>`).join('')}
      </select>
      <input class="form-input" type="number" min="1" value="${cant}" placeholder="Cant" oninput="recalcRow(this)">
      <input class="form-input" type="number" value="${tot}" placeholder="Total" readonly>
      <button class="btn btn-icon btn-danger" type="button" onclick="this.parentNode.remove(); updateSaleTotal()">
        <i class="fas fa-times"></i>
      </button>
    `;
    return row;
  }
  
  function recalcRow(el) {
    const row = el.closest('.form-row');
    const sel    = row.children[0];
    const inpCant= row.children[1];
    const inpTot = row.children[2];
    const rec = recetas.find(x => x.codigo === sel.value) || { precio: 0 };
    inpTot.value = (Number(rec.precio) * Number(inpCant.value || 0)).toFixed(2);
    updateSaleTotal();
  }
  
  function agregarItemVenta() {
    document.getElementById('items-container').append(crearItemRow());
    updateSaleTotal();
  }
  
  function updateSaleTotal() {
    let total = 0;
    document.querySelectorAll('#items-container .form-row').forEach(row => {
      const totalInput = row.querySelector('input[type="number"]:last-child');
      total += parseFloat(totalInput.value) || 0;
    });
    document.getElementById('sale-total').textContent = total.toFixed(2);
  }
  
  function renderTicketCard(v) {
    const fechaStr = new Date(v.fecha).toLocaleDateString();
    const itemsHtml = v.venta.map(it => `<div class="card-row"><div>${it.producto} x${it.cantidad}</div><div>$${it.total}</div></div>`).join('');
    const total = v.venta.reduce((sum,i) => sum + Number(i.total), 0).toFixed(2);
    
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div>
        <div class="list-title">Venta #${v.id}</div>
        <div class="list-subtitle">${fechaStr} | ${v.metodoPago}</div>
        <div class="list-subtitle">${v.venta.length} productos</div>
      </div>
      <div>
        <div class="list-title">$${total}</div>
      </div>
    `;
    
    item.addEventListener('click', () => {
      const card = document.createElement('div');
      card.className = 'card fade-in';
      card.innerHTML = `
        <div class="card-header">Venta #${v.id}</div>
        <div class="card-body">
          <div class="card-row">
            <div class="card-label">Fecha</div>
            <div class="card-value">${fechaStr}</div>
          </div>
          <div class="card-row">
            <div class="card-label">M√©todo de pago</div>
            <div class="card-value">${v.metodoPago}</div>
          </div>
          <div class="card-row">
            <div class="card-label">Productos</div>
            <div class="card-value"></div>
          </div>
          ${itemsHtml}
          <div class="card-row">
            <div class="card-label">Total</div>
            <div class="card-value">$${total}</div>
          </div>
          <div class="card-actions">
            <button class="btn btn-primary" onclick='startEdit(${JSON.stringify(v)})'>Editar</button>
            <button class="btn btn-danger" onclick="eliminarVenta('${v.id}')">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        </div>
      `;
      
      modal.show({
        title: 'Detalle de Venta',
        message: card.innerHTML
      });
    });
    
    return item;
  }
  
  async function cargarVentas() {
    await fetchRecetas();
    const res = await callApi({op:'obtenerVentas'});
    ventData = res.status==='success'?res.data:ventData;
    const list = document.getElementById('tickets-list'); 
    const emptyState = document.getElementById('sale-empty');
    list.innerHTML='';
    
    const searchTerm = document.getElementById('sale-search').value.toLowerCase();
    const paymentFilter = document.getElementById('sale-payment').value;
    const fromDate = document.getElementById('sale-from').value;
    const toDate = document.getElementById('sale-to').value;
    
    let hasItems = false;
    
    ventData.forEach(v => {
      // Filtrar por b√∫squeda
      const matchesSearch = v.id.toString().includes(searchTerm) || 
                           v.venta.some(item => item.producto.toLowerCase().includes(searchTerm));
      
      // Filtrar por m√©todo de pago
      const matchesPayment = paymentFilter ? v.metodoPago === paymentFilter : true;
      
      // Filtrar por fecha
      const saleDate = new Date(v.fecha);
      const matchesDate = (!fromDate || saleDate >= new Date(fromDate)) && 
                         (!toDate || saleDate <= new Date(toDate));
      
      if (!matchesSearch || !matchesPayment || !matchesDate) return;
      
      hasItems = true;
      list.append(renderTicketCard(v));
    });
    
    actualizarResumen(ventData);
    emptyState.style.display = hasItems ? 'none' : 'block';
  }
  
  function startEdit(v) {
    document.getElementById('form-id').value      = v.id;
    document.getElementById('form-fecha').value   = new Date(v.fecha).toISOString().slice(0,10);
    document.getElementById('form-pago').value    = v.metodoPago;
    const cont = document.getElementById('items-container'); cont.innerHTML = '';
    v.venta.forEach(itm => cont.append(crearItemRow(itm.codigo, itm.cantidad, itm.total)));
    modal.backdrop.classList.remove('show');
    cambiarSeccion('ventas');
    updateSaleTotal();
  }
  
  function resetForm() {
    document.getElementById('form-id').value = '';
    document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
    document.getElementById('form-pago').value = 'Efectivo';
    document.getElementById('items-container').innerHTML = '';
    updateSaleTotal();
  }
  
  // ACTUALIZAR RESUMEN DE VENTAS
  function actualizarResumen(vs) {
    let e = 0, t = 0, ta = 0;
    vs.forEach(v => {
      if (v.metodoPago === 'Efectivo') e += v.venta.reduce((sum, i) => sum + Number(i.total), 0);
      else if (v.metodoPago === 'Transferencia') t += v.venta.reduce((sum, i) => sum + Number(i.total), 0);
      else ta += v.venta.reduce((sum, i) => sum + Number(i.total), 0);
    });
    document.getElementById('sum-efectivo').textContent = e.toFixed(2);
    document.getElementById('sum-transferencia').textContent = t.toFixed(2);
    document.getElementById('sum-tarjeta').textContent = ta.toFixed(2);
    document.getElementById('sum-total').textContent = (e + t + ta).toFixed(2);
  }
  
  async function guardarVenta() {
    const fecha = document.getElementById('form-fecha').value;
    const rows = document.querySelectorAll('#items-container .form-row');
    
    if (!fecha) {
      return await showAlert('Selecciona fecha');
    }
    
    if (!rows.length) {
      return await showAlert('Agrega al menos un producto');
    }
    
    const ventaItems = Array.from(rows).map(row => {
      const sel = row.querySelector('select');
      const inpCant = row.querySelector('input[type="number"]:first-child');
      const inpTot = row.querySelector('input[type="number"]:last-child');
      const rec = recetas.find(x => x.codigo === sel.value) || { nombre: '', precio: 0 };
      return { codigo: sel.value, producto: rec.nombre, cantidad: Number(inpCant.value) || 0, total: Number(inpTot.value) || 0 };
    });
    
    const payload = {
      id: document.getElementById('form-id').value,
      fecha,
      metodoPago: document.getElementById('form-pago').value,
      venta: ventaItems,
      items: ventaItems
    };
    
    await postOpNotify('guardarVentas', { venta: JSON.stringify(payload) }, 'Venta guardada');
    resetForm();
    await loadData();
    showNotification('Venta registrada', 'La venta ha sido guardada correctamente', 'success');
  }
  
  async function eliminarVenta(id) {
    const ok = await showConfirm('¬øEliminar venta?');
    if (!ok) return;
    await postOpNotify('eliminarVentas',{id},'Venta eliminada');
    await loadData();
    showNotification('Venta eliminada', 'La venta ha sido eliminada del historial', 'success');
  }

  // RECETAS
  async function fetchRecetas() {
    const cocR = await callApi({ op: 'obtenerCocina' });
    if (cocR.status === 'success') {
      cocData = cocR.data.map(r => ({
        ...r,
        ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
      }));
    }
    recetas = cocData.map(r => {
      const costo = r.ingredientes.reduce((sum, ing) => {
        const p = almacenData.find(x => String(x.codigo) === String(ing.codigo));
        if (!p) return sum;
        const basePrice = p.precio / (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad);
        return sum + basePrice * (FACTORES[ing.unidad.trim().toLowerCase()] * ing.cantidad);
      }, 0);
      return {
        codigo: r.codigo,
        nombre: r.nombre,
        precio: (costo * MARGEN).toFixed(2),
        categoria: r.categoria,
        costo: costo
      };
    });
  }

  async function cargarRecetas() {
    await fetchRecetas();
    recetasData = cocData;
    mostrarRecetas();
  }

  function mostrarRecetas() {
    const grid = document.getElementById('recetas-list'); 
    const emptyState = document.getElementById('recipe-empty');
    grid.innerHTML = '';
    
    const searchTerm = document.getElementById('recipe-search').value.toLowerCase();
    const categoryFilter = document.getElementById('recipe-category').value.toLowerCase();
    const sortBy = document.getElementById('recipe-sort').value;
    
    // Filtrar recetas
    let filteredRecipes = recetasData.filter(r => {
      const matchesSearch = r.nombre.toLowerCase().includes(searchTerm) || 
                           r.codigo.toLowerCase().includes(searchTerm);
      const matchesCategory = categoryFilter ? r.categoria.toLowerCase().includes(categoryFilter) : true;
      return matchesSearch && matchesCategory;
    });
    
    // Ordenar recetas
    filteredRecipes.sort((a, b) => {
      if (sortBy === 'name') return a.nombre.localeCompare(b.nombre);
      if (sortBy === 'popularity') {
        const aSales = ventData.reduce((sum, v) => sum + v.venta.filter(i => i.codigo === a.codigo).length, 0);
        const bSales = ventData.reduce((sum, v) => sum + v.venta.filter(i => i.codigo === b.codigo).length, 0);
        return bSales - aSales;
      }
      if (sortBy === 'cost') {
        const aCost = recetas.find(r => r.codigo === a.codigo)?.costo || 0;
        const bCost = recetas.find(r => r.codigo === b.codigo)?.costo || 0;
        return bCost - aCost;
      }
      if (sortBy === 'price') {
        const aPrice = recetas.find(r => r.codigo === a.codigo)?.precio || 0;
        const bPrice = recetas.find(r => r.codigo === b.codigo)?.precio || 0;
        return bPrice - aPrice;
      }
      return 0;
    });
    
    filteredRecipes.forEach(r => {
      const recetaInfo = recetas.find(x => x.codigo === r.codigo) || {};
      
      const item = document.createElement('div');
      item.className = 'product-card';
      item.innerHTML = `
        <div class="product-image" style="${r.imagen ? `background-image: url('${r.imagen}'); background-size: cover;` : ''}">
          ${!r.imagen ? `<i class="fas fa-utensils"></i>` : ''}
        </div>
        <div class="product-body">
          <div class="product-title">${r.nombre}</div>
          <div class="product-subtitle">#${r.codigo} | ${r.categoria}</div>
          <div class="product-subtitle">${r.ingredientes.length} ingredientes</div>
          <div class="product-price">$${recetaInfo.precio || '0.00'}</div>
        </div>
      `;
      
      item.addEventListener('click', () => {
        const ingredientesHtml = r.ingredientes
          .map(i => {
            const p = almacenData.find(x => String(x.codigo) === String(i.codigo));
            const c = p ? (p.precio / (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad))* 
                        (FACTORES[i.unidad.trim().toLowerCase()] * i.cantidad) : 0;
            
            // Estado del producto seg√∫n productInfo
            const infoProd = productInfo[p?.codigo] || {};
            const estado = p
              ? (infoProd.active
                  ? ''
                  : '<span class="status-badge status-low">Inactivo</span>')
              : '<span class="status-badge status-low">No encontrado</span>';

            // Nombre del producto o c√≥digo si no se encuentra
            const nombreProducto = p ? p.name : `Producto ${i.codigo}`;
            
            return `
            <div class="card-row">
              <div>
                <div>${nombreProducto} ${estado}</div>
                <div class="list-subtitle">${i.cantidad}${i.unidad} | #${i.codigo}</div>
              </div>
              <div class="card-value">$${c.toFixed(2)}</div>
            </div>`;
          })
          .join('');

        const card = document.createElement('div');
        card.className = 'card fade-in';
        card.innerHTML = `
          <div class="card-header">${r.nombre}</div>
          <div class="card-body">
            <div class="card-row">
              <div class="card-label">C√≥digo</div>
              <div class="card-value">${r.codigo}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Categor√≠a</div>
              <div class="card-value">${r.categoria}</div>
            </div>
            ${r.imagen ? `<div class="card-row"><div colspan="2"><img src="${r.imagen}" style="max-width:100%; border-radius:8px;"></div></div>` : ''}
            <div class="card-row">
              <div class="card-label">Ingredientes</div>
              <div class="card-value"></div>
            </div>
            ${ingredientesHtml}
            <div class="card-row">
              <div class="card-label">Costo total</div>
              <div class="card-value">$${recetaInfo.costo?.toFixed(2) || '0.00'}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Precio de venta</div>
              <div class="card-value">$${recetaInfo.precio || '0.00'}</div>
            </div>
            <div class="card-actions">
              <button class="btn btn-primary" onclick='cargarEnForm(${JSON.stringify(r)})'>Editar</button>
              <button class="btn btn-danger" onclick="eliminarReceta('${r.codigo}')">
                <i class="fas fa-trash"></i> Eliminar
              </button>
            </div>
          </div>
        `;
        
        modal.show({
          title: 'Detalle de Receta',
          message: card.innerHTML
        });
      });
      
      grid.appendChild(item);
    });
    
    emptyState.style.display = filteredRecipes.length ? 'none' : 'block';
  }

  function cargarEnForm(r) {
    editMode = true;
    document.getElementById('receta-codigo').value = r.codigo;
    document.getElementById('receta-nombre').value = r.nombre;
    document.getElementById('receta-categoria').value = r.categoria;
    document.getElementById('receta-imagen').value = r.imagen || '';
    
    const cont = document.getElementById('ingredientes-container');
    cont.innerHTML = '';
    r.ingredientes.forEach(i => agregarFila(i));
    
    modal.backdrop.classList.remove('show');
    cambiarSeccion('recetas');
  }

  async function guardarReceta() {
    const cod = document.getElementById('receta-codigo').value.trim();
    const nom = document.getElementById('receta-nombre').value.trim();
    const cat = document.getElementById('receta-categoria').value;
    
    if (!cod || !nom || !cat) {
      return showAlert('Completa todos los campos obligatorios');
    }
    
    const ingredientes = Array.from(
      document.getElementById('ingredientes-container').querySelectorAll('.form-row')
    ).map(row => {
      const [selP, inpC, selU] = row.children;
      return {
        codigo: selP.value,
        cantidad: Number(inpC.value) || 0,
        unidad: selU.value
      };
    });
    
    if (ingredientes.length === 0) {
      return showAlert('Agrega al menos un ingrediente');
    }
    
    const receta = {
      codigo: cod,
      nombre: nom,
      categoria: cat,
      imagen: document.getElementById('receta-imagen').value.trim(),
      ingredientes: ingredientes
    };
    
    await postOpNotify(
      'guardarCocina',
      {
        codigo: cod,
        nombre: nom,
        categoria: cat,
        imagen: document.getElementById('receta-imagen').value.trim(),
        ingredientes: JSON.stringify(ingredientes)
      },
      'Receta guardada'
    );

    await cargarRecetas();
    limpiarForm();
    showNotification('Receta guardada', 'Los cambios se han guardado correctamente', 'success');
  }

  async function eliminarReceta(codigo) {
    const ok = await showConfirm(`¬øEliminar receta ${codigo}?`);
    if (!ok) return;
    await postOpNotify('eliminarCocina', { codigo }, 'Receta eliminada');
    await cargarRecetas();
    showNotification('Receta eliminada', 'La receta ha sido eliminada del sistema', 'success');
  }

  function agregarFila(item = {}) {
    const cont = document.getElementById('ingredientes-container');
    const row = document.createElement('div');
    row.className = 'form-row';

    // 1) Construimos el <select> de productos
    const opcionesProductos = almacenData
      .map(p => `<option value="${p.codigo}">${p.name}</option>`)
      .join('');

    row.innerHTML = `
      <select class="form-select producto-select">
        <option value="">-- Seleccione --</option>
        ${opcionesProductos}
      </select>
      <input class="form-input cantidad-input" type="number" min="0.1" step="0.1" value="${item.cantidad || 1}" placeholder="Cant">
      <select class="form-select unidad-select">
        <option value="">-- Unidad --</option>
        <!-- Aqu√≠ iremos inyectando din√°micamente -->
      </select>
      <button class="btn btn-icon btn-danger" type="button">
        <i class="fas fa-times"></i>
      </button>
    `;

    // 2) Referencias a los selects y al input
    const productoSelect = row.querySelector('.producto-select');
    const unidadSelect   = row.querySelector('.unidad-select');
    const cantidadInput  = row.querySelector('.cantidad-input');
    const btnRemove      = row.querySelector('button');

    // 3) Funci√≥n para poblar las unidades seg√∫n productInfo
    function poblarUnidades(codigoProducto, unidadInicial = '') {
      unidadSelect.innerHTML = ''; 
      if (!codigoProducto || !productInfo[codigoProducto]) {
        unidadSelect.innerHTML = `<option value="">-- Unidad --</option>`;
        return;
      }
      const opciones = productInfo[codigoProducto].opcionesUnidad;
      unidadSelect.innerHTML = opciones
        .map(u => `<option value="${u}"${u === unidadInicial ? ' selected' : ''}>${u}</option>`)
        .join('');
    }

    // 4) Cuando cambie el producto, actualizamos unidades
    productoSelect.addEventListener('change', () => {
      poblarUnidades(productoSelect.value);
    });

    // 5) Si estamos en modo edici√≥n (item trae c√≥digo y unidad), preseleccionamos
    if (item.codigo) {
      productoSelect.value = item.codigo;
      poblarUnidades(item.codigo, item.unidad);
      cantidadInput.value = item.cantidad || 1;
    }

    // 6) Remover fila
    btnRemove.addEventListener('click', () => row.remove());

    cont.appendChild(row);
  }

  function limpiarForm() {
    editMode = false;
    document.getElementById('receta-codigo').value = '';
    document.getElementById('receta-nombre').value = '';
    document.getElementById('receta-categoria').value = '';
    document.getElementById('receta-imagen').value = '';
    document.getElementById('ingredientes-container').innerHTML = '';
  }

  // DASHBOARD
  function updateDashboard() {
    // Actualizar valores principales
    let totalInv = 0, totalCompras = 0, totalRestock = 0;
    const compMap = {}, usedMap = {};

    // Calcular compras
    comprasData.forEach(c => {
      compMap[c.idProducto] = (compMap[c.idProducto] || 0) + c.cantidad * FACTORES[c.unidad];
      const infoC = productInfo[c.idProducto] || { priceBase: 0 };
      totalCompras += infoC.priceBase * c.cantidad * FACTORES[c.unidad];
    });

    // Calcular uso en ventas
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo] || 0) + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
      });
    }));

    // Calcular inventario y reposici√≥n
    let lowStockCount = 0;
    almacenData.forEach(it => {
      const infoI = productInfo[it.codigo] || { priceBase: 0 };
      const bought = compMap[it.codigo] || 0;
      const used   = usedMap[it.codigo] || 0;
      const remain = bought - used;

      totalInv += remain * infoI.priceBase;

      const recBase = (parseFloat(it.stockRecomendado) || 0) * FACTORES[it.unidadDeMedida];
      const pct = recBase ? remain/recBase*100 : 0;
      if (pct <= 30) lowStockCount++;
      
      const delta   = recBase - remain;
      if (delta > 0) {
        totalRestock += delta * infoI.priceBase;
      }
    });

    // Actualizar UI
    document.getElementById('dashboard-inventory').textContent = totalInv.toFixed(2);
    document.getElementById('dashboard-sales').textContent = ventData.reduce((sum, v) => 
      sum + v.venta.reduce((s, i) => s + Number(i.total), 0), 0).toFixed(2);
    document.getElementById('dashboard-low-stock').textContent = lowStockCount;
    
    // Receta m√°s popular
    let topRecipe = '-';
    let maxSales = 0;
    recetas.forEach(r => {
      const sales = ventData.reduce((sum, v) => 
        sum + v.venta.filter(i => i.codigo === r.codigo).length, 0);
      if (sales > maxSales) {
        maxSales = sales;
        topRecipe = r.nombre;
      }
    });
    document.getElementById('dashboard-top-recipe').textContent = topRecipe;
    
    // Actualizar gr√°ficos
    updateCharts();
  }
  
  function updateCharts() {
    // Datos para gr√°fico de ventas por d√≠a (√∫ltimos 7 d√≠as)
    const today = new Date();
    const dates = [];
    const salesData = [];
    
    for (let i = 6; i >= 0; i--) {
      const date = new Date();
      date.setDate(today.getDate() - i);
      const dateStr = date.toISOString().slice(0,10);
      dates.push(date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' }));
      
      const daySales = ventData.filter(v => v.fecha.slice(0,10) === dateStr)
        .reduce((sum, v) => sum + v.venta.reduce((s, i) => s + Number(i.total), 0), 0);
      salesData.push(daySales);
    }
    
    // Gr√°fico de ventas
    const salesCtx = document.getElementById('sales-chart').getContext('2d');
    if (salesChart) salesChart.destroy();
    
    salesChart = new Chart(salesCtx, {
      type: 'bar',
      data: {
        labels: dates,
        datasets: [{
          label: 'Ventas ($)',
          data: salesData,
          backgroundColor: 'rgba(108, 92, 231, 0.7)',
          borderColor: 'rgba(108, 92, 231, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: 'rgba(0,0,0,0.05)'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      }
    });
    
    // Datos para gr√°fico de m√©todos de pago
    const paymentMethods = ['Efectivo', 'Transferencia', 'Tarjeta'];
    const paymentData = paymentMethods.map(method => 
      ventData.filter(v => v.metodoPago === method)
        .reduce((sum, v) => sum + v.venta.reduce((s, i) => s + Number(i.total), 0), 0)
    );
    
    // Gr√°fico de m√©todos de pago
    const paymentCtx = document.getElementById('payment-chart').getContext('2d');
    if (paymentChart) paymentChart.destroy();
    
    paymentChart = new Chart(paymentCtx, {
      type: 'doughnut',
      data: {
        labels: paymentMethods,
        datasets: [{
          data: paymentData,
          backgroundColor: [
            'rgba(0, 184, 148, 0.7)',
            'rgba(108, 92, 231, 0.7)',
            'rgba(255, 118, 117, 0.7)'
          ],
          borderColor: [
            'rgba(0, 184, 148, 1)',
            'rgba(108, 92, 231, 1)',
            'rgba(255, 118, 117, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }

  // EXPORTAR DATOS
  function exportStock() {
    let csv = 'C√≥digo,Nombre,Precio,Cantidad,Unidad,Stock Recomendado,Proveedor,Estado\n';
    
    almacenData.forEach(p => {
      const info = productInfo[p.codigo] || {};
      const estado = info.active ? 'Activo' : 'Inactivo';
      csv += `"${p.codigo}","${p.name}",${p.precio},${p.cantidad},"${p.unidadDeMedida}",${p.stockRecomendado},"${p.proveedor || ''}","${estado}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'stock_export.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('Exportaci√≥n completada', 'El inventario se ha exportado como CSV', 'success');
  }

  // ACTUALIZAR ESTAD√çSTICAS SUPERIORES
  function updateTopStats() {
    let totalInv = 0, totalCompras = 0, totalRestock = 0;
    const compMap = {}, usedMap = {};

    // Calcular compras
    comprasData.forEach(c => {
      compMap[c.idProducto] = (compMap[c.idProducto] || 0) + c.cantidad * FACTORES[c.unidad];
      const infoC = productInfo[c.idProducto] || { priceBase: 0 };
      totalCompras += infoC.priceBase * c.cantidad * FACTORES[c.unidad];
    });

    // Calcular uso en ventas
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo] || 0) + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
      });
    }));

    // Calcular inventario y reposici√≥n
    almacenData.forEach(it => {
      const infoI = productInfo[it.codigo] || { priceBase: 0 };
      const bought = compMap[it.codigo] || 0;
      const used   = usedMap[it.codigo] || 0;
      const remain = bought - used;

      totalInv += remain * infoI.priceBase;

      const recBase = (parseFloat(it.stockRecomendado) || 0) * FACTORES[it.unidadDeMedida];
      const delta   = recBase - remain;
      if (delta > 0) {
        totalRestock += delta * infoI.priceBase;
      }
    });

    document.getElementById('stat-inventory').textContent   = totalInv.toFixed(2);
    document.getElementById('stat-purchases').textContent   = totalCompras.toFixed(2);
    document.getElementById('stat-restock').textContent     = totalRestock.toFixed(2);
    
    // Actualizar badge de compras (productos con stock bajo)
    let lowStockCount = 0;
    almacenData.forEach(it => {
      const recBase = (parseFloat(it.stockRecomendado) || 0) * FACTORES[it.unidadDeMedida];
      const bought  = compMap[it.codigo]||0;
      const used    = usedMap[it.codigo]||0;
      const remain  = bought - used;
      const pct     = recBase ? remain/recBase*100 : 0;
      if (pct <= 30) lowStockCount++;
    });
    
    const purchaseBadge = document.getElementById('purchase-badge');
    if (lowStockCount > 0) {
      purchaseBadge.textContent = lowStockCount;
      purchaseBadge.style.display = 'flex';
    } else {
      purchaseBadge.style.display = 'none';
    }
  }

  // CARGA GENERAL
  async function loadData() {
    const [alm, comp, vent, coc] = await Promise.all([
      callApi({op:'obtenerAlmacen'}),
      callApi({op:'obtenerCompras'}),
      callApi({op:'obtenerVentas'}),
      callApi({op:'obtenerCocina'})
    ]);
    almacenData = alm.data; 
    comprasData = comp.data; 
    ventData = vent.data;
    if (coc.status === 'success') {
      cocData = coc.data.map(r => ({
        ...r,
        ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
      }));
    }
    buildProductInfo();
    renderStockTable();
    renderComprasTable();
    await cargarVentas();
    await cargarRecetas();
    updateTopStats();
    
    // Actualizar proveedores en filtro
    const supplierSelect = document.getElementById('purchase-supplier');
    const suppliers = [...new Set(almacenData.map(p => p.proveedor).filter(p => p))];
    supplierSelect.innerHTML = '<option value="">Todos los proveedores</option>' + 
      suppliers.map(s => `<option value="${s}">${s}</option>`).join('');
    
    if (document.getElementById('dashboard').classList.contains('active')) {
      updateDashboard();
    }
  }

  // Inicializaci√≥n
  window.onload = async () => {
    resetForm();
    document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
    
    // Configurar eventos de filtros
    document.getElementById('stock-search').addEventListener('input', renderStockTable);
    document.getElementById('stock-category').addEventListener('change', renderStockTable);
    document.getElementById('stock-status').addEventListener('change', renderStockTable);
    
    document.getElementById('purchase-search').addEventListener('input', renderComprasTable);
    document.getElementById('purchase-supplier').addEventListener('change', renderComprasTable);
    document.getElementById('purchase-from').addEventListener('change', renderComprasTable);
    document.getElementById('purchase-to').addEventListener('change', renderComprasTable);
    
    document.getElementById('sale-search').addEventListener('input', cargarVentas);
    document.getElementById('sale-payment').addEventListener('change', cargarVentas);
    document.getElementById('sale-from').addEventListener('change', cargarVentas);
    document.getElementById('sale-to').addEventListener('change', cargarVentas);
    
    document.getElementById('recipe-search').addEventListener('input', mostrarRecetas);
    document.getElementById('recipe-category').addEventListener('input', mostrarRecetas);
    document.getElementById('recipe-sort').addEventListener('change', mostrarRecetas);
    
    document.getElementById('dashboard-range').addEventListener('change', function() {
      document.getElementById('custom-dates').style.display = 
        this.value === 'custom' ? 'block' : 'none';
    });
    
    await loadData();
  };
</script>
</body>
</html>
