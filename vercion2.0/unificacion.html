<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <title>Unificaci√≥n</title>
  <style>
    *{ box-sizing: border-box; margin: 0; padding: 0; }
  
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 1rem;
      padding-bottom: calc(60px + 1rem);
    }
  
    /* NAVEGACI√ìN */
    nav.top-nav {
      display: flex;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    nav.top-nav button {
      flex: 1;
      padding: .75rem 0;
      border: none;
      background: #3f51b5;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: opacity .3s;
    }
    nav.top-nav button:not(.active) { opacity: .6; }
    .section { display: none; }
    .section.active { display: block; }
  
    /* GRID DE TARJETAS */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  
    /* TARJETA */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .card-header {
      font-weight: bold;
      margin-bottom: .1rem;
      font-size: 5px;
    }
    .card-body label {
      display: block;
      margin-bottom: .5rem;
      font-size: .7rem;
    }
    .card-body input,
    .card-body select {
      font-size: 16px;
      width: 50%;
      border: none;
    }
    .card-footer {
      margin-top: 10px;
      display: flex;
      gap: .2rem;
    }
    .info2 p {
      font-size: 10px;
    }
    .info2 strong {
      font-weight: 400;
    }
    .card-footer button {
      flex: 1;
      padding: .2rem;
      font-size: 12px;
      border: none;
      background: #3f51b5;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity .3s;
    }
    .card-footer button.delete-btn { 
    background: #cc3e44; }
    .card-footer button:hover { opacity: .85; }
  
    /* BOT√ìN AGREGAR */
    .btn-add {
      display: block;
      width: 100%;
      padding: .75rem 0;
      margin-bottom: 1rem;
      background: #3f51b5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity .3s;
    }
    .btn-add:hover { opacity: .85; }
  
    /* FORMULARIO VENTAS */
    .form-panel {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .item-row {
      margin-bottom: .75rem;
    }
    .item-row input,
    .item-row select {
    width: 100%;
   padding: .5rem;
   border: 1px solid rgba(0,0,0,0.1);
   border-radius: 4px;
    }
    .item-row button { flex: 0 0 auto; padding: .4rem .8rem; }
  
    /* TICKETS VENTAS */
    #tickets-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.50rem;
    }
    .ticket-card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .ticket-header { font-weight: bold; margin-bottom: .5rem; }
    .ticket-method,
    .ticket-footer { margin: .5rem 0; }
    .ticket-item { margin-left: 1rem; font-size: .9rem; }
  
    /* FOOTER RESUMEN */
    footer.payment-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #3f51b5;
      color: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
      font-size: .9rem;
      z-index: 100;
    }
    footer.payment-summary div span {
      display: block;
      font-weight: bold;
      margin-top: .25rem;
    }
    /* PANEL DE ESTAD√çSTICAS */


.top-stats {
  position: sticky;
  top: 1rem;
  z-index: 90;      
  display: flex;
  justify-content: space-around;
  background: #fff;
  padding: .5rem 0;
  margin-bottom: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.top-stats div {
  text-align: center;
  font-size: .9rem;
}
.top-stats i {
  margin-bottom: .25rem;
  display: block;
  font-size: 1.2rem;
  color: #3f51b5;
}
.top-stats strong {
  display: block;
  margin-top: .25rem;
  font-size: 1.1rem;
}
  .hidden { display: none; }
.dividirEn2{
  display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;

}
  </style>
</head>
<body>

  <!-- ESTAD√çSTICAS -->
  <div class="top-stats">
    <div><i class="fa-solid fa-warehouse"></i>Inventario<br><strong id="stat-inventory">0.00</strong></div>
    <div><i class="fa-solid fa-cart-shopping"></i>Compras<br><strong id="stat-purchases">0.00</strong></div>
    <div><i class="fa-solid fa-truck-moving"></i>Reposici√≥n<br><strong id="stat-restock">0.00</strong></div>
  </div>

  <!-- NAVEGACI√ìN -->
  <nav class="top-nav">
    <button data-sec="stock" class="active">Stock</button>
    <button data-sec="compras">Compras</button>
    <button data-sec="ventas">Ventas</button>
    <button data-sec="recetas">Recetas</button>
  </nav>

  <!-- STOCK -->
  <section id="stock" class="section active">
    <h2>Stock de Productos</h2>
    <button class="btn-add" onclick="addNewProducto()">‚ûï Nuevo Producto</button>
    <div id="stock-grid" class="card-grid"></div>
  </section>

  <!-- COMPRAS -->
  <section id="compras" class="section">
    <h2>Historial de Compras</h2>
    <div id="compras-grid" class="card-grid"></div>
  </section>

  <!-- VENTAS -->
  <section id="ventas" class="section">
    <h2>Gesti√≥n de Ventas</h2>
    <div class="form-panel">
      <h3 id="form-title">Nueva Venta</h3>
      <input type="hidden" id="form-id">
      <div class="item-row">
        <label style="flex:1"><input type="date" id="form-fecha"></label>
      </div>
      <div id="items-container"></div>
      <button id="btn-add-item" class="btn-add">+ Agregar producto</button>
      <div class="item-row">
        <label style="flex:1">
          <select id="form-pago">
            <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
          </select>
        </label>
      </div>
      <div style="display:flex;gap:.5rem;">
        <button id="btn-save" class="btn-add"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
        <button id="btn-cancel" class="delete-btn">Cancelar</button>
      </div>
    </div>
    <div id="tickets-grid" class="card-grid"></div>
  </section>

  <!-- RECETAS -->
<!-- RECETAS -->
<section id="recetas" class="section">
  <h2>CRUD Recetas</h2>
  <div class="form-panel">
    <h3 id="form-receta-title">Nueva Receta</h3>
    <input type="hidden" id="form-receta-id">

    <!-- C√≥digo y Nombre -->
    <div class="item-row dividirEn2">
 <input id="receta-codigo" type="text" placeholder="Ej: R001">
        <input id="receta-nombre" type="text" placeholder="Nombre receta">
    </div>

    <div class="item-row dividirEn2">
      <label>
        Categor√≠a:<br>
        <select id="receta-categoria"></select>
      </label>
      <label style="flex:1" class="hidden" id="wrapper-receta-categoria-nueva">
        Nueva categor√≠a:<br>
        <input id="receta-categoria-nueva" type="text" placeholder="Nueva categor√≠a">
      </label>
      
        <input id="receta-imagen" type="text" placeholder="http://...">

      
      
    </div>


    <!-- Ingredientes -->
    <h3>Ingredientes</h3>
    <div class="item-row">
      <button id="agregar-ingrediente" class="btn-add">+ Agregar ingrediente</button>
    </div>
    <table id="ingredientes-table" style="width:100%; margin-top:.5rem; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="text-align:left">Producto</th>
          <th style="text-align:left">Cantidad</th>
          <th style="text-align:left">Unidad</th>
          <th style="text-align:left">Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Acciones -->
    <div class="item-row" style="gap:0.5rem; margin-top:1rem;">
      <button id="guardar-receta" class="btn-add" style="flex:1">
        <i class="fa-solid fa-floppy-disk"></i> Guardar
      </button>
      <button id="limpiar-form" class="delete-btn" style="flex:1">
        Limpiar
      </button>
    </div>
  </div>

  <!-- Listado de Recetas -->
  <div id="lista-recetas" class="card-grid"></div>
</section>

  <footer class="payment-summary">
    <div>Efectivo<br><span id="sum-efectivo">0.00</span></div>
    <div>Transferencia<br><span id="sum-transferencia">0.00</span></div>
    <div>Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
    <div>Total<br><span id="sum-total">0.00</span></div>
  </footer>

<script>
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî PAGINACI√ìN ENTRE SECCIONES ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  document.querySelectorAll('nav.top-nav button').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('nav.top-nav button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(btn.dataset.sec).classList.add('active');
    });
  });

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CONSTANTES Y ESTADO GLOBAL ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
  const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
  const MARGEN     = 1.55;
  const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };

  let almacenData  = [], comprasData = [], ventData   = [], cocData     = [];
  let recetas      = [], recetasData = [], categorias = [];
  let productInfo  = {}, editMode   = false;

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî UTILS UNIDAD ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function categoriaDe(u) {
    if (['mg','g','kg'].includes(u)) return 'peso';
    if (['ml','l'].includes(u)) return 'volumen';
    return 'conteo';
  }
  function humanizeComposite(b,c) {
    if (c==='peso') {
      const kg = Math.trunc(b/1000), g = b%1000, out=[];
      if (kg) out.push(`${kg}kg`);
      if (g ) out.push(`${g}g`);
      return out.join(' ')||'0g';
    }
    if (c==='volumen') {
      const l = Math.trunc(b/1000), m = b%1000, out=[];
      if (l) out.push(`${l}l`);
      if (m) out.push(`${m}ml`);
      return out.join(' ')||'0ml';
    }
    return `${b.toFixed(0)}pz`;
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî LLAMADAS BACKEND ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function callApi(params) {
    const url = new URL(API_URL);
    Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
    return fetch(url).then(r => r.json());
  }
  async function postOp(op, params={}) {
    const fd = new FormData();
    fd.append('op', op);
    Object.entries(params).forEach(([k,v]) => fd.append(k,v));
    const res  = await fetch(API_URL, { method:'POST', body:fd });
    const json = await res.json();
    if (json.status!=='success') throw new Error(json.message);
    return json.data;
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CONSTRUCCI√ìN DE productInfo ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function buildProductInfo() {
    productInfo = {};
    almacenData.forEach(it => {
      const uni = it.unidadDeMedida.trim().toLowerCase();
      const cat = categoriaDe(uni);
      const base = parseFloat(it.cantidad)*FACTORES[uni]||1;
      productInfo[it.codigo] = {
        priceBase: parseFloat(it.precio)/base||0,
        categoria:  cat,
        opcionesUnidad: CATEGORIAS[cat]
      };
    });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RENDER STOCK ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function renderStockTable() {
    const grid = document.getElementById('stock-grid');
    grid.innerHTML = '';
    const compMap={}, usedMap={};

    comprasData.forEach(c => {
      compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad];
    });
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo)===String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo]||0)
          + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
      });
    }));

    almacenData.forEach(it => {
      const info   = productInfo[it.codigo];
      const recBase= (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
      const bought = compMap[it.codigo]||0;
      const used   = usedMap[it.codigo]||0;
      const remain = bought - used;
      const pct    = recBase? remain/recBase*100 : 0;

      let estado;
      if (pct <= 50) estado = 'üî¥ Bajo';
      else if (pct <= 80) estado = 'üü† Medio';
      else if (pct <=100) estado = 'üü¢ Bueno';
      else estado = 'üîµ Excedente';

      const delta  = recBase - remain;
      const accion = delta>0
        ? `Ordenar ${humanizeComposite(delta,info.categoria)}`
        : `Sobrante ${humanizeComposite(-delta,info.categoria)}`;

      const totalB = (info.priceBase*bought).toFixed(2);
      const totalU = (info.priceBase*used).toFixed(2);
      const totalR = (info.priceBase*remain).toFixed(2);

      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">#${it.codigo} ‚Äì ${it.name||'Sin nombre'}</div>
        <div class="card-body">
          <label>Nombre:<input type="text" id="name-${it.codigo}" value="${it.name||''}"></label>
          <label>Precio base:<input type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></label>
          <label>Cant. inicial:<input type="number" id="cant-${it.codigo}" value="${it.cantidad||0}"></label>
          <label>Unidad:<select id="unidad-${it.codigo}">
            ${info.opcionesUnidad.map(u=>
              `<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`
            ).join('')}
          </select></label>
          <label>Stock rec.:<input type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}"></label>
          <label>Proveedor:<input type="text" id="prov-${it.codigo}" value="${it.proveedor||''}"></label>
          <hr>
          <div class="info2">
            <p><strong>Comprado:</strong> ${humanizeComposite(bought,info.categoria)} (~ $${totalB})</p>
            <p><strong>Usado:</strong> ${humanizeComposite(used,info.categoria)} (~ $${totalU})</p>
            <p><strong>Restante:</strong> ${humanizeComposite(remain,info.categoria)} (~ $${totalR})</p>
            <p><strong>Estado:</strong> ${estado}</p>
            <p><strong>Acci√≥n:</strong> ${accion}</p>
          </div>
          <label>Comprar:
            <input type="number" id="buyqty-${it.codigo}" value="1" style="width:4rem;">
            <select id="buyunit-${it.codigo}" style="width:auto;">
              ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
            </select>
          </label>
        </div>
        <div class="card-footer">
          <button onclick="buyProduct('${it.codigo}')"><i class="fa-solid fa-cart-shopping"></i></button>
          <button onclick="saveAlmacen('${it.codigo}')"><i class="fa-solid fa-floppy-disk"></i></button>
          <button class="delete-btn" onclick="deleteAlmacen('${it.codigo}')"><i class="fa-solid fa-trash"></i></button>
        </div>`;
      grid.append(card);
    });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RENDER COMPRAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function renderComprasTable() {
    const grid = document.getElementById('compras-grid');
    grid.innerHTML = '';
    comprasData
      .sort((a,b)=>new Date(b.fecha)-new Date(a.fecha))
      .forEach(c => {
        const prod = almacenData.find(x=>x.codigo==c.idProducto);
        if (!prod) return;
        const info  = productInfo[c.idProducto];
        const total = (info.priceBase * c.cantidad * FACTORES[c.unidad]).toFixed(2);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">Compra #${c.idCompra}</div>
          <div class="card-body">
            <label>Fecha:<input type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}"></label>
            <p><strong>Producto:</strong> ${prod.name}</p>
            <label>Cantidad:<input type="number" id="qty-${c.idCompra}" step=".01" value="${c.cantidad}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')"></label>
            <label>Unidad:<select id="unit-${c.idCompra}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')">
              ${info.opcionesUnidad.map(u=>
                `<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`
              ).join('')}
            </select></label>
            <p><strong>Total:</strong> $<span id="total-${c.idCompra}">${total}</span></p>
          </div>
          <div class="card-footer">
            <button onclick="saveCompra('${c.idCompra}','${c.idProducto}')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button class="delete-btn" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        grid.append(card);
        recalcCompra(c.idCompra, c.idProducto);
      });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî ACCIONES STOCK/COMPRAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  async function addNewProducto() {
    const code = Date.now();
    almacenData.push({ codigo:code, name:'', precio:0, cantidad:0, unidadDeMedida:'pz', stockRecomendado:0, proveedor:'' });
    buildProductInfo();
    renderStockTable();
  }
  async function saveAlmacen(c) {
    await callApi({
      op:'guardarAlmacen',
      codigo:c,
      name:document.getElementById(`name-${c}`).value,
      precio:document.getElementById(`precio-${c}`).value,
      cantidad:document.getElementById(`cant-${c}`).value,
      unidadDeMedida:document.getElementById(`unidad-${c}`).value,
      stockRecomendado:document.getElementById(`rec-${c}`).value,
      proveedor:document.getElementById(`prov-${c}`).value
    });
    await loadData();
  }
  async function deleteAlmacen(c) {
    await callApi({ op:'eliminarAlmacen', codigo:c });
    await loadData();
  }
  async function buyProduct(id) {
    const info = productInfo[id];
    const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value)||0;
    if (qty<=0) return;
    const uni   = document.getElementById(`buyunit-${id}`).value;
    const total = (info.priceBase*qty*FACTORES[uni]).toFixed(0);
    const fecha = new Date().toISOString().slice(0,10);
    await callApi({
      op:'guardarCompras',
      idProducto:id,
      fecha,
      name: almacenData.find(x=>x.codigo==id).name,
      precio: total,
      cantidad:qty,
      unidad:uni
    });
    await loadData();
  }
  function recalcCompra(idC,idP) {
    const info = productInfo[idP];
    const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
    const uni  = document.getElementById(`unit-${idC}`).value;
    document.getElementById(`total-${idC}`).textContent =
      (info.priceBase*qty*FACTORES[uni]).toFixed(2);
  }
  async function saveCompra(idC,idP) {
    const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
    if (qty<=0) return;
    const uni   = document.getElementById(`unit-${idC}`).value;
    const fecha = document.getElementById(`date-${idC}`).value;
    const total = (productInfo[idP].priceBase*qty*FACTORES[uni]).toFixed(0);
    await callApi({
      op:'guardarCompras',
      idCompra:idC,
      idProducto:idP,
      fecha,
      name: almacenData.find(x=>x.codigo==idP).name,
      precio: total,
      cantidad:qty,
      unidad:uni
    });
    await loadData();
  }
  async function deleteCompra(idC,idP) {
    await callApi({ op:'eliminarCompras', idCompra:idC, idProducto:idP });
    await loadData();
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî VENTAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function crearItemRow(cod='',cant='',tot='') {
    const row = document.createElement('div');
    row.className = 'item-row';
    const sel = document.createElement('select');
    recetas.forEach(r => {
      const o = document.createElement('option');
      o.value    = r.codigo;
      o.textContent = r.nombre;
      if (r.codigo===cod) o.selected = true;
      sel.append(o);
    });
    const ic = document.createElement('input');
    ic.type        = 'number'; ic.min='1'; ic.value = cant; ic.placeholder='Cantidad';
    const it = document.createElement('input');
    it.type        = 'number'; it.value = tot; it.placeholder='Total';
    const bd = document.createElement('button');
    bd.type        = 'button';
    bd.textContent = '‚àí';
    bd.onclick     = () => row.remove();
    function recalc() {
      const p = recetas.find(x=>x.codigo===sel.value)||{precio:0};
      it.value = (p.precio*(parseFloat(ic.value)||0)).toFixed(2);
    }
    sel.onchange = recalc;
    ic.oninput   = recalc;
    row.append(sel, ic, it, bd);
    return row;
  }
  function renderTicketCard(v) {
    const c = document.createElement('div');
    c.className = 'ticket-card';
    c.innerHTML = `
      <div class="ticket-header">${new Date(v.fecha).toLocaleDateString()}</div>
      <div class="ticket-method"><strong>Pago:</strong> ${v.metodoPago}</div>
      <div class="ticket-items"></div>
      <div class="ticket-footer"><strong>Total:</strong> <span class="ticket-total">0</span></div>
      <div class="card-footer">
        <button class="edit-btn">Editar</button>
        <button class="delete-btn"><i class="fa-solid fa-trash"></i></button>
      </div>`;
    const itemsDiv = c.querySelector('.ticket-items');
    let total = 0;
    v.venta.forEach(it => {
      const d = document.createElement('div');
      d.className = 'ticket-item';
      d.textContent = `${it.producto} x${it.cantidad} = $${it.total}`;
      total += parseFloat(it.total)||0;
      itemsDiv.append(d);
    });
    c.querySelector('.ticket-total').textContent = total.toFixed(2);
    c.querySelector('.edit-btn').onclick = () => startEdit(v);
    c.querySelector('.delete-btn').onclick = async () => {
      if (!confirm('¬øEliminar venta?')) return;
      await callApi({ op:'eliminarVentas', id:v.id });
      await loadData();
    };
    return c;
  }
  async function cargarVentas() {
    await fetchRecetas(); // asegura recetas disponibles
    const res = await callApi({ op:'obtenerVentas' });
    if (res.status!=='success') return;
    ventData = res.data;
    const grid = document.getElementById('tickets-grid');
    grid.innerHTML = '';
    ventData.forEach(v => grid.append(renderTicketCard(v)));
    actualizarResumen(ventData);
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RES√öMENES Y ESTAD√çSTICAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function actualizarResumen(vs) {
    let e=0, t=0, ta=0;
    vs.forEach(v => {
      const s = v.venta.reduce((a,i)=>a+parseFloat(i.total||0), 0);
      if (v.metodoPago==='Efectivo') e+=s;
      else if (v.metodoPago==='Transferencia') t+=s;
      else if (v.metodoPago==='Tarjeta') ta+=s;
    });
    document.getElementById('sum-efectivo').textContent     = e.toFixed(2);
    document.getElementById('sum-transferencia').textContent = t.toFixed(2);
    document.getElementById('sum-tarjeta').textContent      = ta.toFixed(2);
    document.getElementById('sum-total').textContent        = (e+t+ta).toFixed(2);
  }
  function updateTopStats() {
    let totalInv=0, totalCompras=0, totalRestock=0;
    const compMap={}, usedMap={};
    comprasData.forEach(c => {
      compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad];
      totalCompras += productInfo[c.idProducto].priceBase * c.cantidad*FACTORES[c.unidad];
    });
    ventData.forEach(v => v.venta.forEach(it => {
      const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo]||0)
          + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
      });
    }));
    almacenData.forEach(it => {
      const info   = productInfo[it.codigo];
      const bought = compMap[it.codigo]||0;
      const used   = usedMap[it.codigo]||0;
      const remain = bought-used;
      totalInv += remain * info.priceBase;
      const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
      const delta   = recBase - remain;
      if(delta>0) totalRestock += delta * info.priceBase;
    });
    document.getElementById('stat-inventory').textContent = totalInv.toFixed(2);
    document.getElementById('stat-purchases').textContent = totalCompras.toFixed(2);
    document.getElementById('stat-restock').textContent   = totalRestock.toFixed(2);
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RECETAS: FETCH y RENDER ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  async function fetchRecetas() {
    const cocR = await callApi({ op:'obtenerCocina' });
    if (cocR.status!=='success') return;
    cocData = cocR.data.map(r => ({
      ...r,
      ingredientes: typeof r.ingredientes==='string' ? JSON.parse(r.ingredientes) : r.ingredientes
    }));
    recetas = cocData.map(r => {
      const costo = r.ingredientes.reduce((s,ing) => {
        const p = almacenData.find(x=>String(x.codigo)===String(ing.codigo));
        if (!p) return s;
        const ua = FACTORES[p.unidadDeMedida], ui=FACTORES[ing.unidad];
        return s + (p.precio/(ua*parseFloat(p.cantidad)))*(ui*ing.cantidad);
      },0);
      return { codigo:r.codigo, nombre:r.nombre, precio:(costo*MARGEN).toFixed(2) };
    });
  }
  async function cargarRecetas() {
    await fetchRecetas();
    recetasData = cocData;
    categorias   = [...new Set(recetasData.map(r=>r.categoria))];
    const sel    = document.getElementById('receta-categoria');
    sel.innerHTML = [
      '<option value="">-- Selecciona categor√≠a --</option>',
      ...categorias.sort().map(c=>`<option value="${c}">${c}</option>`),
      '<option value="__nueva__">+ Nueva categor√≠a</option>'
    ].join('');
    sel.onchange = () => {
      document.getElementById('wrapper-receta-categoria-nueva')
        .classList.toggle('hidden', sel.value!=='__nueva__');
    };
    mostrarRecetas();
  }
  function mostrarRecetas() {
    const cont = document.getElementById('lista-recetas');
    cont.innerHTML = '';
    recetasData.forEach(r => {
      const precio = calcularPrecio(r.ingredientes);
      const card   = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="card-header">${r.codigo} ‚Äì ${r.nombre}</div>
        <div class="card-body">
          <p><strong>Categor√≠a:</strong> ${r.categoria}</p>
          ${r.imagen?`<img src="${r.imagen}" alt="${r.nombre}" style="max-width:100%">`:``}
          <div class="info2">
            ${r.ingredientes.map(i=>`<p>${i.codigo}: ${i.cantidad}${i.unidad}</p>`).join('')}
            <p><strong>Costo total:</strong> $${precio.toFixed(2)}</p>
          </div>
        </div>
        <div class="card-footer">
          <button onclick='cargarEnForm(${JSON.stringify(r)})'>Editar</button>
          <button class="delete-btn" onclick="eliminarReceta('${r.codigo}')">Eliminar</button>
        </div>`;
      cont.append(card);
    });
  }
  function calcularPrecio(ingredientes) {
    return ingredientes.reduce((sum,i) => {
      const p = almacenData.find(x=>String(x.codigo)===String(i.codigo));
      if (!p) return sum;
      const factorP   = FACTORES[p.unidadDeMedida.trim().toLowerCase()]*parseFloat(p.cantidad);
      const precioUnit= p.precio/factorP;
      const factorI   = FACTORES[i.unidad.trim().toLowerCase()]*i.cantidad;
      return sum + precioUnit*factorI;
    },0);
  }
  function crearSelectProductos() {
    const sel = document.createElement('select');
    almacenData.forEach(p => {
      const unidad = p.unidadDeMedida.trim().toLowerCase();
      const opt    = new Option(`${p.name} (${p.cantidad}${p.unidadDeMedida})`, p.codigo);
      opt.dataset.unit = unidad;
      sel.append(opt);
    });
    return sel;
  }
  function crearSelectUnidad(cat,val='') {
    const sel = document.createElement('select');
    CATEGORIAS[cat].forEach(u => sel.append(new Option(u,u)));
    if (val) sel.value = val;
    return sel;
  }
  function agregarFila(item={}) {
    const tbody = document.querySelector('#ingredientes-table tbody');
    const tr    = document.createElement('tr');
    const selProd = crearSelectProductos();
    if (item.codigo) selProd.value = item.codigo;
    const inpCant = document.createElement('input');
    inpCant.type  = 'number'; inpCant.min='0'; inpCant.value = item.cantidad||1;
    let unidad0   = item.unidad||selProd.selectedOptions[0].dataset.unit;
    let selUni    = crearSelectUnidad(categoriaDe(unidad0), unidad0);
    selProd.onchange = () => {
      const nu  = selProd.selectedOptions[0].dataset.unit;
      const cat = categoriaDe(nu);
      const nuevo = crearSelectUnidad(cat,nu);
      tr.children[2].replaceChild(nuevo, selUni);
      selUni = nuevo;
    };
    const btnDel = document.createElement('button');
    btnDel.type  = 'button';
    btnDel.textContent = 'Eliminar';
    btnDel.onclick = e => { e.preventDefault(); tr.remove(); };
    [selProd, inpCant, selUni, btnDel].forEach(el => {
      const td = document.createElement('td');
      td.append(el);
      tr.append(td);
    });
    tbody.append(tr);
  }
  function cargarEnForm(r) {
    editMode = true;
    document.getElementById('receta-codigo').value    = r.codigo;
    document.getElementById('receta-codigo').disabled = true;
    document.getElementById('receta-nombre').value    = r.nombre;
    const selCat = document.getElementById('receta-categoria');
    if (!categorias.includes(r.categoria)) {
      selCat.value = '__nueva__';
      document.getElementById('wrapper-receta-categoria-nueva').classList.remove('hidden');
      document.getElementById('receta-categoria-nueva').value = r.categoria;
    } else {
      selCat.value = r.categoria;
      document.getElementById('wrapper-receta-categoria-nueva').classList.add('hidden');
    }
    document.getElementById('receta-imagen').value = r.imagen||'';
    document.querySelector('#ingredientes-table tbody').innerHTML = '';
    r.ingredientes.forEach(i=>agregarFila(i));
  }
  async function guardarReceta() {
    const cod = document.getElementById('receta-codigo').value.trim();
    const nom = document.getElementById('receta-nombre').value.trim();
    if (!cod||!nom) return alert('C√≥digo y nombre requeridos');
    let cat = document.getElementById('receta-categoria').value;
    if (cat==='__nueva__') {
      cat = document.getElementById('receta-categoria-nueva').value.trim();
      if (cat && !categorias.includes(cat)) categorias.push(cat);
    }
    const ingredientes = Array.from(
      document.querySelectorAll('#ingredientes-table tbody tr')
    ).map(tr=>({
      codigo: tr.children[0].firstChild.value,
      cantidad:+tr.children[1].firstChild.value,
      unidad: tr.children[2].firstChild.value
    }));
    try {
      await postOp('guardarCocina', {
        codigo: cod,
        nombre: nom,
        categoria: cat,
        imagen: document.getElementById('receta-imagen').value.trim(),
        ingredientes: JSON.stringify(ingredientes)
      });
      await cargarRecetas();
      limpiarForm();
    } catch(e){
      alert('Error al guardar receta: '+e);
    }
  }
  async function eliminarReceta(codigo) {
    if (!confirm(`¬øEliminar receta ${codigo}?`)) return;
    try {
      await postOp('eliminarCocina',{codigo});
      await cargarRecetas();
    } catch(e){
      alert('Error al eliminar: '+e);
    }
  }
  function limpiarForm() {
    editMode = false;
    ['receta-codigo','receta-nombre','receta-imagen','receta-categoria','receta-categoria-nueva']
      .forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        if (el.tagName==='SELECT') el.selectedIndex = 0;
        else el.value = '';
      });
    document.getElementById('receta-codigo').disabled = false;
    document.querySelector('#ingredientes-table tbody').innerHTML = '';
    document.getElementById('wrapper-receta-categoria-nueva').classList.add('hidden');
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CARGA GENERAL ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  async function loadData() {
    const [alm, comp, vent] = await Promise.all([
      callApi({op:'obtenerAlmacen'}),
      callApi({op:'obtenerCompras'}),
      callApi({op:'obtenerVentas'})
    ]);
    if ([alm,comp,vent].some(r=>r.status!=='success')) return;
    almacenData  = alm.data;
    comprasData  = comp.data;
    ventData     = vent.data;
    buildProductInfo();
    renderStockTable();
    renderComprasTable();
    await cargarVentas();
    updateTopStats();
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî VENTAS FORM ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  document.getElementById('btn-add-item').onclick = () =>
    document.getElementById('items-container').append(crearItemRow());
  document.getElementById('btn-cancel').onclick = resetForm;
  document.getElementById('btn-save').onclick = async () => {
    const id    = document.getElementById('form-id').value;
    const fecha = document.getElementById('form-fecha').value;
    if (!fecha) return;
    const metodo = document.getElementById('form-pago').value;
    const rows   = document.querySelectorAll('#items-container .item-row');
    if (rows.length===0) return;
    const venta = Array.from(rows).map(r => {
      const [sel, ic, it] = r.children;
      return {
        codigo: sel.value,
        producto: recetas.find(x=>x.codigo===sel.value).nombre,
        cantidad: Number(ic.value)||0,
        total:    Number(it.value)||0
      };
    });
    const res = await callApi({op:'guardarVentas', venta: JSON.stringify({id,fecha,metodoPago:metodo,venta})});
    if (res.status==='success') {
      resetForm();
      await loadData();
    }
  };
  function startEdit(v) {
    document.getElementById('form-id').value = v.id;
    document.getElementById('form-title').textContent = 'Editar Venta';
    document.getElementById('form-fecha').value    = new Date(v.fecha).toISOString().slice(0,10);
    document.getElementById('form-pago').value     = v.metodoPago;
    const cont = document.getElementById('items-container');
    cont.innerHTML = '';
    v.venta.forEach(it => cont.append(crearItemRow(it.codigo,it.cantidad,it.total)));
  }
  function resetForm() {
    document.getElementById('form-id').value     = '';
    document.getElementById('form-title').textContent = 'Nueva Venta';
    document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
    document.getElementById('form-pago').value  = 'Efectivo';
    const cont = document.getElementById('items-container');
    cont.innerHTML = '';
    cont.append(crearItemRow());
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî INICIALIZAR TODO ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  window.onload = async () => {
    await loadData();     // stock, compras, ventas, stats
    await cargarRecetas(); // recetas CRUD
    // listeners de Recetas
    document.getElementById('agregar-ingrediente').onclick = () => agregarFila();
    document.getElementById('guardar-receta').onclick     = guardarReceta;
    document.getElementById('limpiar-form').onclick       = limpiarForm;
  };
</script>

</body>
</html>
