<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Font Awesome 6 CDN (Recomendado) -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">

  <title>Unificacion</title>
  <style>
    /* RESET Y VARIABLES */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 1rem;
      padding-bottom: calc(60px + 1rem);
    }
    /* NAVEGACI√ìN */
    nav.top-nav {
      display: flex;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    nav.top-nav button {
      flex: 1;
      padding: .75rem 0;
      border: none;
      background: #3f51b5;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: opacity .3s;
    }
    nav.top-nav button:not(.active) { opacity: .6; }
    .section { display: none; }
    .section.active { display: block; }
    /* GRID DE TARJETAS */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
    /* TARJETA */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .card-header { font-weight: bold; margin-bottom: .1rem; font-size: .9rem; }
    .card-body label { display: block; margin-bottom: .5rem; font-size: .8rem; }
    .card-body input, .card-body select { font-size: .8rem; width: 50%; border: none; }
    .card-footer { margin-top: .5rem; display: flex; gap: .5rem; }
    .info2 p { font-size: .8rem; }
    .info2 strong { font-weight: 400; }
    .card-footer button { flex: 1; padding: .4rem; font-size: .9rem; border: none; background: #3f51b5; color: #fff; border-radius: 4px; cursor: pointer; transition: opacity .3s; }
    .card-footer button.delete-btn { background: #cc3e44; }
    .card-footer button:hover { opacity: .85; }
    /* BOT√ìN AGREGAR */
    .btn-add {
      display: block;
      width: 100%;
      padding: .75rem 0;
      margin-bottom: 1rem;
      background: #3f51b5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity .3s;
    }
    .btn-add:hover { opacity: .85; }
    /* FORMULARIO VENTAS */
    .form-panel {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .item-row {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      margin-bottom: .75rem;
    }
    .item-row input, .item-row select {
      flex: 1 1 45%;
      padding: .5rem;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 4px;
    }
    .item-row button { flex: 0 0 auto; padding: .4rem .8rem; }
    /* TICKETS VENTAS */
    #tickets-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: .5rem;
    }
    .ticket-card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .ticket-header { font-weight: bold; margin-bottom: .5rem; }
    .ticket-method, .ticket-footer { margin: .5rem 0; }
    .ticket-item { margin-left: 1rem; font-size: .9rem; }
    /* FOOTER RESUMEN */
    footer.payment-summary {
      position: fixed;
      bottom: 0; left: 0;
      width: 100%; height: 60px;
      background: #3f51b5; color: #fff;
      display: flex; justify-content: space-around; align-items: center;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
      font-size: .9rem; z-index: 100;
    }
    footer.payment-summary div span { display: block; font-weight: bold; margin-top: .25rem; }
    /* PANEL DE ESTAD√çSTICAS */
    .top-stats {
      position: sticky; top: 1rem; z-index: 90;
      display: flex; justify-content: space-around;
      background: #fff; padding: .5rem 0;
      margin-bottom: 1rem; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .top-stats div { text-align: center; font-size: .9rem; }
    .top-stats i { margin-bottom: .25rem; display: block; font-size: 1.2rem; color: #3f51b5; }
    .top-stats strong { display: block; margin-top: .25rem; font-size: 1.1rem; }
    /* ESTILOS RECETARIO */
    .container { display: flex; gap: 1rem; }
    .form-panel, .recipes-panel {
      background: #fff; border: 1px solid #d0d4da; border-radius: 4px;
      padding: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      max-height: calc(100vh - 4rem); overflow-y: auto;
    }
    .form-panel { flex: 1; }
    .recipes-panel { flex: 2; }
    .recipes-panel #lista-recetas { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 1rem; }
    .card.receta img { width: 100%; height: 140px; object-fit: cover; border-radius: 4px; margin-bottom: .5rem; }
    .recipes-panel .ingredientes { margin: .5rem 0; font-size: .9rem; list-style: disc inside; }
    .recipes-panel .costo-total { font-weight: bold; margin-top: auto; }
    .actions button { margin-right: .5rem; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <!-- PANEL SUPERIOR DE ESTAD√çSTICAS -->
  <div class="top-stats">
    <div><i class="fa-solid fa-warehouse"></i>Inventario:<br><strong id="stat-inventory">0.00</strong></div>
    <div><i class="fa-solid fa-cart-shopping"></i>Compras:<br><strong id="stat-purchases">0.00</strong></div>
    <div><i class="fa-solid fa-truck-moving"></i>Reposici√≥n:<br><strong id="stat-restock">0.00</strong></div>
  </div>

  <nav class="top-nav">
    <button data-sec="stock" class="active">Stock</button>
    <button data-sec="compras">Compras</button>
    <button data-sec="ventas">Ventas</button>
    <button data-sec="recetario">Recetario</button>
  </nav>

  <!-- SECCI√ìN STOCK -->
  <section id="stock" class="section active">
    <h2>Stock de Productos</h2>
    <button class="btn-add" onclick="addNewProducto()">‚ûï Nuevo Producto</button>
    <div id="stock-grid" class="card-grid"></div>
  </section>

  <!-- SECCI√ìN COMPRAS -->
  <section id="compras" class="section">
    <h2>Historial de Compras</h2>
    <div id="compras-grid" class="card-grid"></div>
  </section>

  <!-- SECCI√ìN VENTAS -->
  <section id="ventas" class="section">
    <h2>Gesti√≥n de Ventas</h2>
    <div class="form-panel">
      <h3 id="form-title">Nueva Venta</h3>
      <input type="hidden" id="form-id">
      <div class="item-row">
        <label style="flex:1 1 100%">Fecha:
          <input type="date" id="form-fecha">
        </label>
      </div>
      <div id="items-container"></div>
      <button id="btn-add-item" class="btn-add">+ Agregar producto</button>
      <div class="item-row">
        <label style="flex:1 1 100%">Pago:
          <select id="form-pago">
            <option>Efectivo</option>
            <option>Transferencia</option>
            <option>Tarjeta</option>
          </select>
        </label>
      </div>
      <div style="display:flex; gap:.5rem;">
        <button id="btn-save"><i class="fa-solid fa-floppy-disk"></i></button>
        <button id="btn-cancel">Cancelar</button>
      </div>
    </div>
    <div id="tickets-grid"></div>
  </section>

  <!-- SECCI√ìN RECETARIO -->
  <section id="recetario" class="section">
    <h2>Recetario</h2>
    <div class="container">
      <!-- Formulario -->
      <div class="form-panel">
        <form id="form-receta">
          <label>C√≥digo de la receta:
            <input id="receta-codigo" type="text" placeholder="Ej: R001" required>
          </label>
          <label>Nombre de la receta:
            <input id="receta-nombre" type="text" placeholder="Ej: Ensalada de frutas" required>
          </label>
          <label>Categor√≠a:
            <select id="receta-categoria"></select>
            <input id="receta-categoria-nueva" type="text" placeholder="Nueva categor√≠a" class="hidden">
          </label>
          <label>URL de imagen:
            <input id="receta-imagen" type="text" placeholder="Ej: http://...">
          </label>
          <h3>Ingredientes</h3>
          <table id="ingredientes-table">
            <thead>
              <tr><th>Producto</th><th>Cantidad</th><th>Unidad</th><th>Acci√≥n</th></tr>
            </thead>
            <tbody></tbody>
          </table>
          <button id="agregar-ingrediente" type="button">+ Agregar ingrediente</button>
          <div class="actions">
            <button id="guardar-receta" type="button">Guardar Receta</button>
            <button id="limpiar-form" type="button" class="del">Limpiar</button>
          </div>
        </form>
      </div>
      <!-- Listado -->
      <div class="recipes-panel">
        <h3>Recetas Costeadas</h3>
        <div id="lista-recetas" class="card-grid"></div>
      </div>
    </div>
  </section>

  <!-- FOOTER RESUMEN -->
  <footer class="payment-summary">
    <div>Efectivo<br><span id="sum-efectivo">0.00</span></div>
    <div>Transferencia<br><span id="sum-transferencia">0.00</span></div>
    <div>Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
    <div>Total<br><span id="sum-total">0.00</span></div>
  </footer>

  <script>
    // PAGINACI√ìN ENTRE SECCIONES
    document.querySelectorAll('nav.top-nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('nav.top-nav button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(btn.dataset.sec).classList.add('active');
      });
    });

    // CONFIGURACI√ìN Y DATOS
    const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
    const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
    const MARGEN     = 1.55;
    let almacenData  = [], comprasData = [], ventData    = [], cocData     = [], recetas    = [];
    let productInfo  = {};
    let editRecetaCodigo = null;

    function callApi(params) {
      const url = new URL(API_URL);
      Object.entries(params).forEach(([k,v])=> url.searchParams.append(k,v));
      return fetch(url).then(r=> r.json());
    }
    function categoriaDe(u){
      if(['mg','g','kg'].includes(u)) return ['mg','g','kg'];
      if(['ml','l'].includes(u)) return ['ml','l'];
      return ['pz'];
    }

    // BUILD PRODUCT INFO
    function buildProductInfo(){
      productInfo = {};
      almacenData.forEach(it=>{
        const cat = ['mg','g','kg'].includes(it.unidadDeMedida)? 'peso'
                  : ['ml','l'].includes(it.unidadDeMedida)? 'volumen'
                  : 'conteo';
        const base = parseFloat(it.cantidad)*FACTORES[it.unidadDeMedida]||1;
        productInfo[it.codigo] = {
          priceBase: parseFloat(it.precio)/base||0,
          categoria: cat,
          opcionesUnidad: categoriaDe(it.unidadDeMedida)
        };
      });
    }

    // RENDER STOCK
    function renderStockTable() {
      const grid = document.getElementById('stock-grid');
      grid.innerHTML = '';
      const compMap = {}, usedMap = {};
      comprasData.forEach(c => compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
      ventData.forEach(v => v.venta.forEach(it => {
        const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
        if(!rec) return;
        rec.ingredientes.forEach(ing=>{
          usedMap[ing.codigo] = (usedMap[ing.codigo]||0) + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
        });
      }));
      almacenData.forEach(it=>{
        const info = productInfo[it.codigo];
        const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
        const bought = compMap[it.codigo]||0;
        const used   = usedMap[it.codigo]||0;
        const remain = bought - used;
        const pct    = recBase? remain/recBase*100 : 0;
        let estado   = pct<=50?'üî¥ Bajo': pct<=80?'üü† Medio': pct<=100?'üü¢ Bueno':'üîµ Excedente';
        const delta    = recBase - remain;
        const accion   = delta>0?`Ordenar ${Math.abs(delta)}${info.categoria==='peso'?'g':'pz'}`:`Sobrante ${Math.abs(delta)}${info.categoria==='peso'?'g':'pz'}`;
        const totalB   = (info.priceBase*bought).toFixed(2);
        const totalU   = (info.priceBase*used).toFixed(2);
        const totalR   = (info.priceBase*remain).toFixed(2);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">#${it.codigo} ‚Äì ${it.name||'Sin nombre'}</div>
          <div class="card-body">
            <label>Nombre:<input type="text" id="name-${it.codigo}" value="${it.name||''}"></label>
            <label>Precio base:<input type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></label>
            <label>Cant. inicial:<input type="number" id="cant-${it.codigo}" value="${it.cantidad||0}"></label>
            <label>Unidad:
              <select id="unidad-${it.codigo}">
                ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`).join('')}
              </select>
            </label>
            <label>Stock rec.:<input type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}"></label>
            <label>Proveedor:<input type="text" id="prov-${it.codigo}" value="${it.proveedor||''}"></label>
            <hr>
            <div class="info2">
              <p><strong>Comprado:</strong> ${bought} (~ $${totalB})</p>
              <p><strong>Usado:</strong> ${used} (~ $${totalU})</p>
              <p><strong>Restante:</strong> ${remain} (~ $${totalR})</p>
              <p><strong>Estado:</strong> ${estado}</p>
              <p><strong>Acci√≥n:</strong> ${accion}</p>
            </div>
            <label>Comprar:
              <input type="number" id="buyqty-${it.codigo}" value="1" style="width:4rem;">
              <select id="buyunit-${it.codigo}" style="width:auto;">
                ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
              </select>
            </label>
          </div>
          <div class="card-footer">
            <button onclick="buyProduct('${it.codigo}')"><i class="fa-solid fa-cart-shopping"></i></button>
            <button onclick="saveAlmacen('${it.codigo}')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button class="delete-btn" onclick="deleteAlmacen('${it.codigo}')"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        grid.appendChild(card);
      });
    }

    // RENDER COMPRAS
    function renderComprasTable() {
      const grid = document.getElementById('compras-grid');
      grid.innerHTML = '';
      comprasData.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach(c=>{
        const prod = almacenData.find(x=>x.codigo==c.idProducto);
        if(!prod) return;
        const info = productInfo[c.idProducto];
        const total = (info.priceBase*c.cantidad*FACTORES[c.unidad]).toFixed(2);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div class="card-header">Compra #${c.idCompra}</div>
          <div class="card-body">
            <label>Fecha:<input type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}"></label>
            <p><strong>Producto:</strong> ${prod.name}</p>
            <label>Cantidad:<input type="number" id="qty-${c.idCompra}" value="${c.cantidad}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')"></label>
            <label>Unidad:
              <select id="unit-${c.idCompra}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')">
                ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`).join('')}
              </select>
            </label>
            <p><strong>Total:</strong> $<span id="total-${c.idCompra}">${total}</span></p>
          </div>
          <div class="card-footer">
            <button onclick="saveCompra('${c.idCompra}','${c.idProducto}')"><i class="fa-solid fa-floppy-disk"></i></button>
            <button class="delete-btn" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')"><i class="fa-solid fa-trash"></i></button>
          </div>`;
        grid.appendChild(card);
        recalcCompra(c.idCompra, c.idProducto);
      });
    }

    // FUNCIONES VENTAS
    function crearItemRow(cod='',cant='',tot='') {
      const row = document.createElement('div'); row.className='item-row';
      const sel = document.createElement('select');
      recetas.forEach(r=>{
        const o = document.createElement('option'); o.value=r.codigo; o.textContent=r.nombre;
        if(r.codigo===cod) o.selected=true;
        sel.append(o);
      });
      const ic = document.createElement('input'); ic.type='number'; ic.min='1'; ic.value=cant; ic.placeholder='Cantidad';
      const it = document.createElement('input'); it.type='number'; it.value=tot; it.placeholder='Total';
      const bd = document.createElement('button'); bd.type='button'; bd.textContent='‚àí'; bd.onclick=()=>row.remove();
      function recalc(){
        const p = recetas.find(x=>x.codigo===sel.value)||{precio:0};
        it.value = (p.precio*(parseFloat(ic.value)||0)).toFixed(2);
      }
      sel.onchange = recalc; ic.oninput = recalc;
      row.append(sel, ic, it, bd);
      return row;
    }
    function renderTicketCard(v) {
      const c = document.createElement('div'); c.className='ticket-card';
      c.innerHTML = `
        <div class="ticket-header">${new Date(v.fecha).toLocaleDateString()}</div>
        <div class="ticket-method"><strong>Pago:</strong> ${v.metodoPago}</div>
        <div class="ticket-items"></div>
        <div class="ticket-footer"><strong>Total:</strong> <span class="ticket-total">0</span></div>
        <div class="card-footer">
          <button class="edit-btn">Editar</button>
          <button class="delete-btn"><i class="fa-solid fa-trash"></i></button>
        </div>`;
      let total = 0;
      v.venta.forEach(it=>{
        const d = document.createElement('div'); d.className='ticket-item';
        d.textContent = `${it.producto} x${it.cantidad} = $${it.total}`;
        total += parseFloat(it.total)||0;
        c.querySelector('.ticket-items').appendChild(d);
      });
      c.querySelector('.ticket-total').textContent = total.toFixed(2);
      c.querySelector('.edit-btn').onclick   = ()=> startEdit(v);
      c.querySelector('.delete-btn').onclick = async()=>{
        if(!confirm('¬øEliminar venta?')) return;
        await callApi({op:'eliminarVentas',id:v.id});
        loadData();
      };
      return c;
    }
    async function cargarVentas(){
      await fetchRecetas();
      const res = await callApi({op:'obtenerVentas'});
      if(res.status!=='success') return;
      ventData = res.data;
      const grid = document.getElementById('tickets-grid'); grid.innerHTML = '';
      ventData.forEach(v=> grid.appendChild(renderTicketCard(v)));
      actualizarResumen(ventData);
    }

    // ACCIONES STOCK & COMPRAS
    async function addNewProducto(){
      const code = Date.now();
      almacenData.push({ codigo:code,name:'',precio:0,cantidad:0,unidadDeMedida:'pz',stockRecomendado:0,proveedor:'' });
      buildProductInfo();
      renderStockTable();
    }
    async function saveAlmacen(c){
      await callApi({
        op:'guardarAlmacen', codigo:c,
        name:document.getElementById(`name-${c}`).value,
        precio:document.getElementById(`precio-${c}`).value,
        cantidad:document.getElementById(`cant-${c}`).value,
        unidadDeMedida:document.getElementById(`unidad-${c}`).value,
        stockRecomendado:document.getElementById(`rec-${c}`).value,
        proveedor:document.getElementById(`prov-${c}`).value
      });
      loadData();
    }
    async function deleteAlmacen(c){
      await callApi({op:'eliminarAlmacen', codigo:c});
      loadData();
    }
    async function buyProduct(id){
      const info = productInfo[id];
      const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value)||0;
      if(qty<=0) return;
      const uni = document.getElementById(`buyunit-${id}`).value;
      const total = (info.priceBase*qty*FACTORES[uni]).toFixed(2);
      const fecha = new Date().toISOString().slice(0,10);
      await callApi({op:'guardarCompras',idProducto:id,fecha,name:almacenData.find(x=>x.codigo==id).name,precio:total,cantidad:qty,unidad:uni});
      loadData();
    }

    // RECALC Y CRUD COMPRAS
    function recalcCompra(idC,idP){
      const info=productInfo[idP];
      const qty = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
      const uni = document.getElementById(`unit-${idC}`).value;
      document.getElementById(`total-${idC}`).textContent = (info.priceBase*qty*FACTORES[uni]).toFixed(2);
    }
    async function saveCompra(idC,idP){
      const qty = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
      if(qty<=0) return;
      const uni  = document.getElementById(`unit-${idC}`).value;
      const fecha= document.getElementById(`date-${idC}`).value;
      const total= (productInfo[idP].priceBase*qty*FACTORES[uni]).toFixed(2);
      await callApi({op:'guardarCompras',idCompra:idC,idProducto:idP,fecha,name:almacenData.find(x=>x.codigo==idP).name,precio:total,cantidad:qty,unidad:uni});
      loadData();
    }
    async function deleteCompra(idC,idP){
      await callApi({op:'eliminarCompras',idCompra:idC,idProducto:idP});
      loadData();
    }

    // FORMULARIO VENTAS
    document.getElementById('btn-add-item').onclick = () =>
      document.getElementById('items-container').append(crearItemRow());
    document.getElementById('btn-cancel').onclick = resetForm;
    document.getElementById('btn-save').onclick = async () => {
      const id    = document.getElementById('form-id').value;
      const fecha = document.getElementById('form-fecha').value;
      if(!fecha) return;
      const metodo = document.getElementById('form-pago').value;
      const rows  = document.querySelectorAll('#items-container .item-row');
      if(rows.length===0) return;
      const venta = Array.from(rows).map(r=>{
        const [sel, ic, it] = r.children;
        return { codigo:sel.value, producto:recetas.find(x=>x.codigo===sel.value).nombre, cantidad:Number(ic.value)||0, total:Number(it.value)||0 };
      });
      const res = await callApi({op:'guardarVentas', venta: JSON.stringify({id,fecha,venta,metodoPago:metodo})});
      if(res.status==='success'){
        resetForm();
        loadData();
      }
    };
    function startEdit(v){
      document.getElementById('form-id').value = v.id;
      document.getElementById('form-title').textContent = 'Editar Venta';
      document.getElementById('form-fecha').value = new Date(v.fecha).toISOString().slice(0,10);
      document.getElementById('form-pago').value = v.metodoPago;
      const cont = document.getElementById('items-container'); cont.innerHTML = '';
      v.venta.forEach(it=> cont.append(crearItemRow(it.codigo,it.cantidad,it.total)));
    }
    function resetForm(){
      document.getElementById('form-id').value = '';
      document.getElementById('form-title').textContent = 'Nueva Venta';
      document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
      document.getElementById('form-pago').value = 'Efectivo';
      const cont = document.getElementById('items-container'); cont.innerHTML = '';
      cont.append(crearItemRow());
    }
    function actualizarResumen(vs){
      let e=0,t=0,ta=0;
      vs.forEach(v=>{
        const s = v.venta.reduce((a,i)=>a+parseFloat(i.total||0),0);
        if(v.metodoPago==='Efectivo') e+=s;
        else if(v.metodoPago==='Transferencia') t+=s;
        else if(v.metodoPago==='Tarjeta') ta+=s;
      });
      document.getElementById('sum-efectivo').textContent     = e.toFixed(2);
      document.getElementById('sum-transferencia').textContent = t.toFixed(2);
      document.getElementById('sum-tarjeta').textContent      = ta.toFixed(2);
      document.getElementById('sum-total').textContent        = (e+t+ta).toFixed(2);
    }

    // RECETARIO CRUD HELPERS
    const selCategoria      = document.getElementById('receta-categoria');
    const inpCatNueva       = document.getElementById('receta-categoria-nueva');
    const inpCodigo         = document.getElementById('receta-codigo');
    const inpNombre         = document.getElementById('receta-nombre');
    const inpImagen         = document.getElementById('receta-imagen');
    const tblIngredientes   = document.querySelector('#ingredientes-table tbody');
    const btnAddIngrediente = document.getElementById('agregar-ingrediente');
    const btnGuardarReceta  = document.getElementById('guardar-receta');
    const btnLimpiarForm    = document.getElementById('limpiar-form');
    const contRecetas       = document.getElementById('lista-recetas');

    function setupCategoriaSelect(){
      const cats = [...new Set(cocData.map(r=>r.categoria))].sort();
      selCategoria.innerHTML =
        '<option value="">-- Selecciona categor√≠a --</option>' +
        cats.map(c=>`<option value="${c}">${c}</option>`).join('') +
        '<option value="__nueva__">+ Nueva categor√≠a</option>';
      selCategoria.onchange = ()=> inpCatNueva.classList.toggle('hidden', selCategoria.value!=='__nueva__');
    }

    function crearSelectProducto(){
      const sel = document.createElement('select');
      almacenData.forEach(p=>{
        const opt = new Option(`${p.name} (${p.cantidad}${p.unidadDeMedida})`, p.codigo);
        opt.dataset.unit = p.unidadDeMedida;
        sel.append(opt);
      });
      return sel;
    }

    function crearSelectUnidad(unidad=''){
      const cat = ['mg','g','kg'].includes(unidad)? 'peso'
                : ['ml','l'].includes(unidad)? 'volumen'
                : 'conteo';
      const opts = cat==='peso'? ['mg','g','kg']
                 : cat==='volumen'? ['ml','l']
                 : ['pz'];
      const sel = document.createElement('select');
      opts.forEach(u=> sel.append(new Option(u,u)));
      if(unidad) sel.value = unidad;
      return sel;
    }

    function agregarIngredienteRow(item={}){
      const tr = document.createElement('tr');
      const selP = crearSelectProducto(); if(item.codigo) selP.value = item.codigo;
      const inpC = document.createElement('input'); inpC.type='number'; inpC.min='1'; inpC.value=item.cantidad||1;
      let selU = crearSelectUnidad(item.unidad||selP.selectedOptions[0].dataset.unit);
      selP.onchange = ()=>{
        const newU = crearSelectUnidad(selP.selectedOptions[0].dataset.unit);
        tr.children[2].replaceChild(newU, selU);
        selU = newU;
      };
      const btnDel = document.createElement('button');
      btnDel.type='button'; btnDel.className='del'; btnDel.textContent='Eliminar';
      btnDel.onclick = ()=> tr.remove();
      [selP, inpC, selU, btnDel].forEach(el=>{
        const td = document.createElement('td'); td.append(el); tr.append(td);
      });
      tblIngredientes.append(tr);
    }

    function resetRecetaForm(){
      editRecetaCodigo = null;
      document.getElementById('form-receta').reset();
      inpCodigo.disabled = false;
      inpCatNueva.classList.add('hidden');
      tblIngredientes.innerHTML = '';
    }

    function cargarRecetaEnForm(r){
      editRecetaCodigo = r.codigo;
      inpCodigo.value = r.codigo; inpCodigo.disabled = true;
      inpNombre.value = r.nombre;
      if(!cocData.find(x=>x.categoria===r.categoria)){
        selCategoria.value = '__nueva__';
        inpCatNueva.value   = r.categoria;
        inpCatNueva.classList.remove('hidden');
      } else {
        selCategoria.value = r.categoria;
        inpCatNueva.classList.add('hidden');
      }
      inpImagen.value = r.imagen||'';
      tblIngredientes.innerHTML = '';
      r.ingredientes.forEach(i=> agregarIngredienteRow(i));
    }

    async function eliminarReceta(codigo){
      if(!confirm(`¬øEliminar receta ${codigo}?`)) return;
      await callApi({op:'eliminarCocina', codigo});
      await loadData();
    }

    function renderRecetario(){
      contRecetas.innerHTML = '';
      cocData.forEach(r=>{
        const costo = r.ingredientes.reduce((sum, ing)=>{
          const p = productInfo[ing.codigo];
          return p ? sum + p.priceBase * ing.cantidad * FACTORES[ing.unidad] : sum;
        },0) * MARGEN;
        const card = document.createElement('div'); card.className = 'card receta';
        card.innerHTML = `
          <div class="card-header">#${r.codigo} ‚Äì ${r.nombre}</div>
          <div class="card-body">
            <p><strong>Categor√≠a:</strong> ${r.categoria}</p>
            ${r.imagen?`<img src="${r.imagen}" alt="${r.nombre}">`:''}
            <ul class="ingredientes">
              ${r.ingredientes.map(i=>`<li>${i.cantidad}${i.unidad} de ${i.codigo}</li>`).join('')}
            </ul>
            <p class="costo-total">Costo: $${costo.toFixed(2)}</p>
          </div>
          <div class="card-footer btns">
            <button class="edit-btn">Editar</button>
            <button class="del">Eliminar</button>
          </div>`;
        card.querySelector('.edit-btn').onclick = ()=> cargarRecetaEnForm(r);
        card.querySelector('.del').onclick     = ()=> eliminarReceta(r.codigo);
        contRecetas.append(card);
      });
    }

    // EVENTOS FORM RECETAS
    btnAddIngrediente.onclick = e=>{ e.preventDefault(); agregarIngredienteRow(); };
    btnLimpiarForm.onclick    = e=>{ e.preventDefault(); resetRecetaForm(); };
    btnGuardarReceta.onclick  = async e=>{
      e.preventDefault();
      const codigo = inpCodigo.value.trim();
      const nombre = inpNombre.value.trim();
      if(!codigo||!nombre){ alert('C√≥digo y nombre requeridos'); return; }
      const categoria = selCategoria.value==='__nueva__' ? inpCatNueva.value.trim() : selCategoria.value;
      const ingredientes = Array.from(tblIngredientes.children).map(tr=>({
        codigo: tr.children[0].firstChild.value,
        cantidad:+tr.children[1].firstChild.value,
        unidad: tr.children[2].firstChild.value
      }));
      const receta = { codigo, nombre, categoria, imagen: inpImagen.value.trim(), ingredientes };
      await callApi({ op:'guardarCocina', receta: JSON.stringify(receta) });
      resetRecetaForm();
      await loadData();
    };

    // ACTUALIZAR ESTAD√çSTICAS
    function updateTopStats(){
      let totalInv=0, totalCompras=0, totalRestock=0;
      const compMap={}, usedMap={};
      comprasData.forEach(c=> compMap[c.idProducto]= (compMap[c.idProducto]||0)+c.cantidad*FACTORES[c.unidad]);
      ventData.forEach(v=> v.venta.forEach(it=>{
        const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
        if(!rec) return;
        rec.ingredientes.forEach(ing=> usedMap[ing.codigo] = (usedMap[ing.codigo]||0)+ing.cantidad*FACTORES[ing.unidad]*it.cantidad);
      }));
      almacenData.forEach(it=>{
        const info=productInfo[it.codigo];
        const bought=compMap[it.codigo]||0, used=usedMap[it.codigo]||0;
        const rem=bought-used;
        totalInv += rem*info.priceBase;
        totalCompras += comprasData.reduce((s,c)=> s + info.priceBase*c.cantidad*FACTORES[c.unidad], 0);
        const recBase=(parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
        const delta = recBase-rem;
        if(delta>0) totalRestock += delta*info.priceBase;
      });
      document.getElementById('stat-inventory').textContent  = totalInv.toFixed(2);
      document.getElementById('stat-purchases').textContent = totalCompras.toFixed(2);
      document.getElementById('stat-restock').textContent   = totalRestock.toFixed(2);
    }

    // CARGA INICIAL
    async function loadData(){
      const [alm, coc, vent, comp] = await Promise.all([
        callApi({op:'obtenerAlmacen'}),
        callApi({op:'obtenerCocina'}),
        callApi({op:'obtenerVentas'}),
        callApi({op:'obtenerCompras'})
      ]);
      if([alm, coc, vent, comp].some(r=> r.status!=='success')) return;
      almacenData = alm.data;
      cocData     = coc.data;
      ventData    = vent.data;
      comprasData = comp.data;
      buildProductInfo();
      renderStockTable();
      renderComprasTable();
      cargarVentas();
      updateTopStats();
      setupCategoriaSelect();
      renderRecetario();
      resetRecetaForm();
    }

    // helper fetchRecetas for ventas
    async function fetchRecetas(){
      const res = await callApi({op:'obtenerCocina'});
      if(res.status==='success') cocData = res.data;
      recetas = cocData.map(r=>{
        const costo = r.ingredientes.reduce((sum, ing)=>{
          const p = almacenData.find(x=>String(x.codigo)===String(ing.codigo));
          return p ? sum + (p.precio/(FACTORES[p.unidadDeMedida]*p.cantidad))*(FACTORES[ing.unidad]*ing.cantidad) : sum;
        },0);
        return { codigo:r.codigo, nombre:r.nombre, precio:(costo*MARGEN).toFixed(2) };
      });
    }

    window.onload = loadData;
  </script>
</body>
</html>
