<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <title>Unificaci√≥n</title>
  <style>
    *{ box-sizing: border-box; margin: 0; padding: 0; }
  
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      color: #333;
      padding: 1rem;
      padding-bottom: calc(60px + 1rem);
    }
  
    /* NAVEGACI√ìN */
    nav.top-nav {
      display: flex;
      margin-bottom: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    nav.top-nav button {
      flex: 1;
      padding: .75rem 0;
      border: none;
      background: #3f51b5;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: opacity .3s;
    }
    nav.top-nav button:not(.active) { opacity: .6; }
    .section { display: none; }
    .section.active { display: block; }
  
    /* GRID DE TARJETAS */
    .card-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
    }
  
    /* TARJETA */
    .card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .card-header {
      font-weight: bold;
      margin-bottom: .1rem;
      font-size: 5px;
    }
    .card-body label {
      display: block;
      margin-bottom: .5rem;
      font-size: 10px;
    }
    .card-body input {
      width: 40%;
      border: none;
      text-align: center;
    
    }
    .card-footer {
      margin-top: 10px;
      display: flex;
      gap: .2rem;
    }
    .info2 p {
      font-size: 10px;
    }
    .info2 strong {
      font-weight: 400;
    }
    .card-footer button {
      flex: 1;
      padding: .2rem;
      font-size: 14px;
      border: none;
      background: #3f51b5;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity .3s;
    }
    .card-footer button.delete-btn { 
    background: #cc3e44; 
      
    }
    .card-footer button:hover { opacity: .85; }
  
    /* BOT√ìN AGREGAR */
    .btn-add {
      display: block;
      width: 100%;
      padding: .75rem 0;
      margin-bottom: 1rem;
      background: #3f51b5;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      transition: opacity .3s;
    }
    .btn-add:hover { opacity: .85; }
  
    /* FORMULARIO VENTAS */
    .form-panel {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .item-row {
      margin-bottom: .75rem;
    }
    .item-row input,
    .item-row select {
    width: 100%;
   padding: .5rem;
   border: 1px solid rgba(0,0,0,0.1);
   border-radius: 4px;
    }
select {


  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  background-color: #fff;
  color: #333;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-repeat: no-repeat;
  background-position: right 0.75rem center;
  cursor: pointer;
  transition: border-color 0.2s ease-in-out;
}

select:focus {
  border-color: #66afe9;
  outline: none;
}
    
    
    
    
    
    
    
    
    
    
    
    
    .item-row button { flex: 0 0 auto; padding: .4rem .8rem; }
  
    /* TICKETS VENTAS */
    #tickets-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.50rem;
    }
    .ticket-card {
      background: #fff;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
    }
    .ticket-header { font-weight: bold; margin-bottom: .5rem; }
    .ticket-method,
    .ticket-footer { margin: .5rem 0; }
    .ticket-item { margin-left: 1rem; font-size: .9rem; }
  
    /* FOOTER RESUMEN */
    footer.payment-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: #3f51b5;
      color: #fff;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.2);
      font-size: .9rem;
      z-index: 100;
    }
    footer.payment-summary div span {
      display: block;
      font-weight: bold;
      margin-top: .25rem;
    }
    /* PANEL DE ESTAD√çSTICAS */


.top-stats {
  position: sticky;
  top: 1rem;
  z-index: 90;      
  display: flex;
  justify-content: space-around;
  background: #fff;
  padding: .5rem 0;
  margin-bottom: 1rem;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.top-stats div {
  text-align: center;
  font-size: .9rem;
}
.top-stats i {
  margin-bottom: .25rem;
  display: block;
  font-size: 1.2rem;
  color: #3f51b5;
}
.top-stats strong {
  display: block;
  margin-top: .25rem;
  font-size: 1.1rem;
}
  .hidden { display: none; }
.dividirEn2{
  display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 10px;

}
  </style>
</head>
<body>

  <!-- ESTAD√çSTICAS -->
  <div class="top-stats">
    <div><i class="fa-solid fa-warehouse"></i>Inventario<br><strong id="stat-inventory">0.00</strong></div>
    <div><i class="fa-solid fa-cart-shopping"></i>Compras<br><strong id="stat-purchases">0.00</strong></div>
    <div><i class="fa-solid fa-truck-moving"></i>Reposici√≥n<br><strong id="stat-restock">0.00</strong></div>
  </div>

  <!-- NAVEGACI√ìN -->
  <nav class="top-nav">
    <button data-sec="stock" class="active" onclick="cambiarSeccion('stock')">Stock</button>
    <button data-sec="compras" onclick="cambiarSeccion('compras')">Compras</button>
    <button data-sec="ventas" onclick="cambiarSeccion('ventas')">Ventas</button>
    <button data-sec="recetas" onclick="cambiarSeccion('recetas')">Recetas</button>
  </nav>

  <!-- STOCK -->
  <section id="stock" class="section active">
    <h2>Stock de Productos</h2>
    <button class="btn-add" onclick="addNewProducto()">‚ûï Nuevo Producto</button>
    <div id="stock-grid" class="card-grid"></div>
  </section>

  <!-- COMPRAS -->
  <section id="compras" class="section">
    <h2>Historial de Compras</h2>
    <div id="compras-grid" class="card-grid"></div>
  </section>

  <!-- VENTAS -->
  <section id="ventas" class="section">
    <h2>Gesti√≥n de Ventas</h2>
    <div class="form-panel">
      <h3 id="form-title">Nueva Venta</h3>
      <input type="hidden" id="form-id">
      <div class="item-row">
        <label style="flex:1"><input type="date" id="form-fecha"></label>
      </div>
      <div id="items-container"></div>
      <button id="btn-add-item" class="btn-add" onclick="agregarItemVenta()">+ Agregar producto</button>
      <div class="item-row">
        <label style="flex:1">
          <select id="form-pago">
            <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
          </select>
        </label>
      </div>
      <div style="display:flex;gap:.5rem;">
        <button id="btn-save" class="btn-add" onclick="guardarVenta()"><i class="fa-solid fa-floppy-disk"></i> Guardar</button>
        <button id="btn-cancel" class="delete-btn" onclick="resetForm()">Cancelar</button>
      </div>
    </div>
    <div id="tickets-grid" class="card-grid"></div>
  </section>

  <!-- RECETAS -->
  <section id="recetas" class="section">
    <h2>CRUD Recetas</h2>
    <div class="form-panel">
      <h3 id="form-receta-title">Nueva Receta</h3>
      <input type="hidden" id="form-receta-id">

      <!-- C√≥digo y Nombre -->
      <div class="item-row dividirEn2">
        <input id="receta-codigo" type="text" placeholder="Ej: R001">
        <input id="receta-nombre" type="text" placeholder="Nombre receta">
      </div>

      <div class="item-row dividirEn2">
        <label>
          Categor√≠a:<br>
          <select id="receta-categoria" onchange="toggleNuevaCategoria()"></select>
        </label>
        <label style="flex:1" class="hidden" id="wrapper-receta-categoria-nueva">
          Nueva categor√≠a:<br>
          <input id="receta-categoria-nueva" type="text" placeholder="Nueva categor√≠a">
        </label>
        <input id="receta-imagen" type="text" placeholder="http://...">
      </div>

      <!-- Ingredientes -->
      <h3>Ingredientes</h3>
      <div class="item-row">
        <button id="agregar-ingrediente" class="btn-add" onclick="agregarFila()">+ Agregar ingrediente</button>
      </div>
      <table id="ingredientes-table" style="width:100%; margin-top:.5rem; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align:left">Producto</th>
            <th style="text-align:left">Cantidad</th>
            <th style="text-align:left">Unidad</th>
            <th style="text-align:left">Acci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <!-- Acciones -->
      <div class="item-row" style="gap:0.5rem; margin-top:1rem;">
        <button id="guardar-receta" class="btn-add" style="flex:1" onclick="guardarReceta()">
          <i class="fa-solid fa-floppy-disk"></i> Guardar
        </button>
        <button id="limpiar-form" class="delete-btn" style="flex:1" onclick="limpiarForm()">
          Limpiar
        </button>
      </div>
    </div>

    <!-- Listado de Recetas -->
    <div id="lista-recetas" class="card-grid"></div>
  </section>

  <footer class="payment-summary">
    <div>Efectivo<br><span id="sum-efectivo">0.00</span></div>
    <div>Transferencia<br><span id="sum-transferencia">0.00</span></div>
    <div>Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
    <div>Total<br><span id="sum-total">0.00</span></div>
  </footer>

<script>
  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî PAGINACI√ìN ENTRE SECCIONES ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function cambiarSeccion(sec) {
    document.querySelectorAll('nav.top-nav button').forEach(b => b.classList.remove('active'));
    document.querySelector(`nav.top-nav button[data-sec="${sec}"]`).classList.add('active');
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(sec).classList.add('active');
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CONSTANTES Y ESTADO GLOBAL ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
  const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
  const MARGEN     = 1.55;
  const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };
  const LS_KEYS    = {
    almacen:    'Almac01',
    compras:    'Comp02',
    recetas:    'Recet03',
    ventas:     'Vent04',
    pendientes: 'Pend05'
  };

  let almacenData = [], comprasData = [], recetasData = [], ventData = [], cocData = [];
  let productInfo = {}, editMode = false;

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî UTILIDADES ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function categoriaDe(u) {
    if (['mg','g','kg'].includes(u)) return 'peso';
    if (['ml','l'].includes(u)) return 'volumen';
    return 'conteo';
  }
  function humanizeComposite(b,c) {
    if (c==='peso') {
      const kg=Math.trunc(b/1000), g=b%1000, out=[];
      if(kg) out.push(`${kg}kg`); if(g) out.push(`${g}g`);
      return out.join(' ')||'0g';
    }
    if (c==='volumen') {
      const l=Math.trunc(b/1000), m=b%1000, out=[];
      if(l) out.push(`${l}l`); if(m) out.push(`${m}ml`);
      return out.join(' ')||'0ml';
    }
    return `${b.toFixed(0)}pz`;
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CACHE‚ÄëASIDE ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function loadCache() {
    almacenData = JSON.parse(localStorage.getItem(LS_KEYS.almacen) || '[]');
    comprasData = JSON.parse(localStorage.getItem(LS_KEYS.compras) || '[]');
    recetasData = JSON.parse(localStorage.getItem(LS_KEYS.recetas) || '[]');
    ventData    = JSON.parse(localStorage.getItem(LS_KEYS.ventas)  || '[]');
    cocData     = recetasData.slice();
  }
  function saveCache() {
    localStorage.setItem(LS_KEYS.almacen, JSON.stringify(almacenData));
    localStorage.setItem(LS_KEYS.compras, JSON.stringify(comprasData));
    localStorage.setItem(LS_KEYS.recetas, JSON.stringify(recetasData));
    localStorage.setItem(LS_KEYS.ventas,  JSON.stringify(ventData));
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî COLA DE PENDIENTES ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function loadPendientes() {
    return JSON.parse(localStorage.getItem(LS_KEYS.pendientes) || '[]');
  }
  function savePendientes(p) {
    localStorage.setItem(LS_KEYS.pendientes, JSON.stringify(p));
  }
  function enqueueOp(op, params) {
    const p = loadPendientes();
    p.push({ op, params });
    savePendientes(p);
  }
  async function processPendientes() {
    const pend = loadPendientes(), still = [];
    for (const {op,params} of pend) {
      try { await postOp(op, params); }
      catch { still.push({op,params}); }
    }
    savePendientes(still);
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî BACKEND ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function callApi(params) {
    const url = new URL(API_URL);
    Object.entries(params).forEach(([k,v])=> url.searchParams.append(k,v));
    return fetch(url).then(r=>r.json());
  }
  async function postOp(op, params={}) {
    const fd = new FormData();
    fd.append('op', op);
    Object.entries(params).forEach(([k,v])=> fd.append(k,v));
    const res = await fetch(API_URL, { method:'POST', body:fd });
    const json = await res.json();
    if (json.status!=='success') throw new Error(json.message);
    return json.data;
  }
  async function sendOrEnqueue(op, params) {
    try { await postOp(op, params); }
    catch { enqueueOp(op, params); }
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî BUILD PRODUCT INFO ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function buildProductInfo() {
    productInfo = {};
    almacenData.forEach(it=>{
      const uni = it.unidadDeMedida.trim().toLowerCase(),
            cat = categoriaDe(uni),
            base= parseFloat(it.cantidad)*FACTORES[uni] || 1;
      productInfo[it.codigo] = {
        priceBase: parseFloat(it.precio)/base,
        categoria:  cat,
        opcionesUnidad: CATEGORIAS[cat]
      };
    });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RENDER STOCK ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function renderStockTable() {
    const grid = document.getElementById('stock-grid');
    grid.innerHTML = '';
    const compMap={}, usedMap={};
    comprasData.forEach(c=> compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
    ventData.forEach(v=> v.venta.forEach(it=>{
      const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing=>{
        usedMap[ing.codigo] = (usedMap[ing.codigo]||0)
          + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
      });
    }));
    almacenData.forEach(it=>{
      const info    = productInfo[it.codigo],
            recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida],
            bought  = compMap[it.codigo]||0,
            used    = usedMap[it.codigo]||0,
            remain  = bought - used,
            pct     = recBase ? remain/recBase*100 : 0;
      let estado;
      if (pct<=50) estado='üî¥ Bajo';
      else if (pct<=80) estado='üü† Medio';
      else if (pct<=100) estado='üü¢ Bueno';
      else estado='üîµ Excedente';
      const delta = recBase - remain,
            accion= delta>0
                   ? `Ordenar ${humanizeComposite(delta,info.categoria)}`
                   : `Sobrante ${humanizeComposite(-delta,info.categoria)}`,
            totalB=(info.priceBase*bought).toFixed(2),
            totalU=(info.priceBase*used).toFixed(2),
            totalR=(info.priceBase*remain).toFixed(2);
      const card = document.createElement('div');
      card.className='card';
      card.innerHTML=`
        <div class="card-header">#${it.codigo} ‚Äì ${it.name||'Sin nombre'}</div>
        <div class="card-body">
          <label>Nombre:<input id="name-${it.codigo}" value="${it.name||''}"></label>
          <label>Precio:<input type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></label>
          <label>Cant.:<input type="number" id="cant-${it.codigo}" value="${it.cantidad||0}"></label>
          <label>Unidad:<select id="unidad-${it.codigo}">
            ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`).join('')}
          </select></label>
          <label>Stock rec:<input type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}"></label>
          <label>Prov.:<input id="prov-${it.codigo}" value="${it.proveedor||''}"></label>
          <hr>
          <div class="info2">
            <p><strong>Comprado:</strong> ${humanizeComposite(bought,info.categoria)} (~$${totalB})</p>
            <p><strong>Usado:</strong>    ${humanizeComposite(used,info.categoria)} (~$${totalU})</p>
            <p><strong>Restante:</strong> ${humanizeComposite(remain,info.categoria)} (~$${totalR})</p>
            <p><strong>Estado:</strong>   ${estado}</p>
            <p><strong>Acci√≥n:</strong>   ${accion}</p>
          </div>
          <label>Comprar:
            <input type="number" id="buyqty-${it.codigo}" value="1" style="width:4rem;">
            <select id="buyunit-${it.codigo}" style="width:auto;">
              ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
            </select>
          </label>
        </div>
        <div class="card-footer">
          <button onclick="buyProduct('${it.codigo}')">üõí</button>
          <button onclick="saveAlmacen('${it.codigo}')">üíæ</button>
          <button onclick="deleteAlmacen('${it.codigo}')">‚ùå</button>
        </div>
      `;
      grid.append(card);
    });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî RENDER COMPRAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function renderComprasTable() {
    const grid = document.getElementById('compras-grid');
    grid.innerHTML = '';
    comprasData
      .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))
      .forEach(c => {
        const prod = almacenData.find(x=>x.codigo==c.idProducto);
        if (!prod) return;
        const info  = productInfo[c.idProducto],
              total = (info.priceBase * c.cantidad * FACTORES[c.unidad]).toFixed(2);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML=`
          <div class="card-header">Compra #${c.idCompra}</div>
          <div class="card-body">
            <label>Fecha:<input type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}"></label>
            <p>Producto: ${prod.name}</p>
            <label>Cant.:<input type="number" id="qty-${c.idCompra}" value="${c.cantidad}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')"></label>
            <label>Unidad:<select id="unit-${c.idCompra}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')">
              ${info.opcionesUnidad.map(u=>`<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`).join('')}
            </select></label>
            <p>Total: $<span id="total-${c.idCompra}">${total}</span></p>
          </div>
          <div class="card-footer">
            <button onclick="saveCompra('${c.idCompra}','${c.idProducto}')">üíæ</button>
            <button onclick="deleteCompra('${c.idCompra}','${c.idProducto}')">‚ùå</button>
          </div>
        `;
        grid.append(card);
        recalcCompra(c.idCompra, c.idProducto);
      });
  }

  function recalcCompra(idC,idP) {
    const info = productInfo[idP],
          qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0,
          uni  = document.getElementById(`unit-${idC}`).value;
    document.getElementById(`total-${idC}`)
      .textContent = (info.priceBase*qty*FACTORES[uni]).toFixed(2);
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CRUD ALMAC√âN ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  async function addNewProducto() {
    const n = { codigo:Date.now(), name:'', precio:0, cantidad:0, unidadDeMedida:'pz', stockRecomendado:0, proveedor:'' };
    almacenData.push(n); saveCache(); buildProductInfo(); renderStockTable();
    await sendOrEnqueue('guardarAlmacen', n);
  }
  async function saveAlmacen(c) {
    const it = almacenData.find(x=>x.codigo==c);
    it.name             = document.getElementById(`name-${c}`).value;
    it.precio           = document.getElementById(`precio-${c}`).value;
    it.cantidad         = document.getElementById(`cant-${c}`).value;
    it.unidadDeMedida   = document.getElementById(`unidad-${c}`).value;
    it.stockRecomendado = document.getElementById(`rec-${c}`).value;
    it.proveedor        = document.getElementById(`prov-${c}`).value;
    saveCache(); buildProductInfo(); renderStockTable();
    await sendOrEnqueue('guardarAlmacen', {
      codigo:c, name:it.name, precio:it.precio,
      cantidad:it.cantidad, unidadDeMedida:it.unidadDeMedida,
      stockRecomendado:it.stockRecomendado, proveedor:it.proveedor
    });
  }
  async function deleteAlmacen(c) {
    almacenData = almacenData.filter(x=>x.codigo!=c);
    saveCache(); buildProductInfo(); renderStockTable();
    await sendOrEnqueue('eliminarAlmacen', { codigo:c });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CRUD COMPRAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  async function buyProduct(id) {
  const qty = parseFloat(document.getElementById(`buyqty-${id}`).value) || 0;
  if (qty <= 0) return;

  const uni   = document.getElementById(`buyunit-${id}`).value;
  const fecha = new Date().toISOString().slice(0,10);
  const total = (productInfo[id].priceBase * qty * FACTORES[uni]).toFixed(0);

  // Aqu√≠ tomo el nombre del producto de almacenData
  const prod = almacenData.find(p => p.codigo == id) || {};

  // Primero actualizo el cache/UI
  const nueva = {
    idCompra: Date.now(),
    idProducto: id,
    fecha,
    cantidad: qty,
    unidad: uni,
    total,
    name: prod.name   // <-- clave "name", no "nombre"
  };
  comprasData.push(nueva);
  saveCache();
  renderComprasTable();

  // Luego env√≠o (o encolo) la petici√≥n al servidor
  await sendOrEnqueue('guardarCompras', {
    idProducto: id,
    idCompra:   nueva.idCompra, // si tu backend lo necesita
    name:       prod.name,
    fecha,
    cantidad:   qty,
    unidad:     uni,
    precio:     total
  });
}

  async function saveCompra(idC,idP) {
    const c = comprasData.find(x=>x.idCompra==idC && x.idProducto==idP);
    c.cantidad = parseFloat(document.getElementById(`qty-${idC}`).value)||c.cantidad;
    c.unidad   = document.getElementById(`unit-${idC}`).value;
    c.fecha    = document.getElementById(`date-${idC}`).value;
    c.precio   = (productInfo[idP].priceBase*c.cantidad*FACTORES[c.unidad]).toFixed(0);
    saveCache(); renderComprasTable();
    await sendOrEnqueue('guardarCompras', {
      idCompra:idC, idProducto:idP, fecha:c.fecha,
      cantidad:c.cantidad, unidad:c.unidad, precio:c.precio
    });
  }
  async function deleteCompra(idC,idP) {
    comprasData = comprasData.filter(x=>!(x.idCompra==idC && x.idProducto==idP));
    saveCache(); renderComprasTable();
    await sendOrEnqueue('eliminarCompras', { idCompra:idC, idProducto:idP });
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CRUD RECETAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function crearSelectProductos() {
    const sel = document.createElement('select');
    almacenData.forEach(p => {
      const opt = new Option(`${p.name} (${p.cantidad}${p.unidadDeMedida})`, p.codigo);
      opt.dataset.unit = p.unidadDeMedida.trim().toLowerCase();
      sel.append(opt);
    });
    return sel;
  }
  function crearSelectUnidad(cat, val='') {
    const sel = document.createElement('select');
    CATEGORIAS[cat].forEach(u => sel.append(new Option(u,u)));
    if (val) sel.value = val;
    return sel;
  }
  function agregarFila(item={}) {
    const tbody = document.querySelector('#ingredientes-table tbody');
    const tr = document.createElement('tr');
    const selProd = crearSelectProductos();
    if (item.codigo) selProd.value = item.codigo;
    const inpCant = document.createElement('input');
    inpCant.type='number'; inpCant.min='0'; inpCant.value = item.cantidad||1;
    let unidad0 = item.unidad || selProd.selectedOptions[0].dataset.unit;
    let selUni = crearSelectUnidad(categoriaDe(unidad0), unidad0);
    selProd.addEventListener('change', ()=>{
      const nu=categoriaDe(selProd.selectedOptions[0].dataset.unit);
      const r=crearSelectUnidad(nu, selProd.selectedOptions[0].dataset.unit);
      tr.children[2].replaceChild(r, selUni);
      selUni=r;
    });
    const btnDel=document.createElement('button');
    btnDel.type='button'; btnDel.textContent='Eliminar';
    btnDel.addEventListener('click', e=>{ e.preventDefault(); tr.remove(); });
    [selProd, inpCant, selUni, btnDel].forEach(el=>{
      const td=document.createElement('td'); td.append(el); tr.append(td);
    });
    tbody.append(tr);
  }

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CRUD VENTAS ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
  function crearItemRow(cod='', cant='', tot='') {
    const row = document.createElement('div'); row.className='item-row';
    const sel = document.createElement('select');
    recetasData.forEach(r=>{
      const o=new Option(r.nombre, r.codigo);
      if (r.codigo===cod) o.selected=true;
      sel.append(o);
    });
    const ic=document.createElement('input'); ic.type='number'; ic.min='1'; ic.value=cant; ic.placeholder='Cantidad';
    const it=document.createElement('input'); it.type='number'; it.value=tot; it.placeholder='Total';
    function recalc(){
      const rc=recetasData.find(x=>x.codigo===sel.value)||{precio:0};
      it.value=(Number(rc.precio)*(Number(ic.value)||0)).toFixed(2);
    }
    sel.addEventListener('change', recalc);
    ic.addEventListener('input', recalc);
    const bd=document.createElement('button'); bd.type='button'; bd.textContent='‚àí'; bd.addEventListener('click', ()=>row.remove());
    row.append(sel, ic, it, bd);
    return row;
  }
  function agregarItemVenta() {
    document.getElementById('items-container').append(crearItemRow());
  }
  function resetForm() {
    editMode=false;
    document.getElementById('form-id').value='';
    document.getElementById('form-title').textContent='Nueva Venta';
    document.getElementById('form-fecha').value=new Date().toISOString().slice(0,10);
    document.getElementById('form-pago').value='Efectivo';
    document.getElementById('items-container').innerHTML='';
  }
  function renderRecetasTable() {
    const cont=document.getElementById('lista-recetas');
    cont.innerHTML='';
    recetasData.forEach(r=>{
      const costo=r.ingredientes.reduce((s,i)=>{
        const p=almacenData.find(x=>String(x.codigo)===String(i.codigo));
        if(!p) return s;
        const fu=FACTORES[p.unidadDeMedida.trim().toLowerCase()]*parseFloat(p.cantidad);
        const iu=FACTORES[i.unidad]*i.cantidad;
        return s+(p.precio/fu)*iu;
      },0).toFixed(2);
      const card=document.createElement('div'); card.className='card';
      card.innerHTML=`
        <div class="card-header">${r.codigo} ‚Äì ${r.nombre}</div>
        <div class="card-body">
          <p>Categor√≠a: ${r.categoria}</p>
          ${r.imagen?`<img src="${r.imagen}" style="max-width:100%">`:``}
          <div class="info2">
            ${r.ingredientes.map(i=>`<p>${i.codigo}: ${i.cantidad}${i.unidad}</p>`).join('')}
            <p><strong>Costo:</strong> $${costo}</p>
          </div>
        </div>
        <div class="card-footer">
          <button onclick="cargarEnForm(${JSON.stringify(r)})">‚úèÔ∏è</button>
          <button onclick="eliminarReceta('${r.codigo}')">‚ùå</button>
        </div>`;
      cont.append(card);
    });
  }
  function cargarEnForm(r) {
    editMode=true;
    document.getElementById('receta-codigo').value=r.codigo;
    document.getElementById('receta-codigo').disabled=true;
    document.getElementById('receta-nombre').value=r.nombre;
    const selCat=document.getElementById('receta-categoria');
    if (!Array.from(selCat.options).some(o=>o.value===r.categoria)) {
      selCat.value='__nueva__';
      document.getElementById('wrapper-receta-categoria-nueva').classList.remove('hidden');
      document.getElementById('receta-categoria-nueva').value=r.categoria;
    } else {
      selCat.value=r.categoria;
      document.getElementById('wrapper-receta-categoria-nueva').classList.add('hidden');
    }
    document.getElementById('receta-imagen').value=r.imagen||'';
    document.querySelector('#ingredientes-table tbody').innerHTML='';
    r.ingredientes.forEach(i=>agregarFila(i));
  }
  async function guardarReceta() {
    const cod=document.getElementById('receta-codigo').value.trim();
    const nom=document.getElementById('receta-nombre').value.trim();
    if(!cod||!nom) return alert('C√≥digo y nombre requeridos');
    let cat=document.getElementById('receta-categoria').value;
    if(cat==='__nueva__') cat=document.getElementById('receta-categoria-nueva').value.trim();
    const imagen=document.getElementById('receta-imagen').value.trim();
    const ingredientes=Array.from(
      document.querySelectorAll('#ingredientes-table tbody tr')
    ).map(tr=>({
      codigo:tr.children[0].firstChild.value,
      cantidad:+tr.children[1].firstChild.value,
      unidad:tr.children[2].firstChild.value
    }));
    const nueva={ codigo:cod, nombre:nom, categoria:cat, imagen, ingredientes };
    if(editMode) recetasData=recetasData.map(r=>r.codigo===cod?nueva:r);
    else recetasData.push(nueva);
    cocData=recetasData; saveCache(); renderRecetasTable(); limpiarRecetaForm();
    await sendOrEnqueue('guardarCocina',{
      codigo:cod, nombre:nom, categoria:cat,
      imagen, ingredientes:JSON.stringify(ingredientes)
    });
  }
  async function eliminarReceta(cod) {
    if(!confirm(`¬øEliminar receta ${cod}?`)) return;
    recetasData=recetasData.filter(r=>r.codigo!==cod);
    cocData=recetasData; saveCache(); renderRecetasTable();
    await sendOrEnqueue('eliminarCocina',{ codigo:cod });
  }
  function limpiarRecetaForm() {
    editMode=false;
    ['receta-codigo','receta-nombre','receta-imagen','receta-categoria','receta-categoria-nueva']
      .forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        if(el.tagName==='SELECT') el.selectedIndex=0;
        else el.value='';
      });
    document.getElementById('receta-codigo').disabled=false;
    document.querySelector('#ingredientes-table tbody').innerHTML='';
    document.getElementById('wrapper-receta-categoria-nueva').classList.add('hidden');
  }

  function renderVentasTable() {
    const grid=document.getElementById('tickets-grid');
    grid.innerHTML='';
    ventData.forEach(v=>{
      const card=document.createElement('div'); card.className='ticket-card';
      card.innerHTML=`
        <div class="ticket-header">${new Date(v.fecha).toLocaleDateString()}</div>
        <div class="ticket-method"><strong>Pago:</strong> ${v.metodoPago}</div>
        <div class="ticket-items"></div>
        <div class="ticket-total">0</div>
        <div class="card-footer"></div>`;
      let sum=0;
      v.venta.forEach(it=>{
        const d=document.createElement('div');
        d.textContent=`${it.producto} x${it.cantidad} = $${it.total}`;
        sum+=Number(it.total)||0;
        card.querySelector('.ticket-items').append(d);
      });
      card.querySelector('.ticket-total').textContent=sum.toFixed(2);
      const f=card.querySelector('.card-footer'),
            eBtn=document.createElement('button'),
            dBtn=document.createElement('button');
      eBtn.textContent='‚úèÔ∏è'; eBtn.onclick=()=>startEditVenta(v);
      dBtn.textContent='‚ùå'; dBtn.onclick=()=>eliminarVenta(v.id);
      f.append(eBtn,dBtn);
      grid.append(card);
    });
  }
  function startEditVenta(v) {
    editMode=true;
    document.getElementById('form-id').value=v.id;
    document.getElementById('form-title').textContent='Editar Venta';
    document.getElementById('form-fecha').value=new Date(v.fecha).toISOString().slice(0,10);
    document.getElementById('form-pago').value=v.metodoPago;
    const cont=document.getElementById('items-container');
    cont.innerHTML='';
    v.venta.forEach(it=>cont.append(crearItemRow(it.codigo,it.cantidad,it.total)));
  }
  async function guardarVenta() {
    const id=document.getElementById('form-id').value||Date.now();
    const fecha=document.getElementById('form-fecha').value;
    const metodo=document.getElementById('form-pago').value;
    if(!fecha) return alert('Selecciona fecha');
    const rows=document.querySelectorAll('#items-container .item-row');
    if(!rows.length) return alert('Agrega al menos un producto');
    const items=Array.from(rows).map(r=>{
      const [sel,ic,it]=r.children;
      return { codigo:sel.value, producto:sel.options[sel.selectedIndex].text, cantidad:+ic.value, total:+it.value };
    });
    const nueva={ id, fecha, metodoPago:metodo, venta:items };
    if(editMode) ventData=ventData.map(v=>v.id===id?nueva:v);
    else ventData.push(nueva);
    saveCache(); renderVentasTable(); resetForm();
    await sendOrEnqueue('guardarVentas',{ venta:JSON.stringify(nueva) });
  }
  async function eliminarVenta(id) {
    if(!confirm('¬øEliminar venta?')) return;
    ventData=ventData.filter(v=>v.id!==id);
    saveCache(); renderVentasTable();
    await sendOrEnqueue('eliminarVentas',{ id });
  }
  function actualizarResumen(vs) {
  let e=0, t=0, ta=0;
  vs.forEach(v=>{
    const s = v.venta.reduce((a,i)=>a+parseFloat(i.total||0), 0);
    if (v.metodoPago==='Efectivo')         e += s;
    else if (v.metodoPago==='Transferencia') t += s;
    else if (v.metodoPago==='Tarjeta')       ta += s;
  });
  document.getElementById('sum-efectivo').textContent     = e.toFixed(2);
  document.getElementById('sum-transferencia').textContent = t.toFixed(2);
  document.getElementById('sum-tarjeta').textContent      = ta.toFixed(2);
  document.getElementById('sum-total').textContent        = (e+t+ta).toFixed(2);
}

function updateTopStats() {
  let totalInv=0, totalCompras=0, totalRestock=0;
  const compMap={}, usedMap={};
  // calcular totalCompras e inventario...
  comprasData.forEach(c=>{
    compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad];
    totalCompras += productInfo[c.idProducto].priceBase * c.cantidad*FACTORES[c.unidad];
  });
  ventData.forEach(v=> v.venta.forEach(it=>{
    const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
    if (!rec) return;
    rec.ingredientes.forEach(ing=>{
      usedMap[ing.codigo] = (usedMap[ing.codigo]||0)
        + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
    });
  }));
  almacenData.forEach(it=>{
    const info   = productInfo[it.codigo];
    const bought = compMap[it.codigo]||0;
    const used   = usedMap[it.codigo]||0;
    const remain = bought - used;
    totalInv += remain * info.priceBase;
    const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
    const delta   = recBase - remain;
    if (delta>0) totalRestock += delta * info.priceBase;
  });
  document.getElementById('stat-inventory').textContent = totalInv.toFixed(2);
  document.getElementById('stat-purchases').textContent = totalCompras.toFixed(2);
  document.getElementById('stat-restock').textContent   = totalRestock.toFixed(2);
}

  // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî CARGA GENERAL / INICIO ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
async function loadData() {
  // 1) Reintentar pendientes
  await processPendientes();

  // 2) Cargar de cache y render inmediato
  loadCache();
  buildProductInfo();
  renderStockTable();
  renderComprasTable();
  renderRecetasTable();
  renderVentasTable();

  // **ACTUALIZAR ESTAD√çSTICAS CON DATOS DE CACHE**
  updateTopStats();                  // <‚Äî para el panel flotante superior
  actualizarResumen(ventData);      // <‚Äî para el footer inferior

  // 3) Bajar datos reales y refrescar cache/UI
  try {
    const [alm, comp, vent, coc] = await Promise.all([
      callApi({op:'obtenerAlmacen'}),
      callApi({op:'obtenerCompras'}),
      callApi({op:'obtenerVentas'}),
      callApi({op:'obtenerCocina'})
    ]);
    if ([alm,comp,vent,coc].every(r=>r.status==='success')) {
      almacenData = alm.data;
      comprasData = comp.data;
      ventData    = vent.data;
      cocData     = coc.data.map(r=>({
        ...r,
        ingredientes: typeof r.ingredientes==='string'
          ? JSON.parse(r.ingredientes)
          : r.ingredientes
      }));
      recetasData = cocData;

      // Guardar y renderizar de nuevo
      saveCache();
      buildProductInfo();
      renderStockTable();
      renderComprasTable();
      renderRecetasTable();
      renderVentasTable();

      // **Y vuelvo a actualizar con datos reales**
      updateTopStats();
      actualizarResumen(ventData);
    }
  } catch(e) {
    console.error('Error datos reales:', e);
  }
}

  window.onload = async () => {
    // vincular paginaci√≥n
    document.querySelectorAll('nav.top-nav button')
      .forEach(btn=> btn.addEventListener('click', ()=> cambiarSeccion(btn.dataset.sec)));
    resetForm();
    await loadData();
  };
</script>

</body>
</html>
