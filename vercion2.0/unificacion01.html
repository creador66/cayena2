
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <title>IAEgoStock Pro</title>
  <style>
    :root {
      --primary: #6c5ce7;
      --primary-dark: #5d4ec9;
      --secondary: #4cc9f0;
      --accent: #7209b7;
      --danger: #f72585;
      --success: #4caf50;
      --warning: #ff9800;
      --dark: #212121;
      --light: #f8f9fa;
      --gray: #e0e0e0;
      --card-shadow: 0 6px 16px rgba(0,0,0,0.08);
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      --border-radius: 16px;
      --section-padding: 20px;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
      
    }
  
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f0f4f8 0%, #e6edf7 100%);
      color: var(--dark);
      padding: 0;
      padding-bottom: 90px;
      font-size: 15px;
      line-height: 1.6;
    }
    
    /* HEADER */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: white;
      padding: 18px 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(to right, var(--primary), var(--primary-dark));
      color: white;
      gap: 12px;
    }
    
    .header-top h1{
      width: 100%;
      font-size: 15px;
font-weight: 700;
display: flex;
align-items: center;
gap: 8px;
    }
    
    .app-header .stats {
      display: flex;
      gap: 10px;
      font-size: 12px;
      background: rgba(255,255,255,0.15);
      padding: 5px 10px;
      border-radius: var(--border-radius);
      width: 100%;
      justify-content: space-around;
    }
    
    .stat-item {
      text-align: center;
      min-width: 50px;
    }
    
    .stat-item strong {
      display: block;
      font-size: 15px;
    
      font-weight: 600;
    }
    
    /* RESUMEN VENTAS */
    .sales-summary {
            display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      
      font-size: 10px;
      text-align: center;
      
      width: 100%;
      
      color: white;
      
      
      box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }

    
    .sales-summary span {
      font-weight: 600;
      font-size: 10px;
      display: block;
      margin-top: 3px;
    }
    
    /* NAVEGACIÓN INFERIOR */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: white;
      display: flex;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.08);
      z-index: 100;
      height: 70px;
      border-top-left-radius: var(--border-radius);
      border-top-right-radius: var(--border-radius);
      overflow: hidden;
    }
    
    .nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      color: #777;
      border: none;
      background: transparent;
      transition: var(--transition);
      padding: 8px 0;
      position: relative;
    }
    
    .nav-btn i {
      font-size: 1.3rem;
      margin-bottom: 4px;
      transition: var(--transition);
    }
    
    .nav-btn.active {
      color: var(--primary);
      background: rgba(67, 97, 238, 0.05);
    }
    
    .nav-btn.active i {
      transform: translateY(-5px);
    }
    
    .nav-indicator {
      position: absolute;
      top: 5px;
      width: 6px;
      height: 6px;
      background: var(--primary);
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .nav-btn.active .nav-indicator {
      opacity: 1;
    }
    
    /* SECCIONES */
    .section {
      display: none;
      padding: var(--section-padding);
      animation: fadeIn 0.4s ease;
    }
    
    .section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section-title {
      font-size: 1.4rem;
      margin-bottom: 20px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid var(--gray);
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
    }
    
    .section-subtitle {
      font-size: 1.2rem;
      margin: 25px 0 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* SISTEMA DE FILTRADO */
    .filter-section {
      margin-top: 15px;
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: var(--card-shadow);
      position: relative;
    }
    
    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 5px 0;
    }
    
    .filter-title {
      font-weight: 600;
      color: var(--primary);
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-controls {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .filter-group {
      margin-bottom: 12px;
    }
    
    .filter-label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #555;
      font-weight: 500;
    }
    
    .filter-input, .filter-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.95rem;
      background: white;
      transition: var(--transition);
    }
    
    .filter-input:focus, .filter-select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    .filter-actions {
      display: flex;
      gap: 12px;
      margin-top: 15px;
    }
    
    .btn-filter {
      padding: 10px 18px;
      border-radius: 12px;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      font-size: 1rem;
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-filter-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-filter-reset {
      background: #f1f2f6;
      color: #666;
    }
    
    /* TARJETAS */
    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      margin-bottom: 20px;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0,0,0,0.12);
    }
    
    .card-header {
      background: var(--primary);
      color: white;
      padding: 15px 20px;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-body {
      padding: 20px;
    }
    
    .card-row {
      display: flex;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--gray);
      align-items: center;
    }
    
    .card-row:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    
    .card-label {
      flex: 1;
      color: #666;
      font-weight: 500;
    }
    
    .card-value {
      flex: 1;
      text-align: right;
      font-weight: 600;
      color: var(--dark);
    }
    
    /* FORMULARIOS */
    .form-group {
      display: flex;
      gap: 5px;
      margin-bottom: 18px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      font-size: 0.95rem;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--gray);
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 1rem;
      background: white;
      transition: var(--transition);
    }
    
    .form-input:focus, .form-select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    .form-row {
      display: flex;
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .form-row > * {
      flex: 1;
    }
    
    /* BOTONES */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      border: none;
      cursor: pointer;
      transition: var(--transition);
      padding: 5px 10px;
      text-align: center;
      gap: 8px;
    }
    
    .btn:active {
      transform: translateY(2px);
    }
    
    .btn-block {
      width: 100%;
    }
    
    .btn-primary {
      background: var(--primary);
      color: white;
    }
    
    .btn-secondary {
      background: var(--secondary);
      color: white;
    }
    
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-outline {
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--primary);
    }
    
    .btn-icon {
      padding: 12px;
      aspect-ratio: 1;
    }
    
    .div3 {
      width: 100%;
display: grid;
grid-template-columns: repeat(3, 1fr);
gap: 3px;
   }
    
    /* ESTILOS MEJORADOS PARA BALANCES */
    .totals-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 5px;
      margin: 5px 0;
      margin-top: 20px;
    }
    
    .total-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 5px 7px;
      box-shadow: var(--card-shadow);
      text-align: center;
      position: relative;
      border-top: 5px solid;
      transition: var(--transition);
    }
    
    .total-card:hover {
      transform: translateY(-3px);
    }
    
    .total-card.ingresos { border-top-color: var(--success); }
    .total-card.gastos { border-top-color: var(--danger); }
    .total-card.neto { border-top-color: var(--primary); }
    .total-card.ventas { border-top-color: var(--secondary); }
    .total-card.inventario { border-top-color: var(--accent); }
    
    .total-card h3 {
      font-size: 0.95rem;
      margin-bottom: 3px;
      color: #666;
      font-weight: 500;
    }
    
    .total-card .value {
      font-size: 12px;
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--dark);
    }
    
    .total-card .sub-value {
      font-size: 10px;
      color: #777;
    }
    
    .balance-type {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      
      font-weight: 500;
    }
    
    .balance-type.ingreso { background: rgba(76, 175, 80, 0.15); color: var(--success); }
    .balance-type.gasto { background: rgba(247, 37, 133, 0.15); color: var(--danger); }
    
    .balance-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .balance-status.activo { background: rgba(76, 175, 80, 0.15); color: var(--success); }
    .balance-status.inactivo { background: rgba(189, 195, 199, 0.15); color: #7f8c8d; }
    
    .payment-filter {
      
      gap: 12px;
      margin-bottom: 20px;
      
    }
    
    .payment-filter-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 12px;
      background: #f1f2f6;
      font-family: 'Poppins', sans-serif;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      min-width: 90px;
    }
    
    .payment-filter-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 10px rgba(67, 97, 238, 0.2);
    }
    
    .payment-filter-btn.efectivo.active { background: #00b894; }
    .payment-filter-btn.transferencia.active { background: #0984e3; }
    .payment-filter-btn.tarjeta.active { background: #7209b7; }
    
    /* MODAL */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 15px;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 25px 50px rgba(0,0,0,0.25);
      overflow: hidden;
      animation: modalIn 0.4s ease;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes modalIn {
      from { opacity: 0; transform: translateY(40px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-header {
      padding: 18px 25px;
      background: var(--primary);
      color: white;
      font-weight: 600;
      font-size: 1.2rem;
    }
    
    .modal-body {
      padding: 25px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-footer {
      padding: 18px 25px;
      display: flex;
      gap: 12px;
      background: #f8f9fa;
      border-top: 1px solid var(--gray);
    }
    
    /* LISTAS */
    .list {
      margin-bottom: 20px;
    }
    
    .list-item {
      background: white;
      border-radius: 14px;
      padding: 16px 20px;
      margin-bottom: 12px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .list-item:hover {
      transform: translateX(5px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    
    .list-title {
      font-weight: 600;
      margin-bottom: 5px;
      font-size: 1.05rem;
    }
    
    .list-subtitle {
      font-size: 0.9rem;
      color: #777;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* ESTADOS */
    .status-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }
    
    .status-low {
      background: rgba(247, 37, 133, 0.15);
      color: var(--danger);
    }
    
    .status-medium {
      background: rgba(255, 152, 0, 0.15);
      color: #e17055;
    }
    
    .status-good {
      background: rgba(76, 175, 80, 0.15);
      color: var(--success);
    }
    
    .status-excess {
      background: rgba(67, 97, 238, 0.15);
      color: var(--primary);
    }
    
    .status-reposicion {
      background: rgba(114, 9, 183, 0.15);
      color: var(--accent);
    }
    
    .status-inactive {
      background: rgba(189, 195, 199, 0.15);
      color: #7f8c8d;
    }
    
    /* UTILIDADES */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mb-20 {
      margin-bottom: 20px;
    }
    
    .mt-20 {
      margin-top: 20px;
    }
    
    .flex {
      display: flex;
    }
    
    .gap-12 {
      gap: 12px;
    }
    
    .justify-between {
      justify-content: space-between;
    }
    
    /* ANIMACIONES */
    .fade-in {
      animation: fadeIn 0.4s ease;
    }
    
    /* SCROLLBAR */
    ::-webkit-scrollbar {
      width: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #c2c2c2;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #a0a0a0;
    }
    
    /* INDICADOR DE FILTROS ACTIVOS */
    .filter-indicator {
      background: var(--primary);
      color: white;
      font-size: 0.8rem;
      padding: 3px 8px;
      border-radius: 12px;
      margin-left: 6px;
    }
    
    /* MENSAJE SIN RESULTADOS */
    .no-results {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }
    
    .no-results i {
      font-size: 3.5rem;
      margin-bottom: 20px;
      color: #dfe6e9;
    }

    
    /* EXPORTAR DATOS */
    .export-section {
      margin-top: 25px;
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
    }
    
    .export-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .export-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px 15px;
      border-radius: 14px;
      background: #f8f9fa;
      cursor: pointer;
      transition: var(--transition);
      border: 1px solid rgba(0,0,0,0.05);
    }
    
    .export-option:hover {
      background: #eef2f7;
      transform: translateY(-5px);
    }
    
    .export-option i {
      font-size: 2.5rem;
      margin-bottom: 15px;
    }
    
    .export-option.pdf i {
      color: #e74c3c;
    }
    
    .export-option.whatsapp i {
      color: #25D366;
    }
    
    .export-option.csv i {
      color: #27ae60;
    }
    
    /* GRÁFICO DE BARRAS PARA RESUMEN */
    .bar-chart {
      display: flex;
      justify-content: space-around;
      margin-top: 20px;
      gap: 10px;
    }
    
    .bar-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 30%;
    }
    
    .bar-label {
      font-size: 0.75rem;
      margin-bottom: 8px;
      color: #666;
      text-align: center;
    }
    
    .bar-outer {
      height: 100px;
      width: 20px;
      background: rgba(0,0,0,0.05);
      border-radius: 10px;
      position: relative;
      overflow: hidden;
    }
    
    .bar-inner {
    
      position: absolute;
      bottom: 0;
      width: 100%;
      border-radius: 10px;
      transition: height 0.8s ease;
    }
    
    .bar-inner.efectivo { background: #00b894; }
    .bar-inner.transferencia { background: #0984e3; }
    .bar-inner.tarjeta { background: #7209b7; }
    
    /* ESTILOS PARA TARJETAS DE ESTADÍSTICAS */
    .insights-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin: 10px 0;
    }
    
    .insight-card {
      position: relative;
      background: white;
      border-radius: var(--border-radius);
      padding: 5px;
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      transition: var(--transition);
    }
    
    .insight-card:hover {
      transform: translateY(-5px);
    }
    
    .insight-icon {
      z-index: 0;
      position: absolute;
      font-size: 12px;
      background: none;
      font-size: 20px;
      transform: translateY(-7px);
    }
    .insight-value {
      z-index: 1;
      font-size: 13px;
      font-weight: 700;
      color: #FFFFFF;
    }
    
    .insight-label {
      font-size: 10px;
      color: #777;
    }
    
    /* MEJORAS PARA EL FORMULARIO DE VENTAS */
    .sale-form-grid {
      display: grid;
 
      gap: 15px;
    }
    
    .sale-form-grid .form-group {
      margin-bottom: 0;
    }
    
    .sale-items-container {
      background: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 15px;
      margin: 15px 0;
    }
    
    .sale-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    
    .sale-item:last-child {
      border-bottom: none;
    }
    
    .sale-item-select {
      flex: 2;
    }
    
    .sale-item-qty {
      flex: 1;
    }
    
    .sale-item-total {
      flex: 1;
      font-weight: 600;
    }
    
    .sale-item-remove {
      color: var(--danger);
      font-size: 1.2rem;
      cursor: pointer;
    }
    
    /* MEJORAS PARA LA LISTA DE RECETAS */
    .recipe-card {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .recipe-image {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      background: #f1f2f6;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      font-size: 1.5rem;
    }
    
    .recipe-info {
      flex: 1;
    }
       .div2 {
     display: grid;
     grid-template-columns: repeat(2, 1fr);
     gap: 8px;
   }











   .resumen-contenedor {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 20px;
  background: #f7f9fc;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  font-family: Arial, sans-serif;
}

/* Contenedor de listas */
.resumen-listContenedor {
  width: 100%;
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 3px;
 
}

.resumen-section {

  background: #ffffff;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  height: 200px;
  overflow-X: auto;
 
}

.resumen-section h5 {
  margin: 0 0 10px;
  font-size: 16px;
  font-weight: bold;
  color: #333;
}

.resumen-list{
  font-size: 14px;
  color: #555;
  line-height: 1.5;
}

/* Resumen general */
.resumen-general {
  flex: 1 1 300px;
  background: #ffffff;
  border-radius: 10px;
  padding: 15px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
 
}

.resumen-general h5 {
  margin: 0 0 15px;
  font-size: 16px;
  font-weight: bold;
  color: #333;
}

.resumen-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.resumen-item {
  display: flex;
  justify-content: space-between;
  background: #f4f6f9;
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 14px;
  color: #444;
}

.resumen-item span:last-child {
  font-weight: bold;
  color: #111;
}

  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <div class="header-top">
      <h1><i class="fa-regular fa-eye-slash"></i> IAEgo</h1>
    </div>
  
    <div class="stats">
      <div class="stat-item">
        <i class="fas fa-warehouse"></i> Inventario<br><strong id="stat-inventory">0.00</strong>
      </div>
      <div class="stat-item">
        <i class="fas fa-shopping-cart"></i> Compras<br><strong id="stat-purchases">0.00</strong>
      </div>
      <div class="stat-item">
        <i class="fas fa-truck-loading"></i> Reposición<br><strong id="stat-restock">0.00</strong>
      </div>
    </div>
    
    <div class="sales-summary">
      <div>Efectivo<br><span id="sum-efectivo">0.00</span></div>
      <div>Transferencia<br><span id="sum-transferencia">0.00</span></div>
      <div>Tarjeta<br><span id="sum-tarjeta">0.00</span></div>
      <div>Total<br><span id="sum-total">0.00</span></div>
    </div>
  </header>














































  <!-- SECCIONES -->
  <main>
    <!-- STOCK -->
    <section id="stock" class="section active">
      <div class="justify-between">
        <h2 class="section-title"><i class="fas fa-boxes-stacked"></i> Stock de Productos</h2>
        <div class="div2">
          

          <button class="btn btn-primary" onclick="addNewProducto()">
            <i class="fas fa-plus"></i> Nuevo
          </button>
          <button class="btn btn-secondary" onclick="exportarDatos()">
            <i class="fas fa-file-export"></i> Exportar
          </button>
          </div>
          
          

      </div>
      
      <!-- Filtros Stock -->
      <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter('stock')">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros 
            <span id="filter-stock-indicator" class="filter-indicator">0</span>
          </div>
          <i class="fas fa-chevron-down" id="filter-stock-icon"></i>
        </div>
        
        <div class="filter-controls" id="filter-stock-controls">
          <div class="filter-group">
            <label class="filter-label">Buscar producto</label>
            <input type="text" class="filter-input" id="filter-stock-search" placeholder="Nombre o código">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Estado</label>
            <select class="filter-select" id="filter-stock-status">
              <option value="">Todos</option>
              <option value="low">Bajo</option>
              <option value="medium">Medio</option>
              <option value="good">Bueno</option>
              <option value="excess">Excedente</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Actividad</label>
            <select class="filter-select" id="filter-stock-active">
              <option value="">Todos</option>
              <option value="active">Activos</option>
              <option value="inactive">Inactivos</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Categoría</label>
            <select class="filter-select" id="filter-stock-category">
              <option value="">Todas</option>
              <option value="peso">Peso</option>
              <option value="volumen">Volumen</option>
              <option value="conteo">Conteo</option>
            </select>
          </div>
          
          <div class="filter-actions">
            <button class="btn-filter btn-filter-primary" onclick="applyStockFilters()">
              <i class="fas fa-check"></i> Aplicar
            </button>
            <button class="btn-filter btn-filter-reset" onclick="resetStockFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
<!-- ====== FILTROS STOCK ====== -->

<!-- ====== TARJETAS DE INSIGHTS ====== -->
<div class="insights-grid">
  <!-- Total de piezas -->
  <div class="insight-card" id="insight-total-pieces">
    <div class="insight-icon">
      <i>⚫️</i>
    </div>
    <div class="insight-value">0</div>
    <div id="btn-clear-status" class="insight-label">Total pz</div>
  </div>

  <!-- Bajo -->
  <div class="insight-card" data-status="low">
    <div class="insight-icon">
      <i>🔴</i>
    </div>
    <div class="insight-value" id="insight-count-low">0</div>
    <div class="insight-label">Bajo</div>
  </div>

  <!-- Medio -->
  <div class="insight-card" data-status="medium">
    <div class="insight-icon">
      <i>🟠</i>
    </div>
    <div class="insight-value" id="insight-count-medium">0</div>
    <div class="insight-label">Medio</div>
  </div>

  <!-- Bueno -->
  <div class="insight-card" data-status="good">
    <div class="insight-icon">
      <i>🟢</i>
    </div>
    <div class="insight-value" id="insight-count-good">0</div>
    <div class="insight-label">Bueno</div>
  </div>

  <!-- Excelente -->
  <div class="insight-card" data-status="excess">
    <div class="insight-icon">
      <i>🔵</i>
    </div>
    <div class="insight-value" id="insight-count-excess">0</div>
    <div class="insight-label">Excelente</div>
  </div>
</div>


      
      <div id="stock-list" class="list"></div>
    </section>










    

    <!-- BALANCES -->
    <section id="balances" class="section">
      <div class="justify-between">
        <h2 class="section-title"><i class="fas fa-scale-balanced"></i> Gestión de Balances</h2>
        <div class="div2">
          
          
          <button class="btn btn-primary" onclick="addNewBalance()">
            <i class="fas fa-plus"></i> Nuevo Gasto
          </button>
          <button class="btn btn-secondary" onclick="exportarBalances()">
            <i class="fas fa-file-export"></i> Exportar
          </button>
          
          
        </div>
      </div>
      <!-- Resumen de Totales -->
      <div class="totals-grid">
              <div class="total-card ventas">
                <h3>Total Ventas</h3>
                <div class="value" id="total-ventas">$0.00</div>
                <div class="sub-value" id="ventas-filtro">Todos los métodos</div>
              </div>
        
        <div class="total-card ingresos">
          <h3>Otros Ingresos</h3>
          <div class="value" id="total-otros-ingresos">$0.00</div>
          <div class="sub-value">Registros activos</div>
        </div>
        
        <div class="total-card gastos">
          <h3>Otros Gastos</h3>
          <div class="value" id="total-gastos">$0.00</div>
          <div class="sub-value">Registros activos</div>
        </div>
        
        <div class="total-card inventario">
          <h3>Gastos de Compras</h3>
          <div class="value" id="total-gastos-inventario">$0.00</div>
          <div class="sub-value">Suma de todas las compras</div>
        </div>
        <div class="total-card neto">
          <h3>Recuperación de inversión </h3>
          <div class="value" id="total-almacen">$0.00</div>
          <div class="sub-value">Total Neto - Reposición</div>
        </div>

        <div class="total-card neto">
          <h3>Total Neto</h3>
          <div class="value" id="total-neto">$0.00</div>
          <div class="sub-value">Ventas + Ingresos - Gastos - Compras</div>
        </div>
      </div>




      <div class="total-card neto">
        <div class="sub-value" id="total-porCategoria"></div>
      </div>

      
      <!-- Filtros por método de pago -->
      <div class="payment-filter">
        <button class="payment-filter-btn" data-pago="todos" onclick="filterByPayment('todos')">
          Todos
        </button>
        <button class="payment-filter-btn efectivo" data-pago="Efectivo" onclick="filterByPayment('Efectivo')">
          Efectivo
        </button>
        <button class="payment-filter-btn transferencia" data-pago="Transferencia" onclick="filterByPayment('Transferencia')">
          Transferencia
        </button>
        <button class="payment-filter-btn tarjeta" data-pago="Tarjeta" onclick="filterByPayment('Tarjeta')">
          Tarjeta
        </button>
      </div>
      <div class="resumen-contenedor">

        <div class="resumen-listContenedor">
        <!-- Sección de clientes -->
        <div class="resumen-section">
          <h5>Total por Cliente</h5>
          <div id="resumen-clientes" class="resumen-list"></div>
        </div>
        
        <!-- Sección de vendedores -->
        <div class="resumen-section">
          <h5>Total por Vendedor</h5>
          <div id="resumen-vendedores" class="resumen-list"></div>
        </div>
        
        <!-- Sección de descuentos -->
        <div class="resumen-section">
          <h5>Descuentos por Porcentaje</h5>
          <div id="resumen-descuentos" class="resumen-list"></div>
        </div>
        </div>
        
        
        
        <!-- Resumen general -->
        <div class="resumen-general">
          <h5>Resumen General</h5>
          <div class="resumen-grid">
            <div class="resumen-item">
              <span>Total Ventas:</span>
              <span id="resumen-total-ventas">0</span>
            </div>
            <div class="resumen-item">
              <span>Total Productos:</span>
              <span id="resumen-total-productos">0</span>
            </div>
            <div class="resumen-item">
              <span>Total General:</span>
              <span id="resumen-total-general">0.00</span>
            </div>
            <div class="resumen-item">
              <span>Total Descuentos:</span>
              <span id="resumen-total-descuentos">0.00</span>
            </div>
            <div class="resumen-item">
              <span>Clientes Diferentes:</span>
              <span id="resumen-total-clientes">0</span>
            </div>
            <div class="resumen-item">
              <span>Vendedores Diferentes:</span>
              <span id="resumen-total-vendedores">0</span>
            </div>
          </div>
        </div>
        
        </div>











        
      <!-- Filtros Balances -->
      <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter('balances')">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros de Gastos 
            <span id="filter-balances-indicator" class="filter-indicator">0</span>
          </div>
          <i class="fas fa-chevron-down" id="filter-balances-icon"></i>
        </div>
        
        <div class="filter-controls" id="filter-balances-controls">
          <div class="filter-group">
            <label class="filter-label">Buscar gasto</label>
            <input type="text" class="filter-input" id="filter-balances-search" placeholder="Especificación o código">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Categoría</label>
            <input type="text" class="filter-input" id="filter-balances-categoria" placeholder="Categoría">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Estado</label>
            <select class="filter-select" id="filter-balances-estado">
              <option value="">Todos</option>
              <option value="activo">Activo</option>
              <option value="inactivo">Inactivo</option>
            </select>
          </div>
          
          <div class="filter-actions">
            <button class="btn-filter btn-filter-primary" onclick="applyBalancesFilters()">
              <i class="fas fa-check"></i> Aplicar
            </button>
            <button class="btn-filter btn-filter-reset" onclick="resetBalancesFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <div id="balances-list" class="list"></div>
    </section>

    <!-- COMPRAS -->
    <section id="compras" class="section">
      <h2 class="section-title"><i class="fas fa-shopping-cart"></i> Historial de Compras</h2>
      
      <!-- Filtros Compras -->
      <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter('compras')">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros 
            <span id="filter-compras-indicator" class="filter-indicator">0</span>
          </div>
          <i class="fas fa-chevron-down" id="filter-compras-icon"></i>
        </div>
        
        <div class="filter-controls" id="filter-compras-controls">
          <div class="filter-group">
            <label class="filter-label">Buscar producto</label>
            <input type="text" class="filter-input" id="filter-compras-search" placeholder="Nombre o código">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Proveedor</label>
            <input type="text" class="filter-input" id="filter-compras-provider" placeholder="Nombre proveedor">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha desde</label>
            <input type="date" class="filter-input" id="filter-compras-from">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha hasta</label>
            <input type="date" class="filter-input" id="filter-compras-to">
          </div>
          
          <div class="filter-actions">
            <button class="btn-filter btn-filter-primary" onclick="applyComprasFilters()">
              <i class="fas fa-check"></i> Aplicar
            </button>
            <button class="btn-filter btn-filter-reset" onclick="resetComprasFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <div id="compras-list" class="list"></div>
    </section>

    <!-- VENTAS -->
    <section id="ventas" class="section">
      <h2 class="section-title"><i class="fas fa-cash-register"></i> Gestión de Ventas</h2>
      
      <div class="card mb-20">
        <div class="card-header">Nueva Venta</div>
        <div class="card-body">
          <input type="hidden" id="form-id">
          
          <div class="sale-form-grid">
            <div class="form-group">
              <label class="form-label">Fecha
              <input class="form-input" type="date" id="form-fecha">
            </label>
              <label class="form-label">Método de Pago
              <select class="form-select" id="form-pago">
                <option>Efectivo</option>
                <option>Transferencia</option>
                <option>Tarjeta</option>
              </select>
            </label>
            </div>
         
            <div class="form-group">
          <label class="form-label">codigo del vendedor
          <input class="form-input" id="form-vendedor">
          </label>
          <label class="form-label">codigo del cliente
          <input class="form-input" id="form-cliente">
          </label>
          <label class="form-label">descuento
           <input class="form-input" id="form-descuento">
          </label>
        
    
            </div>
          </div>
          
          <div class="sale-items-container" id="items-container"></div>
          
          <div class="div3">
            <button class="btn btn-outline" onclick="agregarItemVenta()"> Agregar
            </button>
            <button class="btn btn-primary" onclick="guardarVenta()"> Guardar
            </button>
            <button class="btn btn-outline" onclick="resetForm()"> Cancelar
            </button>
          </div>
        </div>
      </div>
      
      <h3 class="section-subtitle"><i class="fas fa-receipt"></i> Tickets</h3>
      
      <!-- Filtros Ventas -->
      <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter('ventas')">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros 
            <span id="filter-ventas-indicator" class="filter-indicator">0</span>
          </div>
          <i class="fas fa-chevron-down" id="filter-ventas-icon"></i>
        </div>
        
        <div class="filter-controls" id="filter-ventas-controls">
          <div class="filter-group">
            <label class="filter-label">Buscar receta</label>
            <input type="text" class="filter-input" id="filter-ventas-search" placeholder="Nombre o código">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Método de pago</label>
            <select class="filter-select" id="filter-ventas-payment">
              <option value="">Todos</option>
              <option value="Efectivo">Efectivo</option>
              <option value="Transferencia">Transferencia</option>
              <option value="Tarjeta">Tarjeta</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha desde</label>
            <input type="date" class="filter-input" id="filter-ventas-from">
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Fecha hasta</label>
            <input type="date" class="filter-input" id="filter-ventas-to">
          </div>
          
          <div class="filter-actions">
            <button class="btn-filter btn-filter-primary" onclick="applyVentasFilters()">
              <i class="fas fa-check"></i> Aplicar
            </button>
            <button class="btn-filter btn-filter-reset" onclick="resetVentasFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <div id="tickets-list" class="list"></div>
    </section>

    <!-- RECETAS -->
    <section id="recetas" class="section">
      <div class="">
        <h2 class="section-title"><i class="fas fa-utensils"></i> Gestión de Recetas</h2>
      </div>
      
      <div class="card mb-20">
        <div class="card-header">Nueva Receta</div>
        <div class="card-body">
          <input type="hidden" id="form-receta-id">
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Código
              <input class="form-input" id="receta-codigo" type="text" placeholder="Ej: R001">
            </label>
            </div>
            <div class="form-group">
              <label class="form-label">Nombre
              <input class="form-input" id="receta-nombre" type="text" placeholder="Nombre receta">
            </label>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Categoría
              <select class="form-select" id="receta-categoria"></select>
            </label>
            </div>
            <div class="form-group">
              <label class="form-label">Imagen (URL)
              <input class="form-input" id="receta-imagen" type="text" placeholder="http://...">
            </label>
            </div>
          </div>
          
          <h3 class="section-subtitle"><i class="fas fa-carrot"></i> Ingredientes</h3>
          <div id="ingredientes-container" class="mb-20"></div>
          <div class="div3">
            <button class="btn btn-outline" onclick="agregarFila()"> Agregar
            </button>
            <button class="btn btn-primary" onclick="guardarReceta()"> Guardar
            </button>
            <button class="btn btn-outline" onclick="limpiarForm()"> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <h3 class="section-subtitle"><i class="fas fa-book"></i> Recetas</h3>
      
      <!-- Filtros Recetas -->
      <div class="filter-section">
        <div class="filter-header" onclick="toggleFilter('recetas')">
          <div class="filter-title">
            <i class="fas fa-filter"></i> Filtros 
            <span id="filter-recetas-indicator" class="filter-indicator">0</span>
          </div>
          <i class="fas fa-chevron-down" id="filter-recetas-icon"></i>
        </div>
        
        <div class="filter-controls" id="filter-recetas-controls">
          <div class="filter-group">
            <label class="filter-label">Buscar receta</label>
            <input type="text" class="filter-input" id="filter-recetas-search" placeholder="Nombre o código">
          </div>
          
          <div class="filter-group">
            <label class="form-label">Categoría</label>
            <select class="filter-select" id="filter-recetas-category">
              <option value="">Todas</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">Estado ingredientes</label>
            <select class="filter-select" id="filter-recetas-status">
              <option value="">Todos</option>
              <option value="active">Solo activos</option>
              <option value="inactive">Con inactivos</option>
            </select>
          </div>
          
          <div class="filter-actions">
            <button class="btn-filter btn-filter-primary" onclick="applyRecetasFilters()">
              <i class="fas fa-check"></i> Aplicar
            </button>
            <button class="btn-filter btn-filter-reset" onclick="resetRecetasFilters()">
              <i class="fas fa-times"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
      
      <div id="recetas-list" class="list"></div>
    </section>
  </main>

  <!-- NAVEGACIÓN INFERIOR -->
  <nav class="bottom-nav">
    <button class="nav-btn" data-sec="stock" onclick="cambiarSeccion('stock')">
      <span class="nav-indicator"></span>
      <i class="fas fa-boxes-stacked"></i> Stock
    </button>
    <button class="nav-btn" data-sec="compras" onclick="cambiarSeccion('compras')">
      <span class="nav-indicator"></span>
      <i class="fas fa-shopping-cart"></i> Compras
    </button>
    <button class="nav-btn" data-sec="ventas" onclick="cambiarSeccion('ventas')">
      <span class="nav-indicator"></span>
      <i class="fas fa-cash-register"></i> Ventas
    </button>
    <button class="nav-btn" data-sec="recetas" onclick="cambiarSeccion('recetas')">
      <span class="nav-indicator"></span>
      <i class="fas fa-utensils"></i> Recetas
    </button>
    <button class="nav-btn" data-sec="balances" onclick="cambiarSeccion('balances')">
      <span class="nav-indicator"></span>
      <i class="fas fa-scale-balanced"></i> Balances
    </button>
  </nav>







  <!-- MODAL REUTILIZABLE -->
  <div id="modal-backdrop" class="modal-backdrop" style="display:none;">
    <div class="modal-content">
      <div id="modal-header" class="modal-header"></div>
      <div id="modal-body" class="modal-body"></div>
      <div id="modal-footer" class="modal-footer"></div>
    </div>
  </div>

<script>
// CONSTANTES
const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
const MARGEN     = 2;
const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };
const ALL_UNITS  = ['mg','g','kg','ml','l','pz'];

// ESTADO GLOBAL
let balancesData = [];
let almacenData = [], comprasData = [], ventData = [], cocData = [];
let recetas = [], recetasData = [], categorias = [], productInfo = {}, editMode = false;

// FILTROS
let stockFilters = {}, comprasFilters = {}, ventasFilters = {}, recetasFilters = {};
let filteredStock = [], filteredCompras = [], filteredVentas = [], filteredRecetas = [];
let balancesFilters = {}, filteredBalances = [];
let currentPaymentFilter = 'todos';

// MODAL REUTILIZABLE
const modal = {
  backdrop: document.getElementById('modal-backdrop'),
  header:   document.getElementById('modal-header'),
  body:     document.getElementById('modal-body'),
  footer:   document.getElementById('modal-footer'),
  show: ({ title = '', message = '', confirm = false }) => new Promise(res => {
    modal.header.textContent = title;
    modal.body.innerHTML   = message;
    modal.footer.innerHTML   = '';
    const btnOk = document.createElement('button');
    btnOk.className = 'btn btn-primary';
    btnOk.textContent = 'OK';
    btnOk.onclick = () => (modal.backdrop.style.display = 'none', res(true));
    modal.footer.append(btnOk);
    if (confirm) {
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn btn-outline';
      btnCancel.textContent = 'Cancelar';
      btnCancel.onclick = () => (modal.backdrop.style.display = 'none', res(false));
      modal.footer.append(btnCancel);
    }
    modal.backdrop.style.display = 'flex';
  })
};
const showAlert   = msg => modal.show({ title: '¡Atención!', message: msg });
const showConfirm = msg => modal.show({ title: 'Confirma', message: msg, confirm: true });

// UTILIDADES DE FETCH
const callApi = params => {
  const url = new URL(API_URL);
  Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
  return fetch(url).then(r => r.json());
};
async function postOpNotify(op, params = {}, successTitle = 'Éxito') {
  try {
    const data = await postOp(op, params);
    const msg = typeof data === 'string' ? data : data?.message ?? JSON.stringify(data);
    await modal.show({ title: successTitle, message: msg });
    return data;
  } catch (err) {
    const errMsg = err?.message ?? String(err);
    await modal.show({ title: 'Error', message: errMsg });
    throw err;
  }
}
const postOp = async (op, params = {}) => {
  const fd = new FormData(); fd.append('op', op);
  Object.entries(params).forEach(([k,v]) => fd.append(k,v));
  const res = await fetch(API_URL, { method: 'POST', body: fd });
  const json = await res.json();
  if (json.status === 'success') return json.data;
  else throw new Error(json.message);
};

// UTILIDADES DE UNIDAD
const categoriaDe = u =>
  ['mg','g','kg'].includes(u) ? 'peso'
: ['ml','l'].includes(u)    ? 'volumen'
:                             'conteo';

function humanizeComposite(b, c) {
  const absB = Math.abs(b);
  let result = '';
  
  if (c === 'peso') {
      const kg = Math.floor(absB / 1000);
      const g = absB % 1000;
      result = (kg ? kg + 'kg ' : '') + (g ? g + 'g' : '') || '0g';
  } else if (c === 'volumen') {
      const l = Math.floor(absB / 1000);
      const ml = absB % 1000;
      result = (l ? l + 'l ' : '') + (ml ? ml + 'ml' : '') || '0ml';
  } else {
      result = absB.toFixed(0) + 'pz';
  }
  
  return b < 0 ? '-' + result : result;
}

// PRODUCT INFO CORREGIDO
function buildProductInfo() {
  productInfo = {};
  almacenData.forEach(it => {
    const uni = it.unidadDeMedida.trim().toLowerCase();
    const cat = categoriaDe(uni);
    const baseQty = parseFloat(it.cantidad) * FACTORES[uni];
    productInfo[it.codigo] = {
      priceBase: baseQty > 0 ? parseFloat(it.precio) / baseQty : 0,
      categoria:  cat,
      opcionesUnidad: CATEGORIAS[cat],
      name: it.name,
      active: it.active !== false
    };
  });
}

// Buscar recetas que usan un producto
function buscarRecetasConProducto(codigoProducto) {
  return cocData.filter(receta => 
    receta.ingredientes.some(ing => ing.codigo == codigoProducto && parseFloat(ing.cantidad) > 0)
  ).map(receta => receta.nombre);
}

// FILTRADO DE STOCK
function applyStockFilters() {
  const search   = document.getElementById('filter-stock-search').value.toLowerCase();
  const status   = document.getElementById('filter-stock-status').value;
  const active   = document.getElementById('filter-stock-active').value;
  const category = document.getElementById('filter-stock-category').value;

  stockFilters = { search, status, active, category };

  filteredStock = almacenData.filter(product => {
    // Filtro de búsqueda
    if (
      search &&
      !product.name.toLowerCase().includes(search) &&
      !String(product.codigo).toLowerCase().includes(search)
    ) {
      return false;
    }

    // Filtro por estado
    if (status) {
      const compMap = {}, usedMap = {};

      comprasData.forEach(c =>
        compMap[c.idProducto] = (compMap[c.idProducto] || 0) + c.cantidad * FACTORES[c.unidad]
      );

      ventData.forEach(v => {
        v.venta.forEach(it => {
          const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
          if (rec) {
            rec.ingredientes.forEach(ing => {
              usedMap[ing.codigo] = (usedMap[ing.codigo] || 0)
                + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
            });
          }
        });
      });

      const bought  = compMap[product.codigo] || 0;
      const used    = usedMap[product.codigo] || 0;
      const remain  = bought - used;
      const recBase = (parseFloat(product.stockRecomendado) || 0) * FACTORES[product.unidadDeMedida];
      const pct     = recBase ? (remain / recBase) * 100 : 0;

      let productStatus = '';
      if (pct <= 30)        productStatus = 'low';
      else if (pct <= 50)   productStatus = 'medium';
      else if (pct <= 90)   productStatus = 'good';
      else                  productStatus = 'excess';

      if (status !== productStatus) return false;
    }

    // Filtro por actividad
    if (active) {
      const isActive = product.active !== false;
      if (active === 'active' && !isActive)   return false;
      if (active === 'inactive' && isActive)  return false;
    }

    // Filtro por categoría
    if (category && productInfo[product.codigo]?.categoria !== category) {
      return false;
    }

    return true;
  });

  // Actualizar contador de filtros
  const filterCount = Object.values(stockFilters).filter(f => f).length;
  document.getElementById('filter-stock-indicator').textContent = filterCount;

  renderStockTable();
  updateTopStats();
  updateStockInsights();
}

function resetStockFilters() {
  document.getElementById('filter-stock-search').value   = '';
  document.getElementById('filter-stock-status').value   = '';
  document.getElementById('filter-stock-active').value   = '';
  document.getElementById('filter-stock-category').value = '';
  stockFilters   = {};
  filteredStock  = [];
  document.getElementById('filter-stock-indicator').textContent = '0';
  renderStockTable();
  updateTopStats();
  updateStockInsights();
}

// ACTUALIZAR ESTADÍSTICAS DE PRODUCTOS
function updateStockInsights() {
  const dataToRender = filteredStock.length ? filteredStock : almacenData;

  // Total de piezas
  document.getElementById('insight-total-pieces')
          .querySelector('.insight-value')
          .textContent = dataToRender.length;

  // Preparar mapas de compras y usos
  const compMap = {}, usedMap = {};
  comprasData.forEach(c =>
    compMap[c.idProducto] = (compMap[c.idProducto] || 0) + c.cantidad * FACTORES[c.unidad]
  );
  ventData.forEach(v => {
    v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
      if (rec) rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo] || 0)
          + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
      });
    });
  });

  // Contadores de estado
  let lowCount = 0, medCount = 0, goodCount = 0, excCount = 0;
  dataToRender.forEach(p => {
    const info = productInfo[p.codigo];
    if (!info || !info.active) return;
    const recBase = (parseFloat(p.stockRecomendado)||0) * FACTORES[p.unidadDeMedida];
    const bought  = compMap[p.codigo] || 0;
    const used    = usedMap[p.codigo] || 0;
    const pct     = recBase ? ( (bought - used) / recBase ) * 100 : 0;
    if (pct <= 30)      lowCount++;
    else if (pct <= 50) medCount++;
    else if (pct <= 90) goodCount++;
    else                excCount++;
  });

  document.getElementById('insight-count-low').textContent    = lowCount;
  document.getElementById('insight-count-medium').textContent = medCount;
  document.getElementById('insight-count-good').textContent   = goodCount;
  document.getElementById('insight-count-excess').textContent = excCount;
}

// RENDERIZAR TABLA DE STOCK
function renderStockTable() {
  const list = document.getElementById('stock-list');
  list.innerHTML = '';

  // Construir mapas de compras y usos
  const compMap = {}, usedMap = {};
  comprasData.forEach(c =>
    compMap[c.idProducto] = (compMap[c.idProducto] || 0) + c.cantidad * FACTORES[c.unidad]
  );
  ventData.forEach(v => {
    v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
      if (rec) {
        rec.ingredientes.forEach(ing => {
          usedMap[ing.codigo] = (usedMap[ing.codigo] || 0)
            + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
        });
      }
    });
  });

  const dataToRender = filteredStock.length ? filteredStock : almacenData;
  if (dataToRender.length === 0) {
    list.innerHTML = `
      <div class="no-results">
        <i class="fas fa-box-open"></i>
        <h3>No se encontraron productos</h3>
        <p>Intenta ajustar los filtros o agregar nuevos productos</p>
      </div>
    `;
    return;
  }

  dataToRender.forEach(it => {
    const info    = productInfo[it.codigo];
    const recBase = (parseFloat(it.stockRecomendado) || 0) * FACTORES[it.unidadDeMedida];
    const bought  = compMap[it.codigo] || 0;
    const used    = usedMap[it.codigo] || 0;
    const remain  = bought - used;
    const pct     = recBase ? (remain / recBase) * 100 : 0;
    const estado  = pct <= 30  ? 'status-low'
                  : pct <= 50  ? 'status-medium'
                  : pct <= 90  ? 'status-good'
                  :              'status-excess';
    const estadoText = pct <= 30  ? '🔴 Bajo'
                      : pct <= 50  ? '🟠 Medio'
                      : pct <= 100 ? '🟢 Bueno'
                      :              '🔵 Excedente';
    const delta   = recBase - remain;
    const accion  = delta > 0
      ? `Ordenar ${humanizeComposite(delta, info.categoria)}`
      : `Sobrante ${humanizeComposite(-delta, info.categoria)}`;
    const valorReposicion = (delta * info.priceBase).toFixed(2);
    const enUso = buscarRecetasConProducto(it.codigo).length > 0;

    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div>
        <div class="list-title">${it.name} ${!info.active ? '<span class="status-badge status-inactive">Inactivo</span>' : ''}</div>
        <div class="list-subtitle">#${it.codigo} | ${it.unidadDeMedida}</div>
        <div class="list-subtitle">Restante: ${humanizeComposite(remain, info.categoria)}</div>
        <div class="list-subtitle">Estado: <span class="status-badge ${estado}">${estadoText}</span></div>
        <div class="list-subtitle">${accion}</div>
      </div>
      <div>
        <span class="list-title">$${parseFloat(it.precio).toFixed(2)}</span>
        <div class="list-subtitle">${it.proveedor || 'Sin proveedor'}</div>
        <div class="list-subtitle status-badge status-reposicion">Rep: $${valorReposicion}</div>
      </div>
    `;
    item.addEventListener('click', () => {
      const card = document.createElement('div');
      card.className = 'card fade-in';
      card.innerHTML = `
          <div class="card-header">Detalle de Producto</div>
          <div class="card-body">
            <div class="card-row">
              <div class="card-label">Código</div>
              <div class="card-value">#${it.codigo}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Precio</div>
              <div class="card-value">
                <input class="form-input" type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Cantidad inicial</div>
              <div class="card-value">
                <input class="form-input" type="number" id="cant-${it.codigo}" value="${it.cantidad||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Unidad</div>
              <div class="card-value">
                <select class="form-select" id="unidad-${it.codigo}">
  ${(it.unidadDeMedida ? info.opcionesUnidad : ALL_UNITS)
    .map(u => `<option value="${u}"${u === it.unidadDeMedida ? ' selected' : ''}>${u}</option>`)
    .join('')}
</select>
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Stock recomendado</div>
              <div class="card-value">
                <input class="form-input" type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Nombre</div>
              <div class="card-value">
                <input class="form-input" type="text" id="name-${it.codigo}" value="${it.name ||''}">
              </div>
            </div>
            <div class="card-row">
              <div class="card-label">Proveedor</div>
              <div class="card-value">
                <input class="form-input" type="text" id="prov-${it.codigo}" value="${it.proveedor||''}">
              </div>
            </div>
            ${enUso ? `
            <div class="card-row">
              <div class="card-label">En uso en</div>
              <div class="card-value">
                <div class="status-badge status-medium">${buscarRecetasConProducto(it.codigo).length} recetas</div>
              </div>
            </div>` : ''}
            <div class="card-row">
              <div class="card-label">Comprado</div>
              <div class="card-value">${humanizeComposite(bought,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Usado</div>
              <div class="card-value">${humanizeComposite(used,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Restante</div>
              <div class="card-value">${humanizeComposite(remain,info.categoria)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Estado</div>
              <div class="card-value"><span class="status-badge ${estado}">${estadoText}</span></div>
            </div>
            <div class="card-row">
              <div class="card-label">Valor inventario</div>
              <div class="card-value">$${(remain * info.priceBase).toFixed(2)}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Reposición necesaria</div>
              <div class="card-value">${accion}</div>
            </div>
            <div class="card-row">
              <div class="card-label">Valor reposición</div>
              <div class="card-value">$${valorReposicion}</div>
            </div>
            <div class="form-row mt-15">
              <div class="form-group">
                <label class="form-label">Comprar cantidad</label>
                <input class="form-input" type="number" id="buyqty-${it.codigo}" value="1" min="0" step="0.1">
              </div>
              <div class="form-group">
                <label class="form-label">Unidad</label>
                <select class="form-select" id="buyunit-${it.codigo}">
                  ${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="div3">
              <button class="btn btn-icon btn-primary" onclick="buyProduct('${it.codigo}')">
                <i class="fas fa-cart-plus"></i>
              </button>
              <button class="btn btn-icon btn-primary" onclick="saveAlmacen('${it.codigo}')">
                <i class="fas fa-save"></i>
              </button>
              <button class="btn btn-icon btn-danger" onclick="deleteAlmacen('${it.codigo}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        `;
      modal.show({
        title: 'Detalle de Producto',
        message: card.innerHTML
      });
    });
    list.appendChild(item);
  });
}

// EXPORTAR DATOS
function exportarDatos() {
  const modalContent = document.createElement('div');
  modalContent.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <h3>Exportar Datos Filtrados</h3>
      <p>Seleccione el formato de exportación:</p>
      <div class="export-options">
        <div class="export-option pdf" onclick="exportarPDF()">
          <i class="fas fa-file-pdf"></i>
          <span>PDF</span>
        </div>
        <div class="export-option whatsapp" onclick="solicitarNumeroWhatsApp()">
          <i class="fab fa-whatsapp"></i>
          <span>WhatsApp</span>
        </div>
        <div class="export-option csv" onclick="exportarCSV()">
          <i class="fas fa-file-csv"></i>
          <span>CSV</span>
        </div>
      </div>
    </div>
  `;
  
  modal.show({
    title: 'Exportar Datos',
    message: modalContent.innerHTML
  });
}

function solicitarNumeroWhatsApp() {
  const savedNumber = localStorage.getItem('whatsappNumber') || '';
  
  const modalContent = document.createElement('div');
  modalContent.innerHTML = `
    <div style="padding: 15px;">
      <p>Ingrese el número de teléfono (con código de país, sin espacios ni caracteres especiales):</p>
      <input
        type="tel"
        id="whatsapp-number"
        class="form-input"
        placeholder="Ej: 5491123456789"
        style="width: 100%; padding: 12px; margin-bottom: 15px;"
        value="${savedNumber}"
      >
      <button
        class="btn btn-primary"
        onclick="enviarWhatsApp()"
        style="width: 100%; padding: 12px;"
      >
        <i class="fab fa-whatsapp"></i> Enviar
      </button>
    </div>
  `;
  
  modal.show({
    title: 'Enviar por WhatsApp',
    message: modalContent.innerHTML
  });
  
  setTimeout(() => {
    const input = document.getElementById('whatsapp-number');
    if (!input) return;
    
    input.addEventListener('input', () => {
      localStorage.setItem('whatsappNumber', input.value.trim());
    });
  }, 100);
}

function enviarWhatsApp() {
  const numero = document.getElementById('whatsapp-number').value.trim();
  if (!numero) {
    return showAlert('Por favor, ingrese un número de teléfono.');
  }
  
  const datos = getDatosExportacion();
  
  // Formatear los datos como texto
  let texto = '📋 *Lista de Compras Generada por IAEgoStock Pro* 📋\n\n';
  texto += '*Fecha:* ' + new Date().toLocaleDateString() + '\n';
  texto += '*Productos Filtrados:* ' + datos.length + '\n\n';
  
  datos.forEach((prod, index) => {
    texto += `*${index + 1}. ${prod.nombre}*\n`;
    texto += `   🔢 Código: ${prod.codigo}\n`;
    texto += `   🟡 Estado: ${prod.estado}\n`;
    texto += `   📦 Cantidad a reponer: ${prod.reponer}\n`;
    texto += `   💰 Valor reposición: $${prod.valorReposicion}\n\n`;
  });
  
  // Calcular totales
  const totalReposicion = datos
    .reduce((sum, prod) => sum + parseFloat(prod.valorReposicion), 0)
    .toFixed(2);
  texto += `*TOTAL REPOSICIÓN:* $${totalReposicion}\n\n`;
  
  // Codificar el texto para URL
  const textoCodificado = encodeURIComponent(texto);
  const url = `https://wa.me/${numero}?text=${textoCodificado}`;
  
  // Crear un <a> temporal y disparar el click para abrir en nueva pestaña
  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener noreferrer';
  a.style.display = 'none';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function getDatosExportacion() {
  const compMap = {}, usedMap = {};
  
  comprasData.forEach(c => compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
  ventData.forEach(v => v.venta.forEach(it => {
    const rec = cocData.find(r => String(r.codigo)===String(it.codigo));
    rec && rec.ingredientes.forEach(ing =>
      usedMap[ing.codigo] = (usedMap[ing.codigo]||0) + ing.cantidad*FACTORES[ing.unidad]*it.cantidad
    );
  }));
  
  const productos = filteredStock.length ? filteredStock : almacenData;
  
  return productos.map(it => {
    const infoI = productInfo[it.codigo] || {};
    const recBase = (parseFloat(it.stockRecomendado) || 0) * FACTORES[it.unidadDeMedida];
    const bought = compMap[it.codigo] || 0;
    const used   = usedMap[it.codigo] || 0;
    const remain = bought - used;
    const pct     = recBase ? remain/recBase*100 : 0;
    const estado  = pct <= 30 ? 'Bajo' 
                  : pct <= 50 ? 'Medio'
                  : pct <=90 ? 'Bueno'
                  :             'Excedente';
    const delta   = recBase - remain;
    const reponer = delta > 0 ? humanizeComposite(delta, infoI.categoria) : 'Sobrante';
    const valorReposicion = (delta > 0 ? delta * (infoI.priceBase || 0) : 0).toFixed(2);
    
    return {
      nombre: it.name,
      codigo: it.codigo,
      existencias: humanizeComposite(remain, infoI.categoria),
      estado: estado,
      reponer: reponer,
      valorReposicion: valorReposicion
    };
  });
}

function exportarPDF() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    return showAlert('La librería jsPDF no está cargada.');
  }
  const { jsPDF } = window.jspdf;
  const datos    = getDatosExportacion();
  const doc      = new jsPDF({ unit: 'pt', format: 'letter' });
  const margin   = 40;
  const lineH    = 16;
  const pageW    = doc.internal.pageSize.getWidth();
  const pageH    = doc.internal.pageSize.getHeight();
  let   y        = margin;
  
  // --- Encabezado ---
  doc.setFontSize(16).text('Reporte de IAEgoStock Pro', margin, y);
  y += lineH * 1.2;
  doc.setFontSize(11)
     .text(`Fecha: ${new Date().toLocaleDateString()}`, margin, y);
  y += lineH;
  doc.text(`Productos listados: ${datos.length}`, margin, y);
  y += lineH * 1.5;
  
  // --- Cabecera Tabla con fondo ---
  const colsX = [0, 30, 200, 260, 340, 420, 490];
  const headers = ['No.', 'Producto', 'Código', 'Existencias', 'Estado', 'Reponer', 'Valor Repo.'];
  
  doc.setFillColor(60, 120, 216);
  doc.setTextColor(255);
  doc.setFontSize(12);
  headers.forEach((h, i) => {
    const x = margin + colsX[i];
    doc.rect(x - 2, y - lineH + 4, (i === 1 ? 150 : 60), lineH, 'F');
    doc.text(h, x, y);
  });
  
  // línea bajo encabezado
  doc.setDrawColor(0);
  y += lineH;
  doc.line(margin, y - 4, pageW - margin, y - 4);
  
  // Restaurar estilos para filas
  doc.setFontSize(10);
  doc.setTextColor(0);
  
  // --- Filas ---
  datos.forEach((p, idx) => {
    if (y + lineH > pageH - margin) {
      doc.addPage();
      y = margin;
    }
    // sombreado alterno
    if (idx % 2 === 1) {
      doc.setFillColor(240);
      doc.rect(margin, y - lineH + 4, pageW - 2 * margin, lineH, 'F');
    }
    const vals = [
      String(idx + 1),
      p.nombre,
      String(p.codigo),
      String(p.existencias),
      p.estado,
      String(p.reponer),
      `$${parseFloat(p.valorReposicion).toFixed(2)}`
    ];
    vals.forEach((txt, i) => {
      const x = margin + colsX[i];
      if (i === 1) {
        doc.text(txt, x, y, { maxWidth: 150 });
      } else {
        doc.text(txt, x, y);
      }
    });
    y += lineH;
  });
  
  // --- Total reposición ---
  if (y + lineH > pageH - margin) {
    doc.addPage();
    y = margin;
  }
  const total = datos.reduce((s, p) => s + parseFloat(p.valorReposicion), 0).toFixed(2);
  y += lineH;
  doc.setFontSize(12).text(`TOTAL REPOSICIÓN: $${total}`, margin, y);
  
  // Mostrar PDF
  window.location.href = doc.output('bloburl');
}

function exportarCSV() {
  const datos = getDatosExportacion();
  
  // 1) Cabecera CSV
  let csv = 'Producto,Código,Existencias,Estado,Reposición,Valor Reposición\n';
  
  // 2) Filas de datos (escapando comillas)
  const escape = str => String(str).replace(/"/g, '""');
  datos.forEach(prod => {
    csv += `"${escape(prod.nombre)}","${escape(prod.codigo)}","${escape(prod.existencias)}","${escape(prod.estado)}","${escape(prod.reponer)}","${escape(prod.valorReposicion)}"\n`;
  });
  
  // 3) Total reposición
  const totalReposicion = datos
    .reduce((sum, prod) => sum + parseFloat(prod.valorReposicion), 0)
    .toFixed(2);
  csv += `\n"","","","","TOTAL","${totalReposicion}"`;
  
  // 4) Crear blob y generar URL
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  
  window.location.href = url;
  
  setTimeout(() => URL.revokeObjectURL(url), 10000);
}

// ACTUALIZAR ESTADÍSTICAS SUPERIORES
function updateTopStats() {
  let totalInv = 0,
      totalCompras = 0,
      totalRestock = 0;
  const compMap = {},
        usedMap = {};

  // Calcular compras: almacena cantidades y suma los totales guardados
  comprasData.forEach(c => {
    // Mapa de cantidades (en la unidad base)
    compMap[c.idProducto] = (compMap[c.idProducto] || 0)
      + c.cantidad * FACTORES[c.unidad];

    // Sumamos el total guardado de cada compra (c.precio)
    totalCompras += Number(c.precio) || 0;
  });

  // Calcular uso en ventas
  ventData.forEach(v =>
    v.venta.forEach(it => {
      const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
      if (!rec) return;
      rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo] || 0)
          + ing.cantidad * FACTORES[ing.unidad] * it.cantidad;
      });
    })
  );

  // Productos a considerar (filtrados o todos)
  const productos = filteredStock.length ? filteredStock : almacenData;

  // Calcular inventario y reposición
  productos.forEach(it => {
    const infoI = productInfo[it.codigo] || { priceBase: 0 };
    const bought = compMap[it.codigo] || 0;
    const used   = usedMap[it.codigo] || 0;
    const remain = bought - used;

    // Valor del inventario con precio base actual
    totalInv += remain * infoI.priceBase;

    // Cálculo de reposición según stock recomendado
    const recBase = (parseFloat(it.stockRecomendado) || 0)
      * FACTORES[it.unidadDeMedida];
    const delta = recBase - remain;
    if (delta > 0) {
      totalRestock += delta * infoI.priceBase;
    }
  });

  // Mostrar estadísticas
  document.getElementById('stat-inventory').textContent   = totalInv.toFixed(2);
  document.getElementById('stat-purchases').textContent   = totalCompras.toFixed(2);
  document.getElementById('stat-restock').textContent     = totalRestock.toFixed(2);
}

// ACCIONES STOCK/COMPRAS
async function addNewProducto() {
  almacenData.push({ 
    codigo: Date.now(), 
    name:'Nuevo Producto', 
    precio:0, 
    cantidad:0, 
    unidadDeMedida: '', 
    stockRecomendado:0, 
    proveedor:'',
    active: true
  });
  buildProductInfo(); 
  renderStockTable();
  updateStockInsights();
}
// 2) Al hacer clic en las tarjetas, fijar filtro y desactivar el select
function bindInsightFilters() {
  const statusSelect = document.getElementById('filter-stock-status');

  document.querySelectorAll('.insight-card[data-status]').forEach(card => {
    const estado = card.dataset.status;
    card.style.cursor = 'pointer';
    card.addEventListener('click', () => {
      statusSelect.value    = estado;
      statusSelect.disabled = true;
      applyStockFilters();
    });
  });

  // Botón para limpiar y re-habilitar el select
  document.getElementById('btn-clear-status').addEventListener('click', () => {
    statusSelect.value    = '';
    statusSelect.disabled = false;
    applyStockFilters();
  });
}

// 3) Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', () => {
  bindInsightFilters();
});

async function saveAlmacen(codigo) {
  const name = document.getElementById(`name-${codigo}`)?.value.trim() || 'Nuevo Producto';
  
  await postOpNotify('guardarAlmacen', {
    codigo,
    name,
    precio: document.getElementById(`precio-${codigo}`).value,
    cantidad: document.getElementById(`cant-${codigo}`).value,
    unidadDeMedida: document.getElementById(`unidad-${codigo}`).value,
    stockRecomendado: document.getElementById(`rec-${codigo}`).value,
    proveedor: document.getElementById(`prov-${codigo}`).value
  }, 'Almacén actualizado');
  await loadData();
}

async function deleteAlmacen(codigo) {
  // Buscar recetas que usan este producto
  const recetasQueLoUsan = buscarRecetasConProducto(codigo);
  
  if (recetasQueLoUsan.length > 0) {
    const message = `
      <div class="card">
        <div class="card-header">¡Advertencia!</div>
        <div class="card-body">
          <p>Este producto está siendo usado en las siguientes recetas:</p>
          <ul style="padding-left: 20px; margin: 10px 0;">
            ${recetasQueLoUsan.map(r => `<li>${r}</li>`).join('')}
          </ul>
          <p>Si continúa, el producto se marcará como inactivo y en las recetas su cantidad se establecerá a 0.</p>
        </div>
      </div>
      <p>¿Desea continuar con la eliminación?</p>
    `;
    
    const ok = await showConfirm(message);
    if (!ok) return;
    
    // Actualizar las recetas: poner a 0 la cantidad de este ingrediente
    for (const receta of cocData) {
      if (receta.ingredientes.some(ing => ing.codigo == codigo)) {
        receta.ingredientes = receta.ingredientes.map(ing => {
          if (ing.codigo == codigo) {
            return { ...ing, cantidad: 0 };
          }
          return ing;
        });
        await postOp('guardarCocina', {
          codigo: receta.codigo,
          nombre: receta.nombre,
          categoria: receta.categoria,
          imagen: receta.imagen || '',
          ingredientes: JSON.stringify(receta.ingredientes)
        });
      }
    }
    
    // Marcar el producto como inactivo
    const producto = almacenData.find(p => p.codigo == codigo);
    if (producto) {
      producto.active = false;
      await postOpNotify('guardarAlmacen', {
        codigo,
        name: producto.name,
        precio: producto.precio,
        cantidad: producto.cantidad,
        unidadDeMedida: producto.unidadDeMedida,
        stockRecomendado: producto.stockRecomendado,
        proveedor: producto.proveedor,
        active: false
      }, 'Producto marcado como inactivo');
    }
  } else {
    const ok = await showConfirm(`¿Eliminar producto ${codigo}?`);
    if (!ok) return;
    await postOpNotify('eliminarAlmacen',{codigo},'Producto eliminado');
  }
  
  await loadData();
}

// COMPRAS - CORREGIDO
async function buyProduct(id) {
  const info = productInfo[id];
  const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value) || 0;
  if (qty <= 0) {
    return showAlert('La cantidad debe ser mayor que cero');
  }
  const uni   = document.getElementById(`buyunit-${id}`).value;
  const factor = FACTORES[uni];
  const total = (info.priceBase * qty * factor).toFixed(2); // CORRECCIÓN
  const fecha = new Date().toISOString().slice(0,10);
  await postOpNotify('guardarCompras',{ 
    idProducto: id,
    fecha,
    name: almacenData.find(x => x.codigo == id).name,
    precio: total,
    cantidad: qty,
    unidad: uni
  },'Compra registrada');
  await loadData();
}

// RENDERIZAR TABLA DE COMPRAS
function renderComprasTable() {
  const list = document.getElementById('compras-list');
  list.innerHTML = '';

  const dataToRender = filteredCompras.length ? filteredCompras : comprasData;
  if (dataToRender.length === 0) {
    list.innerHTML = `
      <div class="no-results">
        <i class="fas fa-shopping-cart"></i>
        <h3>No se encontraron compras</h3>
        <p>Intenta ajustar los filtros o registrar nuevas compras</p>
      </div>`;
    return;
  }

  dataToRender
    .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
    .forEach(c => {
      const prod = almacenData.find(x => x.codigo == c.idProducto);
      if (!prod) return;

      // Usamos c.precio (total guardado)
      const totalGuardado = Number(c.precio).toFixed(2);

      const item = document.createElement('div');
      item.className = 'list-item';
      item.innerHTML = `
        <div>
          <div class="list-title">${prod.name}</div>
          <div class="list-subtitle">Compra #${c.idCompra}</div>
          <div class="list-subtitle">${new Date(c.fecha).toLocaleDateString()}</div>
        </div>
        <div>
          <div class="list-title">${c.cantidad}${c.unidad}</div>
          <div class="list-subtitle">$${totalGuardado}</div>
        </div>
      `;
      item.addEventListener('click', () => openEditCompraModal(c));
      list.appendChild(item);
    });
}

// FILTROS COMPRAS
function applyComprasFilters() {
  const search = document.getElementById('filter-compras-search').value.toLowerCase();
  const provider = document.getElementById('filter-compras-provider').value.toLowerCase();
  const from = document.getElementById('filter-compras-from').value;
  const to = document.getElementById('filter-compras-to').value;

  comprasFilters = { search, provider, from, to };

  filteredCompras = comprasData.filter(c => {
    const prod = almacenData.find(p => p.codigo == c.idProducto) || { name: '' };
    if (search && !prod.name.toLowerCase().includes(search) && !String(c.idProducto).includes(search)) {
      return false;
    }
    if (provider && !c.proveedor.toLowerCase().includes(provider)) {
      return false;
    }
    if (from && c.fecha < from) {
      return false;
    }
    if (to && c.fecha > to) {
      return false;
    }
    return true;
  });

  const filterCount = Object.values(comprasFilters).filter(f => f).length;
  document.getElementById('filter-compras-indicator').textContent = filterCount;

  renderComprasTable();
}

function resetComprasFilters() {
  document.getElementById('filter-compras-search').value = '';
  document.getElementById('filter-compras-provider').value = '';
  document.getElementById('filter-compras-from').value = '';
  document.getElementById('filter-compras-to').value = '';
  comprasFilters = {};
  filteredCompras = [];
  document.getElementById('filter-compras-indicator').textContent = '0';
  renderComprasTable();
}



// NAVEGACIÓN
function cambiarSeccion(sec) {
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.nav-btn[data-sec="${sec}"]`).classList.add('active');
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(sec).classList.add('active');
  window.scrollTo(0, 0);
}




































// VENTAS SECCION
// ===================== FUNCIÓN AUXILIAR NUEVA =====================
function getSaleBreakdown(v) {
    const subtotal = v.venta.reduce((sum, item) => sum + Number(item.total), 0);
    let discountPercentage = 0;
    if (v.codigosdeventa && v.codigosdeventa.length > 0) {
        discountPercentage = parseFloat(v.codigosdeventa[0].descuento) || 0;
    }
    const discountAmount = subtotal * discountPercentage / 100;
    const total = subtotal - discountAmount;
    return { subtotal, discountPercentage, discountAmount, total };
}

function crearItemRow(cod = '', cant = '', tot = '') {
  const row = document.createElement('div');
  row.className = 'sale-item';
  row.innerHTML = `
    <select class="form-select sale-item-select"
            onchange="recalcRow(this)" onclick="recalcRow(this)">
      ${recetas.map(r =>
        `<option value="${r.codigo}" ${r.codigo === cod ? 'selected' : ''}>
          ${r.nombre}
        </option>`
      ).join('')}
    </select>
    <input class="form-input sale-item-qty" type="number"
           min="1" value="${cant}" placeholder="Cant"
           onclick="recalcRow(this)" oninput="recalcRow(this)">
    <input class="form-input sale-item-total" type="number"
           value="${tot}" placeholder="Total" readonly>
    <i class="fas fa-times sale-item-remove"
       onclick="this.parentNode.remove()"></i>
  `;
  return row;
}

function recalcRow(el) {
  const row = el.closest('.sale-item');
  const sel = row.querySelector('.sale-item-select');
  const inpCant = row.querySelector('.sale-item-qty');
  const inpTot = row.querySelector('.sale-item-total');
  const rec = recetas.find(x => x.codigo === sel.value) || { precio: 0 };
  inpTot.value = (Number(rec.precio) * Number(inpCant.value || 0)).toFixed(2);
}

function agregarItemVenta() {
  document.getElementById('items-container').append(crearItemRow());
}

function renderTicketCard(v) {
  const fechaStr = new Date(v.fecha).toLocaleDateString();
  const itemsHtml = v.venta.map(it =>
    `<div class="card-row">
       <div>${it.producto} x${it.cantidad}</div>
       <div>$${it.total}</div>
     </div>`
  ).join('');
  const codigosDeventas = v.codigosdeventa.map(it2 =>
    `<div class="card-row">
       <div>Cliente${it2.cliente}, Vendedor${it2.empleado}, Descuento%${it2.descuento}</div>
     </div>`
  ).join('');

  // CALCULAR DESCUENTOS Y TOTALES (MODIFICADO)
  const { subtotal, discountPercentage, discountAmount, total } = getSaleBreakdown(v);

  const item = document.createElement('div');
  item.className = 'list-item';
  item.innerHTML = `
    <div>
      <div class="list-title">Venta #${v.id}</div>
      <div class="list-subtitle">${fechaStr} | ${v.metodoPago}</div>
      <div class="list-subtitle">${v.venta.length} productos</div>
    </div>
    <div>
      <div class="list-title">$${total.toFixed(2)}</div> <!-- Total con descuento -->
    </div>
  `;
  item.addEventListener('click', () => {
    const card = document.createElement('div');
    card.className = 'card fade-in';
    card.innerHTML = `
      <div class="card-header">Venta #${v.id}</div>
      <div class="card-body">
        <div class="card-row">
          <div class="card-label">Fecha</div>
          <div class="card-value">${fechaStr}</div>
        </div>
        <div class="card-row">
          <div class="card-label">Método de pago</div>
          <div class="card-value">${v.metodoPago}</div>
        </div>
        ${itemsHtml}
        ${codigosDeventas} 
        
        <!-- SECCIÓN DE DESCUENTOS AÑADIDA -->
        <div class="card-row">
          <div class="card-label">Subtotal</div>
          <div class="card-value">$${subtotal.toFixed(2)}</div>
        </div>
        <div class="card-row">
          <div class="card-label">Descuento (${discountPercentage}%)</div>
          <div class="card-value">$${discountAmount.toFixed(2)}</div>
        </div>
        <div class="card-row">
          <div class="card-label">Total</div>
          <div class="card-value">$${total.toFixed(2)}</div>
        </div>
        
        <div class="div2">
          <button class="btn btn-primary"
                  onclick='startEdit(${JSON.stringify(v)})'>
            Editar
          </button>
          <button class="btn btn-danger"
                  onclick="eliminarVenta('${v.id}')">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </div>
      </div>`;
    modal.show({ title: 'Detalle de Venta', message: card.innerHTML });
  });
  return item;
}

async function cargarVentas() {
  await fetchRecetas(); // asegura que 'recetas' esté poblado
  const list = document.getElementById('tickets-list');
  list.innerHTML = '';

  const dataToRender = filteredVentas.length ? filteredVentas : ventData;
  if (dataToRender.length === 0) {
    list.innerHTML = `
      <div class="no-results">
        <i class="fas fa-receipt"></i>
        <h3>No se encontraron ventas</h3>
        <p>Intenta ajustar los filtros o registrar nuevas ventas</p>
      </div>`;
    return;
  }

  dataToRender.forEach(v => list.append(renderTicketCard(v)));
  actualizarResumen(dataToRender);
}

function startEdit(v) {
  document.getElementById('form-id').value = v.id;
  document.getElementById('form-fecha').value =
    new Date(v.fecha).toISOString().slice(0,10);
  document.getElementById('form-pago').value = v.metodoPago;

  const cont = document.getElementById('items-container');
  cont.innerHTML = '';
  (v.venta || []).forEach(itm =>
    cont.append(crearItemRow(itm.codigo, itm.cantidad, itm.total))
  );

  // --- AÑADIDO: rellenar 3 inputs si existen ---
  const firstCode = Array.isArray(v.codigosdeventa) && v.codigosdeventa.length ? v.codigosdeventa[0] : null;
  if (firstCode) {
    const clienteEl = document.getElementById('form-cliente');
    const vendedorEl = document.getElementById('form-vendedor');
    const descuentoEl = document.getElementById('form-descuento');

    if (clienteEl && firstCode.cliente !== undefined) clienteEl.value = firstCode.cliente;
    if (vendedorEl && firstCode.empleado !== undefined) vendedorEl.value = firstCode.empleado;
    if (descuentoEl && firstCode.descuento !== undefined) descuentoEl.value = firstCode.descuento;
  }

  if (modal && modal.backdrop) modal.backdrop.style.display = 'none';
  cambiarSeccion('ventas');
}


function resetForm() {
  document.getElementById('form-id').value = '';
  document.getElementById('form-fecha').value =
    new Date().toISOString().slice(0,10);
  document.getElementById('form-pago').value = 'Efectivo';
  document.getElementById('items-container').innerHTML = '';
  document.getElementById('form-cliente').value = '';
  document.getElementById('form-vendedor').value = '';
  document.getElementById('form-descuento').value = '';
}

function actualizarResumen(vs) {
  // Totales por método de pago (con descuentos)
  let e = 0, t = 0, ta = 0;
  
  // Acumuladores para clientes y vendedores (SIN descuentos)
  const clientesSinDescuento = {};
  const vendedoresSinDescuento = {};
  
  // Acumuladores normales (CON descuentos)
  const clientes = {};
  const vendedores = {};
  const descuentosPorcentaje = {};
  
  // Contadores de compras por cliente y ventas por vendedor
  const comprasPorCliente = {};
  const ventasPorVendedor = {};

  let totalDescuentos = 0;
  let totalGeneral = 0;
  let totalVentas = vs.length;
  let totalProductos = 0;
  let subtotalGeneral = 0;

  vs.forEach(v => {
    const { subtotal, discountAmount, discountPercentage, total } = getSaleBreakdown(v);
    
    subtotalGeneral += subtotal;
    totalDescuentos += discountAmount;
    totalGeneral += total;

    // Acumular por método de pago
    if (v.metodoPago === 'Efectivo') e += total;
    else if (v.metodoPago === 'Transferencia') t += total;
    else ta += total;

    // Obtener datos de cliente y vendedor
    const codigos = v.codigosdeventa || [];
    
    // Cliente
    const cliente = codigos.length > 0 ? codigos[0].cliente : 'Sin cliente';
    
    // Vendedor - extraemos solo el código
    let codigoVendedor = 'SIN-COD';
    if (codigos.length > 0 && codigos[0].empleado) {
      // Extraer el código del formato "CODIGO - Nombre"
      const match = codigos[0].empleado.match(/^([^-]+)/);
      codigoVendedor = match ? match[0].trim() : 'SIN-COD';
    }

    // Acumular por cliente (CON descuento)
    clientes[cliente] = (clientes[cliente] || 0) + total;
    
    // Acumular por cliente (SIN descuento)
    clientesSinDescuento[cliente] = (clientesSinDescuento[cliente] || 0) + subtotal;
    
    // Acumular por vendedor (CON descuento) usando solo el código
    vendedores[codigoVendedor] = (vendedores[codigoVendedor] || 0) + total;
    
    // Acumular por vendedor (SIN descuento) usando solo el código
    vendedoresSinDescuento[codigoVendedor] = (vendedoresSinDescuento[codigoVendedor] || 0) + subtotal;
    
    // Contar compras por cliente
    comprasPorCliente[cliente] = (comprasPorCliente[cliente] || 0) + 1;
    
    // Contar ventas por vendedor
    ventasPorVendedor[codigoVendedor] = (ventasPorVendedor[codigoVendedor] || 0) + 1;
    
    // Acumular por porcentaje de descuento
    if (discountPercentage > 0) {
      const porcentajeKey = `${discountPercentage}%`;
      descuentosPorcentaje[porcentajeKey] = (descuentosPorcentaje[porcentajeKey] || 0) + discountAmount;
    }
    
    // Calcular total de productos vendidos
    v.venta.forEach(item => {
      totalProductos += parseInt(item.cantidad) || 0;
    });
  });

  // Actualizar totales por método de pago
  document.getElementById('sum-efectivo').textContent = e.toFixed(2);
  document.getElementById('sum-transferencia').textContent = t.toFixed(2);
  document.getElementById('sum-tarjeta').textContent = ta.toFixed(2);
  document.getElementById('sum-total').textContent = totalGeneral.toFixed(2);

  // Actualizar lista de clientes (mostrar "Compras")
  const clientesList = document.getElementById('resumen-clientes');
  clientesList.innerHTML = '';
  for (const [cliente, total] of Object.entries(clientes)) {
    const totalSinDescuento = clientesSinDescuento[cliente] || 0;
    const descuentoCliente = totalSinDescuento - total;
    const compras = comprasPorCliente[cliente] || 0;
    
    const item = document.createElement('div');
    item.className = 'resumen-item';
    item.innerHTML = `
      <div>
        <div>${cliente}</div>
        <div class="resumen-count">Compras: ${compras}</div>
      </div>
      <div>
        <div>$${totalSinDescuento.toFixed(2)}</div>
        <div class="resumen-descuento">-$${descuentoCliente.toFixed(2)}</div>
        <div class="resumen-total-net">$${total.toFixed(2)}</div>
      </div>
    `;
    clientesList.appendChild(item);
  }

  // Actualizar lista de vendedores (mostrar "Ventas")
  const vendedoresList = document.getElementById('resumen-vendedores');
  vendedoresList.innerHTML = '';
  for (const [codigoVendedor, total] of Object.entries(vendedores)) {
    const totalSinDescuento = vendedoresSinDescuento[codigoVendedor] || 0;
    const descuentoVendedor = totalSinDescuento - total;
    const ventas = ventasPorVendedor[codigoVendedor] || 0;
    
    const item = document.createElement('div');
    item.className = 'resumen-item';
    item.innerHTML = `
      <div>
        <div class="resumen-codigo">${codigoVendedor}</div>
        <div class="resumen-count">Ventas: ${ventas}</div>
      </div>
      <div>
        <div>$${totalSinDescuento.toFixed(2)}</div>
        <div class="resumen-descuento">-$${descuentoVendedor.toFixed(2)}</div>
        <div class="resumen-total-net">$${total.toFixed(2)}</div>
      </div>
    `;
    vendedoresList.appendChild(item);
  }

  // Actualizar lista de descuentos por porcentaje
  const descuentosList = document.getElementById('resumen-descuentos');
  descuentosList.innerHTML = '';
  for (const [porcentaje, total] of Object.entries(descuentosPorcentaje)) {
    const item = document.createElement('div');
    item.className = 'resumen-item';
    item.innerHTML = `<span>${porcentaje}</span><span>$${total.toFixed(2)}</span>`;
    descuentosList.appendChild(item);
  }

  // Actualizar resumen general
  document.getElementById('resumen-total-ventas').textContent = totalVentas;
  document.getElementById('resumen-total-productos').textContent = totalProductos;
  document.getElementById('resumen-subtotal-general').textContent = subtotalGeneral.toFixed(2);
  document.getElementById('resumen-total-descuentos').textContent = totalDescuentos.toFixed(2);
  document.getElementById('resumen-total-general').textContent = totalGeneral.toFixed(2);
  document.getElementById('resumen-total-clientes').textContent = Object.keys(clientes).length;
  document.getElementById('resumen-total-vendedores').textContent = Object.keys(vendedores).length;
}











async function guardarVenta() {
  const fecha = document.getElementById('form-fecha').value;
  const cliente = document.getElementById('form-cliente').value;
  const vendedor = document.getElementById('form-vendedor').value;
  const descuento = document.getElementById('form-descuento').value;
  const rows = document.querySelectorAll('#items-container .sale-item');
  if (!fecha) return await showAlert('Selecciona fecha');
  if (!rows.length) return await showAlert('Agrega al menos un producto');

  const ventaItems = Array.from(rows).map(r => {
    const sel = r.querySelector('.sale-item-select');
    const ic = r.querySelector('.sale-item-qty');
    const it = r.querySelector('.sale-item-total');
    const rec = recetas.find(x => x.codigo === sel.value) || { nombre: '', precio: 0 };
    return {
      codigo: sel.value,
      producto: rec.nombre,
      cantidad: Number(ic.value) || 0,
      total: Number(it.value) || 0
    };
  });
  const codigosdeventa = [];
  if (cliente || vendedor || descuento) {
    codigosdeventa.push({
      cliente: cliente,
      empleado: vendedor,
      descuento: descuento
    });
  }







  

  const payload = {
    id: document.getElementById('form-id').value,
    fecha,
    metodoPago: document.getElementById('form-pago').value,
    venta: ventaItems,
    items: ventaItems,
    codigosdeventa: codigosdeventa  // Añadir esta línea
  };

  await postOpNotify('guardarVentas', { venta: JSON.stringify(payload) }, 'Venta guardada');
  resetForm();
  await loadData();
}

async function eliminarVenta(id) {
  const ok = await showConfirm('¿Eliminar venta?');
  if (!ok) return;
  await postOpNotify('eliminarVentas', { id }, 'Venta eliminada');
  await loadData();
}

// FILTROS VENTAS
function applyVentasFilters() {
  const search = document.getElementById('filter-ventas-search').value.toLowerCase();
  const payment = document.getElementById('filter-ventas-payment').value;
  const from = document.getElementById('filter-ventas-from').value;
  const to = document.getElementById('filter-ventas-to').value;

  ventasFilters = { search, payment, from, to };

  filteredVentas = ventData.filter(v => {
    if (search) {
      const found = v.venta.some(it => {
        const rec = cocData.find(r => String(r.codigo) === String(it.codigo));
        return rec && rec.nombre.toLowerCase().includes(search);
      });
      if (!found) return false;
    }
    if (payment && v.metodoPago !== payment) {
      return false;
    }
    if (from && v.fecha < from) {
      return false;
    }
    if (to && v.fecha > to) {
      return false;
    }
    return true;
  });

  const filterCount = Object.values(ventasFilters).filter(f => f).length;
  document.getElementById('filter-ventas-indicator').textContent = filterCount;

  cargarVentas();
}

function resetVentasFilters() {
  document.getElementById('filter-ventas-search').value = '';
  document.getElementById('filter-ventas-payment').value = '';
  document.getElementById('filter-ventas-from').value = '';
  document.getElementById('filter-ventas-to').value = '';
  ventasFilters = {};
  filteredVentas = [];
  document.getElementById('filter-ventas-indicator').textContent = '0';
  cargarVentas();
}
// VENTAS FIN








































// BALANCES - CORREGIDO
// helper: convierte "$1,234.56" o "1,234.56" -> 1234.56
function parseCurrency(str) {
  if (str == null) return 0;
  return parseFloat(String(str).replace(/\$/g, '').replace(/,/g, '').trim()) || 0;
}

// === loadBalances ===
async function loadBalances() {
  const res = await callApi({ op: 'obtenerBalances' });
  if (res.status === 'success') {
    balancesData = res.data || [];
    filteredBalances = [];
    renderBalancesTable();
    // No override: calcula según los datos disponibles (usar filteredVentas si existe)
    updateBalancesSummary();
  }
}

// Calcula total de ventas. Si pasas ventasSource asumimos que YA está filtrada.
// Si no pasas ventasSource, se usa filteredVentas (si existe) o ventData.
function calculateSalesTotal(paymentFilter = 'todos', ventasSource = null) {
  const source = Array.isArray(ventasSource) && ventasSource.length
    ? ventasSource
    : (Array.isArray(filteredVentas) && filteredVentas.length ? filteredVentas : (Array.isArray(ventData) ? ventData : []));

  const sourceIsVentData = source === ventData;

  return source.reduce((sum, v) => {
    // Si la fuente es ventData (todas las ventas) y piden filtrar por metodo, aplicarlo
    if (sourceIsVentData && paymentFilter !== 'todos' && v.metodoPago !== paymentFilter) return sum;

    // Usar getSaleBreakdown si existe (para considerar descuentos), si no sumar items brutos
    let ventaTotal = 0;
    if (typeof getSaleBreakdown === 'function') {
      try {
        ventaTotal = Number(getSaleBreakdown(v).total || 0);
      } catch (e) {
        ventaTotal = v.venta.reduce((s, i) => s + Number(i.total || 0), 0);
      }
    } else {
      ventaTotal = v.venta.reduce((s, i) => s + Number(i.total || 0), 0);
    }

    return sum + ventaTotal;
  }, 0);
}

// Filtrar por método de pago — ahora usa los totales ya renderizados en el DOM
function filterByPayment(payment) {
  currentPaymentFilter = payment;

  // Actualizar botones activos
  document.querySelectorAll('.payment-filter-btn').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.pago === payment) btn.classList.add('active');
  });

  // Leer los totales ya calculados en el DOM (sum-efectivo, sum-transferencia, sum-tarjeta, sum-total)
  const efectivoEl = document.getElementById('sum-efectivo');
  const transferenciaEl = document.getElementById('sum-transferencia');
  const tarjetaEl = document.getElementById('sum-tarjeta');
  const totalEl = document.getElementById('sum-total');

  const efectivo = parseCurrency(efectivoEl?.textContent ?? efectivoEl?.value ?? '0');
  const transferencia = parseCurrency(transferenciaEl?.textContent ?? transferenciaEl?.value ?? '0');
  const tarjeta = parseCurrency(tarjetaEl?.textContent ?? tarjetaEl?.value ?? '0');
  const total = parseCurrency(totalEl?.textContent ?? totalEl?.value ?? String(efectivo + transferencia + tarjeta));

  // Decidir qué valor inyectar en la tarjeta "total-ventas"
  let ventasValue = 0;
  const p = String(payment || '').toLowerCase();
  if (p === 'efectivo') ventasValue = efectivo;
  else if (p === 'transferencia') ventasValue = transferencia;
  else if (p === 'tarjeta') ventasValue = tarjeta;
  else ventasValue = total; // 'todos' u otros

  // Actualizar la tarjeta objetivo inmediatamente
  const totalVentasEl = document.getElementById('total-ventas');
  if (totalVentasEl) totalVentasEl.textContent = '$' + Number(ventasValue || 0).toFixed(2);

  const filtroText = (payment === 'todos' || !payment) ? 'Todos los métodos' : `Solo ${payment}`;
  const ventasFiltroEl = document.getElementById('ventas-filtro');
  if (ventasFiltroEl) ventasFiltroEl.textContent = filtroText;

  // Llamar a updateBalancesSummary pasando el override para que use este valor
  if (typeof updateBalancesSummary === 'function') {
    updateBalancesSummary(ventasValue);
    // garantizar que el valor mostrado en la tarjeta no sea sobrescrito por la función
    if (totalVentasEl) totalVentasEl.textContent = '$' + Number(ventasValue || 0).toFixed(2);
  }
}

// updateBalancesSummary ahora acepta un override numérico para totalVentas (ventasOverride)
// y/o una ventasSource (arreglo) para que no recalcules si ya tienes la fuente filtrada.
function updateBalancesSummary(ventasOverride = null, ventasSource = null) {
  const dataToRender = Array.isArray(filteredBalances) && filteredBalances.length ? filteredBalances : (Array.isArray(balancesData) ? balancesData : []);

  // 1) Total de ventas según el filtro
  // Si nos pasan ventasOverride usamos ese número (ya proviene del DOM).
  // Si no, lo calculamos con calculateSalesTotal, pasando ventasSource si viene.
  let totalVentas = 0;
  if (typeof ventasOverride === 'number' && !isNaN(ventasOverride)) {
    totalVentas = Number(ventasOverride);
  } else {
    totalVentas = calculateSalesTotal(currentPaymentFilter || 'todos', ventasSource);
  }

  // 2) Otros ingresos activos
  const totalOtrosIngresos = (dataToRender || [])
    .filter(b => b.estado === 'activo' && b.tipo === 'ingreso')
    .reduce((sum, b) => sum + (parseFloat(b.monto) || 0), 0);

  // 3) Otros gastos activos
  const totalGastos = (dataToRender || [])
    .filter(b => b.estado === 'activo' && b.tipo === 'deducible')
    .reduce((sum, b) => sum + (parseFloat(b.monto) || 0), 0);

  // 4) Compras (gasto de inventario) — leer del DOM (evitamos recalcular)
  const totalCompras = parseCurrency(document.getElementById('stat-purchases')?.textContent || document.getElementById('stat-purchases')?.value || '0');

  // 5) Costo de surtir el almacén al 100%
  const totalAlmacen = parseCurrency(document.getElementById('stat-restock')?.textContent || document.getElementById('stat-restock')?.value || '0');

  // 6) Neto: ingresos menos gastos y compras
  const totalNeto = totalVentas + totalOtrosIngresos - totalGastos - totalCompras;

  // 7) Saldo con almacen
  const saldoConAlmacen = totalNeto - totalAlmacen;

  // 8) Formato con signo
  const signo = saldoConAlmacen >= 0 ? '$' : '-$';
  const valorFormateado = Math.abs(saldoConAlmacen).toFixed(2);

  // Totales por categoría (sobre dataToRender)
  const categoryTotals = (dataToRender || [])
    .filter(b => b.estado === 'activo')
    .reduce((acc, b) => {
      const cat = b.categoria || 'Sin categoría';
      acc[cat] = (acc[cat] || 0) + (parseFloat(b.monto) || 0);
      return acc;
    }, {});

  const textoCategorias = Object.entries(categoryTotals)
    .map(([cat, tot]) => `${cat}: $${tot.toFixed(2)}`)
    .join(', ');

  // — Actualización del DOM —
  const el = id => document.getElementById(id);
  if (el('total-ventas')) el('total-ventas').textContent = '$' + Number(totalVentas || 0).toFixed(2);
  if (el('total-otros-ingresos')) el('total-otros-ingresos').textContent = '$' + totalOtrosIngresos.toFixed(2);
  if (el('total-gastos')) el('total-gastos').textContent = '$' + totalGastos.toFixed(2);
  if (el('total-gastos-inventario')) el('total-gastos-inventario').textContent = '$' + totalCompras.toFixed(2);
  if (el('total-neto')) el('total-neto').textContent = '$' + totalNeto.toFixed(2);
  if (el('total-almacen')) el('total-almacen').textContent = signo + valorFormateado;
  if (el('total-porCategoria')) el('total-porCategoria').textContent = textoCategorias;

  const filtroText = (currentPaymentFilter === 'todos' || !currentPaymentFilter) ? 'Todos los métodos' : `Solo ${currentPaymentFilter}`;
  if (el('ventas-filtro')) el('ventas-filtro').textContent = filtroText;
}

// === RENDER TABLE ===
function renderBalancesTable() {
  const list = document.getElementById('balances-list');
  if (!list) return;
  list.innerHTML = '';

  const dataToRender = Array.isArray(filteredBalances) && filteredBalances.length ? filteredBalances : (Array.isArray(balancesData) ? balancesData : []);

  if (!dataToRender.length) {
    list.innerHTML = `
      <div class="no-results">
        <i class="fas fa-scale-balanced"></i>
        <h3>No se encontraron registros</h3>
        <p>Intenta ajustar los filtros o agregar nuevos registros</p>
      </div>
    `;
    return;
  }

  dataToRender.forEach(b => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div>
        <div class="list-title">${b.especificacion || 'Sin especificación'}</div>
        <div class="list-subtitle">#${b.codigo} | ${b.categoria || ''} 
          <span class="balance-type ${b.tipo === 'ingreso' ? 'ingreso' : 'gasto'}">
            ${b.tipo === 'ingreso' ? 'Ingreso' : 'Gasto'}
          </span>
        </div>
        <div class="list-subtitle">
          <span class="balance-status ${b.estado === 'activo' ? 'activo' : 'inactivo'}">
            ${b.estado === 'activo' ? 'Activo' : 'Inactivo'}
          </span>
        </div>
      </div>
      <div>
        <div class="list-title ${b.tipo === 'ingreso' ? 'text-success' : 'text-danger'}">
          ${b.tipo === 'ingreso' ? '+' : '-'} $${(parseFloat(b.monto) || 0).toFixed(2)}
        </div>
      </div>
    `;

    item.addEventListener('click', () => {
      const modalContent = document.createElement('div');
      modalContent.innerHTML = `
        <div class="card">
          <div class="card-header">Editar Balance #${b.codigo}</div>
          <div class="card-body">
            <input type="hidden" id="balance-codigo" value="${b.codigo}">
            <div class="form-group">
              <label class="form-label">Monto</label>
              <input type="number" class="form-input" id="balance-monto" value="${b.monto}" step="0.01">
            </div>
            <div class="form-group">
              <label class="form-label">Categoría</label>
              <input type="text" class="form-input" id="balance-categoria" value="${b.categoria || ''}">
            </div>
            <div class="form-group">
              <label class="form-label">Tipo</label>
              <select class="form-select" id="balance-tipo">
                <option value="ingreso" ${b.tipo === 'ingreso' ? 'selected' : ''}>Ingreso</option>
                <option value="deducible" ${b.tipo === 'deducible' ? 'selected' : ''}>Gasto</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Estado</label>
              <select class="form-select" id="balance-estado">
                <option value="activo" ${b.estado === 'activo' ? 'selected' : ''}>Activo</option>
                <option value="inactivo" ${b.estado === 'inactivo' ? 'selected' : ''}>Inactivo</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Especificación</label>
              <input type="text" class="form-input" id="balance-especificacion" value="${b.especificacion || ''}">
            </div>
            <div class="div2">
              <button class="btn btn-primary" onclick="saveBalance()">Guardar</button>
              <button class="btn btn-danger" onclick="deleteBalance('${b.codigo}')">Eliminar</button>
            </div>
          </div>
        </div>
      `;

      modal.show({
        title: 'Editar Balance',
        message: modalContent.innerHTML
      });
    });

    list.appendChild(item);
  });
}

// === FILTROS / CRUD ===
function applyBalancesFilters() {
  const search = (document.getElementById('filter-balances-search')?.value || '').toLowerCase();
  const categoria = (document.getElementById('filter-balances-categoria')?.value || '').toLowerCase();
  const estado = document.getElementById('filter-balances-estado')?.value || '';

  balancesFilters = { search, categoria, estado };

  balancesData = balancesData || [];
  filteredBalances = balancesData.filter(b => {
    if (search && !( (b.especificacion || '').toLowerCase().includes(search) || String(b.codigo).includes(search) )) return false;
    if (categoria && !((b.categoria || '').toLowerCase().includes(categoria))) return false;
    if (estado && b.estado !== estado) return false;
    return true;
  });

  const filterCount = Object.values(balancesFilters).filter(f => f).length;
  const indicator = document.getElementById('filter-balances-indicator');
  if (indicator) indicator.textContent = filterCount;

  renderBalancesTable();
  // No override: recalcula ventas segun la fuente disponible
  updateBalancesSummary();
}

function resetBalancesFilters() {
  if (document.getElementById('filter-balances-search')) document.getElementById('filter-balances-search').value = '';
  if (document.getElementById('filter-balances-categoria')) document.getElementById('filter-balances-categoria').value = '';
  if (document.getElementById('filter-balances-estado')) document.getElementById('filter-balances-estado').value = '';
  balancesFilters = {};
  filteredBalances = [];
  const indicator = document.getElementById('filter-balances-indicator');
  if (indicator) indicator.textContent = '0';
  renderBalancesTable();
  updateBalancesSummary();
}

function addNewBalance() {
  const newBalance = {
    codigo: Date.now(),
    monto: 0,
    categoria: '',
    tipo: 'deducible',
    estado: 'activo',
    especificacion: 'Nuevo registro'
  };
  balancesData = balancesData || [];
  balancesData.push(newBalance);
  renderBalancesTable();

  const modalContent = document.createElement('div');
  modalContent.innerHTML = `
    <div class="card">
      <div class="card-header">Nuevo Balance</div>
      <div class="card-body">
        <input type="hidden" id="balance-codigo" value="${newBalance.codigo}">
        <div class="form-group">
          <label class="form-label">Monto</label>
          <input type="number" class="form-input" id="balance-monto" value="0" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label">Categoría</label>
          <input type="text" class="form-input" id="balance-categoria" placeholder="Categoría">
        </div>
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-select" id="balance-tipo">
            <option value="ingreso">Ingreso</option>
            <option value="deducible" selected>Gasto</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select class="form-select" id="balance-estado">
            <option value="activo" selected>Activo</option>
            <option value="inactivo">Inactivo</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Especificación</label>
          <input type="text" class="form-input" id="balance-especificacion" placeholder="Descripción">
        </div>
        <div class="div2">
          <button class="btn btn-primary" onclick="saveBalance()">Guardar</button>
          <button class="btn btn-outline" onclick="modal.backdrop.style.display='none'">Cancelar</button>
        </div>
      </div>
    </div>
  `;

  modal.show({
    title: 'Nuevo Balance',
    message: modalContent.innerHTML
  });
}

async function saveBalance() {
  const codigo = document.getElementById('balance-codigo')?.value;
  const monto = parseFloat(document.getElementById('balance-monto')?.value);
  const categoria = document.getElementById('balance-categoria')?.value || '';
  const tipo = document.getElementById('balance-tipo')?.value || 'deducible';
  const estado = document.getElementById('balance-estado')?.value || 'activo';
  const especificacion = document.getElementById('balance-especificacion')?.value || '';

  if (isNaN(monto) || monto <= 0) {
    return showAlert('El monto debe ser un número positivo');
  }

  const params = { codigo, monto, categoria, tipo, estado, especificacion };

  await postOpNotify('guardarBalances', params, 'Balance guardado');
  await loadBalances();
}

async function deleteBalance(codigo) {
  const ok = await showConfirm('¿Eliminar este registro?');
  if (!ok) return;
  await postOpNotify('eliminarBalances', { codigo }, 'Registro eliminado');
  await loadBalances();
}




















































// RECETAS
async function fetchRecetas() {
  const cocR = await callApi({ op: 'obtenerCocina' });
  if (cocR.status === 'success') {
    cocData = cocR.data.map(r => ({
      ...r,
      ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
    }));
  }
  recetas = cocData.map(r => {
    const costo = r.ingredientes.reduce((sum, ing) => {
      const p = almacenData.find(x => String(x.codigo) === String(ing.codigo));
      if (!p) return sum;
      const basePrice = p.precio / (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad);
      return sum + basePrice * (FACTORES[ing.unidad.trim().toLowerCase()] * ing.cantidad);
    }, 0);
    return {
      codigo: r.codigo,
      nombre: r.nombre,
      precio: (costo * MARGEN).toFixed(2)
    };
  });
}

async function cargarRecetas() {
  await fetchRecetas();
  recetasData = cocData;
  categorias = [...new Set(recetasData.map(r => r.categoria))];
  
  // Actualizar select de categorías en formulario
  const sel = document.getElementById('receta-categoria');
  sel.innerHTML = [
    '<option value="">-- Selecciona --</option>',
    ...categorias.sort().map(c => `<option value="${c}">${c}</option>`)
  ].join('');
  
  // Actualizar select de categorías en filtros
  const filterCatSel = document.getElementById('filter-recetas-category');
  filterCatSel.innerHTML = [
    '<option value="">Todas</option>',
    ...categorias.sort().map(c => `<option value="${c}">${c}</option>`)
  ].join('');
  
  mostrarRecetas();
}

function mostrarRecetas() {
  const list = document.getElementById('recetas-list'); 
  list.innerHTML = '';
  
  const dataToRender = filteredRecetas.length ? filteredRecetas : recetasData;
  
  if (dataToRender.length === 0) {
    list.innerHTML = `
      <div class="no-results">
        <i class="fas fa-book"></i>
        <h3>No se encontraron recetas</h3>
        <p>Intenta ajustar los filtros o crear nuevas recetas</p>
      </div>
    `;
    return;
  }
  
  dataToRender.forEach(r => {
    const costo = r.ingredientes.reduce((sum, ing) => {
      const p = almacenData.find(x => String(x.codigo) === String(ing.codigo));
      if (!p) return sum;
      const basePrice = p.precio / (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad);
      return sum + basePrice * (FACTORES[ing.unidad.trim().toLowerCase()] * ing.cantidad);
    }, 0).toFixed(2);
    
    // Verificar si hay ingredientes inactivos
    let hasInactive = false;
    for (const ing of r.ingredientes) {
      const product = almacenData.find(p => p.codigo == ing.codigo);
      if (product && product.active === false) {
        hasInactive = true;
        break;
      }
    }
    
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div class="recipe-card">
        ${r.imagen ? 
          `<img src="${r.imagen}" class="recipe-image" alt="${r.nombre}">` : 
          `<div class="recipe-image"><i class="fas fa-utensils"></i></div>`
        }
        <div class="recipe-info">
          <div class="list-title">${r.nombre} ${hasInactive ? '<span class="status-badge status-inactive">Inactivo</span>' : ''}</div>
          <div class="list-subtitle">#${r.codigo} | ${r.categoria}</div>
          <div class="list-subtitle">${r.ingredientes.length} ingredientes</div>
        </div>
      </div>
      <div>
        <div class="list-title">$${(costo * MARGEN).toFixed(2)}</div>
        <div class="list-subtitle">Costo: $${costo}</div>
      </div>
    `;
    
    item.addEventListener('click', () => {
      const ingredientesHtml = r.ingredientes
        .map(i => {
          const p = almacenData.find(x => String(x.codigo) === String(i.codigo));
          const c = p ? (p.precio / (FACTORES[p.unidadDeMedida.trim().toLowerCase()] * p.cantidad))* 
                      (FACTORES[i.unidad.trim().toLowerCase()] * i.cantidad) : 0;
          
          // Estado del producto según productInfo
          const infoProd = productInfo[p?.codigo] || {};
          const estado = p
            ? (infoProd.active
                ? ''
                : '<span class="status-badge status-low">Inactivo</span>')
            : '<span class="status-badge status-low">No encontrado</span>';
          
          // Nombre del producto o código si no se encuentra
          const nombreProducto = p ? p.name : `Producto ${i.codigo}`;
          
          return `
          <div class="card-row">
            <div>
              <div>${nombreProducto} ${estado}</div>
              <div class="list-subtitle">${i.cantidad}${i.unidad} | #${i.codigo}</div>
            </div>
            <div class="card-value">$${c.toFixed(2)}</div>
          </div>`;
        })
        .join('');
        
      const card = document.createElement('div');
      card.className = 'card fade-in';
      card.innerHTML = `
        <div class="card-header">${r.nombre}</div>
        <div class="card-body">
          <div class="card-row">
            <div class="card-label">Código</div>
            <div class="card-value">${r.codigo}</div>
          </div>
          <div class="card-row">
            <div class="card-label">Categoría</div>
            <div class="card-value">${r.categoria}</div>
          </div>
          ${r.imagen ? `<div class="card-row"><div colspan="2"><img src="${r.imagen}" style="max-width:100%; border-radius:12px;"></div></div>` : ''}
          <div class="card-row">
            <div class="card-label">Ingredientes</div>
            <div class="card-value"></div>
          </div>
          ${ingredientesHtml}
          <div class="card-row">
            <div class="card-label">Costo total</div>
            <div class="card-value">$${costo}</div>
          </div>
          <div class="card-row">
            <div class="card-label">Precio de venta</div>
            <div class="card-value">$${(costo * MARGEN).toFixed(2)}</div>
          </div>
          <div class="div2">
            <button class="btn btn-primary" onclick='cargarEnForm(${JSON.stringify(r)})'>Editar</button>
            <button class="btn btn-danger" onclick="eliminarReceta('${r.codigo}')">
              <i class="fas fa-trash"></i> Eliminar
            </button>
          </div>
        </div>
      `;
      
      modal.show({
        title: 'Detalle de Receta',
        message: card.innerHTML
      });
    });
    
    list.appendChild(item);
  });
}

function cargarEnForm(r) {
  editMode = true;
  document.getElementById('receta-codigo').value = r.codigo;
  document.getElementById('receta-nombre').value = r.nombre;
  document.getElementById('receta-categoria').value = r.categoria;
  document.getElementById('receta-imagen').value = r.imagen || '';
  
  const cont = document.getElementById('ingredientes-container');
  cont.innerHTML = '';
  r.ingredientes.forEach(i => agregarFila(i));
  
  modal.backdrop.style.display = 'none';
  cambiarSeccion('recetas');
}

async function guardarReceta() {
  const cod = document.getElementById('receta-codigo').value.trim();
  const nom = document.getElementById('receta-nombre').value.trim();
  const cat = document.getElementById('receta-categoria').value;
  
  const ingredientes = Array.from(
    document.getElementById('ingredientes-container').querySelectorAll('.form-row')
  ).map(row => {
    const selP = row.querySelector('.producto-select');
    const inpCant = row.querySelector('.cantidad-input');
    const selU = row.querySelector('.unidad-select');
    return {
      codigo: selP.value,
      cantidad: Number(inpCant.value) || 0,
      unidad: selU.value
    };
  });
  
  await postOpNotify(
    'guardarCocina',
    {
      codigo: cod,
      nombre: nom,
      categoria: cat,
      imagen: document.getElementById('receta-imagen').value.trim(),
      ingredientes: JSON.stringify(ingredientes)
    },
    'Receta guardada'
  );
  
  await cargarRecetas();
  limpiarForm();
}

async function eliminarReceta(codigo) {
  const ok = await showConfirm(`¿Eliminar receta ${codigo}?`);
  if (!ok) return;
  await postOpNotify('eliminarCocina', { codigo }, 'Receta eliminada');
  await cargarRecetas();
}

function agregarFila(item = {}) {
  const cont = document.getElementById('ingredientes-container');
  const row = document.createElement('div');
  row.className = 'form-row';
  
  // 1) Construimos el <select> de productos
  const opcionesProductos = almacenData
    .map(p => `<option value="${p.codigo}">${p.name} ${p.active === false ? '(Inactivo)' : ''}</option>`)
    .join('');
  
  row.innerHTML = `
    <select class="form-select producto-select">
      <option value="">-- Seleccione --</option>
      ${opcionesProductos}
    </select>
    <input class="form-input cantidad-input" type="number" min="0.1" step="0.1" value="${item.cantidad || 1}" placeholder="Cant">
    <select class="form-select unidad-select">
      <option value="">-- Unidad --</option>
      <!-- Aquí iremos inyectando dinámicamente -->
    </select>
    <button class="btn btn-icon btn-danger" onclick="this.parentNode.remove()">
      <i class="fas fa-times"></i>
    </button>
  `;
  
  // 2) Referencias a los selects y al input
  const productoSelect = row.querySelector('.producto-select');
  const unidadSelect   = row.querySelector('.unidad-select');
  const cantidadInput  = row.querySelector('.cantidad-input');
  
  // 3) Función para poblar las unidades según productInfo
  function poblarUnidades(codigoProducto, unidadInicial = '') {
    unidadSelect.innerHTML = ''; 
    if (!codigoProducto || !productInfo[codigoProducto]) {
      unidadSelect.innerHTML = `<option value="">-- Unidad --</option>`;
      return;
    }
    const opciones = productInfo[codigoProducto].opcionesUnidad;
    unidadSelect.innerHTML = opciones
      .map(u => `<option value="${u}"${u === unidadInicial ? ' selected' : ''}>${u}</option>`)
      .join('');
  }
  
  // 4) Cuando cambie el producto, actualizamos unidades
  productoSelect.addEventListener('change', () => {
    poblarUnidades(productoSelect.value);
  });
  
  // 5) Si estamos en modo edición (item trae código y unidad), preseleccionamos
  if (item.codigo) {
    productoSelect.value = item.codigo;
    poblarUnidades(item.codigo, item.unidad);
    cantidadInput.value = item.cantidad || 1;
  }
  
  cont.appendChild(row);
}

function limpiarForm() {
  editMode = false;
  document.getElementById('receta-codigo').value = '';
  document.getElementById('receta-nombre').value = '';
  document.getElementById('receta-categoria').selectedIndex = 0;
  document.getElementById('receta-imagen').value = '';
  document.getElementById('ingredientes-container').innerHTML = '';
}

// FILTROS RECETAS
function applyRecetasFilters() {
  const search = document.getElementById('filter-recetas-search').value.toLowerCase();
  const category = document.getElementById('filter-recetas-category').value;
  const status = document.getElementById('filter-recetas-status').value;

  recetasFilters = { search, category, status };

  filteredRecetas = recetasData.filter(r => {
    if (search && !r.nombre.toLowerCase().includes(search) && !String(r.codigo).includes(search)) {
      return false;
    }
    if (category && r.categoria !== category) {
      return false;
    }
    if (status) {
      let hasInactive = r.ingredientes.some(ing => {
        const p = almacenData.find(prod => prod.codigo == ing.codigo);
        return p && p.active === false;
      });
      if (status === 'active' && hasInactive) return false;
      if (status === 'inactive' && !hasInactive) return false;
    }
    return true;
  });

  const filterCount = Object.values(recetasFilters).filter(f => f).length;
  document.getElementById('filter-recetas-indicator').textContent = filterCount;

  mostrarRecetas();
}

function resetRecetasFilters() {
  document.getElementById('filter-recetas-search').value = '';
  document.getElementById('filter-recetas-category').value = '';
  document.getElementById('filter-recetas-status').value = '';
  recetasFilters = {};
  filteredRecetas = [];
  document.getElementById('filter-recetas-indicator').textContent = '0';
  mostrarRecetas();
}

// TOGGLE FILTROS
function toggleFilter(section) {
  const controls = document.getElementById(`filter-${section}-controls`);
  const icon = document.getElementById(`filter-${section}-icon`);
  
  if (controls.style.display === 'none' || controls.style.display === '') {
    controls.style.display = 'grid';
    icon.className = 'fas fa-chevron-up';
  } else {
    controls.style.display = 'none';
    icon.className = 'fas fa-chevron-down';
  }
}




// FUNCIÓN PARA EDITAR COMPRA
function openEditCompraModal(c) {
  const prod = almacenData.find(x => x.codigo == c.idProducto);
  const info = productInfo[c.idProducto];

  // Precio unitario histórico = total guardado / cantidad
  const precioUnitarioGuardado = Number(c.precio) / Number(c.cantidad);
  const totalInicial = Number(c.precio).toFixed(2);

  const card = document.createElement('div');
  card.className = 'card fade-in';
  card.innerHTML = `
    <div class="card-header">Detalle de Compra #${c.idCompra}</div>
    <div class="card-body">
      <div class="card-row">
        <div class="card-label">Producto</div>
        <div class="card-value">${prod.name}</div>
      </div>
      <div class="card-row">
        <div class="card-label">Fecha</div>
        <div class="card-value">
          <input type="date" class="form-input"
                 id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}">
        </div>
      </div>
      <div class="card-row">
        <div class="card-label">Cantidad</div>
        <div class="card-value">
          <input type="number" class="form-input"
                 id="qty-${c.idCompra}" value="${c.cantidad}"
                 min="0" step="0.1"
                 oninput="recalcEditTotal('${c.idCompra}', ${precioUnitarioGuardado})">
        </div>
      </div>
      <div class="card-row">
        <div class="card-label">Unidad</div>
        <div class="card-value">
          <select class="form-select" id="unit-${c.idCompra}" disabled>
            ${info.opcionesUnidad.map(u =>
              `<option value="${u}"${u === c.unidad ? ' selected' : ''}>${u}</option>`
            ).join('')}
          </select>
        </div>
      </div>
      <div class="card-row">
        <div class="card-label">Precio unitario histórico</div>
        <div class="card-value">$${precioUnitarioGuardado.toFixed(2)}</div>
      </div>
      <div class="card-row">
        <div class="card-label">Total</div>
        <div class="card-value" id="total-${c.idCompra}">$${totalInicial}</div>
      </div>
      <div class="div2">
        <button class="btn btn-primary"
                onclick="saveCompra('${c.idCompra}','${c.idProducto}', true)">
          <i class="fas fa-save"></i> Guardar
        </button>
        <button class="btn btn-danger"
                onclick="deleteCompra('${c.idCompra}','${c.idProducto}')">
          <i class="fas fa-trash"></i> Eliminar
        </button>
      </div>
    </div>`;
  modal.show({ title: 'Editar Compra', message: card.innerHTML });
}

// FUNCIÓN PARA RECALCULAR TOTAL AL EDITAR COMPRA
function recalcEditTotal(idC, precioUnitarioGuardado) {
  const qty = parseFloat(document.getElementById(`qty-${idC}`).value) || 0;
  document.getElementById(`total-${idC}`).textContent =
    `$${(precioUnitarioGuardado * qty).toFixed(2)}`;
}

// GUARDAR Y ELIMINAR COMPRA
async function saveCompra(idC, idP, isEdit = false) {
  const qty = parseFloat(document.getElementById(`qty-${idC}`).value) || 0;
  if (qty <= 0) return showAlert('La cantidad debe ser mayor que cero');
  const fecha = document.getElementById(`date-${idC}`).value;
  const uni = document.getElementById(`unit-${idC}`).value;

  let precioUnitario;
  if (isEdit) {
    // Sacamos precio histórico de comprasData
    const original = comprasData.find(c =>
      c.idCompra == idC && c.idProducto == idP
    );
    precioUnitario = Number(original.precio) / Number(original.cantidad);
  } else {
    // Compra nueva: precio actual * factor
    precioUnitario = productInfo[idP].priceBase * FACTORES[uni];
  }

  const total = (precioUnitario * qty).toFixed(2);

  await postOpNotify('guardarCompras', {
    idCompra: idC,
    idProducto: idP,
    fecha,
    cantidad: qty,
    unidad: uni,
    name: almacenData.find(x => x.codigo == idP).name,
    precio: total  // guardamos el total bajo la clave 'precio'
  }, 'Compra guardada');

  await loadData();
}

async function deleteCompra(idC, idP) {
  const ok = await showConfirm(`¿Eliminar compra ${idC}?`);
  if (!ok) return;
  await postOpNotify('eliminarCompras', {
    idCompra: idC,
    idProducto: idP
  }, 'Compra eliminada');
  await loadData();
}

// FUNCIÓN PARA EXPORTAR BALANCES
function exportarBalances() {
  const modalContent = document.createElement('div');
  modalContent.innerHTML = `
    <div style="text-align: center; padding: 20px;">
      <h3>Exportar Balances</h3>
      <p>Seleccione el formato de exportación:</p>
      <div class="export-options">
        <div class="export-option pdf" onclick="exportarBalancesPDF()">
          <i class="fas fa-file-pdf"></i>
          <span>PDF</span>
        </div>
        <div class="export-option csv" onclick="exportarBalancesCSV()">
          <i class="fas fa-file-csv"></i>
          <span>CSV</span>
        </div>
      </div>
    </div>
  `;
  
  modal.show({
    title: 'Exportar Balances',
    message: modalContent.innerHTML
  });
}

function exportarBalancesPDF() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    return showAlert('La librería jsPDF no está cargada.');
  }
  const { jsPDF } = window.jspdf;
  const dataToRender = filteredBalances.length ? filteredBalances : balancesData;
  const doc = new jsPDF();
  let y = 20;

  // Encabezado
  doc.setFontSize(16);
  doc.text('Reporte de Balances', 105, 15, null, null, 'center');
  
  // Fecha y filtros
  doc.setFontSize(10);
  doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 10, y);
  y += 10;
  doc.text(`Filtro de pago: ${currentPaymentFilter}`, 10, y);
  y += 10;
  
  // Cabecera de tabla
  doc.setFillColor(60, 120, 216);
  doc.setTextColor(255);
  doc.rect(10, y, 190, 10, 'F');
  doc.text('ID', 15, y + 7);
  doc.text('Especificación', 40, y + 7);
  doc.text('Categoría', 100, y + 7);
  doc.text('Tipo', 140, y + 7);
  doc.text('Estado', 160, y + 7);
  doc.text('Monto', 180, y + 7);
  y += 12;
  
  // Restaurar colores
  doc.setTextColor(0);
  doc.setFontSize(10);
  
  // Filas
  dataToRender.forEach(b => {
    if (y > 280) {
      doc.addPage();
      y = 20;
    }
    
    doc.text(b.codigo, 15, y);
    doc.text(b.especificacion || '-', 40, y, { maxWidth: 55 });
    doc.text(b.categoria || '-', 100, y, { maxWidth: 35 });
    doc.text(b.tipo, 140, y);
    doc.text(b.estado, 160, y);
    doc.text(`$${parseFloat(b.monto).toFixed(2)}`, 180, y);
    y += 10;
  });
  
  // Totales
  y += 10;
  doc.setFontSize(12);
  doc.text(`Total Ventas: $${calculateSalesTotal(currentPaymentFilter).toFixed(2)}`, 10, y);
  y += 10;
  doc.text(`Total Otros Ingresos: $${document.getElementById('total-otros-ingresos').textContent.replace('$', '')}`, 10, y);
  y += 10;
  doc.text(`Total Gastos: $${document.getElementById('total-gastos').textContent.replace('$', '')}`, 10, y);
  y += 10;
  doc.text(`Total Compras: $${document.getElementById('total-gastos-inventario').textContent.replace('$', '')}`, 10, y);
  y += 10;
  doc.text(`Total Neto: $${document.getElementById('total-neto').textContent.replace('$', '')}`, 10, y);
  y += 10;
  doc.text(`Saldo con Almacén: ${document.getElementById('total-almacen').textContent}`, 10, y);
  
  // Guardar PDF
  doc.save(`balances_${new Date().toISOString().slice(0,10)}.pdf`);
}

function exportarBalancesCSV() {
  const dataToRender = filteredBalances.length ? filteredBalances : balancesData;
  
  // Cabecera CSV
  let csv = 'ID,Especificación,Categoría,Tipo,Estado,Monto\n';
  
  // Filas de datos
  dataToRender.forEach(b => {
    csv += `"${b.codigo}","${b.especificacion || ''}","${b.categoria || ''}",`;
    csv += `"${b.tipo}","${b.estado}",${b.monto}\n`;
  });
  
  // Totales
  csv += '\n';
  csv += `Total Ventas,${calculateSalesTotal(currentPaymentFilter).toFixed(2)}\n`;
  csv += `Otros Ingresos,${document.getElementById('total-otros-ingresos').textContent.replace('$', '')}\n`;
  csv += `Gastos,${document.getElementById('total-gastos').textContent.replace('$', '')}\n`;
  csv += `Compras,${document.getElementById('total-gastos-inventario').textContent.replace('$', '')}\n`;
  csv += `Neto,${document.getElementById('total-neto').textContent.replace('$', '')}\n`;
  csv += `Saldo con Almacén,${document.getElementById('total-almacen').textContent.replace('$', '').replace('-', '-')}\n`;
  
  // Crear blob y descargar
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `balances_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 100);
}

// CARGA GENERAL - CORREGIDO
async function loadData() {
  const [alm, comp, vent, coc, bal] = await Promise.all([
    callApi({op:'obtenerAlmacen'}),
    callApi({op:'obtenerCompras'}),
    callApi({op:'obtenerVentas'}),
    callApi({op:'obtenerCocina'}),
    callApi({op:'obtenerBalances'})
  ]);
  
  if (alm.status === 'success') almacenData = alm.data;
  if (comp.status === 'success') comprasData = comp.data;
  if (vent.status === 'success') ventData = vent.data;
  
  if (coc.status === 'success') {
    cocData = coc.data.map(r => ({
      ...r,
      ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : r.ingredientes
    }));
  }
  
  if (bal.status === 'success') {
    balancesData = bal.data;
  }
  
  buildProductInfo();
  renderStockTable();
  renderComprasTable();
  await cargarVentas();
  await cargarRecetas();
  renderBalancesTable();
  updateTopStats();
  updateBalancesSummary();
  updateStockInsights();
}

// Inicialización
window.onload = async () => {
  resetForm();
  document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
  
  // Ocultar todos los paneles de filtros al inicio
  document.querySelectorAll('.filter-controls').forEach(el => {
    el.style.display = 'none';
  });
  
  await loadData();
};
</script>
</body>
</html>
