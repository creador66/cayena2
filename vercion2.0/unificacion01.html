<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ModernStock | Gestión de Almacén</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* RESET Y VARIABLES */
    *, *::before, *::after { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    
    :root {
      --primary: #2d3748;
      --secondary: #4a5568;
      --accent: #4299e1;
      --accent-light: #63b3ed;
      --success: #48bb78;
      --warning: #ed8936;
      --danger: #e53e3e;
      --text: #e2e8f0;
      --text-light: #a0aec0;
      --bg: #1a202c;
      --card-bg: #2d3748;
      --border: #4a5568;
      --radius: 12px;
      --transition: .3s ease;
      --shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      min-height: 100vh;
      line-height: 1.6;
    }
    
    /* BARRA LATERAL */
    .sidebar {
      width: 250px;
      background: var(--primary);
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      transition: var(--transition);
      box-shadow: var(--shadow);
      z-index: 10;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 1rem 2rem;
      border-bottom: 1px solid var(--border);
      margin-bottom: 1.5rem;
    }
    
    .logo i {
      font-size: 2rem;
      color: var(--accent);
    }
    
    .logo h1 {
      font-size: 1.5rem;
      font-weight: 600;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      -webkit-text-fill-color: transparent;
    }
    
    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      flex-grow: 1;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0.8rem 1.2rem;
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text-light);
      transition: var(--transition);
    }
    
    .nav-item:hover, .nav-item.active {
      background: rgba(66, 153, 225, 0.15);
      color: var(--text);
    }
    
    .nav-item i {
      width: 24px;
      text-align: center;
    }
    
    .nav-item.active {
      color: var(--accent);
    }
    
    .nav-footer {
      margin-top: auto;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0.8rem;
      background: rgba(74, 85, 104, 0.4);
      border-radius: var(--radius);
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    
    /* CONTENIDO PRINCIPAL */
    .main-content {
      flex-grow: 1;
      padding: 2rem;
      overflow-y: auto;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    .header h2 {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text);
    }
    
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .stat-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      transition: var(--transition);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .stat-title {
      color: var(--text-light);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .icon-blue { background: rgba(66, 153, 225, 0.2); color: var(--accent); }
    .icon-green { background: rgba(72, 187, 120, 0.2); color: var(--success); }
    .icon-orange { background: rgba(237, 137, 54, 0.2); color: var(--warning); }
    .icon-red { background: rgba(229, 62, 62, 0.2); color: var(--danger); }
    
    .stat-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    
    .stat-change {
      font-size: 0.85rem;
      color: var(--success);
    }
    
    /* TARJETAS DE CONTENIDO */
    .content-section {
      margin-bottom: 2.5rem;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .section-header h3 {
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .card {
        overflow-y: auto;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }
    
    /* TABLAS */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      background: rgba(45, 55, 72, 0.7);
    }
    
    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    th {
      background: rgba(74, 85, 104, 0.5);
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }
    
    tr:hover {
      background: rgba(74, 85, 104, 0.3);
    }
    
    /* BOTONES */
    button {
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 0.7rem 1.2rem;
      cursor: pointer;
      transition: var(--transition);
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }
    
    button:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }
    
    .delete-btn { 
      background: var(--danger); 
    }
    
    .delete-btn:hover { 
      background: #c53030; 
    }
    
    .success-btn {
      background: var(--success);
    }
    
    .success-btn:hover {
      background: #38a169;
    }
    
    /* ENTRADAS */
    input, select {
      background: rgba(74, 85, 104, 0.4);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.7rem 1rem;
      color: var(--text);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.3);
    }
    
    input.small { width: 5rem; }
    input.qty   { width: 4rem; margin-right: .5rem; }
    
    /* NIVELES DE STOCK */
    .nivel-1 { background: rgba(229, 62, 62, 0.1); } 
    .nivel-2 { background: rgba(237, 137, 54, 0.1); } 
    .nivel-3 { background: rgba(72, 187, 120, 0.1); } 
    .nivel-4 { background: rgba(66, 153, 225, 0.1); } 
    
    /* RESUMEN */
    .summary-panel {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      width: 280px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .summary-panel h2 {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--accent);
    }
    
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
    }
    
    .summary-item:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    /* VENTAS */
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }
    
    .list-panel, .form-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 1.5rem;
      box-shadow: var(--shadow);
    }
    
    .tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .ticket-card {
      background: rgba(45, 55, 72, 0.7);
      border-radius: var(--radius);
      padding: 1rem;
      border: 1px solid var(--border);
      transition: var(--transition);
    }
    
    .ticket-card:hover {
      transform: translateY(-3px);
      border-color: var(--accent);
    }
    
    .ticket-header {
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--accent);
    }
    
    .ticket-item {
      padding: 0.3rem 0;
      font-size: 0.9rem;
    }
    
    .ticket-footer {
      font-weight: 600;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }
    
    .ticket-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .item-row {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      align-items: center;
    }
    
    .item-row select, .item-row input {
      flex: 1;
    }
    
    .form-title {
      margin-bottom: 1rem;
    }
    
    /* RESPONSIVIDAD */
    @media (max-width: 1200px) {
      .sidebar {
        width: 80px;
        padding: 1rem 0.5rem;
      }
      
      .logo h1, .nav-item span, .user-name, .user-role {
        display: none;
      }
      
      .logo {
        justify-content: center;
        padding-bottom: 1.5rem;
      }
      
      .nav-item {
        justify-content: center;
        padding: 0.8rem;
      }
      
      .user-info {
        justify-content: center;
      }
    }
    
    @media (max-width: 1024px) {
      .container {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        padding: 1rem;
      }
      
      .logo h1, .nav-item span, .user-name, .user-role {
        display: block;
      }
      
      .nav-links {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 0.3rem;
        margin-bottom: 1rem;
      }
      
      .nav-item {
        flex-grow: 1;
        justify-content: center;
      }
      
      .stats-row {
        grid-template-columns: 1fr;
      }
    }
    
    /* EFECTOS Y ANIMACIONES */
    .pulse {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.4); }
      70% { box-shadow: 0 0 0 10px rgba(66, 153, 225, 0); }
      100% { box-shadow: 0 0 0 0 rgba(66, 153, 225, 0); }
    }
    
    .fade-in {
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- BARRA LATERAL -->
  <div class="sidebar">
    <div class="logo">
      <i class="fas fa-warehouse"></i>
      <h1>ModernStock</h1>
    </div>
    
    <div class="nav-links">
      <a href="#" class="nav-item active">
        <i class="fas fa-boxes"></i>
        <span>Inventario</span>
      </a>
      <a href="#" class="nav-item">
        <i class="fas fa-shopping-cart"></i>
        <span>Compras</span>
      </a>
      <a href="#" class="nav-item">
        <i class="fas fa-cash-register"></i>
        <span>Ventas</span>
      </a>
      <a href="#" class="nav-item">
        <i class="fas fa-chart-line"></i>
        <span>Reportes</span>
      </a>
      <a href="#" class="nav-item">
        <i class="fas fa-cogs"></i>
        <span>Ajustes</span>
      </a>
    </div>
    
    <div class="nav-footer">
      <div class="user-info">
        <div class="user-avatar">JS</div>
        <div>
          <div class="user-name">John Smith</div>
          <div class="user-role">Administrador</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CONTENIDO PRINCIPAL -->
  <div class="main-content">
    <div class="header">
      <h2>Panel de Control</h2>
      <div class="search-box">
        <input type="text" placeholder="Buscar productos...">
        <button><i class="fas fa-search"></i> Buscar</button>
      </div>
    </div>
    
    <!-- ESTADÍSTICAS RÁPIDAS -->
    <div class="stats-row">
      <div class="stat-card fade-in">
        <div class="stat-header">
          <div class="stat-title">Productos en Stock</div>
          <div class="stat-icon icon-blue">
            <i class="fas fa-box"></i>
          </div>
        </div>
        <div class="stat-value">1,248</div>
        <div class="stat-change">+5.2% desde el mes pasado</div>
      </div>
      
      <div class="stat-card fade-in">
        <div class="stat-header">
          <div class="stat-title">Ventas del Mes</div>
          <div class="stat-icon icon-green">
            <i class="fas fa-chart-bar"></i>
          </div>
        </div>
        <div class="stat-value">$42,560</div>
        <div class="stat-change">+12.7% desde el mes pasado</div>
      </div>
      
      <div class="stat-card fade-in">
        <div class="stat-header">
          <div class="stat-title">Pedidos Pendientes</div>
          <div class="stat-icon icon-orange">
            <i class="fas fa-truck-loading"></i>
          </div>
        </div>
        <div class="stat-value">24</div>
        <div class="stat-change">-3 desde la semana pasada</div>
      </div>
      
      <div class="stat-card fade-in">
        <div class="stat-header">
          <div class="stat-title">Productos Bajos</div>
          <div class="stat-icon icon-red">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
        </div>
        <div class="stat-value">18</div>
        <div class="stat-change">Reabastecimiento necesario</div>
      </div>
    </div>
    
    <!-- SECCIÓN DE INVENTARIO -->
    <div class="content-section">
      <div class="section-header">
        <h3><i class="fas fa-boxes"></i> Inventario</h3>
        <button onclick="addNewProducto()"><i class="fas fa-plus"></i> Nuevo Producto</button>
      </div>
      
      <div class="card">
        <h2>Lista de Compras y Stock</h2>
        <table>
          <thead><tr>
            <th>Código</th><th>Nombre</th><th>Precio</th><th>Cant.</th><th>Unid.</th>
            <th>Stock Rec.</th><th>Proveedor</th><th>Acción</th>
            <th>Comprar</th><th>Comprado</th><th>Usado</th><th>Restante</th><th>Estado</th>
          </tr></thead>
          <tbody id="table-stock"></tbody>
        </table>
        <button onclick="addNewProducto()"><i class="fas fa-plus"></i> Nuevo Producto</button>
      </div>
    </div>
    
    <!-- SECCIÓN DE COMPRAS -->
    <div class="content-section">
      <div class="section-header">
        <h3><i class="fas fa-shopping-cart"></i> Compras</h3>
      </div>
      
      <div class="card">
        <h3>Historial de Compras</h3>
        <table>
          <thead><tr>
            <th>Fecha</th><th>Producto</th><th>Cant.</th><th>Unid.</th>
            <th>Total</th><th>Guardar</th><th>Eliminar</th>
          </tr></thead>
          <tbody id="table-compras"></tbody>
        </table>
      </div>
    </div>
    
    <!-- SECCIÓN DE VENTAS -->
    <div class="content-section">
      <div class="section-header">
        <h3><i class="fas fa-cash-register"></i> Ventas</h3>
      </div>
      
      <div class="container">
        <div class="list-panel">
          <h2>Tickets de Venta</h2>
          <button id="btn-cargar"><i class="fas fa-sync-alt"></i> Cargar Ventas</button>
          <div class="tickets-grid" id="tickets-grid"></div>
        </div>
        <div class="form-panel">
          <div>
            <h2 id="form-title">Nueva Venta</h2>
            <input type="hidden" id="form-id">
            <div class="item-row">
              <label style="flex:0 0 80px">Fecha:</label>
              <input type="date" id="form-fecha" style="flex:1">
            </div>
            <div id="items-container"></div>
            <button id="btn-add-item"><i class="fas fa-plus"></i> Agregar producto</button>
            <div class="item-row" style="margin-top:1rem;">
              <label style="flex:0 0 80px">Pago:</label>
              <select id="form-pago" style="flex:1">
                <option>Efectivo</option><option>Transferencia</option><option>Tarjeta</option>
              </select>
            </div>
            <div style="margin-top:1rem; display:flex; gap:.5rem;">
              <button id="btn-save" class="success-btn"><i class="fas fa-save"></i> Guardar</button>
              <button id="btn-cancel"><i class="fas fa-times"></i> Cancelar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- RESUMEN -->
    <div class="summary-panel">
      <h2><i class="fas fa-chart-pie"></i> Resumen de Pagos</h2>
      <div id="sum-efectivo" class="summary-item">Efectivo: 0.00</div>
      <div id="sum-transferencia" class="summary-item">Transferencia: 0.00</div>
      <div id="sum-tarjeta" class="summary-item">Tarjeta: 0.00</div>
      <hr>
      <div id="sum-total" class="summary-item">Total: 0.00</div>
    </div>

    <script>
      const API_URL = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
      const FACTORES = { mg:0.001,g:1,kg:1000,ml:1,l:1000,pz:1 };
      const MARGEN = 1.55;

      let almacenData = [], comprasData = [], ventData = [], cocData = [], recetas = [], productInfo = {};

      async function callApi(params) {
        const url = new URL(API_URL);
        Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
        return (await fetch(url)).json();
      }

      // UTILS STOCK/COMPRAS
      function categoriaDe(u){
        if(['mg','g','kg'].includes(u)) return ['mg','g','kg'];
        if(['ml','l'].includes(u)) return ['ml','l'];
        return ['pz'];
      }
      function humanizeComposite(b,c){
        if(c==='peso'){ const kg=Math.trunc(b/1000),g=b%1000,p=[];if(kg)p.push(`${kg} kg`);if(g)p.push(`${g} g`);return p.join(' ')||'0 g'; }
        if(c==='volumen'){ const l=Math.trunc(b/1000),m=b%1000,p=[];if(l)p.push(`${l} l`);if(m)p.push(`${m} ml`);return p.join(' ')||'0 ml'; }
        return `${b.toFixed(0)} pz`;
      }

      function buildProductInfo(){
        productInfo = {};
        almacenData.forEach(it=>{
          const cat = ['mg','g','kg'].includes(it.unidadDeMedida)?'peso': ['ml','l'].includes(it.unidadDeMedida)?'volumen':'conteo';
          const base = parseFloat(it.cantidad)*FACTORES[it.unidadDeMedida]||1;
          productInfo[it.codigo] = { priceBase:parseFloat(it.precio)/base||0, categoria:cat, opcionesUnidad:categoriaDe(it.unidadDeMedida) };
        });
      }

      function renderStockTable(){
        const tbody = document.getElementById('table-stock');
        const compMap={}, usedMap={};
        comprasData.forEach(c=> compMap[c.idProducto] = (compMap[c.idProducto]||0) + c.cantidad*FACTORES[c.unidad]);
        ventData.forEach(v=> v.venta.forEach(it=>{
          const rec = cocData.find(r=>String(r.codigo)===String(it.codigo));
          if(!rec) return;
          rec.ingredientes.forEach(ing=>{
            usedMap[ing.codigo] = (usedMap[ing.codigo]||0) + ing.cantidad*FACTORES[ing.unidad]*it.cantidad;
          });
        }));
        tbody.innerHTML = '';
        almacenData.forEach(it=>{
          const info = productInfo[it.codigo];
          const recBase = (parseFloat(it.stockRecomendado)||0)*FACTORES[it.unidadDeMedida];
          const bought = compMap[it.codigo]||0, used = usedMap[it.codigo]||0, remain = bought-used;
          const pct = recBase? remain/recBase*100:0;
          let nivel, cl;
          if(pct<=50){nivel=4;cl='nivel-1';}
          else if(pct<=80){nivel=3;cl='nivel-2';}
          else if(pct<=100){nivel=2;cl='nivel-3';}
          else{nivel=1;cl='nivel-4';}
          const delta = remain-recBase;
          const accion = delta<0? `ordenar ${humanizeComposite(-delta, info.categoria)}` : `sobrante ${humanizeComposite(delta, info.categoria)}`;
          const hB = humanizeComposite(bought,info.categoria), hU = humanizeComposite(used,info.categoria), hR = humanizeComposite(remain,info.categoria);
          const tB = (info.priceBase*bought).toFixed(0), tU = (info.priceBase*used).toFixed(0), tR = (info.priceBase*remain).toFixed(0);
          tbody.insertAdjacentHTML('beforeend',`
            <tr class="${cl}">
              <td>${it.codigo}</td>
              <td><input id="name-${it.codigo}" value="${it.name||''}"></td>
              <td><input type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></td>
              <td><input id="cant-${it.codigo}" value="${it.cantidad||0}" class="small"></td>
              <td><select id="unidad-${it.codigo}">${categoriaDe(it.unidadDeMedida).map(u=>`<option value="${u}"${u===it.unidadDeMedida?' selected':''}>${u}</option>`).join('')}</select></td>
              <td><input id="rec-${it.codigo}" value="${it.stockRecomendado||0}" class="small"></td>
              <td><input id="prov-${it.codigo}" value="${it.proveedor||''}"></td>
              <td>
                <button onclick="saveAlmacen('${it.codigo}')"><i class="fas fa-save"></i></button>
                <button class="delete-btn" onclick="deleteAlmacen('${it.codigo}')"><i class="fas fa-trash"></i></button>
              </td>
              <td>
                <input class="qty" id="buyqty-${it.codigo}" type="number" step=".01" value="1">
                <select id="buyunit-${it.codigo}">${info.opcionesUnidad.map(u=>`<option value="${u}">${u}</option>`).join('')}</select>
                <button onclick="buyProduct('${it.codigo}')"><i class="fas fa-shopping-cart"></i></button>
              </td>
              <td>${hB} ~ $${tB}</td>
              <td>${hU} ~ $${tU}</td>
              <td>${hR} ~ $${tR}</td>
              <td>- Nivel ${nivel} ${accion}</td>
            </tr>`);
        });
      }

      async function addNewProducto(){
        const code = Date.now();
        almacenData.push({ codigo:code, name:'', precio:0, cantidad:0, unidadDeMedida:'pz', stockRecomendado:0, proveedor:'' });
        buildProductInfo(); renderStockTable();
      }
      async function saveAlmacen(codigo){
        await callApi({
          op:'guardarAlmacen', codigo,
          name: document.getElementById(`name-${codigo}`).value,
          precio: document.getElementById(`precio-${codigo}`).value,
          cantidad: document.getElementById(`cant-${codigo}`).value,
          unidadDeMedida: document.getElementById(`unidad-${codigo}`).value,
          stockRecomendado: document.getElementById(`rec-${codigo}`).value,
          proveedor: document.getElementById(`prov-${codigo}`).value
        });
        loadData();
      }
      async function deleteAlmacen(codigo){
        if(!confirm('¿Eliminar producto?')) return;
        await callApi({ op:'eliminarAlmacen', codigo });
        loadData();
      }
      async function buyProduct(id){
        const info = productInfo[id];
        const qty  = parseFloat(document.getElementById(`buyqty-${id}`).value)||0;
        if(qty<=0) return alert('Cantidad inválida');
        const uni = document.getElementById(`buyunit-${id}`).value;
        const total = (info.priceBase*qty*FACTORES[uni]).toFixed(0);
        const fecha = new Date().toISOString().slice(0,10);
        await callApi({
          op:'guardarCompras', idProducto:id, fecha,
          name: almacenData.find(x=>x.codigo==id).name,
          precio: total, cantidad: qty, unidad: uni
        });
        loadData();
      }

      function renderComprasTable(){
        const tbody = document.getElementById('table-compras');
        tbody.innerHTML = '';
        comprasData.sort((a,b)=>new Date(b.fecha)-new Date(a.fecha)).forEach(c=>{
          const opts = productInfo[c.idProducto].opcionesUnidad.map(u=>`<option value="${u}"${u===c.unidad?' selected':''}>${u}</option>`).join('');
          tbody.insertAdjacentHTML('beforeend',`
            <tr>
              <td><input type="date" id="date-${c.idCompra}" value="${c.fecha.slice(0,10)}"></td>
              <td>${almacenData.find(x=>x.codigo==c.idProducto).name}</td>
              <td><input class="qty" id="qty-${c.idCompra}" type="number" step=".01" value="${c.cantidad}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')"></td>
              <td><select id="unit-${c.idCompra}" onchange="recalcCompra('${c.idCompra}','${c.idProducto}')">${opts}</select></td>
              <td><span id="total-${c.idCompra}"></span></td>
              <td><button onclick="saveCompra('${c.idCompra}','${c.idProducto}')"><i class="fas fa-save"></i></button></td>
              <td><button class="delete-btn" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')"><i class="fas fa-trash"></i></button></td>
            </tr>`);
          recalcCompra(c.idCompra,c.idProducto);
        });
      }
      function recalcCompra(idC,idP){
        const info = productInfo[idP];
        const qty  = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
        const uni  = document.getElementById(`unit-${idC}`).value;
        document.getElementById(`total-${idC}`).textContent = `$${(info.priceBase*qty*FACTORES[uni]).toFixed(2)}`;
      }
      async function saveCompra(idC,idP){
        const qty = parseFloat(document.getElementById(`qty-${idC}`).value)||0;
        if(qty<=0) return alert('Cantidad inválida');
        const uni = document.getElementById(`unit-${idC}`).value;
        const fecha = document.getElementById(`date-${idC}`).value;
        const total = (productInfo[idP].priceBase*qty*FACTORES[uni]).toFixed(0);
        await callApi({
          op:'guardarCompras', idCompra:idC, idProducto:idP,
          fecha, name: almacenData.find(x=>x.codigo==idP).name,
          precio:total, cantidad:qty, unidad:uni
        });
        loadData();
      }
      async function deleteCompra(idC,idP){
        if(!confirm('¿Eliminar compra?')) return;
        await callApi({ op:'eliminarCompras', idCompra:idC, idProducto:idP });
        loadData();
      }

      /* VENTAS */
      async function fetchRecetas(){
        const [almR,cocR] = await Promise.all([ callApi({op:'obtenerAlmacen'}), callApi({op:'obtenerCocina'}) ]);
        if(almR.status!=='success'||cocR.status!=='success') return;
        almacenData = almR.data; cocData = cocR.data;
        recetas = cocData.map(r=>{
          const costo = r.ingredientes.reduce((s,ing)=>{
            const p = almacenData.find(x=>String(x.codigo)===String(ing.codigo));
            if(!p) return s;
            const ua=FACTORES[p.unidadDeMedida], ui=FACTORES[ing.unidad];
            return s + (p.precio/(ua*parseFloat(p.cantidad)))*(ui*ing.cantidad);
          },0);
          return { codigo: r.codigo, nombre: r.nombre, precio: parseFloat((costo*MARGEN).toFixed(2)) };
        });
      }

      function crearItemRow(cod='',cant='',tot=''){
        const row=document.createElement('div'); row.className='item-row';
        const sel=document.createElement('select');
        recetas.forEach(r=>{ const o=document.createElement('option'); o.value=r.codigo; o.textContent=r.nombre; if(r.codigo===cod) o.selected=true; sel.append(o); });
        const ic=document.createElement('input'); ic.type='number'; ic.min='1'; ic.value=cant; ic.placeholder='Cantidad';
        const it=document.createElement('input'); it.type='number'; it.value=tot; it.placeholder='Total';
        const bd=document.createElement('button'); bd.type='button'; bd.textContent='−'; bd.className='delete-btn'; bd.onclick=()=>row.remove();
        function recalc(){ const p=recetas.find(x=>x.codigo===sel.value)||{precio:0}; const q=parseFloat(ic.value)||0; it.value=(p.precio*q).toFixed(2); }
        sel.onchange=recalc; ic.oninput=recalc;
        row.append(sel,ic,it,bd);
        return row;
      }

      function renderCard(v){
        const c=document.createElement('div'); c.className='ticket-card';
        const h=document.createElement('div'); h.className='ticket-header'; h.textContent=new Date(v.fecha).toISOString().slice(0,10);
        const m=document.createElement('div'); m.className='ticket-method'; m.textContent='Pago: '+(v.metodoPago||'—');
        const itemsDiv=document.createElement('div'); itemsDiv.className='ticket-items';
        v.venta.forEach(it=>{ const d=document.createElement('div'); d.className='ticket-item'; d.textContent=`${it.producto} x${it.cantidad} = ${it.total}`; itemsDiv.append(d); });
        const f=document.createElement('div'); f.className='ticket-footer'; const tot=v.venta.reduce((s,i)=>s+parseFloat(i.total||0),0).toFixed(2); f.textContent='Total: '+tot;
        const a=document.createElement('div'); a.className='ticket-actions';
        const be=document.createElement('button'), bd=document.createElement('button');
        be.textContent='Editar'; be.onclick=()=>startEdit(v);
        bd.textContent='Eliminar'; bd.className='delete-btn'; bd.onclick=async()=>{ await callApi({op:'eliminarVentas',id:v.id}); loadData(); };
        a.append(be,bd); c.append(h,m,itemsDiv,f,a);
        return c;
      }

      async function cargarVentas(){
        await fetchRecetas();
        const res=await callApi({op:'obtenerVentas'});
        if(res.status!=='success') return alert(res.message);
        ventData=res.data;
        const grid=document.getElementById('tickets-grid'); grid.innerHTML='';
        ventData.forEach(v=>grid.append(renderCard(v)));
        actualizarResumen(ventData);
      }

      function actualizarResumen(vs){
        let e=0,t=0,ta=0;
        vs.forEach(v=>{ const s=v.venta.reduce((a,i)=>a+parseFloat(i.total||0),0); if(v.metodoPago==='Efectivo') e+=s; else if(v.metodoPago==='Transferencia') t+=s; else if(v.metodoPago==='Tarjeta') ta+=s; });
        document.getElementById('sum-efectivo').textContent=`Efectivo: ${e.toFixed(2)}`;
        document.getElementById('sum-transferencia').textContent=`Transferencia: ${t.toFixed(2)}`;
        document.getElementById('sum-tarjeta').textContent=`Tarjeta: ${ta.toFixed(2)}`;
        document.getElementById('sum-total').textContent=`Total: ${(e+t+ta).toFixed(2)}`;
      }

      function startEdit(v){
        document.getElementById('form-id').value=v.id;
        document.getElementById('form-title').textContent='Editar Venta';
        document.getElementById('form-fecha').value=new Date(v.fecha).toISOString().slice(0,10);
        document.getElementById('form-pago').value=v.metodoPago;
        const cont=document.getElementById('items-container'); cont.innerHTML='';
        v.venta.forEach(it=>cont.append(crearItemRow(it.codigo,it.cantidad,it.total)));
      }

      function resetForm(){
        document.getElementById('form-id').value='';
        document.getElementById('form-title').textContent='Nueva Venta';
        document.getElementById('form-fecha').value=new Date().toISOString().slice(0,10);
        document.getElementById('form-pago').value='Efectivo';
        const cont=document.getElementById('items-container'); cont.innerHTML=''; cont.append(crearItemRow());
      }

      document.getElementById('btn-add-item').onclick = () => document.getElementById('items-container').append(crearItemRow());
      document.getElementById('btn-cargar').onclick    = () => loadData();
      document.getElementById('btn-save').onclick     = async () => {
        const id    = document.getElementById('form-id').value;
        const fecha = document.getElementById('form-fecha').value;
        if(!fecha) return alert('Fecha requerida');
        const metodo= document.getElementById('form-pago').value;
        const rows  = document.querySelectorAll('#items-container .item-row');
        if(rows.length===0) return alert('Agrega al menos un producto');
        const venta = Array.from(rows).map(r=>{
          const [sel,ic,it] = r.children;
          return {
            codigo: sel.value,
            producto: recetas.find(x=>x.codigo===sel.value).nombre,
            cantidad: Number(ic.value)||0,
            total: Number(it.value)||0
          };
        });
        const payload = { id, fecha, items: venta, metodoPago: metodo, venta };
        // Envío EXACTO del JSON de ejemplo
        const res = await callApi({ op:'guardarVentas', venta: JSON.stringify(payload) });
        if(res.status==='success'){
          resetForm();
          loadData();
        } else {
          alert('Error: '+res.message);
        }
      };
      document.getElementById('btn-cancel').onclick = resetForm;

      async function loadData(){
        const [alm,coc,vent,comp] = await Promise.all([
          callApi({op:'obtenerAlmacen'}),
          callApi({op:'obtenerCocina'}),
          callApi({op:'obtenerVentas'}),
          callApi({op:'obtenerCompras'})
        ]);
        if([alm,coc,vent,comp].some(r=>r.status!=='success')) return;
        almacenData=alm.data; cocData=coc.data; ventData=vent.data; comprasData=comp.data;
        buildProductInfo();
        renderStockTable();
        renderComprasTable();
        cargarVentas();
        resetForm();
      }

      window.onload = loadData;
    </script>
  </div>
</body>
</html>