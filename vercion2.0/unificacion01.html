<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Almac√©n y Compras ‚Äî IAEgoStock (filtro por estado)</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#e9eef6;
      --card:#f7fbff;
      --muted:#6b7280;
      --accent:#315bff;
      --accent-2:#2d8fff;
      --danger:#ff5b5b;
      --glass:rgba(255,255,255,0.6);
      --radius:14px;
      --soft-shadow:14px 14px 30px rgba(163,177,198,0.25), -8px -8px 20px rgba(255,255,255,0.85);
      --inset-shadow: inset 6px 6px 14px rgba(163,177,198,0.12), inset -6px -6px 14px rgba(255,255,255,0.8);
      --gap:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:linear-gradient(180deg,#e9eef6 0%, #f3f7fb 100%);color:#0f1724;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:14px;padding:12px;border-radius:14px;background:linear-gradient(180deg,var(--card),#f8fbff);box-shadow:var(--soft-shadow);border:1px solid rgba(255,255,255,0.6)}
    header i{color:transparent; background:linear-gradient(135deg,var(--accent),var(--accent-2)); -webkit-background-clip:text; background-clip:text; font-size:22px}
    header h1{font-size:1.05rem;margin:0;letter-spacing:-0.2px}
    .view-switch{margin-left:12px;display:flex;gap:8px}
    .view-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);cursor:pointer;background:linear-gradient(180deg,#fff,#f7fbff);box-shadow:var(--inset-shadow);font-weight:600}
    .view-btn.active{background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#fff;box-shadow:6px 8px 18px rgba(49,91,255,0.14), inset -2px -2px 6px rgba(255,255,255,0.04)}
    main{padding:0}
    .card{
      
      
      background: linear-gradient(180deg,#ffffff,#f6fbff); border-radius:12px; padding:12px; margin-bottom:12px; border:1px solid rgba(0,0,0,0.03); box-shadow:6px 8px 18px rgba(10,20,40,0.04); }
    .card-header{
      
      font-weight:700;margin-bottom:8px}
    .div2{display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background: linear-gradient(180deg,#fff,#f7fbff);cursor:pointer;font-weight:700;box-shadow:var(--inset-shadow)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background: linear-gradient(180deg,var(--accent),var(--accent-2)); color:#fff; border:none; box-shadow: 6px 8px 18px rgba(49,91,255,0.12), inset -2px -2px 6px rgba(255,255,255,0.04)}
    .btn-outline{background:transparent;border:1px solid rgba(16,24,40,0.06)}
    .btn-danger{background: linear-gradient(180deg,#ff6b6b,#ff5252); color:#fff; border:none}
    .list{display:flex;flex-direction:column;gap:10px}
    .list-item{
      display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.03);background:linear-gradient(180deg,#fff,#fbfeff);cursor:pointer;box-shadow:8px 10px 20px rgba(10,20,40,0.03);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .list-item:hover{transform:translateY(-4px); box-shadow: var(--soft-shadow)}
    .list-title{font-weight:700}
    .list-subtitle{font-size:13px;color:var(--muted); margin-top:4px}
    .status-badge{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .status-low{background:#fee2e2;color:#991b1b;border:1px solid rgba(153,27,27,0.06)}
    .status-medium{background:#fff7ed;color:#92400e;border:1px solid rgba(146,64,14,0.06)}
    .status-good{background:#ecfdf5;color:#065f46;border:1px solid rgba(6,95,70,0.06)}
    .status-excess{background:#eef2ff;color:#3730a3;border:1px solid rgba(55,48,163,0.06)}
    .no-results{text-align:center;padding:18px;color:var(--muted)}
    .form-input,.form-select{padding:10px;border-radius:10px;border:1px solid rgba(16,24,40,0.06);width:100%;background:linear-gradient(180deg,#fff,#f7fbff);outline:none;box-shadow: inset 4px 4px 10px rgba(163,177,198,0.05), inset -3px -3px 8px rgba(255,255,255,0.8)}
    .form-row{display:flex;gap:10px}
    .form-group{flex:1}
    .card-row{display:flex;justify-content:space-between;padding:10px 0;border-top:1px dashed rgba(16,24,40,0.04)}
    .card-row:first-of-type{border-top:0}
    .modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;background: linear-gradient(180deg, rgba(6,12,34,0.36), rgba(6,12,34,0.18)); z-index:9999}
    .modal-content{
      height: 500px;
      overflow-y: auto;
      background: linear-gradient(180deg,#f9fbff,#ffffff); border-radius:14px; max-width:760px; width:100%; padding:14px; border:1px solid rgba(255,255,255,0.6); box-shadow:var(--soft-shadow)}
    .insights{display:flex;gap:12px;flex-wrap:wrap}
    .insight-card{flex:1;padding:12px;border-radius:12px;background: linear-gradient(180deg,#fff,#fbfdff);border:1px solid rgba(0,0,0,0.03);cursor:pointer;box-shadow:6px 8px 18px rgba(10,20,40,0.02);transition:transform .12s,box-shadow .12s}
    .insight-card:hover{transform:translateY(-4px);box-shadow:var(--soft-shadow)}
    .insight-card.active{box-shadow:0 8px 30px rgba(45,88,255,0.12);border-color:rgba(45,88,255,0.12)}
    .insight-value{font-weight:800;font-size:20px}
    .insight-label{font-size:13px;color:var(--muted);margin-top:6px}
    .clear-filter{margin-left:8px;padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,#fff,#f7fbff);cursor:pointer}
    .muted{color:var(--muted)}
    @media(max-width:900px){
      .form-row{flex-direction:column}
      .insights{flex-direction:column}
      header{flex-direction:column;align-items:flex-start;gap:8px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <i class="fas fa-boxes-stacked" style="font-size:20px"></i>
      <h1>IAEgoStock ‚Äî Almac√©n & Compras</h1>

      <div class="view-switch" role="tablist" aria-label="Cambiar vista">
        <button id="btn-almacen" class="view-btn active"
                onclick="handle('view', currentView==='almacen' ? 'almacen' : 'almacen')">Almac√©n</button>
        <button id="btn-compras" class="view-btn"
                onclick="handle('view', currentView==='compras' ? 'compras' : 'compras')">Compras</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="whatsapp-btn" class="btn" onclick="handle('openWhatsapp')"><i class="fab fa-whatsapp"></i> Enviar por WhatsApp</button>
        <button class="btn btn-primary" onclick="handle('addProduct')"><i class="fas fa-plus"></i> Producto</button>
      </div>
    </header>

    <main>
      <!-- INSIGHTS (clickables para filtrar) -->
      <div class="card">
        <div class="card-header">Resumen r√°pido (haz click para filtrar)</div>
        <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
          <div class="insights" style="flex:1">
            <div id="insight-low" class="insight-card"
                 onclick="handle('filter', currentStockStatusFilter==='low' ? null : 'low')">
              <div class="insight-value" id="insight-count-low">0</div>
              <div class="insight-label">Bajo</div>
            </div>
            <div id="insight-medium" class="insight-card"
                 onclick="handle('filter', currentStockStatusFilter==='medium' ? null : 'medium')">
              <div class="insight-value" id="insight-count-medium">0</div>
              <div class="insight-label">Medio</div>
            </div>
            <div id="insight-good" class="insight-card"
                 onclick="handle('filter', currentStockStatusFilter==='good' ? null : 'good')">
              <div class="insight-value" id="insight-count-good">0</div>
              <div class="insight-label">Bueno</div>
            </div>
            <div id="insight-excess" class="insight-card"
                 onclick="handle('filter', currentStockStatusFilter==='excess' ? null : 'excess')">
              <div class="insight-value" id="insight-count-excess">0</div>
              <div class="insight-label">Excedente</div>
            </div>
          </div>

          <div style="min-width:260px;display:flex;flex-direction:column;gap:6px">
            <div>Productos totales: <strong><span id="insight-total-pieces">0</span></strong></div>
            <div>Valor inventario: <strong>$<span id="stat-inventory">0.00</span></strong></div>
            <div style="display:flex;align-items:center">
              <div style="margin-right:8px">Valor reposici√≥n:</div>
              <div><strong>$<span id="stat-restock">0.00</span></strong></div>
              <button class="clear-filter" onclick="handle('filter', null)" title="Quitar filtro" style="margin-left:auto">Quitar filtro</button>
            </div>
          </div>
        </div>
      </div>

      <!-- SECCI√ìN: ALMAC√âN (STOCK) -->
      <section id="seccion-almacen" class="card" aria-hidden="false">
        <div class="card-header">Almac√©n - Productos</div>
        <div class="card-body">
          <div id="stock-list" class="list"></div>
        </div>
      </section>

      <!-- SECCI√ìN: COMPRAS (oculta por defecto) -->
      <section id="seccion-compras" class="card" style="display:none" aria-hidden="true">
        <div class="card-header">Compras</div>
        <div class="card-body">
          <div id="compras-list" class="list"></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL REUTILIZABLE -->
  <div id="modal-backdrop" class="modal-backdrop" style="display:none;">
    <div class="modal-content">
      <div id="modal-header" class="modal-header"></div>
      <div id="modal-body" class="modal-body"></div>
      <div id="modal-footer" class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"></div>
    </div>
  </div>

<script>
/* -------------------- CONSTANTES Y ESTADO -------------------- */
const API_URL    = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
const FACTORES   = { mg:0.001, g:1, kg:1000, ml:1, l:1000, pz:1 };
const CATEGORIAS = { volumen:['ml','l'], peso:['mg','g','kg'], conteo:['pz'] };
const ALL_UNITS  = ['mg','g','kg','ml','l','pz'];

let almacenData = [], comprasData = [], ventData = [], cocData = [];
let productInfo = {};
let currentStockStatusFilter = null;
let currentView = 'almacen';

/* -------------------- MODAL -------------------- */
const modal = {
  backdrop: document.getElementById('modal-backdrop'),
  header:   document.getElementById('modal-header'),
  body:     document.getElementById('modal-body'),
  footer:   document.getElementById('modal-footer'),
  show: ({ title = '', message = '', confirm = false }) => new Promise(res => {
    modal.header.innerHTML = `<strong style="display:block;margin-bottom:8px">${title}</strong>`;
    modal.body.innerHTML   = message;
    modal.footer.innerHTML = '';
    const btnOk = document.createElement('button');
    btnOk.className = 'btn btn-primary';
    btnOk.textContent = 'OK';
    btnOk.onclick = () => (modal.backdrop.style.display = 'none', res(true));
    modal.footer.append(btnOk);
    if (confirm) {
      const btnCancel = document.createElement('button');
      btnCancel.className = 'btn btn-outline';
      btnCancel.textContent = 'Cancelar';
      btnCancel.onclick = () => (modal.backdrop.style.display = 'none', res(false));
      modal.footer.append(btnCancel);
    }
    modal.backdrop.style.display = 'flex';
  })
};
const showAlert   = msg => modal.show({ title: '¬°Atenci√≥n!', message: msg });
const showConfirm = msg => modal.show({ title: 'Confirma', message: msg, confirm: true });

/* -------------------- UTILIDADES FETCH -------------------- */
const callApi = params => {
  const url = new URL(API_URL);
  Object.entries(params).forEach(([k,v]) => url.searchParams.append(k,v));
  return fetch(url).then(r => r.json());
};
async function postOp(op, params = {}) {
  const fd = new FormData(); fd.append('op', op);
  Object.entries(params).forEach(([k,v]) => fd.append(k,v));
  const res = await fetch(API_URL, { method: 'POST', body: fd });
  const json = await res.json();
  if (json.status === 'success') return json.data;
  else throw new Error(json.message || 'Error API');
}
async function postOpNotify(op, params = {}, successTitle = '√âxito') {
  try {
    const data = await postOp(op, params);
    await modal.show({ title: successTitle, message: typeof data === 'string' ? data : JSON.stringify(data) });
    return data;
  } catch (err) {
    await modal.show({ title: 'Error', message: err?.message || String(err) });
    throw err;
  }
}

/* -------------------- UNIDADES / PRODUCT INFO -------------------- */
const categoriaDe = u =>
  ['mg','g','kg'].includes(u) ? 'peso'
: ['ml','l'].includes(u)    ? 'volumen'
:                             'conteo';

function buildProductInfo() {
  productInfo = {};
  almacenData.forEach(it => {
    const uni = (it.unidadDeMedida || '').trim().toLowerCase();
    const cat = categoriaDe(uni);
    const baseQty = (parseFloat(it.cantidad) || 0) * (FACTORES[uni] || 1);
    productInfo[it.codigo] = {
      priceBase: baseQty > 0 ? (parseFloat(it.precio) || 0) / baseQty : 0,
      categoria:  cat,
      opcionesUnidad: CATEGORIAS[cat] || ALL_UNITS,
      name: it.name || '',
      active: it.active !== false
    };
  });
}

function buscarRecetasConProducto(codigoProducto) {
  return (cocData || []).filter(receta =>
    Array.isArray(receta.ingredientes) && receta.ingredientes.some(ing => String(ing.codigo) === String(codigoProducto) && parseFloat(ing.cantidad) > 0)
  ).map(r => r.nombre || r.codigo);
}

function humanizeComposite(b, c) {
  const absB = Math.abs(Math.round(b));
  let result = '';
  if (c === 'peso') {
      const kg = Math.floor(absB / 1000);
      const g = absB % 1000;
      result = (kg ? kg + 'kg ' : '') + (g ? g + 'g' : '') || '0g';
  } else if (c === 'volumen') {
      const l = Math.floor(absB / 1000);
      const ml = absB % 1000;
      result = (l ? l + 'l ' : '') + (ml ? ml + 'ml' : '') || '0ml';
  } else {
      result = absB.toFixed(0) + 'pz';
  }
  return b < 0 ? '-' + result : result;
}

/* -------------------- CALCULOS Y ESTAD√çSTICAS -------------------- */
function computeMaps() {
  const compMap = {}, usedMap = {};
  (comprasData||[]).forEach(c =>
    compMap[c.idProducto] = (compMap[c.idProducto] || 0) + (Number(c.cantidad) || 0) * (FACTORES[c.unidad] || 1)
  );
  (ventData||[]).forEach(v => {
    (v.venta||[]).forEach(it => {
      const rec = (cocData||[]).find(r => String(r.codigo) === String(it.codigo));
      if (rec) rec.ingredientes.forEach(ing => {
        usedMap[ing.codigo] = (usedMap[ing.codigo] || 0) + (ing.cantidad || 0) * (FACTORES[ing.unidad] || 1) * (it.cantidad || 0);
      });
    });
  });
  return { compMap, usedMap };
}

function updateStockInsights() {
  const dataToRender = almacenData || [];
  document.getElementById('insight-total-pieces').textContent = dataToRender.length;

  const { compMap, usedMap } = computeMaps();

  let lowCount = 0, medCount = 0, goodCount = 0, excCount = 0;
  dataToRender.forEach(p => {
    const info = productInfo[p.codigo] || {};
    if (!info || info.active === false) return;
    const recBase = (parseFloat(p.stockRecomendado)||0) * (FACTORES[p.unidadDeMedida] || 1);
    const bought  = compMap[p.codigo] || 0;
    const used    = usedMap[p.codigo] || 0;
    const pct     = recBase ? ( (bought - used) / recBase ) * 100 : 0;
    if (pct <= 30)      lowCount++;
    else if (pct <= 50) medCount++;
    else if (pct <= 90) goodCount++;
    else                excCount++;
  });

  document.getElementById('insight-count-low').textContent    = lowCount;
  document.getElementById('insight-count-medium').textContent = medCount;
  document.getElementById('insight-count-good').textContent   = goodCount;
  document.getElementById('insight-count-excess').textContent = excCount;
}

/* -------------------- RENDER COMPRAS -------------------- */
function renderComprasTable() {
  const list = document.getElementById('compras-list');
  list.innerHTML = '';

  const dataToRender = (comprasData || []).slice().sort((a,b)=> new Date(b.fecha) - new Date(a.fecha));
  if (dataToRender.length === 0) {
    list.innerHTML = `<div class="no-results"><i class="fas fa-shopping-cart"></i><h3>No se encontraron compras</h3><p>Registra compras desde el producto.</p></div>`;
    return;
  }

  dataToRender.forEach(c => {
    const prod = almacenData.find(x => String(x.codigo) == String(c.idProducto));
    if (!prod) return;
    const totalGuardado = Number(c.precio).toFixed(2);
    // Incluyo onclick inline que pasa JSON con ternaria si fuera necesario
    const html = `
      <div class="list-item" onclick="handle('openCompra', { idCompra: '${c.idCompra || ''}', idProducto: '${c.idProducto || ''}' })">
        <div>
          <div class="list-title">${prod.name || ('#'+c.idProducto)}</div>
          <div class="list-subtitle">Compra #${c.idCompra || ''}</div>
          <div class="list-subtitle">${new Date(c.fecha).toLocaleDateString()}</div>
        </div>
        <div style="text-align:right">
          <div class="list-title">${c.cantidad || ''}${c.unidad || ''}</div>
          <div class="list-subtitle">$${totalGuardado}</div>
        </div>
      </div>
    `;
    list.insertAdjacentHTML('beforeend', html);
  });
}

/* -------------------- FILTRADO POR ESTADO -------------------- */
function setStockFilter(status) {
  if (currentStockStatusFilter === status) currentStockStatusFilter = null;
  else currentStockStatusFilter = status;
  ['low','medium','good','excess'].forEach(s => {
    const el = document.getElementById('insight-' + (s==='excess' ? 'excess' : s));
    if (!el) return;
    if (currentStockStatusFilter === s) el.classList.add('active'); else el.classList.remove('active');
  });
  renderStockTable();
}

function clearStockFilter() {
  currentStockStatusFilter = null;
  ['low','medium','good','excess'].forEach(s => {
    const el = document.getElementById('insight-' + (s==='excess' ? 'excess' : s));
    if (el) el.classList.remove('active');
  });
  renderStockTable();
}

/* -------------------- RENDER ALMAC√âN (con filtro) -------------------- */
function evaluateStatusForProduct(it, compMap, usedMap) {
  const info    = productInfo[it.codigo] || { categoria:'conteo', opcionesUnidad:ALL_UNITS, priceBase:0 };
  const recBase = (parseFloat(it.stockRecomendado) || 0) * (FACTORES[it.unidadDeMedida] || 1);
  const bought  = compMap[it.codigo] || 0;
  const used    = usedMap[it.codigo] || 0;
  const remain  = bought - used;
  const pct     = recBase ? (remain / recBase) * 100 : 0;
  const estado  = pct <= 30  ? 'low' : pct <= 50  ? 'medium' : pct <= 90  ? 'good' : 'excess';
  const estadoText = pct <= 30  ? 'üî¥ Bajo' : pct <= 50  ? 'üü† Medio' : pct <= 100 ? 'üü¢ Bueno' : 'üîµ Excedente';
  const delta   = recBase - remain;
  const accion  = delta > 0 ? `Ordenar ${humanizeComposite(delta, info.categoria)}` : `Sobrante ${humanizeComposite(-delta, info.categoria)}`;
  const valorReposicion = (Math.max(delta,0) * (info.priceBase || 0)).toFixed(2);
  return { info, recBase, bought, used, remain, pct, estado, estadoText, delta, accion, valorReposicion };
}

function renderStockTable() {
  const list = document.getElementById('stock-list');
  list.innerHTML = '';

  const { compMap, usedMap } = computeMaps();

  if (!almacenData || almacenData.length === 0) {
    list.innerHTML = `<div class="no-results"><i class="fas fa-box-open"></i><h3>No hay productos</h3><p>Agrega productos con "+ Producto"</p></div>`;
    return;
  }

  let anyShown = false;
  almacenData.forEach(it => {
    const { info, remain, estado, estadoText, accion, valorReposicion } = evaluateStatusForProduct(it, compMap, usedMap);

    // aplicar filtro si hay
    if (currentStockStatusFilter && currentStockStatusFilter !== estado) return;

    anyShown = true;
    const html = `
      <div class="list-item" onclick="handle('openProduct', { codigo: '${it.codigo}' })">
        <div>
          <div class="list-title">${it.name || 'Sin nombre'} ${it.active === false ? '<span class="status-badge" style="background:#f3f4f6;color:#6b7280">Inactivo</span>' : ''}</div>
          <div class="list-subtitle">#${it.codigo} | ${it.unidadDeMedida || ''}</div>
          <div class="list-subtitle">Restante: ${humanizeComposite(remain, info.categoria)}</div>
          <div class="list-subtitle">Estado: <span class="status-badge ${estado === 'low' ? 'status-low' : estado === 'medium' ? 'status-medium' : estado === 'good' ? 'status-good' : 'status-excess'}">${estadoText}</span></div>
          <div class="list-subtitle">${accion}</div>
        </div>
        <div style="text-align:right">
          <div class="list-title">$${(parseFloat(it.precio)||0).toFixed(2)}</div>
          <div class="list-subtitle">${it.proveedor || 'Sin proveedor'}</div>
          <div class="list-subtitle status-badge" style="background:#f8fafc">$ Rep: $${valorReposicion}</div>
        </div>
      </div>
    `;
    list.insertAdjacentHTML('beforeend', html);
  });

  if (!anyShown) {
    list.innerHTML = `<div class="no-results"><i class="fas fa-filter"></i><h3>No hay productos con ese estado</h3><p>Quita el filtro o selecciona otro estado</p></div>`;
  }
}

/* -------------------- CRUD ALMACEN -------------------- */
function openProductoModal(codigo) {
  const it = almacenData.find(p => String(p.codigo) === String(codigo));
  if (!it) return;
  const info = productInfo[codigo] || { opcionesUnidad: ALL_UNITS, categoria:'conteo', priceBase:0 };
  const enUso = buscarRecetasConProducto(codigo).length > 0;

  const html = `
    <div class="card-header">Detalle de Producto</div>
    <div class="card-body">
      <div class="card-row"><div class="card-label">C√≥digo</div><div class="card-value">#${it.codigo}</div></div>

      <div class="card-row">
        <div class="card-label">Precio</div>
        <div class="card-value"><input class="form-input" type="number" step=".01" id="precio-${it.codigo}" value="${it.precio||0}"></div>
      </div>

      <div class="card-row">
        <div class="card-label">Cantidad inicial</div>
        <div class="card-value"><input class="form-input" type="number" id="cant-${it.codigo}" value="${it.cantidad||0}"></div>
      </div>

      <div class="card-row">
        <div class="card-label">Unidad</div>
        <div class="card-value">
          <select class="form-select" id="unidad-${it.codigo}">
            ${(info.opcionesUnidad || ALL_UNITS).map(u => `<option value="${u}" ${u === it.unidadDeMedida ? 'selected' : ''}>${u}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="card-row">
        <div class="card-label">Stock recomendado</div>
        <div class="card-value"><input class="form-input" type="number" id="rec-${it.codigo}" value="${it.stockRecomendado||0}"></div>
      </div>

      <div class="card-row">
        <div class="card-label">Nombre</div>
        <div class="card-value"><input class="form-input" type="text" id="name-${it.codigo}" value="${it.name||''}"></div>
      </div>

      <div class="card-row">
        <div class="card-label">Proveedor</div>
        <div class="card-value"><input class="form-input" type="text" id="prov-${it.codigo}" value="${it.proveedor||''}"></div>
      </div>

      ${enUso ? `<div class="card-row"><div class="card-label">En uso en</div><div class="card-value"><div class="status-badge status-medium">${buscarRecetasConProducto(it.codigo).length} recetas</div></div></div>` : ''}

      <div class="form-row" style="margin-top:10px">
        <div class="form-group">
          <label class="form-label">Comprar cantidad</label>
          <input class="form-input" type="number" id="buyqty-${it.codigo}" value="1" min="0" step="0.1">
        </div>
        <div class="form-group">
          <label class="form-label">Unidad</label>
          <select class="form-select" id="buyunit-${it.codigo}">
            ${(info.opcionesUnidad || ALL_UNITS).map(u=>`<option value="${u}">${u}</option>`).join('')}
          </select>
        </div>
      </div>

      <div class="div2" style="margin-top:12px">
        <button class="btn btn-primary" onclick="handle('productAction', { cmd: 'buy', codigo: '${it.codigo}' })"><i class="fas fa-cart-plus"></i> Comprar</button>
        <button class="btn btn-primary" onclick="handle('productAction', { cmd: 'save', codigo: '${it.codigo}' })"><i class="fas fa-save"></i> Guardar</button>
        <button class="btn btn-danger" onclick="handle('productAction', { cmd: 'delete', codigo: '${it.codigo}' })"><i class="fas fa-trash"></i> Eliminar</button>
      </div>
    </div>
  `;
  modal.show({ title: 'Detalle de Producto', message: html });
}

async function addNewProducto() {
  const codigo = Date.now();
  almacenData.push({
    codigo,
    name:'Nuevo Producto',
    precio:0,
    cantidad:0,
    unidadDeMedida: '',
    stockRecomendado:0,
    proveedor:'',
    active: true
  });
  buildProductInfo();
  renderStockTable();
  updateStockInsights();
  setTimeout(()=> openProductoModal(codigo), 200);
}

async function saveAlmacen(codigo) {
  const name = document.getElementById(`name-${codigo}`)?.value.trim() || 'Nuevo Producto';
  await postOpNotify('guardarAlmacen', {
    codigo,
    name,
    precio: document.getElementById(`precio-${codigo}`).value,
    cantidad: document.getElementById(`cant-${codigo}`).value,
    unidadDeMedida: document.getElementById(`unidad-${codigo}`).value,
    stockRecomendado: document.getElementById(`rec-${codigo}`).value,
    proveedor: document.getElementById(`prov-${codigo}`).value
  }, 'Almac√©n actualizado');
  await loadData();
}

async function deleteAlmacen(codigo) {
  const recetasQueLoUsan = buscarRecetasConProducto(codigo);
  if (recetasQueLoUsan.length > 0) {
    const message = `<div>Este producto est√° en ${recetasQueLoUsan.length} recetas. Si contin√∫a se marcar√° como inactivo y su cantidad en recetas quedar√° en 0.</div><div style="margin-top:8px"><strong>Recetas:</strong><ul>${recetasQueLoUsan.map(r=>`<li>${r}</li>`).join('')}</ul></div>`;
    const ok = await showConfirm(message);
    if (!ok) return;
    for (const receta of cocData) {
      if (receta.ingredientes.some(ing => String(ing.codigo) === String(codigo))) {
        receta.ingredientes = receta.ingredientes.map(ing => String(ing.codigo) === String(codigo) ? { ...ing, cantidad: 0 } : ing);
        await postOp('guardarCocina', {
          codigo: receta.codigo,
          nombre: receta.nombre,
          categoria: receta.categoria || '',
          imagen: receta.imagen || '',
          ingredientes: JSON.stringify(receta.ingredientes)
        });
      }
    }
    const producto = almacenData.find(p => String(p.codigo) === String(codigo));
    if (producto) {
      producto.active = false;
      await postOpNotify('guardarAlmacen', {
        codigo,
        name: producto.name,
        precio: producto.precio,
        cantidad: producto.cantidad,
        unidadDeMedida: producto.unidadDeMedida,
        stockRecomendado: producto.stockRecomendado,
        proveedor: producto.proveedor,
        active: false
      }, 'Producto marcado como inactivo');
    }
  } else {
    const ok = await showConfirm(`¬øEliminar producto ${codigo}?`);
    if (!ok) return;
    await postOpNotify('eliminarAlmacen',{codigo},'Producto eliminado');
  }
  await loadData();
}

/* -------------------- COMPRAS (editar/guardar/eliminar) -------------------- */
function openEditCompraModal(c) {
  const prod = almacenData.find(x => String(x.codigo) == String(c.idProducto)) || {};
  const info = productInfo[c.idProducto] || { opcionesUnidad: ALL_UNITS };
  const precioUnitarioGuardado = (Number(c.precio) || 0) / (Number(c.cantidad) || 1);
  const totalInicial = (Number(c.precio) || 0).toFixed(2);

  const html = `
    <div class="card-header">Detalle de Compra #${c.idCompra || ''}</div>
    <div class="card-body">
      <div class="card-row"><div class="card-label">Producto</div><div class="card-value">${prod.name || ('#'+c.idProducto)}</div></div>
      <div class="card-row"><div class="card-label">Fecha</div><div class="card-value"><input type="date" class="form-input" id="date-${c.idCompra}" value="${(c.fecha||'').slice(0,10)}"></div></div>
      <div class="card-row"><div class="card-label">Cantidad</div><div class="card-value"><input type="number" class="form-input" id="qty-${c.idCompra}" value="${c.cantidad}" min="0" step="0.1" oninput="recalcEditTotal('${c.idCompra}', ${precioUnitarioGuardado})"></div></div>
      <div class="card-row"><div class="card-label">Unidad</div><div class="card-value"><select class="form-select" id="unit-${c.idCompra}" disabled>${(info.opcionesUnidad||ALL_UNITS).map(u=>`<option value="${u}" ${u===c.unidad?'selected':''}>${u}</option>`).join('')}</select></div></div>
      <div class="card-row"><div class="card-label">Precio unit.</div><div class="card-value">$${precioUnitarioGuardado.toFixed(2)}</div></div>
      <div class="card-row"><div class="card-label">Total</div><div class="card-value" id="total-${c.idCompra}">$${totalInicial}</div></div>
      <div class="div2" style="margin-top:8px">
        <button class="btn btn-primary" onclick="handle('saveCompra', { idCompra: '${c.idCompra}', idProducto: '${c.idProducto}', isEdit: true })"><i class="fas fa-save"></i> Guardar</button>
        <button class="btn btn-danger" onclick="handle('deleteCompra', { idCompra: '${c.idCompra}', idProducto: '${c.idProducto}' })"><i class="fas fa-trash"></i> Eliminar</button>
      </div>
    </div>
  `;
  modal.show({ title: 'Editar Compra', message: html });
}

function recalcEditTotal(idC, precioUnitarioGuardado) {
  const qty = parseFloat(document.getElementById(`qty-${idC}`)?.value) || 0;
  const el = document.getElementById(`total-${idC}`);
  if (el) el.textContent = `$${(precioUnitarioGuardado * qty).toFixed(2)}`;
}

async function saveCompra(idC, idP, isEdit = false) {
  const qty = parseFloat(document.getElementById(`qty-${idC}`).value) || 0;
  if (qty <= 0) return showAlert('La cantidad debe ser mayor que cero');
  const fecha = document.getElementById(`date-${idC}`).value;
  const uni = document.getElementById(`unit-${idC}`).value;

  let precioUnitario;
  if (isEdit) {
    const original = comprasData.find(c => String(c.idCompra) == String(idC) && String(c.idProducto) == String(idP));
    precioUnitario = Number(original.precio) / Number(original.cantidad || 1);
  } else {
    precioUnitario = (productInfo[idP]?.priceBase || 0) * (FACTORES[uni] || 1);
  }

  const total = (precioUnitario * qty).toFixed(2);

  await postOpNotify('guardarCompras', {
    idCompra: idC,
    idProducto: idP,
    fecha,
    cantidad: qty,
    unidad: uni,
    name: almacenData.find(x => String(x.codigo) == String(idP)).name,
    precio: total
  }, 'Compra guardada');

  await loadData();
}

async function deleteCompra(idC, idP) {
  const ok = await showConfirm(`¬øEliminar compra ${idC}?`);
  if (!ok) return;
  await postOpNotify('eliminarCompras', { idCompra: idC, idProducto: idP }, 'Compra eliminada');
  await loadData();
}

/* -------------------- WHATSAPP -> usa filtro activo -------------------- */
function getFilteredProductsForExport() {
  const { compMap, usedMap } = computeMaps();
  return (almacenData || []).map(it => {
    const { info, remain, estado, accion, valorReposicion } = evaluateStatusForProduct(it, compMap, usedMap);
    return {
      nombre: it.name,
      codigo: it.codigo,
      existencias: humanizeComposite(remain, (productInfo[it.codigo]||{}).categoria||'conteo'),
      estado,
      reponer: accion,
      valorReposicion
    };
  }).filter(p => {
    if (!currentStockStatusFilter) return true;
    return p.estado === currentStockStatusFilter;
  });
}

function solicitarNumeroWhatsApp() {
  const savedNumber = localStorage.getItem('whatsappNumber') || '';
  const modalContent = `
    <div style="padding:15px">
      <p>Ingrese el n√∫mero de tel√©fono (c√≥digo pa√≠s, sin espacios ni s√≠mbolos). Ej: 5215512345678</p>
      <input type="tel" id="whatsapp-number" class="form-input" placeholder="5215512345678" value="${savedNumber}" style="width:100%;margin-bottom:10px"/>
      <div style="display:flex;gap:8px">
        <button class="btn btn-primary" onclick="handle('sendWhatsapp')">Enviar</button>
        <button class="btn btn-outline" onclick="handle('closeModal')">Cancelar</button>
      </div>
    </div>
  `;
  modal.show({ title: 'Enviar por WhatsApp', message: modalContent }).then(()=>{});
  setTimeout(()=> {
    const input = document.getElementById('whatsapp-number');
    if (!input) return;
    input.addEventListener('input', ()=> localStorage.setItem('whatsappNumber', input.value.trim()));
  },100);
}

function enviarWhatsApp() {
  const numeroEl = document.getElementById('whatsapp-number');
  if (!numeroEl) return;
  const numero = numeroEl.value.trim();
  if (!numero) return showAlert('Por favor ingresa un n√∫mero de tel√©fono.');
  const datos = getFilteredProductsForExport();
  if (!datos.length) return showAlert('No hay productos para exportar con el filtro actual.');
  let texto = 'üìã *Lista de Compras ‚Äî IAEgoStock* üìã\n\n';
  texto += `*Fecha:* ${new Date().toLocaleDateString()}\n`;
  texto += currentStockStatusFilter ? `*Filtro:* ${currentStockStatusFilter.toUpperCase()}\n` : '';
  texto += `*Productos listados:* ${datos.length}\n\n`;
  datos.forEach((prod, index) => {
    texto += `*${index+1}. ${prod.nombre}*\n`;
    texto += `   üî¢ C√≥digo: ${prod.codigo}\n`;
    texto += `   üü° Estado: ${prod.estado}\n`;
    texto += `   üì¶ Cantidad a reponer: ${prod.reponer}\n`;
    texto += `   üí∞ Valor reposici√≥n: $${prod.valorReposicion}\n\n`;
  });
  const totalReposicion = datos.reduce((s,p)=> s + parseFloat(p.valorReposicion || 0), 0).toFixed(2);
  texto += `*TOTAL REPOSICI√ìN:* $${totalReposicion}\n\n`;
  const textoCodificado = encodeURIComponent(texto);
  const url = `https://wa.me/${numero}?text=${textoCodificado}`;
  const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel='noopener noreferrer'; document.body.appendChild(a); a.click(); a.remove();
  modal.backdrop.style.display = 'none';
}

/* -------------------- VISTA (Almac√©n / Compras) -------------------- */
function cambiarVista(v) {
  const almEl = document.getElementById('seccion-almacen');
  const compEl = document.getElementById('seccion-compras');
  const btnAlm = document.getElementById('btn-almacen');
  const btnComp = document.getElementById('btn-compras');

  if (v === 'compras') {
    almEl.style.display = 'none';
    almEl.setAttribute('aria-hidden','true');
    compEl.style.display = 'block';
    compEl.setAttribute('aria-hidden','false');
    btnAlm.classList.remove('active');
    btnComp.classList.add('active');
  } else {
    compEl.style.display = 'none';
    compEl.setAttribute('aria-hidden','true');
    almEl.style.display = 'block';
    almEl.setAttribute('aria-hidden','false');
    btnComp.classList.remove('active');
    btnAlm.classList.add('active');
  }
}

/* -------------------- CARGA GENERAL -------------------- */
async function loadData() {
  try {
    const [alm, comp, vent, coc] = await Promise.all([
      callApi({op:'obtenerAlmacen'}),
      callApi({op:'obtenerCompras'}),
      callApi({op:'obtenerVentas'}),
      callApi({op:'obtenerCocina'})
    ]);
    if (alm.status === 'success') almacenData = alm.data || [];
    if (comp.status === 'success') comprasData = comp.data || [];
    if (vent.status === 'success') ventData = vent.data || [];
    if (coc.status === 'success') {
      cocData = (coc.data || []).map(r => ({ ...r, ingredientes: typeof r.ingredientes === 'string' ? JSON.parse(r.ingredientes) : (r.ingredientes || []) }));
    }
    buildProductInfo();
    renderStockTable();
    renderComprasTable();
    updateTopStats();
    updateStockInsights();
  } catch (err) {
    console.error('Error loadData', err);
    showAlert('Error cargando datos: ' + (err.message || err));
  }
}

/* -------------------- ESTAD√çSTICAS TOP -------------------- */
function updateTopStats() {
  const { compMap, usedMap } = computeMaps();

  let totalInventoryValue = 0;
  let totalRestockValue   = 0;

  (almacenData || []).forEach(it => {
    const info = productInfo[it.codigo] || {};
    const bought = compMap[it.codigo] || 0;
    const used   = usedMap[it.codigo] || 0;
    const remain = bought - used;
    const recBase = (parseFloat(it.stockRecomendado) || 0) * (FACTORES[it.unidadDeMedida] || 1);
    const toRestock = Math.max(recBase - remain, 0);
    let priceBase = Number(info.priceBase || 0);
    if (!priceBase) {
      const qty = (parseFloat(it.cantidad) || 1) * (FACTORES[it.unidadDeMedida] || 1);
      priceBase = qty > 0 ? (parseFloat(it.precio) || 0) / qty : 0;
    }
    totalInventoryValue += (remain * priceBase);
    totalRestockValue   += (toRestock * priceBase);
  });

  const invEl = document.getElementById('stat-inventory');
  const restEl = document.getElementById('stat-restock');
  const totalPiecesEl = document.getElementById('insight-total-pieces');

  if (invEl)  invEl.textContent  = Number(totalInventoryValue || 0).toFixed(2);
  if (restEl) restEl.textContent = Number(totalRestockValue || 0).toFixed(2);
  if (totalPiecesEl) totalPiecesEl.textContent = (almacenData || []).length;
}

/* -------------------- BUY PRODUCT (implementaci√≥n) -------------------- */
async function buyProduct(codigo) {
  const qty = parseFloat(document.getElementById(`buyqty-${codigo}`)?.value) || 0;
  if (qty <= 0) return showAlert('La cantidad a comprar debe ser mayor que cero');
  const unidad = document.getElementById(`buyunit-${codigo}`)?.value || '';
  // intentar usar priceBase si existe, si no c√°lculo fallback
  const info = productInfo[codigo] || {};
  let precioUnitarioBase = info.priceBase || 0;
  if (!precioUnitarioBase) {
    const producto = almacenData.find(p=>String(p.codigo)===String(codigo)) || {};
    const qtyBase = (parseFloat(producto.cantidad) || 1) * (FACTORES[producto.unidadDeMedida] || 1);
    precioUnitarioBase = qtyBase>0? (parseFloat(producto.precio) || 0) / qtyBase : 0;
  }
  const precioUnitario = precioUnitarioBase * (FACTORES[unidad] || 1);
  const total = (precioUnitario * qty).toFixed(2);
  const idCompra = 'c' + Date.now();
  await postOpNotify('guardarCompras', {
    idCompra,
    idProducto: codigo,
    fecha: (new Date()).toISOString(),
    cantidad: qty,
    unidad,
    name: almacenData.find(x => String(x.codigo) == String(codigo)).name,
    precio: total
  }, 'Compra registrada');
  await loadData();
}

/* -------------------- HANDLER GENERICO (onclick ternarias/json) -------------------- */
function handle(action, payload) {
  try {
    switch(action) {
      case 'view':
        currentView = payload || 'almacen';
        cambiarVista(currentView);
        break;

      case 'filter':
        payload === null ? clearStockFilter() : setStockFilter(payload);
        break;

      case 'addProduct':
        addNewProducto();
        break;

      case 'openWhatsapp':
        solicitarNumeroWhatsApp();
        break;

      case 'openProduct':
        if (payload && payload.codigo != null) openProductoModal(String(payload.codigo));
        break;

      case 'productAction':
        if (!payload || !payload.cmd) break;
        if (payload.cmd === 'save') saveAlmacen(payload.codigo);
        else if (payload.cmd === 'delete') deleteAlmacen(payload.codigo);
        else if (payload.cmd === 'buy') buyProduct(payload.codigo);
        break;

      case 'openCompra':
        if (payload && payload.idCompra) {
          const compra = comprasData.find(c=>String(c.idCompra)===String(payload.idCompra) && String(c.idProducto)===String(payload.idProducto));
          if (compra) openEditCompraModal(compra);
        }
        break;

      case 'saveCompra':
        if (payload && payload.idCompra) saveCompra(payload.idCompra, payload.idProducto, !!payload.isEdit);
        break;

      case 'deleteCompra':
        if (payload && payload.idCompra) deleteCompra(payload.idCompra, payload.idProducto);
        break;

      case 'sendWhatsapp':
      case 'sendWhatsApp':
      case 'sendwhatsapp':
        enviarWhatsApp();
        break;

      case 'closeModal':
        modal.backdrop.style.display = 'none';
        break;

      default:
        console.warn('handle: acci√≥n no reconocida', action, payload);
    }
  } catch (err) {
    console.error('Error en handle:', err);
    showAlert('Error interno: ' + (err.message || err));
  }
}

/* -------------------- INICIALIZACI√ìN -------------------- */
window.addEventListener('load', async () => {
  cambiarVista('almacen');
  await loadData();
});
</script>
</body>
</html>
