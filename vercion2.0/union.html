<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockPro+ - Sistema Integrado de Gesti√≥n</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-dark: #3a56d4;
      --secondary: #4cc9f0;
      --success: #06d6a0;
      --warning: #ffd166;
      --danger: #ef476f;
      --dark: #1d3557;
      --light: #f8f9fa;
      --gray: #6c757d;
      --light-gray: #e9ecef;
      --purple: #9d4edd;
      --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      --border-radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
      overflow-x: hidden;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
    }

    /* Header */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      margin-bottom: 25px;
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      color: white;
      position: relative;
      overflow: hidden;
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
      opacity: 0.1;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
      z-index: 2;
    }

    .logo-icon {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(5px);
      color: white;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .logo-text {
      font-size: 26px;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .logo-text span {
      font-weight: 300;
    }

    /* Navigation */
    .nav-tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .nav-tab {
      padding: 12px 20px;
      border-radius: 50px;
      background: white;
      font-weight: 600;
      cursor: pointer;
      box-shadow: var(--card-shadow);
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 15px;
    }

    .nav-tab.active {
      background: var(--primary);
      color: white;
    }

    .nav-tab:hover:not(.active) {
      background: var(--light-gray);
    }

    /* Dashboard grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
      padding: 25px;
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .card-icon.blue { background: rgba(67, 97, 238, 0.15); color: var(--primary); }
    .card-icon.green { background: rgba(6, 214, 160, 0.15); color: var(--success); }
    .card-icon.orange { background: rgba(255, 209, 102, 0.15); color: #ff9e00; }
    .card-icon.purple { background: rgba(156, 39, 176, 0.15); color: #9c27b0; }
    .card-icon.red { background: rgba(239, 71, 111, 0.15); color: var(--danger); }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .btn {
      background: var(--light-gray);
      border: none;
      border-radius: 8px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
      color: var(--gray);
    }

    .btn:hover {
      background: var(--primary);
      color: white;
    }

    /* Summary section */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .summary-item {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .summary-item::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
    }

    .summary-item:nth-child(1)::after { background: var(--primary); }
    .summary-item:nth-child(2)::after { background: var(--success); }
    .summary-item:nth-child(3)::after { background: var(--warning); }
    .summary-item:nth-child(4)::after { background: var(--danger); }

    .summary-label {
      font-size: 14px;
      color: var(--gray);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .summary-label i {
      font-size: 18px;
    }

    .summary-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--dark);
    }

    .summary-trend {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 13px;
      font-weight: 500;
    }

    .chart-container {
      height: 280px;
      position: relative;
      margin-top: 15px;
    }

    /* Table */
    .table-container {
      overflow-x: auto;
      max-height: 320px;
      border-radius: 12px;
      border: 1px solid var(--light-gray);
      margin-top: 15px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 700px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      background: var(--light-gray);
      text-align: left;
      padding: 16px 20px;
      font-weight: 600;
      font-size: 14px;
      color: var(--gray);
    }

    td {
      padding: 14px 20px;
      border-bottom: 1px solid var(--light-gray);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .low-stock { background-color: rgba(239, 71, 111, 0.05); }
    .medium-stock { background-color: rgba(255, 209, 102, 0.05); }
    .warning-stock { background-color: rgba(6, 214, 160, 0.05); }

    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 12px;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 500;
    }

    .status-critical { background: rgba(239, 71, 111, 0.1); color: var(--danger); }
    .status-low { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
    .status-adequate { background: rgba(76, 175, 80, 0.1); color: #4CAF50; }
    .status-optimal { background: rgba(33, 150, 243, 0.1); color: #2196F3; }

    /* Inventory panel styles */
    .inventory-panel {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
      margin-bottom: 25px;
    }

    @media (max-width: 992px) {
      .inventory-panel {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--light-gray);
    }

    .panel-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn-primary {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      font-size: 14px;
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #05b98a;
    }

    .btn-whatsapp {
      background: #25D366;
      color: white;
    }

    .btn-whatsapp:hover {
      background: #1da854;
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--primary);
      color: var(--primary);
    }

    .btn-outline:hover {
      background: rgba(67, 97, 238, 0.08);
    }

    .panel-content {
      padding: 20px;
      overflow-y: auto;
      max-height: 500px;
    }

    .item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .item:last-child { border-bottom: none; }
    
    .info {
      flex: 1;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      gap: 0.5rem;
      font-size: 0.95rem;
    }
    
    .info div { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    
    .actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }
    
    .actions input[type="number"] {
      width: 3rem;
      padding: 0.4rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      text-align: center;
      font-size: 0.9rem;
    }
    
    button {
      padding: 0.4rem 0.8rem;
      border: none;
      border-radius: 6px;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    button:hover { background: var(--primary-dark); }
    
    .delete-btn {
      background: #cc3e44;
    }
    
    .delete-btn:hover {
      background: #a32f35;
    }
    
    .stock-warning {
      background-color: #fff8e1;
    }
    
    .stock-low {
      background-color: #ffebee;
    }

    .stock-indicator {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
    }

    .stock-low-ind { background: rgba(239, 71, 111, 0.15); color: var(--danger); }
    .stock-warning-ind { background: rgba(255, 209, 102, 0.15); color: #e6a500; }
    .stock-good-ind { background: rgba(6, 214, 160, 0.15); color: var(--success); }

    .search-bar {
      display: flex;
      margin-bottom: 20px;
      gap: 10px;
    }

    .search-input {
      flex: 1;
      padding: 12px 15px;
      border-radius: 10px;
      border: 1px solid var(--light-gray);
      font-size: 15px;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: var(--gray);
    }

    .no-data i {
      font-size: 48px;
      margin-bottom: 15px;
      color: var(--light-gray);
    }

    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 20px;
      box-shadow: var(--card-shadow);
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .stat-icon.blue { background: rgba(67, 97, 238, 0.15); color: var(--primary); }
    .stat-icon.orange { background: rgba(255, 209, 102, 0.15); color: #ff9e00; }
    .stat-icon.green { background: rgba(6, 214, 160, 0.15); color: var(--success); }
    .stat-icon.red { background: rgba(239, 71, 111, 0.15); color: var(--danger); }
    .stat-icon.purple { background: rgba(157, 78, 221, 0.15); color: var(--purple); }

    .stat-info h3 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .stat-info p {
      color: var(--gray);
      font-size: 14px;
    }

    /* Shopping list */
    .shopping-list-panel {
      grid-column: 1 / -1;
    }

    .shopping-list-item {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #e0e0e0;
    }

    .shopping-list-item:last-child {
      border-bottom: none;
    }

    .shopping-list-header {
      font-weight: 600;
      background-color: #f8f9fa;
      border-radius: 8px 8px 0 0;
      padding: 12px 0;
    }

    .shopping-list-content {
      max-height: 300px;
      overflow-y: auto;
    }

    .shopping-list-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 15px 0;
    }

    /* Product icons */
    .product-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--light-gray);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      margin-right: 12px;
    }

    .product-info {
      display: flex;
      align-items: center;
    }

    .value-display {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--dark);
      text-align: center;
      margin: 20px 0;
      padding: 15px;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
    }

    .value-display span {
      color: var(--primary);
    }

    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 5px;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
    }

    .progress-low { background: var(--danger); }
    .progress-medium { background: var(--warning); }
    .progress-high { background: var(--success); }

    .inventory-value-card {
      background: linear-gradient(135deg, #4361ee 0%, #3a56d4 100%);
      color: white;
      padding: 25px;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 25px;
    }

    .inventory-value-title {
      font-size: 1.2rem;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .inventory-value-amount {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
    }

    .inventory-value-subtitle {
      text-align: center;
      opacity: 0.9;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    /* Strategy cards */
    .strategy-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }

    .strategy-card {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 25px;
      display: flex;
      flex-direction: column;
      gap: 20px;
      transition: var(--transition);
      border: 1px solid rgba(0, 0, 0, 0.05);
      position: relative;
      overflow: hidden;
    }

    .strategy-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .strategy-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
    }

    .strategy-card:nth-child(1)::before { background: var(--primary); }
    .strategy-card:nth-child(2)::before { background: var(--success); }
    .strategy-card:nth-child(3)::before { background: var(--warning); }

    .strategy-header {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .strategy-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: rgba(67, 97, 238, 0.1);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .strategy-card:nth-child(1) .strategy-icon { background: rgba(67, 97, 238, 0.1); color: var(--primary); }
    .strategy-card:nth-child(2) .strategy-icon { background: rgba(6, 214, 160, 0.1); color: var(--success); }
    .strategy-card:nth-child(3) .strategy-icon { background: rgba(255, 209, 102, 0.1); color: var(--warning); }

    .strategy-content {
      font-size: 15px;
      line-height: 1.7;
      color: var(--gray);
    }

    .strategy-content p {
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .strategy-content strong {
      color: var(--dark);
      font-weight: 600;
    }

    .strategy-content .highlight {
      background: var(--light);
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 600;
      display: inline-block;
      margin-top: 5px;
    }

    /* Sales CRUD Styles */
    .sales-crud-container {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
      height: calc(100vh - 200px);
    }
    
    .list-panel {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1rem;
      overflow-y: auto;
      flex: 2 1 60%; 
      min-width: 300px; 
      position: relative;
    }
    
    .form-panel { 
      flex: 1 1 35%; 
      min-width: 250px;
      display: flex;
      justify-content: center;
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 1rem;
      overflow-y: auto;
    }

    /* GRID DE TICKETS */
    .tickets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 0.5rem;
    }
    
    .ticket-card {
      background: #fff;
      border: 1px solid var(--light-gray);
      border-radius: var(--border-radius);
      padding: 1rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    
    .ticket-header { 
      font-weight: bold; 
      margin-bottom: 0.5rem; 
      color: var(--dark);
    }
    
    .ticket-items { 
      flex: 1; 
      overflow-y: auto; 
      max-height: 150px; 
      margin-bottom: 0.5rem; 
    }
    
    .ticket-item { 
      font-size: 0.9rem; 
      margin-bottom: 0.25rem; 
      padding: 4px 0;
      border-bottom: 1px dashed var(--light-gray);
    }
    
    .ticket-footer { 
      font-weight: bold; 
      margin-bottom: 0.5rem; 
    }
    
    .ticket-method { 
      font-style: italic; 
      margin-bottom: 0.5rem; 
      color: var(--primary);
    }

    .ticket-actions button { 
      margin-right: 0.5rem; 
      padding: 6px 12px;
      font-size: 14px;
    }

    .ticket-actions .delete-btn {
      background: var(--danger);
    }

    /* FORM ITEMS */
    .item-row { 
      display: flex; 
      gap: 0.5rem; 
      margin-bottom: 0.5rem; 
      align-items: center; 
    }
    
    .item-row select, .item-row input { 
      flex: 1; 
      padding: 0.6rem; 
      border: 1px solid var(--light-gray); 
      border-radius: 4px; 
      font-size: 14px;
    }
    
    .item-row button { 
      flex: 0 0 auto; 
      margin-top: 0; 
      width: 36px;
      height: 36px;
    }
    
    #btn-add-item { 
      margin-top: 0.5rem; 
      width: 100%;
      padding: 10px;
    }
    
    .form-panel #items-container { 
      max-height: 60vh; 
      overflow-y: auto; 
      padding-right: 0.5rem; 
    }
    
    #btn-save, #btn-cancel {
      padding: 10px 20px;
      font-size: 16px;
    }

    /* MODAL DE RESUMEN */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: var(--border-radius);
      box-shadow: var(--card-shadow);
      padding: 25px;
      width: 300px;
      max-width: 90%;
      position: relative;
    }
    
    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: var(--gray);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--dark);
    }
    
    .modal-summary-item {
      padding: 8px 0;
      border-bottom: 1px solid var(--light-gray);
    }
    
    .modal-summary-item:last-child {
      border-bottom: none;
    }
    
    .modal-summary-total {
      font-weight: 700;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid var(--dark);
    }
    
    .show-summary-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      font-size: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .summary-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .col-6, .col-8, .col-9 {
        grid-column: span 12;
      }
    }

    @media (max-width: 1100px) {
      .strategy-grid {
        grid-template-columns: repeat(1, 1fr);
      }
    }

    @media (max-width: 900px) {
      .summary-grid {
        grid-template-columns: repeat(1, 1fr);
      }
      
      header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
        padding: 20px;
      }
      
      .logo {
        justify-content: center;
      }
      
      .nav-tabs {
        flex-wrap: wrap;
      }
      
      .sales-crud-container {
        flex-direction: column;
        height: auto;
      }
    }

    @media (max-width: 768px) {
      .inventory-panel {
        grid-template-columns: 1fr;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .shopping-list-item {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .tickets-grid {
        grid-template-columns: 1fr;
      }
      
      .form-panel, .list-panel {
        min-width: 100%;
      }
    }

    /* Sections */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card, .strategy-card, .ticket-card {
      animation: fadeIn 0.6s ease-out forwards;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="logo-text">Stock<span>Pro+</span></div>
      </div>
      <div class="header-controls">
        <button class="btn-refresh" id="refresh-btn">
          <i class="fas fa-sync-alt"></i> Actualizar Datos
        </button>
      </div>
    </header>

    <div class="nav-tabs">
      <div class="nav-tab active" data-tab="inventory">
        <i class="fas fa-warehouse"></i> Gesti√≥n de Inventario
      </div>
      <div class="nav-tab" data-tab="dashboard">
        <i class="fas fa-chart-line"></i> Dashboard de Ventas
      </div>
      <div class="nav-tab" data-tab="sales-crud">
        <i class="fas fa-cash-register"></i> Gesti√≥n de Ventas
      </div>
    </div>

    <!-- Secci√≥n de Inventario -->
    <div class="section active" id="inventory-section">
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon blue">
            <i class="fas fa-box-open"></i>
          </div>
          <div class="stat-info">
            <h3 id="total-products">0</h3>
            <p>Productos en stock</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon orange">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="stat-info">
            <h3 id="low-stock">0</h3>
            <p>Productos bajos</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon green">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <div class="stat-info">
            <h3 id="month-purchases">0</h3>
            <p>Compras este mes</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon red">
            <i class="fas fa-coins"></i>
          </div>
          <div class="stat-info">
            <h3 id="total-spent">$0</h3>
            <p>Gasto en compras</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon purple">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="stat-info">
            <h3 id="inventory-value">$0</h3>
            <p>Valor del inventario</p>
          </div>
        </div>
      </div>

      <div class="inventory-value-card">
        <div class="inventory-value-title">
          <i class="fas fa-dollar-sign"></i>
          Valor Total del Almac√©n
        </div>
        <div class="inventory-value-amount" id="total-inventory-value">$0.00</div>
        <div class="inventory-value-subtitle">Calculado en base al stock actual</div>
      </div>

      <div class="inventory-panel">
        <!-- Panel izquierdo - Stock -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="fas fa-warehouse"></i>
              <h2>Inventario Actual</h2>
            </div>
            <div class="panel-actions">
              <div class="search-bar">
                <input type="text" class="search-input" id="search-stock" placeholder="Buscar producto..." oninput="filterStock()">
              </div>
            </div>
          </div>
          <div class="panel-content">
            <ul id="list-stock"></ul>
          </div>
        </div>
        
        <!-- Panel derecho - Historial de Compras -->
        <div class="panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="fas fa-history"></i>
              <h2>Historial de Compras</h2>
            </div>
            <div class="panel-actions">
              <div class="search-bar">
                <input type="text" class="search-input" id="search-purchases" placeholder="Buscar compra..." oninput="filterPurchases()">
              </div>
            </div>
          </div>
          <div class="panel-content">
            <ul id="list-compras"></ul>
          </div>
        </div>
      </div>

      <!-- Nuevo panel: Lista de Compras -->
      <div class="panel shopping-list-panel">
        <div class="panel-header">
          <div class="panel-title">
            <i class="fas fa-shopping-cart"></i>
            <h2>Lista de Compras Recomendada</h2>
          </div>
          <div class="panel-actions">
            <button class="btn btn-whatsapp" onclick="sendWhatsApp()">
              <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
            </button>
          </div>
        </div>
        <div class="panel-content">
          <div class="shopping-list-header shopping-list-item">
            <div>Producto</div>
            <div>Stock Actual</div>
            <div>Recomendado</div>
            <div>Cantidad a Comprar</div>
          </div>
          <div class="shopping-list-content" id="shopping-list-items"></div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Dashboard -->
    <div class="section" id="dashboard-section">
      <div class="dashboard-grid">
        <!-- Resumen de Ventas -->
        <div class="card col-12">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon blue">
                <i class="fas fa-chart-bar"></i>
              </div>
              <h2>Resumen Financiero</h2>
            </div>
            <div class="card-actions">
              <button class="btn" title="Exportar PDF">
                <i class="fas fa-file-pdf"></i>
              </button>
              <button class="btn" title="Exportar Excel">
                <i class="fas fa-file-excel"></i>
              </button>
              <button class="btn" title="Compartir">
                <i class="fas fa-share-alt"></i>
              </button>
            </div>
          </div>
          
          <div class="summary-grid">
            <div class="summary-item">
              <div class="summary-label">
                <i class="fas fa-money-bill-wave" style="color: #4CAF50;"></i>
                <span>Ventas Totales</span>
              </div>
              <div class="summary-value" id="res-total">$0.00</div>
              <div class="summary-trend">
                <i class="fas fa-arrow-up" style="color: #4CAF50;"></i>
                <span style="color: #4CAF50;">+12% vs periodo anterior</span>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-label">
                <i class="fas fa-wallet" style="color: #2196F3;"></i>
                <span>Ventas en Efectivo</span>
              </div>
              <div class="summary-value" id="res-efectivo">$0.00</div>
              <div class="summary-trend">
                <i class="fas fa-arrow-up" style="color: #4CAF50;"></i>
                <span style="color: #4CAF50;">+8% vs periodo anterior</span>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-label">
                <i class="fas fa-credit-card" style="color: #FF9800;"></i>
                <span>Ventas con Tarjeta</span>
              </div>
              <div class="summary-value" id="res-tarjeta">$0.00</div>
              <div class="summary-trend">
                <i class="fas fa-arrow-up" style="color: #4CAF50;"></i>
                <span style="color: #4CAF50;">+15% vs periodo anterior</span>
              </div>
            </div>
            
            <div class="summary-item">
              <div class="summary-label">
                <i class="fas fa-exchange-alt" style="color: #9C27B0;"></i>
                <span>Ventas por Transferencia</span>
              </div>
              <div class="summary-value" id="res-transferencia">$0.00</div>
              <div class="summary-trend">
                <i class="fas fa-arrow-up" style="color: #4CAF50;"></i>
                <span style="color: #4CAF50;">+18% vs periodo anterior</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Gr√°fico de Ventas por D√≠a -->
        <div class="card col-8">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon green">
                <i class="fas fa-calendar-day"></i>
              </div>
              <h2>Tendencia de Ventas Diarias</h2>
            </div>
            <div class="card-actions">
              <button class="btn" title="Ver detalles">
                <i class="fas fa-expand"></i>
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chart-daily"></canvas>
          </div>
        </div>
        
        <!-- Productos M√°s Vendidos -->
        <div class="card col-4">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon orange">
                <i class="fas fa-star"></i>
              </div>
              <h2>Top Productos</h2>
            </div>
            <div class="card-actions">
              <button class="btn" title="Ver todos">
                <i class="fas fa-list"></i>
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chart-products"></canvas>
          </div>
        </div>
        
        <!-- Ingredientes M√°s Usados -->
        <div class="card col-12">
          <div class="card-header">
            <div class="card-title">
              <div class="card-icon purple">
                <i class="fas fa-carrot"></i>
              </div>
              <h2>Ingredientes Clave</h2>
            </div>
            <div class="card-actions">
              <button class="btn" title="Generar orden de compra">
                <i class="fas fa-shopping-cart"></i>
              </button>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="chart-ingredients"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Estrategias de Ventas -->
      <div class="strategy-grid">
        <div class="strategy-card">
          <div class="strategy-header">
            <div class="strategy-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div>
              <h3>Estrategias Temporales</h3>
              <p style="color: var(--primary); font-size: 14px; margin-top: 5px;">Optimiza tus ventas seg√∫n el tiempo</p>
            </div>
          </div>
          <div class="strategy-content">
            <p><i class="fas fa-check-circle" style="color: #4CAF50;"></i> <strong>D√≠a con m√°s ventas:</strong> <span id="strategy-best-day">--</span></p>
            <p><i class="fas fa-exclamation-triangle" style="color: #FF9800;"></i> <strong>D√≠a con menos ventas:</strong> <span id="strategy-worst-day">--</span></p>
            <p class="highlight">Planifique promociones especiales los d√≠as de menor venta para aumentar el tr√°fico y mejorar los resultados.</p>
          </div>
        </div>
        
        <div class="strategy-card">
          <div class="strategy-header">
            <div class="strategy-icon">
              <i class="fas fa-box-open"></i>
            </div>
            <div>
              <h3>Estrategias de Producto</h3>
              <p style="color: var(--success); font-size: 14px; margin-top: 5px;">Maximiza el potencial de tus productos</p>
            </div>
          </div>
          <div class="strategy-content">
            <p><i class="fas fa-bullseye" style="color: #F44336;"></i> <strong>Producto estrella:</strong> <span id="strategy-product">--</span></p>
            <p><i class="fas fa-carrot" style="color: #FF9800;"></i> <strong>Ingrediente clave:</strong> <span id="strategy-ingredient">--</span></p>
            <p class="highlight">Crea combos promocionales con tus productos m√°s populares para aumentar su visibilidad y ventas.</p>
          </div>
        </div>
        
        <div class="strategy-card">
          <div class="strategy-header">
            <div class="strategy-icon">
              <i class="fas fa-lightbulb"></i>
            </div>
            <div>
              <h3>Estrategias Adicionales</h3>
              <p style="color: var(--warning); font-size: 14px; margin-top: 5px;">Mejora continua y optimizaci√≥n</p>
            </div>
          </div>
          <div class="strategy-content">
            <p><i class="fas fa-truck" style="color: #2196F3;"></i> <strong>Proveedor recomendado:</strong> <span id="strategy-supplier">--</span></p>
            <p><i class="fas fa-tags" style="color: #9C27B0;"></i> <strong>Combo sugerido:</strong> <span id="strategy-promo">--</span></p>
            <p class="highlight">Optimiza tu cadena de suministro para reducir costos y mejorar los m√°rgenes de beneficio.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Secci√≥n de Gesti√≥n de Ventas (CRUD) -->
    <div class="section" id="sales-crud-section">
      <h1 style="margin-bottom: 20px;">Gesti√≥n de Ventas</h1>
      <div class="sales-crud-container">
        <!-- PANEL LISTADO -->
        <div class="list-panel">
          <div class="panel-header">
            <div class="panel-title">
              <i class="fas fa-receipt"></i>
              <h2>Tickets de Venta</h2>
            </div>
            <div class="panel-actions">
              <button id="btn-cargar" type="button" class="btn-primary">
                <i class="fas fa-sync"></i> Cargar Ventas
              </button>
            </div>
          </div>
          <div class="tickets-grid" id="tickets-grid"></div>
        </div>
        
        <!-- PANEL FORMULARIO -->
        <div class="form-panel">
          <div class="panel">
            <div class="panel-header">
              <div class="panel-title">
                <i class="fas fa-edit"></i>
                <h2 id="form-title">Editar Venta</h2>
              </div>
            </div>
            <div class="panel-content">
              <input type="hidden" id="form-id" />
              <div class="item-row">
                <label for="form-fecha" style="flex:0 0 80px">Fecha:</label>
                <input type="date" id="form-fecha" style="flex:1"/>
              </div>
              <div id="items-container"></div>
              <button id="btn-add-item" type="button" class="btn-outline">
                <i class="fas fa-plus"></i> Agregar producto
              </button>
              <!-- Selecci√≥n de m√©todo de pago -->
              <div class="item-row" style="margin-top:1rem;">
                <label for="form-pago" style="flex:0 0 80px">Pago:</label>
                <select id="form-pago" style="flex:1">
                  <option value="Efectivo">Efectivo</option>
                  <option value="Transferencia">Transferencia</option>
                  <option value="Tarjeta">Tarjeta</option>
                </select>
              </div>
              <div style="margin-top:1rem; display:flex; gap:0.5rem;">
                <button id="btn-save" type="button" class="btn-success">
                  <i class="fas fa-save"></i> Guardar
                </button>
                <button id="btn-cancel" type="button" class="btn-outline">
                  <i class="fas fa-times"></i> Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Bot√≥n flotante para abrir el resumen -->
      <button class="show-summary-btn" id="show-summary-btn">
        <i class="fas fa-chart-pie"></i>
      </button>
    </div>
    
    <!-- Modal de Resumen de Pagos -->
    <div class="modal" id="summary-modal">
      <div class="modal-content">
        <button class="close-modal" id="close-modal">&times;</button>
        <div class="modal-header">
          <h3 class="modal-title">Resumen de Pagos</h3>
        </div>
        <div class="modal-body">
          <div class="modal-summary-item" id="sum-efectivo">Efectivo: $0.00</div>
          <div class="modal-summary-item" id="sum-transferencia">Transferencia: $0.00</div>
          <div class="modal-summary-item" id="sum-tarjeta">Tarjeta: $0.00</div>
          <div class="modal-summary-item modal-summary-total" id="sum-total">Total: $0.00</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxBOyRG_Q3hEtHyRcgnhYLqk4yB5BGWQXQC4cDb-QG45Gs96fL5dnn9B9GD87rS9ghW7w/exec';
    const FACTORES = { g:1, kg:1000, kl:1000, mg:0.001, ml:1, l:1000, pz:1 };
    const MARGEN = 2;
    const DIAS = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    
    // Variables globales
    let almacenData = [];
    let comprasData = [];
    let filteredStock = [];
    let filteredPurchases = [];
    let shoppingList = [];
    let dailyChart, productsChart, ingredientsChart;
    let dashboardInitialized = false;
    let recetas = [];
    
    // Iconos por categor√≠a de productos
    const CATEGORY_ICONS = {
      default: 'fa-box',
      fruta: 'fa-apple-alt',
      verdura: 'fa-carrot',
      carne: 'fa-drumstick-bite',
      lacteo: 'fa-cheese',
      bebida: 'fa-wine-bottle',
      grano: 'fa-seedling',
      especia: 'fa-mortar-pestle',
      pan: 'fa-bread-slice',
      pescado: 'fa-fish',
      conserva: 'fa-jar',
      limpieza: 'fa-pump-soap',
      utensilio: 'fa-utensils'
    };

    // Colores para gr√°ficos
    const CHART_COLORS = {
      primary: '#4361ee',
      secondary: '#4cc9f0',
      success: '#06d6a0',
      warning: '#ffd166',
      danger: '#ef476f',
      purple: '#9c27b0',
      blue: '#2196f3',
      green: '#4caf50',
      orange: '#ff9800',
      teal: '#20c997'
    };

    // Funci√≥n para cambiar entre secciones
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(`${sectionId}-section`).classList.add('active');
      document.querySelector(`.nav-tab[data-tab="${sectionId}"]`).classList.add('active');
      
      // Si se muestra el dashboard por primera vez, inicializarlo
      if (sectionId === 'dashboard' && !dashboardInitialized) {
        initDashboard();
        dashboardInitialized = true;
      }
      
      // Si se muestra el CRUD de ventas, cargar los datos
      if (sectionId === 'sales-crud') {
        cargarVentas();
      }
    }

    // Funci√≥n para obtener icono por categor√≠a
    function getCategoryIcon(name) {
      name = name.toLowerCase();
      
      if (name.includes('manzana') || name.includes('naranja') || name.includes('fruta')) 
        return CATEGORY_ICONS.fruta;
      if (name.includes('pollo') || name.includes('carne') || name.includes('res') || name.includes('cerdo')) 
        return CATEGORY_ICONS.carne;
      if (name.includes('leche') || name.includes('queso') || name.includes('yogur') || name.includes('l√°cteo')) 
        return CATEGORY_ICONS.lacteo;
      if (name.includes('agua') || name.includes('jugo') || name.includes('refresco') || name.includes('bebida')) 
        return CATEGORY_ICONS.bebida;
      if (name.includes('arroz') || name.includes('frijol') || name.includes('grano')) 
        return CATEGORY_ICONS.grano;
      if (name.includes('sal') || name.includes('pimienta') || name.includes('especia')) 
        return CATEGORY_ICONS.especia;
      if (name.includes('pan') || name.includes('tortilla')) 
        return CATEGORY_ICONS.pan;
      if (name.includes('pescado') || name.includes('at√∫n') || name.includes('salm√≥n')) 
        return CATEGORY_ICONS.pescado;
      if (name.includes('lat') || name.includes('conserva')) 
        return CATEGORY_ICONS.conserva;
      if (name.includes('jab√≥n') || name.includes('limpiador') || name.includes('limpieza')) 
        return CATEGORY_ICONS.limpieza;
      if (name.includes('cuchara') || name.includes('tenedor') || name.includes('cuchillo') || name.includes('utensilio')) 
        return CATEGORY_ICONS.utensilio;
      
      return CATEGORY_ICONS.default;
    }

    // Llamada a la API
    async function callApi(params) {
      const url = new URL(API_URL);
      Object.entries(params).forEach(([k, v]) => url.searchParams.append(k, v));
      const res = await fetch(url);
      return res.json();
    }

    // Funciones de inventario
    async function buyProduct(idProducto, unidad) {
      const qtyInput = document.getElementById(`qty-${idProducto}`);
      const qty = parseFloat(qtyInput.value);
      if (isNaN(qty) || qty <= 0) return alert('Cantidad inv√°lida');
      const item = almacenData.find(i => String(i.codigo) === String(idProducto));
      if (!item) return alert('Producto no encontrado');
      const factorP = FACTORES[item.unidadDeMedida.trim().toLowerCase()] * parseFloat(item.cantidad);
      const pricePerUnit = item.precio / factorP;
      const totalPrice = parseFloat((pricePerUnit * qty).toFixed(2));
      const fecha = new Date().toISOString().slice(0,10);

      await callApi({ op: 'guardarCompras', idProducto, fecha, name: item.name, precio: totalPrice, cantidad: qty, unidad });
      loadData();
    }

    async function editCompra(idCompra, idProducto) {
      const comp = comprasData.find(c => c.idCompra === idCompra && c.idProducto === idProducto);
      if (!comp) return alert('Compra no encontrada');
      const nuevaCantidad = parseFloat(prompt('Nueva cantidad:', comp.cantidad));
      if (isNaN(nuevaCantidad) || nuevaCantidad < 0) return alert('Cantidad inv√°lida');
      const item = almacenData.find(i => String(i.codigo) === String(idProducto));
      const factorP = FACTORES[item.unidadDeMedida.trim().toLowerCase()] * parseFloat(item.cantidad);
      const pricePerUnit = item.precio / factorP;
      const nuevoPrecio = parseFloat((pricePerUnit * nuevaCantidad).toFixed(2));

      await callApi({ op: 'guardarCompras', idCompra, idProducto, fecha: comp.fecha, name: comp.name, precio: nuevoPrecio, cantidad: nuevaCantidad, unidad: comp.unidad });
      loadData();
    }

    async function deleteCompra(idCompra, idProducto) {
      await callApi({ op:'eliminarCompras', idCompra, idProducto });
      loadData();
    }

    function filterStock() {
      const searchTerm = document.getElementById('search-stock').value.toLowerCase();
      filteredStock = almacenData.filter(item => 
        item.name.toLowerCase().includes(searchTerm) || 
        String(item.codigo).includes(searchTerm)
      );
      renderStock();
    }

    function filterPurchases() {
      const searchTerm = document.getElementById('search-purchases').value.toLowerCase();
      filteredPurchases = comprasData.filter(compra => 
        compra.name.toLowerCase().includes(searchTerm) || 
        compra.fecha.includes(searchTerm) ||
        String(compra.idProducto).includes(searchTerm)
      );
      renderPurchases();
    }

    function renderStock() {
      const listStock = document.getElementById('list-stock');
      
      if (filteredStock.length === 0) {
        listStock.innerHTML = `
          <div class="no-data">
            <i class="fas fa-box-open"></i>
            <p>No se encontraron productos</p>
          </div>
        `;
        return;
      }
      
      listStock.innerHTML = '';
      filteredStock.forEach(item => {
        const recos = parseFloat(item.stockRecomendado)||0;
        const used  = window.ingMap[item.codigo]||0;
        const bought= window.comprMap[item.codigo]||0;
        const remain= recos + bought - used;
        const factorP = FACTORES[item.unidadDeMedida.trim().toLowerCase()] * parseFloat(item.cantidad);
        const pricePerUnit = item.precio / factorP;
        const stockPercentage = Math.min(100, Math.max(0, (remain / recos) * 100));
        
        let stockClass = '';
        let stockIndicator = '';
        let progressClass = '';
        
        if (remain <= 0) {
          stockClass = 'stock-low';
          stockIndicator = '<span class="stock-indicator stock-low-ind">Agotado</span>';
          progressClass = 'progress-low';
        } else if (remain <= 0.3 * recos) {
          stockClass = 'stock-warning';
          stockIndicator = '<span class="stock-indicator stock-warning-ind">Bajo</span>';
          progressClass = 'progress-medium';
        } else {
          stockIndicator = '<span class="stock-indicator stock-good-ind">Disponible</span>';
          progressClass = 'progress-high';
        }

        listStock.insertAdjacentHTML('beforeend', `
          <li class="item ${stockClass}">
            <div class="product-info">
              <div class="product-icon">
                <i class="fas ${getCategoryIcon(item.name)}"></i>
              </div>
              <div class="info">
                <div>${item.name}</div>
                <div>$${pricePerUnit.toFixed(2)}/${item.unidadDeMedida}</div>
                <div>Rec.: ${recos}</div>
                <div>
                  ${stockIndicator} ${remain.toFixed(1)}
                  <div class="progress-bar">
                    <div class="progress-fill ${progressClass}" style="width: ${stockPercentage}%"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="actions">
              <input type="number" id="qty-${item.codigo}" value="1" min="1" step="0.5" />
              <button onclick="buyProduct('${item.codigo}','${item.unidadDeMedida}')">
                <i class="fas fa-cart-plus"></i> Comprar
              </button>
            </div>
          </li>
        `);
      });
    }

    function renderPurchases() {
      const listCompras = document.getElementById('list-compras');
      
      if (filteredPurchases.length === 0) {
        listCompras.innerHTML = `
          <div class="no-data">
            <i class="fas fa-file-invoice-dollar"></i>
            <p>No se encontraron compras</p>
          </div>
        `;
        return;
      }
      
      listCompras.innerHTML = '';
      filteredPurchases
        .sort((a,b) => new Date(b.fecha) - new Date(a.fecha))
        .forEach(c => {
          const fecha = c.fecha;
          const total = c.precio.toFixed(2);
          
          listCompras.insertAdjacentHTML('beforeend', `
            <li class="item">
              <div class="product-info">
                <div class="product-icon">
                  <i class="fas ${getCategoryIcon(c.name)}"></i>
                </div>
                <div class="info">
                  <div>${c.name}</div>
                  <div>${fecha}</div>
                  <div>${c.cantidad} ${c.unidad}</div>
                  <div>$${total}</div>
                </div>
              </div>
              <div class="actions">
                <button onclick="editCompra('${c.idCompra}','${c.idProducto}')">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="delete-btn" onclick="deleteCompra('${c.idCompra}','${c.idProducto}')">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          `);
        });
    }

    function generateShoppingList() {
      shoppingList = [];
      let totalValue = 0;
      
      almacenData.forEach(item => {
        const recos = parseFloat(item.stockRecomendado) || 0;
        const used = window.ingMap[item.codigo] || 0;
        const bought = window.comprMap[item.codigo] || 0;
        const remain = recos + bought - used;
        
        // Solo incluir productos que necesitan reposici√≥n
        if (remain < recos * 0.8) {
          const factorP = FACTORES[item.unidadDeMedida.trim().toLowerCase()] * parseFloat(item.cantidad);
          const pricePerUnit = item.precio / factorP;
          const needed = Math.max(0, recos - remain);
          const value = needed * pricePerUnit;
          
          shoppingList.push({
            id: item.codigo,
            name: item.name,
            unit: item.unidadDeMedida,
            current: remain,
            recommended: recos,
            needed: needed,
            value: value
          });
          
          totalValue += value;
        }
      });
      
      // Ordenar por mayor necesidad
      shoppingList.sort((a, b) => b.needed - a.needed);
      
      renderShoppingList();
      document.getElementById('inventory-value').textContent = '$' + totalValue.toFixed(2);
    }
    
    function renderShoppingList() {
      const container = document.getElementById('shopping-list-items');
      container.innerHTML = '';
      
      if (shoppingList.length === 0) {
        container.innerHTML = `
          <div class="no-data">
            <i class="fas fa-check-circle"></i>
            <p>¬°Todo en orden! No se necesitan compras</p>
          </div>
        `;
        return;
      }
      
      shoppingList.forEach(item => {
        container.insertAdjacentHTML('beforeend', `
          <div class="shopping-list-item">
            <div class="product-info">
              <div class="product-icon">
                <i class="fas ${getCategoryIcon(item.name)}"></i>
              </div>
              <div>${item.name}</div>
            </div>
            <div>${item.current.toFixed(1)}</div>
            <div>${item.recommended}</div>
            <div>${item.needed.toFixed(1)} ${item.unit}</div>
          </div>
        `);
      });
    }
    
    function sendWhatsApp() {
      if (shoppingList.length === 0) {
        alert('La lista de compras est√° vac√≠a');
        return;
      }
      
      let message = "üìã *Lista de Compras - StockPro* üìã\n\n";
      message += "Aqu√≠ tienes la lista de productos a comprar:\n\n";
      
      shoppingList.forEach(item => {
        message += `‚û°Ô∏è *${item.name}*: ${item.needed.toFixed(1)} ${item.unit}\n`;
      });
      
      message += `\nTotal estimado: $${shoppingList.reduce((sum, item) => sum + item.value, 0).toFixed(2)}`;
      message += "\n\nGenerado autom√°ticamente por StockPro";
      
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }

    function updateStats() {
      // Total de productos
      document.getElementById('total-products').textContent = almacenData.length;
      
      // Productos con stock bajo
      const lowStockCount = almacenData.filter(item => {
        const recos = parseFloat(item.stockRecomendado) || 0;
        const used = window.ingMap[item.codigo] || 0;
        const bought = window.comprMap[item.codigo] || 0;
        const remain = recos + bought - used;
        return remain <= 0.3 * recos;
      }).length;
      document.getElementById('low-stock').textContent = lowStockCount;
      
      // Compras este mes
      const currentMonth = new Date().getMonth();
      const monthPurchases = comprasData.filter(c => {
        const purchaseMonth = new Date(c.fecha).getMonth();
        return purchaseMonth === currentMonth;
      }).length;
      document.getElementById('month-purchases').textContent = monthPurchases;
      
      // Total gastado
      const totalSpent = comprasData.reduce((sum, c) => sum + c.precio, 0);
      document.getElementById('total-spent').textContent = `$${totalSpent.toFixed(2)}`;
      
      // Valor del inventario
      let inventoryValue = 0;
      almacenData.forEach(item => {
        const recos = parseFloat(item.stockRecomendado) || 0;
        const used = window.ingMap[item.codigo] || 0;
        const bought = window.comprMap[item.codigo] || 0;
        const remain = recos + bought - used;
        
        const baseUnitsPerPackage = FACTORES[item.unidadDeMedida.trim().toLowerCase()] * parseFloat(item.cantidad);
        const baseUnitPrice = item.precio / baseUnitsPerPackage;
        
        inventoryValue += baseUnitPrice * remain;
      });
      
      document.getElementById('inventory-value').textContent = `$${inventoryValue.toFixed(2)}`;
      document.getElementById('total-inventory-value').textContent = `$${inventoryValue.toFixed(2)}`;
    }

    // Funciones del dashboard
    function calcularCosto(ingredientes, almacen) {
      let total = 0;
      ingredientes.forEach(i => {
        const p = almacen.find(x => String(x.codigo) === String(i.codigo));
        if (!p) return;
        const ua = FACTORES[p.unidadDeMedida.trim().toLowerCase()] || 1;
        const ui = FACTORES[i.unidad.trim().toLowerCase()] || 1;
        total += (p.precio / (ua * parseFloat(p.cantidad))) * (ui * i.cantidad);
      });
      return parseFloat(total.toFixed(2));
    }
    
    function aplicarMargen(c) { return parseFloat((c * MARGEN).toFixed(2)); }

    async function initDashboard() {
      // Mostrar estado de carga
      document.querySelectorAll('.summary-value').forEach(el => {
        el.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div>';
      });
      
      const [almResp, cocResp, ventResp] = await Promise.all([
        callApi({op:'obtenerAlmacen'}),
        callApi({op:'obtenerCocina'}),
        callApi({op:'obtenerVentas'})
      ]);
      
      if (almResp.status!=='success' || cocResp.status!=='success' || ventResp.status!=='success') {
        alert('Error al cargar datos. Intente nuevamente.');
        return;
      }
      
      const almacen = almResp.data;
      const cocinas = cocResp.data;
      const ventas = ventResp.data;

      // Prepara recetas con costo y margen
      const recetas = cocinas.map(r => ({
        codigo: r.codigo,
        nombre: r.nombre,
        precio: aplicarMargen(calcularCosto(r.ingredientes, almacen)),
        ingredientes: r.ingredientes
      }));

      // Inicializa acumuladores
      let totalRevenue = 0;
      const paymentMap = { 'Efectivo':0, 'Transferencia':0, 'Tarjeta':0 };
      const dailyMap = {}, prodMap = {}, ingMap = {}, dowMap = {0:0,1:0,2:0,3:0,4:0,5:0,6:0};

      ventas.forEach(v => {
        const date = new Date(v.fecha);
        const dayKey = date.toISOString().slice(0,10);
        const dow = date.getDay();

        // Suponemos que v.metodoPago es 'Efectivo'|'Transferencia'|'Tarjeta'
        const metodo = v.metodoPago || 'Efectivo';
        let saleTotal = 0;
        v.venta.forEach(it => {
          saleTotal += it.total;
          prodMap[it.producto] = (prodMap[it.producto]||0) + it.cantidad;
          const receta = recetas.find(r=>r.codigo===it.codigo);
          if (receta) receta.ingredientes.forEach(ing =>
            ingMap[ing.codigo] = (ingMap[ing.codigo]||0) + ing.cantidad*it.cantidad
          );
        });

        totalRevenue += saleTotal;
        paymentMap[metodo] = (paymentMap[metodo]||0) + saleTotal;
        dailyMap[dayKey] = (dailyMap[dayKey]||0) + saleTotal;
        dowMap[dow] += saleTotal;
      });

      // Actualiza Resumen General
      document.getElementById('res-efectivo').textContent = `$${paymentMap['Efectivo'].toFixed(2)}`;
      document.getElementById('res-transferencia').textContent = `$${paymentMap['Transferencia'].toFixed(2)}`;
      document.getElementById('res-tarjeta').textContent = `$${paymentMap['Tarjeta'].toFixed(2)}`;
      document.getElementById('res-total').textContent = `$${totalRevenue.toFixed(2)}`;

      // Estrategias b√°sicas
      const bestDow = DIAS[Object.keys(dowMap).reduce((a,b)=>dowMap[a]>dowMap[b]?a:b)];
      const worstDow= DIAS[Object.keys(dowMap).reduce((a,b)=>dowMap[a]<dowMap[b]?a:b)];
      const topProduct = Object.entries(prodMap).sort((a,b)=>b[1]-a[1])[0]?.[0]||'--';
      document.getElementById('strategy-best-day').textContent = bestDow;
      document.getElementById('strategy-worst-day').textContent = worstDow;
      document.getElementById('strategy-product').textContent = topProduct;

      // Estrategias adicionales
      const sortedIng = Object.entries(ingMap).sort((a,b)=>b[1]-a[1]);
      const topIngCode = sortedIng[0]?.[0]||null;
      const topIngQty  = sortedIng[0]?.[1]||0;
      const topIngName = topIngCode
        ? (almacen.find(x=>String(x.codigo)===topIngCode)?.name||topIngCode)
        : '--';
      document.getElementById('strategy-ingredient').textContent = `${topIngName} (${topIngQty.toFixed(0)})`;
      document.getElementById('strategy-supplier').textContent =
        topIngName!=='--' ? `Proveedores de ${topIngName}` : '--';
      document.getElementById('strategy-promo').textContent =
        topProduct!=='--' ? `Combo Premium ${topProduct}` : '--';

      // Generar gr√°ficas
      createDailyChart(dailyMap);
      createProductsChart(prodMap);
      createIngredientsChart(ingMap, almacen);
    }

    function createDailyChart(dailyMap) {
      const ctx = document.getElementById('chart-daily').getContext('2d');
      
      // Destruir gr√°fico existente si hay uno
      if (dailyChart) {
        dailyChart.destroy();
      }
      
      const dates = Object.keys(dailyMap).sort();
      const salesData = dates.map(d => dailyMap[d]);
      
      dailyChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: 'Ventas ($)',
            data: salesData,
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderColor: CHART_COLORS.primary,
            borderWidth: 3,
            pointBackgroundColor: '#fff',
            pointBorderColor: CHART_COLORS.primary,
            pointBorderWidth: 2,
            pointRadius: 5,
            pointHoverRadius: 7,
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleFont: { size: 14, weight: 'normal' },
              bodyFont: { size: 15, weight: '500' },
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(tooltipItems) {
                  return tooltipItems[0].label;
                },
                label: function(context) {
                  return `Ventas: $${context.raw.toFixed(2)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return '$' + value;
                },
                font: {
                  size: 12
                }
              },
              title: {
                display: true,
                text: 'Monto en D√≥lares',
                font: {
                  size: 13,
                  weight: '500'
                }
              }
            },
            x: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 11
                }
              },
              title: {
                display: true,
                text: 'Fechas',
                font: {
                  size: 13,
                  weight: '500'
                }
              }
            }
          }
        }
      });
    }

    function createProductsChart(prodMap) {
      const ctx = document.getElementById('chart-products').getContext('2d');
      
      // Destruir gr√°fico existente si hay uno
      if (productsChart) {
        productsChart.destroy();
      }
      
      // Top 5 productos
      const topProducts = Object.entries(prodMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      
      productsChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: topProducts.map(item => item[0]),
          datasets: [{
            data: topProducts.map(item => item[1]),
            backgroundColor: [
              CHART_COLORS.primary,
              CHART_COLORS.secondary,
              CHART_COLORS.success,
              CHART_COLORS.warning,
              CHART_COLORS.danger
            ],
            borderWidth: 0,
            hoverOffset: 15
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: {
                padding: 15,
                font: {
                  size: 12
                },
                generateLabels: function(chart) {
                  const data = chart.data;
                  if (data.labels.length && data.datasets.length) {
                    return data.labels.map(function(label, i) {
                      const meta = chart.getDatasetMeta(0);
                      const style = meta.controller.getStyle(i);
                      
                      return {
                        text: label + ': ' + data.datasets[0].data[i] + ' unidades',
                        fillStyle: style.backgroundColor,
                        strokeStyle: style.borderColor,
                        lineWidth: style.borderWidth,
                        hidden: false,
                        index: i
                      };
                    });
                  }
                  return [];
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} unidades (${percentage}%)`;
                }
              }
            }
          },
          cutout: '65%'
        }
      });
    }

    function createIngredientsChart(ingMap, almacen) {
      const ctx = document.getElementById('chart-ingredients').getContext('2d');
      
      // Destruir gr√°fico existente si hay uno
      if (ingredientsChart) {
        ingredientsChart.destroy();
      }
      
      // Top 6 ingredientes
      const topIngredients = Object.entries(ingMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
      
      const ingredientNames = topIngredients.map(([code]) => {
        const product = almacen.find(x => String(x.codigo) === code);
        return product ? product.name : code;
      });
      
      ingredientsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ingredientNames,
          datasets: [{
            label: 'Cantidad Usada',
            data: topIngredients.map(([,qty]) => qty),
            backgroundColor: CHART_COLORS.purple,
            borderRadius: 8,
            borderSkipped: false
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Cantidad: ${context.raw}`;
                }
              }
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              title: {
                display: true,
                text: 'Cantidad Utilizada',
                font: {
                  size: 13,
                  weight: '500'
                }
              }
            },
            y: {
              grid: {
                display: false
              },
              ticks: {
                font: {
                  size: 12
                }
              }
            }
          }
        }
      });
    }

    // Funci√≥n principal de carga de datos
    async function loadData() {
      const [almResp, cocResp, ventResp, compResp] = await Promise.all([
        callApi({ op:'obtenerAlmacen' }),
        callApi({ op:'obtenerCocina' }),
        callApi({ op:'obtenerVentas' }),
        callApi({ op:'obtenerCompras' })
      ]);
      
      if ([almResp, cocResp, ventResp, compResp].some(r => r.status !== 'success')) return;
      
      almacenData = almResp.data;
      comprasData = compResp.data;
      filteredStock = [...almacenData];
      filteredPurchases = [...comprasData];

      // C√°lculos de stock y usados
      const recetas = cocResp.data;
      const ventas = ventResp.data;
      window.ingMap = {};
      ventas.forEach(v => v.venta.forEach(it => {
        const rec = recetas.find(r => String(r.codigo) === String(it.codigo));
        if (!rec) return;
        rec.ingredientes.forEach(ing => {
          window.ingMap[ing.codigo] = (window.ingMap[ing.codigo]||0) + ing.cantidad * it.cantidad;
        });
      }));
      
      window.comprMap = {};
      comprasData.forEach(c => {
        window.comprMap[c.idProducto] = (window.comprMap[c.idProducto]||0) + c.cantidad;
      });

      renderStock();
      renderPurchases();
      updateStats();
      generateShoppingList();
      
      // Si el dashboard est√° activo, actualizarlo tambi√©n
      if (document.getElementById('dashboard-section').classList.contains('active')) {
        initDashboard();
      }
    }

    // Funciones de Gesti√≥n de Ventas (CRUD)
    async function fetchRecetas() {
      try {
        const { status: stA, data: almacen, message: errA } = await callApi({ op: 'obtenerAlmacen' });
        if (stA !== 'success') throw new Error('Inventario: ' + errA);
  
        const { status, data, message } = await callApi({ op: 'obtenerCocina' });
        if (status !== 'success') throw new Error('Recetas: ' + message);
  
        recetas = data.map(r => {
          const costoBase = calcularCosto(r.ingredientes, almacen);
          return {
            codigo: r.codigo,
            nombre: r.nombre,
            precio: aplicarMargen(costoBase)
          };
        });
  
        console.log('Recetas cargadas:', recetas);
      } catch (e) {
        console.error(e);
        alert(e.message);
      }
    }
  
    function crearItemRow(codigo = '', cantidad = '', total = '') {
      const row = document.createElement('div');
      row.className = 'item-row';
  
      const selProd = document.createElement('select');
      recetas.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.codigo;
        opt.textContent = r.nombre;
        if (r.codigo === codigo) opt.selected = true;
        selProd.append(opt);
      });
  
      const inpCant = document.createElement('input');
      inpCant.type = 'number'; 
      inpCant.min = '1';
      inpCant.placeholder = 'Cantidad'; 
      inpCant.value = cantidad;
  
      const inpTotal = document.createElement('input');
      inpTotal.type = 'number'; 
      inpTotal.placeholder = 'Total';
      inpTotal.value = total;
      inpTotal.readOnly = true;
  
      const btnDel = document.createElement('button');
      btnDel.type = 'button'; 
      btnDel.textContent = '‚àí';
      btnDel.className = 'delete-btn';
      btnDel.onclick = () => row.remove();
  
      function recalc() {
        const prod = recetas.find(r => r.codigo === selProd.value);
        const qty = parseFloat(inpCant.value) || 0;
        inpTotal.value = prod ? (prod.precio * qty).toFixed(2) : '0.00';
      }
      selProd.onchange = recalc;
      inpCant.oninput = recalc;
  
      row.append(selProd, inpCant, inpTotal, btnDel);
      return row;
    }
  
    function renderCard(v) {
      const card = document.createElement('div');
      card.className = 'ticket-card';
  
      const header = document.createElement('div');
      header.className = 'ticket-header';
      header.textContent = new Date(v.fecha).toISOString().slice(0,10);
  
      const method = document.createElement('div');
      method.className = 'ticket-method';
      method.textContent = 'Pago: ' + (v.metodoPago || '‚Äî');
  
      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'ticket-items';
      v.venta.forEach(it => {
        const itDiv = document.createElement('div');
        itDiv.className = 'ticket-item';
        itDiv.textContent = `${it.producto} x${it.cantidad} = $${it.total}`;
        itemsDiv.append(itDiv);
      });
  
      const footer = document.createElement('div');
      footer.className = 'ticket-footer';
      const total = v.venta.reduce((a,i) => a + (parseFloat(i.total)||0), 0).toFixed(2);
      footer.textContent = 'Total: $' + total;
  
      const actions = document.createElement('div');
      actions.className = 'ticket-actions';
      
      const btnE = document.createElement('button');
      btnE.textContent = 'Editar';
      btnE.onclick = () => startEdit(v, v.venta);
      
      const btnD = document.createElement('button');
      btnD.textContent = 'Eliminar';
      btnD.className = 'delete-btn';
      btnD.onclick = async () => { 
        await callApi({ op: 'eliminarVentas', id: v.id }); 
        cargarVentas(); 
      };
      
      actions.append(btnE, btnD);
  
      card.append(header, method, itemsDiv, footer, actions);
      return card;
    }
  
    async function cargarVentas() {
      await fetchRecetas();
      const { status, data, message } = await callApi({ op: 'obtenerVentas' });
      if (status !== 'success') {
        alert('Error: ' + message);
        return;
      }
      const grid = document.getElementById('tickets-grid');
      grid.innerHTML = '';
      data.forEach(v => grid.append(renderCard(v)));
      actualizarResumen(data);
    }
  
    function actualizarResumen(ventas) {
      let sumE = 0, sumT = 0, sumTa = 0;
      ventas.forEach(v => {
        const tot = v.venta.reduce((a,i) => a + (parseFloat(i.total)||0), 0);
        if (v.metodoPago === 'Efectivo') sumE += tot;
        else if (v.metodoPago === 'Transferencia') sumT += tot;
        else if (v.metodoPago === 'Tarjeta') sumTa += tot;
      });
      const totalAll = sumE + sumT + sumTa;
      document.getElementById('sum-efectivo').textContent = `Efectivo: $${sumE.toFixed(2)}`;
      document.getElementById('sum-transferencia').textContent = `Transferencia: $${sumT.toFixed(2)}`;
      document.getElementById('sum-tarjeta').textContent = `Tarjeta: $${sumTa.toFixed(2)}`;
      document.getElementById('sum-total').textContent = `Total: $${totalAll.toFixed(2)}`;
    }
  
    function startEdit(v, itemsArray) {
      document.getElementById('form-id').value = v.id;
      document.getElementById('form-title').textContent = 'Editar Venta - ' + new Date(v.fecha).toISOString().slice(0,10);
      document.getElementById('form-fecha').value = new Date(v.fecha).toISOString().slice(0,10);
      document.getElementById('form-pago').value = v.metodoPago || 'Efectivo';
      const cont = document.getElementById('items-container');
      cont.innerHTML = '';
      itemsArray.forEach(it => cont.append(crearItemRow(it.codigo, it.cantidad, it.total)));
    }
  
    function resetForm() {
      document.getElementById('form-id').value = '';
      document.getElementById('form-title').textContent = 'Editar Venta';
      document.getElementById('form-fecha').value = new Date().toISOString().slice(0,10);
      document.getElementById('form-pago').value = 'Efectivo';
      document.getElementById('items-container').innerHTML = '';
    }
  
    // Inicializar la aplicaci√≥n
    window.onload = function() {
      loadData();
      fetchRecetas();
      
      // Configurar eventos de navegaci√≥n
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          showSection(this.dataset.tab);
        });
      });
      
      // Evento para el bot√≥n de actualizar
      document.getElementById('refresh-btn').addEventListener('click', loadData);
      
      // Eventos para el CRUD de ventas
      document.getElementById('btn-cargar').addEventListener('click', cargarVentas);
      document.getElementById('btn-add-item').addEventListener('click', () => {
        document.getElementById('items-container').append(crearItemRow());
      });
      
      document.getElementById('btn-save').addEventListener('click', async () => {
        const id = document.getElementById('form-id').value;
        const fecha = document.getElementById('form-fecha').value;
        const metodoPago = document.getElementById('form-pago').value;
        if (!fecha) return alert('Fecha requerida');
  
        let items;
        try {
          const rows = document.querySelectorAll('#items-container .item-row');
          items = Array.from(rows).map(row => {
            const [sel, ic, it] = row.children;
            const p = recetas.find(r => r.codigo === sel.value);
            if (!p || !ic.value) throw new Error();
            return { 
              codigo: sel.value, 
              producto: p.nombre, 
              cantidad: Number(ic.value), 
              total: Number(it.value) 
            };
          });
        } catch {
          return alert('Completa todos los campos de items');
        }
  
        try {
          const venta = { id, fecha, items, metodoPago };
          const res = await callApi({ 
            op: 'guardarVentas', 
            venta: JSON.stringify(venta) 
          });
          
          if (res.status === 'success') {
            resetForm();
            cargarVentas();
            // Actualizar tambi√©n el dashboard
            if (dashboardInitialized) {
              initDashboard();
            }
          } else {
            alert('Error: ' + res.message);
          }
        } catch (e) {
          alert('Error: ' + e);
        }
      });
      
      document.getElementById('btn-cancel').addEventListener('click', resetForm);
      
      // Eventos para el modal de resumen
      document.getElementById('show-summary-btn').addEventListener('click', () => {
        document.getElementById('summary-modal').classList.add('active');
      });
      
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('summary-modal').classList.remove('active');
      });
      
      // Cerrar modal al hacer clic fuera del contenido
      document.getElementById('summary-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('summary-modal')) {
          document.getElementById('summary-modal').classList.remove('active');
        }
      });
    };
  </script>
</body>
</html>